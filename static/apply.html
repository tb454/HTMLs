<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>BRidge — Apply for Access</title>
  <link rel="icon" href="/static/favicon.ico">
  <meta name="color-scheme" content="light dark">
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
    crossorigin="anonymous"
  />
  <style>
    :root{
      --bg: #f6f8fb;
      --card-bg:#fff;
      --card-br:#e7eaf0;
      --ink:#0f172a;
      --muted:#6b7280;
      --brand:#0f62fe;
      --ok:#10b981;
      --err:#e11d48;
      --radius:14px;
      --radius-sm:10px;
      --shadow: 0 12px 30px rgba(22,29,37,.06), 0 4px 14px rgba(22,29,37,.04);
      --focus: 0 0 0 4px rgba(15,98,254,.14), 0 0 0 1px rgba(15,98,254,.55) inset;
    }

    @media (prefers-color-scheme: dark) {
      :root{
        --bg:#0b1020;
        --card-bg:#0f1426;
        --card-br:#1e2745;
        --ink:#e5e7eb;
        --muted:#96a0b8;
        --shadow: 0 12px 30px rgba(0,0,0,.35), 0 4px 14px rgba(0,0,0,.25);
        --focus: 0 0 0 4px rgba(15,98,254,.35), 0 0 0 1px rgba(15,98,254,.6) inset;
      }
    }

    html,body{height:100%}
    body{
      background: var(--bg);
      color: var(--ink);
      font: 15.5px/1.45 system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji","Segoe UI Emoji";
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Constrain page for a “composed” feel */
    .container{ max-width: 980px; }

    /* Header */
    h1.h4{
      font-weight: 650;
      letter-spacing:.2px;
    }
    .badge-live{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;background:#fff;
      border:1px solid var(--card-br); box-shadow: var(--shadow);
      font: 12px/1.2 system-ui; color: var(--muted);
    }
    .badge-live::before{
      content:""; width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;
    }
    .badge-live[data-ok="1"]{ color: var(--ok); }
    .badge-live[data-ok="1"]::before{ background: var(--ok); }

    /* Cards */
    .card{
      border:1px solid var(--card-br);
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    /* Form */
    label.form-label{ font-weight: 600; color: var(--ink); }
    .req::after{ content:" *"; color: var(--err); }

    .form-control, .form-select{
      border: 1px solid var(--card-br);
      background: var(--card-bg);
      color: var(--ink);
      height: 44px;
      border-radius: var(--radius-sm);
      transition: box-shadow .15s ease, border-color .15s ease, background-color .2s ease;
    }
    .form-control::placeholder, .form-hint{ color: var(--muted); }
    .form-control:focus, .form-select:focus{ box-shadow: var(--focus); border-color: transparent; }

    /* Section card for Stripe PM */
    .pm-card{
      background: var(--card-bg);
      border:1px dashed #d1d5db;
      border-radius: var(--radius-sm);
    }
    @media (prefers-color-scheme: dark){
      .pm-card{ border-color:#2a355d; }
    }

    /* Buttons */
    .btn{ border-radius: 12px; }
    .btn-primary{
      background: linear-gradient(180deg, #2b78ff, #0f62fe);
      border-color: #0f62fe;
    }
    .btn-primary:hover{ filter: brightness(1.03); }
    .btn-outline-primary{ border-color:#b9ccff; }
    .btn-success{ background: linear-gradient(180deg, #15c58c, #10b981); border-color:#0fb07d; }
    button:disabled{ opacity:.6; cursor:not-allowed; }
    /* Toast */ 
    #toast{
      position:fixed; right:16px; bottom:16px; z-index:1055;
      max-width:360px; display:none;
      padding:12px 14px; background:#0b1324; color:#fff; border-radius:12px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      font: 14px/1.35 system-ui;
    }

    /* Alerts */
    .alert{ border-radius: 12px; }

    /* Footer links */
    footer a{ text-decoration: none; }
    footer a:hover{ text-decoration: underline; }

    /* Fine-tune grid spacing on larger screens */
    @media (min-width: 992px){
      .row.g-3{ row-gap: 1rem; }
    }
  </style>

   <script>
    // Unified API base
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);

    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g,'\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    function toast(msg, ms=2800){
      const t=document.getElementById('toast'); if(!t){ alert(msg); return; }
      t.textContent=typeof msg==='string'?msg:(msg?.message||'');
      t.style.display='block';
      try {
        setTimeout(()=>t.style.display='none', ms);
      }
      catch{}
    }
    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const res = await fetch(url, {
        ...opts,
        headers:{ Accept:'application/json', 'X-CSRF': _cookie('XSRF-TOKEN'), ...(opts.headers||{}) }
      });
      if(res.status===401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if(!res.ok){
        let m='Request failed'; try{ m=(await res.clone().json()).detail||m; }catch{ try{ m=await res.clone().text()||m; }catch{} }
        throw new Error(m);
      }
      return res;
    }
  </script>
  <script src="https://js.stripe.com/v3/"></script>
</head>
<body>

  <div class="container py-4">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-2">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M4 12h16M4 6h10M4 18h10" stroke="#0f62fe" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <h1 class="h4 m-0">BRidge — Apply for Access</h1>
      </div>
      <span class="badge-live" data-health>● Checking…</span>
    </div>

 <!-- Toast + endpoint + api helper -->
  <div id="toast"
     role="status" aria-live="polite" aria-atomic="true" tabindex="-1"
     style="position:fixed;right:16px;bottom:16px;max-width:360px;display:none;
            padding:12px 14px;background:#111827;color:#fff;border-radius:10px;
            box-shadow:0 6px 24px rgba(0,0,0,.2);font:14px system-ui"></div>

    <div id="alert" class="alert d-none" role="status" aria-live="polite"></div>

    <div class="card p-3 p-md-4">
      <form id="applyForm" novalidate>
        <div class="row g-3">
          <!-- Org & role -->
          <div class="col-md-4">
            <label class="form-label req" for="entity_type">Entity Type</label>
            <select id="entity_type" class="form-select" required name="entity_type">
            <option value="">Select…</option>
            <option value="yard">Scrap Yard</option>
            <option value="mill">Mill</option>
            <option value="industrial">Industrial Generator</option>
            <option value="manufacturer">Manufacturer</option>
            <option value="broker">Broker</option>
          </select>

          </div>
          <div class="col-md-4">
            <label class="form-label req" for="role">Role</label>
            <select id="role" class="form-select" required aria-required="true" name="role">
              <option value="">Select…</option>
              <option value="buyer">Buyer</option>
              <option value="seller">Seller</option>
              <option value="both">Both</option>
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label req" for="org_name">Organization</label>
            <input id="org_name" name="org_name" autocomplete="organization" class="form-control" placeholder="Company / Yard name" required aria-required="true">
          </div>

          <!-- Company details -->
          <div class="col-md-4">
            <label class="form-label" for="ein">EIN</label>
            <input id="ein" name="ein" class="form-control" inputmode="numeric"
                   pattern="^\d{2}-\d{7}$" title="Format: 12-3456789" placeholder="12-3456789">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="website">Website</label>
            <input id="website" name="website" class="form-control" inputmode="url" autocomplete="url" placeholder="https://example.com">
          </div>
          <div class="col-md-2">
            <label class="form-label" for="monthly_volume_tons">Monthly Volume (tons)</label>
            <input id="monthly_volume_tons" name="monthly_volume_tons" type="number" min="0" step="1" class="form-control" placeholder="e.g., 1200">
          </div>

          <!-- Address -->
          <div class="col-md-6">
            <label class="form-label" for="address">Address</label>
            <input id="address" name="street-address" autocomplete="street-address" class="form-control" placeholder="Street">
          </div>
          <div class="col-md-4">
            <label class="form-label" for="city">City</label>
            <input id="city" name="address-level2" autocomplete="address-level2" class="form-control" placeholder="City">
          </div>
          <div class="col-md-2">
            <label class="form-label" for="region">State/Region</label>
            <input id="region" name="address-level1" autocomplete="address-level1" class="form-control" placeholder="IN">
          </div>

          <!-- Contact -->
          <div class="col-md-4">
            <label class="form-label req" for="contact_name">Contact Name</label>
            <input id="contact_name" name="name" autocomplete="name" class="form-control" placeholder="Full name" required aria-required="true">
          </div>
          <div class="col-md-4">
            <label class="form-label req" for="email">Email</label>
            <input id="email" name="email" type="email" class="form-control" autocomplete="email" placeholder="name@company.com" required aria-required="true">
          </div>
          <div class="col-md-4">
            <label class="form-label" for="phone">Phone</label>
            <input id="phone" name="tel" inputmode="tel" autocomplete="tel" class="form-control" placeholder="(555) 555-5555">
          </div>

          <!-- Honeypot anti-spam -->
          <div style="position:absolute;left:-9999px" aria-hidden="true">
            <label>Fax</label><input id="fax_hp" tabindex="-1" autocomplete="off">
          </div>

          <!-- Referral / UTM -->
          <div class="col-md-4">
            <label class="form-label" for="ref_code">Referral Code</label>
            <input id="ref_code" name="ref_code" class="form-control" placeholder="(optional)">
          </div>

          <!-- Materials / lanes / compliance -->
          <div class="col-md-6">
            <label class="form-label" for="materials_buy">Materials Buying</label>
            <input id="materials_buy" name="materials_buy" class="form-control" placeholder="e.g., Shred, 5' HMS, #1 Copper">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="materials_sell">Materials Selling</label>
            <input id="materials_sell" name="materials_sell" class="form-control" placeholder="e.g., P&S, #2 Copper, Zorba">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="lanes">Primary Lanes</label>
            <input id="lanes" name="lanes" class="form-control" placeholder="e.g., IN→OH">
          </div>
          <div class="col-md-6">
            <label class="form-label" for="compliance_notes">Compliance Notes</label>
            <input id="compliance_notes" name="compliance_notes" class="form-control" placeholder="EPA permits, etc.">
          </div>

          <!-- Plan + notes -->
          <div class="col-md-4">
            <label class="form-label req" for="plan">Plan</label>
            <select id="plan" name="plan" class="form-select" required aria-required="true">
              <option value="">Select…</option>
              <option value="starter">Starter</option>
              <option value="standard">Standard</option>
              <option value="enterprise">Enterprise</option>
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label" for="notes">Notes</label>
            <input id="notes" name="notes" class="form-control" placeholder="Anything else we should know?">
          </div>
          <!-- Payment Method (required) -->
          <div class="col-12">
            <div class="card p-3" style="background:#fff;border:1px dashed #d1d5db">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <label class="form-label req">Payment Method on File</label>
                  <div id="pmStatus" class="form-hint">No payment method yet.</div>
                </div>
                <div class="d-flex gap-2">
                  <button type="button" id="addPmBtn" class="btn btn-outline-primary">Add Payment Method</button>
                  <button type="button" id="refreshPmBtn" class="btn btn-outline-secondary">Refresh</button>
                  <button type="button" id="startSubBtn" class="btn btn-success" disabled>Start Subscription</button>
                </div>
              </div>
              <div class="form-hint mt-1">
                We accept ACH (US bank) and credit/debit cards. You will not be charged at signup.<br>
                <span id="subHint" class="text-muted">Choose a plan and add a payment method to enable “Start Subscription”.</span>
              </div>
            </div>
          </div>

          <!-- Terms -->
          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="agree" required>
              <label class="form-check-label" for="agree">
                I agree to the <a href="/terms" target="_blank" rel="noopener noreferrer">Terms</a> and <a href="/privacy" target="_blank" rel="noopener noreferrer">Privacy</a>.
              </label>
            </div>
          </div>
        </div>

        <div class="form-check my-3">
          <input class="form-check-input" type="checkbox" id="feesAgree" required>
          <label class="form-check-label" for="feesAgree">
            I have read and agree to the <a href="/fees" target="_blank" rel="noopener">BRidge Fee Schedule</a>.
          </label>
        </div>
        <div class="d-flex gap-2 mt-3">
          <button type="submit" id="submitBtn" class="btn btn-primary" disabled>Submit Application</button>
        </div>
        <div class="form-hint mt-2">Fields marked with <span class="text-danger">*</span> are required.</div>
      </form>
    </div>

    <footer class="text-center text-muted mt-4" style="font-size:.9rem">
      <hr class="mb-3">
      <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
        <a href="/terms"               class="link-secondary" rel="noopener noreferrer">Terms of Use</a><span>·</span>
        <a href="/eula"                class="link-secondary" rel="noopener noreferrer">EULA</a><span>·</span>
        <a href="/privacy"             class="link-secondary" rel="noopener noreferrer">Privacy Policy</a><span>·</span>
        <a href="/aup"                 class="link-secondary" rel="noopener noreferrer">Acceptable Use</a><span>·</span>
        <a href="/cookies"             class="link-secondary" rel="noopener noreferrer">Cookie Notice</a><span>·</span>
        <a href="/legal/subprocessors" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>·</span>
        <a href="/legal/dpa"           class="link-secondary" rel="noopener noreferrer">DPA</a><span>·</span>
        <a href="/legal/sla"           class="link-secondary" rel="noopener noreferrer">SLA</a><span>·</span>
        <a href="/legal/security"      class="link-secondary" rel="noopener noreferrer">Security Overview</a><span>·</span>
        <a href="/privacy/appendix"    class="link-secondary" rel="noopener noreferrer">Privacy Appendix (APAC &amp; CA)</a><span>·</span>
        <a href="/fees"                class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
      </nav>

      <div class="mt-3"><strong>BRidge Platform</strong> — Powered by ScrapFutures.com</div>
      <div>Need help? <a href="mailto:support@scrapfutures.com">support@scrapfutures.com</a></div>
    </footer>
  </div>

  <script>

    // Health badge
  (async ()=>{
    const el = document.querySelector('[data-health]');
    if (!el) return;
    try {
      const r = await api('/health', { headers:{Accept:'application/json'} });
      if (r && r.ok) { el.textContent = '● Live'; el.setAttribute('data-ok','1'); return; }
    } catch {}
    el.textContent = '● Degraded';
  })();

    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);
    function setVal(id,v){ const el=$(id); if(el!=null) el.value = v; }
    function show(kind,msg){
      const box=$('alert');
      box.className = 'alert ' + (kind==='ok' ? 'alert-success' : 'alert-danger');
      box.textContent = msg;
      box.classList.remove('d-none');
      window.scrollTo({top:0,behavior:'smooth'});
    }

    // Prefill referral/utm
    setVal('ref_code', qs.get('ref') || '');
    const utm = {
      utm_source:  qs.get('utm_source')  || null,
      utm_campaign:qs.get('utm_campaign')|| null,
      utm_medium:  qs.get('utm_medium')  || null
    };

    // Draft autosave/restore
    const KEY='bridge_apply_draft_v1';
    const form=$('applyForm');
    document.getElementById('refreshPmBtn')?.addEventListener('click', refreshPmBadge);
    form.addEventListener('input', ()=> {
      const data = Object.fromEntries(new FormData(form).entries());
      localStorage.setItem(KEY, JSON.stringify(data));
    });
    (function restore(){
      const raw=localStorage.getItem(KEY); if(!raw) return;
      try{
        const data=JSON.parse(raw);
        Object.entries(data).forEach(([k,v])=>{
          // Prefer name= match (most fields), fall back to id=
          const byName = form.querySelector(`[name="${CSS.escape(k)}"]`);
          if (byName) { byName.value = v; return; }
          const byId = document.getElementById(k);
          if (byId) byId.value = v;
        });
      }catch{}
    })();    
    </script>
  <script>
    
  // ---- Payment Method flow (Stripe Checkout in setup mode) ----    
  async function pmStatus(member){
    const res = await api(`/billing/pm/status?member=${encodeURIComponent(member)}`);
    return await res.json();
  }

  async function pmStart(member, email){
    const res = await api('/billing/pm/setup_session', {
      method: 'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ member, email })
    });
    const j = await res.json();
    if (j.url) { location.href = j.url; return; }
    throw new Error('Could not start payment method setup.');
  }

  function memberKeyFromForm(){
    const org = (document.getElementById('org_name')?.value || '').trim();
    const mail = (document.getElementById('email')?.value || '').trim();
    return org || mail || '';
  }

  async function refreshPmBadge(){
    const member = memberKeyFromForm();
    const plan = (document.getElementById('plan').value || '').trim();
    if(!member){ return; }
    try{
      const s = await pmStatus(member);
      const hasPm = !!s.has_default;
      document.getElementById('pmStatus').textContent = hasPm
        ? `Payment method on file: ${s.pm || 'default'}`
        : 'No payment method yet.';
      // Submit application hard gate still controlled by PM:
      document.getElementById('submitBtn').disabled = !hasPm;

      // Only enable Start Subscription when PM exists AND plan chosen
      const subBtn = document.getElementById('startSubBtn');
      const canStart = hasPm && !!plan;
      subBtn.disabled = !canStart;
      document.getElementById('subHint').textContent =
        canStart ? 'Ready to start subscription.' : 'Choose a plan and add a payment method to enable “Start Subscription”.';

    }catch{
      document.getElementById('submitBtn').disabled = true;
      const subBtn = document.getElementById('startSubBtn');
      if (subBtn) subBtn.disabled = true;
    }    
  }
  // Hook up Start Subscription button
  document.getElementById('startSubBtn')?.addEventListener('click', async (ev)=>{
    const btn = ev.currentTarget;
    const member = memberKeyFromForm();
    const plan = (document.getElementById('plan').value || '').trim().toLowerCase();
    if (!member || !plan) { toast('Set Organization and Plan first'); return; }
    btn.disabled = true; const old=btn.textContent; btn.textContent='Starting…';
    try {
      await startSubscription(member, plan);
    } catch (e) {
      toast(e.message || 'Could not start subscription checkout.');
      btn.disabled = false; 
      btn.textContent = old;
    }
  });
  
  // Hook up the Add PM button
    document.getElementById('addPmBtn').addEventListener('click', async ()=>{    
      const member = memberKeyFromForm();
      const email  = (document.getElementById('email').value || '').trim();
      if(!member || !email){
        toast('Enter Organization and Email first'); return;
      }
      try{
        await pmStart(member, email);
      }catch(e){
        toast(e.message || 'Could not start payment method setup');
      }
    });
  // On load: finalize PM (?pm=ok&sess=...) and/or Subscription (?sub=ok&session=...)
  (async ()=>{
    // --- PM finalize ---
    const pmOk   = qs.get('pm') === 'ok';
    const pmSess = qs.get('sess');  // set by pm_setup_session success_url
    if (pmOk && pmSess) {
      const member = memberKeyFromForm() || (qs.get('member') || '');
      try {
        await api(`/billing/pm/finalize_from_session?sess=${encodeURIComponent(pmSess)}&member=${encodeURIComponent(member)}`);
        toast('✓ Payment method saved');
      } catch (e) {
        console.warn('PM finalize failed', e);
        toast('Payment method saved (finalization deferred)');
      }
    } else if (pmOk) {
      toast('✓ Payment method saved');
    }

  // --- Subscription finalize ---
  const subOk = qs.get('sub') === 'ok';
  const subSession = qs.get('session');   // set by subscribe/checkout success_url
  if (subOk && subSession) {
    const member = memberKeyFromForm() || (qs.get('member') || '');
    try {
      const res = await api(`/billing/subscribe/finalize_from_session?sess=${encodeURIComponent(subSession)}&member=${encodeURIComponent(member)}`);
      const j = await res.json();
      toast(`✓ Subscription active — ${j.plan || 'plan'}`);
    } catch (e) {
      console.warn('Subscription finalize failed', e);
      toast('Subscription recorded. If status is not updated, refresh.');
    }
  }

  await refreshPmBadge();
})();

  // --- HARD GATE: require PM before submission ---
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    $('alert').classList.add('d-none');
    
  // Honeypot check
  if ((document.getElementById('fax_hp')?.value || '').trim()) {
    show('err','Submission blocked.'); 
    return;
  }
  
    if(!form.checkValidity()){
      const bad=form.querySelector(':invalid'); bad?.focus();
      show('err','Please fix the highlighted fields.'); return;
    }
    if(!$('agree').checked){ show('err','Please accept the Terms & Privacy.'); return; }

    const member = memberKeyFromForm();
    if(!member){ show('err','Organization or Email is required.'); return; }

    try{
      const s = await pmStatus(member);
      if(!s.has_default){
        show('err','Add a payment method to continue.'); toast('Payment method required'); return;
      }
    }catch{
      show('err','Could not verify payment method. Try again.'); return;
    }

// build backend-shaped payload
const fd = new FormData(form);
const payload = {
  entity_type:               (fd.get('entity_type') || '').trim() || null,         // yard|mill|industrial|manufacturer|broker
  role:                      (fd.get('role') || '').trim() || null,                // buyer|seller|both
  org_name:                  (fd.get('org_name') || fd.get('organization') || '').trim() || null,
  ein:                       (fd.get('ein') || '').trim() || null,
  address:                   (fd.get('street-address') || fd.get('address') || '').trim() || null,
  city:                      (fd.get('address-level2') || fd.get('city') || '').trim() || null,
  region:                    (fd.get('address-level1') || fd.get('region') || '').trim() || null,
  website:                   (fd.get('website') || '').trim() || null,
  monthly_volume_tons:       fd.get('monthly_volume_tons') ? parseInt(fd.get('monthly_volume_tons'),10) : null,
  contact_name:              (fd.get('name') || fd.get('contact_name') || '').trim() || null,
  email:                     (fd.get('email') || '').trim() || null,
  phone:                     (fd.get('tel') || fd.get('phone') || '').trim() || null,
  ref_code:                  (fd.get('ref_code') || '').trim() || null,
  materials_buy:             (fd.get('materials_buy') || '').trim() || null,
  materials_sell:            (fd.get('materials_sell') || '').trim() || null,
  lanes:                     (fd.get('lanes') || '').trim() || null,
  compliance_notes:          (fd.get('compliance_notes') || '').trim() || null,
  plan:                      (fd.get('plan') || '').trim() || null,                // starter|standard|enterprise
  notes:                     (fd.get('notes') || '').trim() || null,
  utm_source:                qs.get('utm_source')  || null,
  utm_campaign:              qs.get('utm_campaign')|| null,
  utm_medium:                qs.get('utm_medium')  || null
};


    const btn=$('submitBtn'); btn.disabled=true; const old=btn.textContent; btn.textContent='Submitting…';
    try{
      const idem = (self.crypto?.randomUUID?.() || String(Date.now()) + Math.random());
      await api('/public/apply', {
        method:'POST',
        headers:{'Content-Type':'application/json','Idempotency-Key': idem},
        body: JSON.stringify(payload)
      });
      show('ok',"Thanks! Your application has been received. We'll email you after review.");
      toast('✓ Application submitted');
      localStorage.removeItem('bridge_apply_draft_v1'); form.reset(); $('agree').checked=false;
      await refreshPmBadge();
    }catch(err){
      show('err', err?.message || 'Could not submit application.');
    }finally{
      btn.disabled=false; btn.textContent=old;
    }
  });

// ---- Plan Subscription (Stripe Checkout in subscription mode) ----
async function startSubscription(member, plan) {
  const res = await api('/billing/subscribe/checkout', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ member, plan })
  });
  const j = await res.json();
  if (j.url) { location.href = j.url; return; }
  throw new Error('Could not start subscription checkout.');
}
// Keep PM/Subscription readiness current if org/email/plan changes
['org_name','email','plan'].forEach(id=>{
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('blur', refreshPmBadge);
  el.addEventListener('change', refreshPmBadge);
});

</script>
</body>
</html>