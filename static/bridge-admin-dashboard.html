<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" href="/static/favicon.ico" />
  <meta name="color-scheme" content="light dark" />
  <style>
    body{background:#f4f6f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:20px}
    .table-container{background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.1);padding:20px}
    .table th,.table td{vertical-align:middle}
    .filters{margin-bottom:20px}
    .signature-pad{border:1px solid #ccc;border-radius:6px;width:100%;height:150px;background:#fff;margin-top:10px}
    .form-hint{font-size:.85rem;color:#6c757d}
    .badge-pill{border-radius:50rem;padding:.35em .6em}
    .muted{color:#6c757d}
    code.small{font-size:.8rem}
    table thead.sticky{position:sticky;top:0;background:#fff;z-index:2;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    .table-scroll{max-height:70vh;overflow:auto;border-radius:10px}
    .skeleton-row td{height:14px;padding:10px}
    .skeleton{display:block;width:100%;height:10px;border-radius:6px;background:linear-gradient(90deg,#eee,#f6f7f8,#eee);background-size:200% 100%;animation:sk 1.1s linear infinite}
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
    button:disabled{opacity:.6;cursor:not-allowed}
    .health-badge{font:12px/1 system-ui;color:#6b7280}
    .health-badge[data-ok="1"]{color:#10b981}
  </style>

  <script>
    // Single source of truth for API base
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);

    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g,'\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    // Toast notification (non-blocking)
    function toast(msg, ms=2800){
      const t=document.getElementById('toast'); if(!t){ alert(typeof msg==='string'?msg:(msg?.message||'')); return; }
      t.textContent = (typeof msg==='string'? msg : (msg?.message||''));
      t.style.display='block'; setTimeout(()=>t.style.display='none', ms);
    }
    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const res = await fetch(url, { 
        ...opts, 
        credentials: 'include',
        headers:{ Accept:'application/json', ...(opts.headers||{}), 'X-CSRF': _cookie('XSRF-TOKEN') }
      });

      if (res.status === 401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if (!res.ok){
        let m = 'Request failed';
        try { m = (await res.clone().json()).detail || m; } catch { try { m = await res.clone().text() || m; } catch {} }
        toast(m);
        throw new Error(m);
      }
      return res;
    }
    // Optional tiny health badge
    window.addEventListener('DOMContentLoaded', async () => {
      const el = document.querySelector('[data-health-badge]');
      if (!el) return;
      async function ping(){ try { await api('/health'); el.textContent='‚óè Live'; el.dataset.ok='1'; } catch { el.textContent='‚óè Degraded'; el.dataset.ok='0'; } }
      await ping();
      setInterval(ping, 15000);
    });

  </script>
</head>
<body>
  <!-- Toast lives in <body> (valid HTML) -->
  <div id="toast" style="position:fixed;right:16px;bottom:16px;max-width:360px;display:none;padding:12px 14px;background:#111827;color:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.2);font:14px system-ui" role="status" aria-live="polite"></div>

  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h2 class="mb-0">üìä BRidge Admin Dashboard</h2>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="bols-tab" data-bs-toggle="tab" data-bs-target="#bols-pane" type="button" role="tab" aria-controls="bols-pane" aria-selected="true">BOLs</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="futures-tab" data-bs-toggle="tab" data-bs-target="#futures-pane" type="button" role="tab" aria-controls="futures-pane" aria-selected="false">Futures</button>
      </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">

      <!-- BR-Indices Controls -->
      <div class="card" style="padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:10px;">
        <div class="d-flex align-items-center justify-content-between">
          <h3 class="m-0">BR-Indices Controls</h3>
          <a class="btn btn-link btn-sm" href="/static/indices.html">Open Indices Dashboard ‚Üí</a>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <button class="btn btn-outline-secondary btn-sm" id="btnPullRefs">Pull Reference Prices</button>
          <button class="btn btn-outline-secondary btn-sm" id="btnBuildIndices">Build Today's Indices</button>
          <button class="btn btn-outline-secondary btn-sm" id="btnRunForecasts">Run Forecasts</button>
        </div>
        <div id="idxCtlMsg" class="mt-2 small text-muted"></div>
      </div>

      <script>
        async function postJSON(url, body){
          const r = await api(url, { method:'POST', headers: body? {'Content-Type':'application/json'}:undefined, body: body? JSON.stringify(body): undefined });
          return r.json().catch(()=> ({}));
        }
        function guard(btn, fn){ btn.disabled=true; btn.setAttribute('aria-busy','true'); return fn().finally(()=>{ btn.disabled=false; btn.removeAttribute('aria-busy'); }); }
        document.getElementById('btnPullRefs').onclick = function(){
          const el = document.getElementById('idxCtlMsg'); el.textContent='Pulling reference prices...';
          guard(this, async ()=>{ await postJSON('/reference_prices/pull_now_all'); el.textContent='‚úì Reference prices pulled.'; })
          .catch(e=> el.textContent='‚úó Failed: ' + e.message);
        };
        document.getElementById('btnBuildIndices').onclick = function(){
          const el = document.getElementById('idxCtlMsg'); el.textContent='Building indices...';
          guard(this, async ()=>{ await postJSON('/indices/run'); el.textContent='‚úì Indices built.'; })
          .catch(e=> el.textContent='‚úó Failed: ' + e.message);
        };
        document.getElementById('btnRunForecasts').onclick = function(){
          const el = document.getElementById('idxCtlMsg'); el.textContent='Running forecasts...';
          guard(this, async ()=>{ await postJSON('/forecasts/run'); el.textContent='‚úì Forecasts complete.'; })
          .catch(e=> el.textContent='‚úó Failed: ' + e.message);
        };
      </script>

<!-- RFQ (two-click) -->
<div class="card" style="padding:12px;margin:8px 0;border:1px solid #ddd;border-radius:10px;">
  <h5 class="m-0 mb-2">Quick RFQ</h5>
  <div class="d-flex gap-2">
    <select id="rfqSym" class="form-select" style="max-width:200px" aria-label="Symbol">
      <option>CU-SHRED-1M</option>
      <option>AL-6061-1M</option>
    </select>
    <select id="rfqSide" class="form-select" style="max-width:120px" aria-label="Side">
      <option>buy</option>
      <option>sell</option>
    </select>
    <input id="rfqQty" class="form-control" type="number" placeholder="Qty (lots)" style="max-width:160px" min="0.01" step="0.01" aria-label="Quantity in lots">
    <button id="rfqGo" class="btn btn-primary">RFQ</button>
  </div>
</div>

<script>
  (function(){
    const btn = document.getElementById('rfqGo');
    if(!btn) return;
    btn.onclick = async ()=>{
      const s   = document.getElementById('rfqSym').value;
      const side= document.getElementById('rfqSide').value;
      const q   = +document.getElementById('rfqQty').value;
      if(!q) return toast('Enter qty');
      const exp = new Date(Date.now()+20*60*1000).toISOString();
      const r = await api('/rfq', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ symbol:s, side, quantity_lots:q, expires_at:exp })
      });
      toast('RFQ posted');
      try { console.log(await r.json()); } catch {}
    };
  })();
</script>

      <!-- ====================== BOLs TAB ====================== -->
      <div class="tab-pane fade show active" id="bols-pane" role="tabpanel" aria-labelledby="bols-tab">
        <div class="filters row g-3">
          <div class="col-md-3"><input type="date" class="form-control" id="startDate" /></div>
          <div class="col-md-3"><input type="date" class="form-control" id="endDate" /></div>
          <div class="col-md-3"><input type="text" class="form-control" id="buyerFilter" placeholder="Filter by Buyer" /></div>
          <div class="col-md-3"><input type="text" class="form-control" id="materialFilter" placeholder="Filter by Material/SKU (e.g., SHRED)" /></div>

          <div class="col-md-3"><button class="btn btn-outline-primary w-100" onclick="downloadCSV()">üì§ Export CSV</button></div>
          <div class="col-md-3"><button class="btn btn-outline-primary w-100" onclick="downloadAll()">üì¶ Download All (ZIP)</button></div>
          <div class="col-md-3"><button class="btn btn-outline-primary w-100" onclick="openOpenAPI()">üìú OpenAPI</button></div>
          <div class="col-md-3"><button class="btn btn-outline-primary w-100" onclick="openHealth()">üü¢ Health</button></div>
        </div>

        <div class="d-flex gap-2 mb-2">
          <button id="adminPrevBtn" class="btn btn-outline-secondary btn-sm">‚óÄ Prev</button>
          <button id="adminNextBtn" class="btn btn-outline-secondary btn-sm">Next ‚ñ∂</button>
          <span id="adminPageInfo" class="small text-muted"></span>
        </div>

        <div class="table-container table-scroll">
          <table class="table table-bordered table-striped" id="bol-table" aria-busy="false">
            <thead class="table-dark sticky">
              <tr>
                <th>BOL ID</th>
                <th>Contract ID</th>
                <th>Buyer</th>
                <th>Material</th>
                <th>Weight (Tons)</th>
                <th>Status</th>
                <th>Pickup Time</th>
                <th>Delivery Time</th>
                <th>Total Value</th>
                <th>PDF</th>
                <th>ICE</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ====================== FUTURES TAB ====================== -->
      <div class="tab-pane fade" id="futures-pane" role="tabpanel" aria-labelledby="futures-tab">
        <div class="row g-4">
          <!-- Create Product -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Create Product</h5>
              <form id="productForm" onsubmit="event.preventDefault(); createProduct(this);">
                <div class="row g-3">
                  <div class="col-md-4"><label class="form-label">Symbol Root</label><input name="symbol_root" class="form-control" placeholder="HMS" required /></div>
                  <div class="col-md-8"><label class="form-label">Material</label><input name="material" class="form-control" placeholder="Shred Steel" required /></div>
                  <div class="col-md-6"><label class="form-label">Delivery Location</label><input name="delivery_location" class="form-control" placeholder="IN-Midwest" required /></div>
                  <div class="col-md-3"><label class="form-label">Contract Size (tons)</label><input name="contract_size_tons" type="number" step="0.01" class="form-control" value="20" required /></div>
                  <div class="col-md-3"><label class="form-label">Tick Size</label><input name="tick_size" type="number" step="0.01" class="form-control" value="0.5" required /></div>
                  <div class="col-md-4"><label class="form-label">Currency</label><select name="currency" class="form-select"><option>USD</option><option>EUR</option></select></div>
                  <div class="col-md-8">
                    <label class="form-label">Price Method</label>
                    <select name="price_method" class="form-select">
                      <option value="VWAP_BASIS">VWAP_BASIS</option>
                      <option value="MANUAL">MANUAL</option>
                      <option value="EXTERNAL">EXTERNAL</option>
                    </select>
                    <div class="form-hint">VWAP_BASIS = VWAP + basis + carry√ómonths</div>
                  </div>
                  <div class="col-12"><button class="btn btn-primary">Create / Upsert</button></div>
                </div>
              </form>
            </div>
          </div>

          <!-- Pricing Params -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Pricing Params</h5>
              <form id="pricingForm" onsubmit="event.preventDefault(); submitPricing();">
                <div class="row g-3">
                  <div class="col-md-5"><label class="form-label">Product (Symbol Root)</label><select id="pricingSymbol" class="form-select" required></select></div>
                  <div class="col-md-3"><label class="form-label">Lookback (days)</label><input id="pricingLookback" type="number" class="form-control" value="14" /></div>
                  <div class="col-md-2"><label class="form-label">Basis ($/t)</label><input id="pricingBasis" type="number" step="0.01" class="form-control" value="0" /></div>
                  <div class="col-md-2"><label class="form-label">Carry ($/t/mo)</label><input id="pricingCarry" type="number" step="0.01" class="form-control" value="0" /></div>
                  <div class="col-md-6"><label class="form-label">Manual Mark (if MANUAL)</label><input id="pricingManual" type="number" step="0.01" class="form-control" /></div>
                  <div class="col-12"><button class="btn btn-primary">Save Pricing</button></div>
                </div>
              </form>
            </div>
          </div>

          <!-- Generate Series -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Generate Series (12 months)</h5>
              <form id="seriesForm" onsubmit="event.preventDefault(); submitGenerateSeries();">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label">Product</label><select id="seriesProduct" class="form-select" required></select></div>
                  <div class="col-md-3"><label class="form-label">Expiry Day</label><input id="seriesDay" type="number" min="1" max="28" class="form-control" value="15" /></div>
                  <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100">Generate</button></div>
                </div>
              </form>
              <div class="form-hint mt-2">Generates monthly <b>Draft</b> listings. Then click <b>List</b> to publish and <b>Publish Mark</b> for settlement.</div>
            </div>
          </div>

          <!-- Listings -->
          <div class="col-12">
            <div class="table-container">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-3">Listings</h5>
                <div class="d-flex gap-2 align-items-center">
                  <input type="date" id="markDate" class="form-control form-control-sm" style="width:170px;" />
                  <span class="muted small">Backfill Mark Date (optional)</span>
                  <select id="filterSeriesProduct" class="form-select form-select-sm" style="width:220px;"></select>
                  <select id="filterSeriesStatus" class="form-select form-select-sm" style="width:160px;">
                    <option value="">(all statuses)</option>
                    <option>Draft</option><option>Listed</option><option>Halted</option><option>Expired</option>
                  </select>
                  <button class="btn btn-outline-secondary btn-sm" onclick="refreshSeries()">Refresh</button>
                </div>
              </div>
              <div class="table-scroll">
                <table class="table table-bordered table-striped" id="series-table" aria-busy="false">
                  <thead class="table-dark sticky">
                    <tr>
                      <th>Symbol</th><th>Material</th><th>Month</th><th>Year</th><th>Expiry</th><th>Status</th><th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Recent Marks -->
          <div class="col-12">
            <div class="table-container">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-3">Recent Marks</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="refreshMarks()">Refresh</button>
                </div>
              </div>
              <div class="table-scroll">
                <table class="table table-bordered table-striped" id="marks-table" aria-busy="false">
                  <thead class="table-dark sticky">
                    <tr><th>Symbol</th><th>Contract</th><th>Mark Date</th><th>Mark Price</th><th>Method</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- =============== /FUTURES TAB ================= -->
    </div>
  </div>

  <!-- Delivery Log Modal -->
  <div class="modal fade" id="deliveryLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delivery Log ‚Äî <span id="logBolId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="logStats" class="small text-muted mb-2"></div>
        <div class="table-scroll" style="max-height:50vh">
          <table class="table table-sm table-striped">
            <thead class="sticky"><tr><th>Attempt</th><th>When (UTC)</th><th>Status</th><th>Latency (ms)</th><th>Response</th></tr></thead>
            <tbody id="logTbody"></tbody>
          </table>
        </div>
        <div id="hashRow" class="small text-muted"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-primary" id="btnResend">‚Üª Re-send</button>
        <button class="btn btn-outline-secondary" id="btnTest">üß™ Test Ping</button>
        <button class="btn btn-outline-danger" id="btnRotate">üîë Rotate Secret</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // ----- helpers -----
    async function fetchJSON(url, opts){ const r = await api(url, opts||{}); return r.json(); }
    function statusColor(s){ return {Open:'secondary',Matched:'info','BOL Issued':'primary','In Transit':'warning',Delivered:'success',Closed:'dark'}[s] || 'light'; }
    function formatTime(iso){ try{ return iso? new Date(iso).toLocaleString() : '‚Äî'; }catch{ return '‚Äî'; } }
    const safe = v => (v ?? '‚Äî');
    const _fmtUSD = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:2 });
    const money = n => _fmtUSD.format(Number(n||0));
    const esc = (s)=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    async function _tryDownload(paths){
      for (const p of paths){
        const url = `${window.endpoint}${p}`;
        const head = await api(url, { method:"HEAD" }).catch(()=>null);
        if (head?.ok){ window.location.href = url; return; }
        const get = await api(url, { method:"GET" }).catch(()=>null);
        if (get?.ok){ window.location.href = url; return; }
      }
      toast("Download endpoint not found (404/405).");
    }

    // ----- BOLs pagination -----
    let aOffset=0, aLimit=100;
    const startDate=document.getElementById("startDate"), endDate=document.getElementById("endDate");
    const buyerFilter=document.getElementById("buyerFilter"), materialFilter=document.getElementById("materialFilter");
    const adminPrevBtn=document.getElementById("adminPrevBtn"), adminNextBtn=document.getElementById("adminNextBtn"), adminPageInfo=document.getElementById("adminPageInfo");

    function setBusy(sel, busy){
      const el = document.querySelector(sel);
      if (!el) return;
      if (busy) el.setAttribute('aria-busy','true'); else el.removeAttribute('aria-busy');
    }
    function showSkeleton(tableSel, cols){
      const tb = document.querySelector(`${tableSel} tbody`); if (!tb) return;
      setBusy(tableSel, true);
      tb.innerHTML='';
      for(let i=0;i<5;i++){
        const tr=document.createElement('tr'); tr.className='skeleton-row';
        for(let c=0;c<cols;c++){ const td=document.createElement('td'); td.innerHTML='<span class="skeleton"></span>'; tr.appendChild(td); }
        tb.appendChild(tr);
      }
    }
    function clearBusy(tableSel){ setBusy(tableSel, false); }

    function downloadCSV(){ _tryDownload([ "/contracts/export_csv", "/admin/contracts/export_csv" ]); }
    function downloadAll(){ _tryDownload([ "/admin/exports/all.zip", "/admin/export_all", "/admin/export_all.zip" ]); }
    function openOpenAPI(){ window.open(`${window.endpoint}/docs`, "_blank", "noopener,noreferrer"); }
    function openHealth(){ window.open(`${window.endpoint}/health`, "_blank", "noopener,noreferrer"); }
    function downloadPDF(bolId){ window.open(`${window.endpoint}/bol/${bolId}/pdf`, "_blank", "noopener,noreferrer"); }

    async function loadBOLsAdmin(){
      const qs = new URLSearchParams({ limit:aLimit, offset:aOffset });
      const buyer = buyerFilter.value.trim(), material = materialFilter.value.trim();
      const start = startDate.value, end = endDate.value;
      if (buyer) qs.set("buyer", buyer);
      if (material) qs.set("material", material);
      if (start){ const d=new Date(start); d.setHours(0,0,0,0); qs.set("start", d.toISOString()); }
      if (end){ const d=new Date(end); d.setHours(23,59,59,999); qs.set("end", d.toISOString()); }

      showSkeleton('#bol-table', 11);
      try {
        const res = await api(`/bols?${qs.toString()}`, { headers:{ "Accept":"application/json" }});
        const total = +(res.headers.get('X-Total-Count') || 0);
        const rows = await res.json();

        renderBOLTable(rows);
        adminPrevBtn.disabled = aOffset===0;
        adminNextBtn.disabled = rows.length < aLimit;
        adminPageInfo.textContent = total
          ? `Page ${Math.floor(aOffset/aLimit)+1} ‚Ä¢ ${rows.length} rows ‚Ä¢ ${aOffset+1}‚Äì${aOffset+rows.length} of ${total}`
          : `Page ${Math.floor(aOffset/aLimit)+1} ‚Ä¢ ${rows.length} rows`;

      } catch(e){ toast(e.message||'Load failed'); }
      finally { clearBusy('#bol-table'); }
    }

    function renderBOLTable(rows){
      const tbody = document.querySelector("#bol-table tbody");
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-3">No BOLs match your filters.</td></tr>`;
        return;
      }
      const html = rows.map(bol => {
        const hashHtml = bol.pdf_sha256
          ? `<div class="small text-muted">SHA-256: <code class="small">${esc(String(bol.pdf_sha256).slice(0,12))}‚Ä¶</code></div>`
          : '';
        return `
        <tr>
          <td>${esc(bol.bol_id)}</td>
          <td>${esc(bol.contract_id)}</td>
          <td>${esc(bol.buyer)}</td>
          <td>${esc(bol.material)}</td>
          <td>${safe(bol.weight_tons)}</td>
          <td><span class="badge bg-${statusColor(bol.status)}">${esc(bol.status)}</span></td>
          <td>${formatTime(bol.pickup_time)}</td>
          <td>${formatTime(bol.delivery_time)}</td>
          <td>${money(bol.total_value)}</td>
          <td>
            <button class="btn btn-sm btn-outline-dark" onclick="downloadPDF('${esc(bol.bol_id)}')">üìÑ PDF</button>
            ${hashHtml}
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" onclick="showDeliveryLog('${esc(bol.bol_id)}')">üöö Log</button>
            </div>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    adminPrevBtn?.addEventListener("click", ()=>{ aOffset=Math.max(0,aOffset-aLimit); loadBOLsAdmin(); });
    adminNextBtn?.addEventListener("click", ()=>{ aOffset=aOffset+aLimit; loadBOLsAdmin(); });
    startDate.addEventListener("change", ()=>{ aOffset=0; loadBOLsAdmin(); });
    endDate.addEventListener("change", ()=>{ aOffset=0; loadBOLsAdmin(); });
    buyerFilter.addEventListener("input", debounce(()=>{ aOffset=0; loadBOLsAdmin(); }));
    materialFilter.addEventListener("input", debounce(()=>{ aOffset=0; loadBOLsAdmin(); }));

    // Delivery log modal
    async function showDeliveryLog(bolId){
      document.getElementById("logBolId").textContent = bolId;
      const modal = new bootstrap.Modal(document.getElementById('deliveryLogModal'));
      try{
        const log = await fetchJSON(`/admin/ice/logs?bol_id=${encodeURIComponent(bolId)}`);
        const tb = document.getElementById("logTbody"); tb.innerHTML='';
        (log.entries||[]).forEach((e,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${e.when_utc||"‚Äî"}</td><td>${e.http_status||"‚Äî"}</td><td>${e.ms||"‚Äî"}</td><td><code class="small">${(e.response||"").slice(0,160)}</code></td>`;
          tb.appendChild(tr);
        });
        document.getElementById("logStats").textContent = `Delivered: ${log.delivered_count||0} ‚Ä¢ Pending: ${log.pending_count||0} ‚Ä¢ Failed: ${log.failed_count||0}`;
        document.getElementById("hashRow").innerHTML = log.pdf_sha256 ? `PDF SHA-256: <code class="small">${String(log.pdf_sha256)}</code>` : "";

        document.getElementById("btnResend").onclick = ()=> fetchJSON(`/admin/ice/resend`, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ bol_id: bolId })
        }).then(()=>showDeliveryLog(bolId)).catch(e=>toast(e.message));

        document.getElementById("btnTest").onclick = ()=> fetchJSON(`/admin/ice/test_ping`, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ bol_id: bolId })
        }).then(()=>showDeliveryLog(bolId)).catch(e=>toast(e.message));

        document.getElementById("btnRotate").onclick = ()=> fetchJSON(`/admin/ice/rotate_secret`, { method:"POST" })
          .then(()=>toast("Secret rotated.")).catch(e=>toast(e.message));

        modal.show();
      }catch(e){ toast("Failed to load log: " + e.message); }
    }

    // ----- FUTURES -----
    const apiBase = `${window.endpoint}/admin/futures`;
    let products = []; const productById = {}, productBySymbol = {};
    const pricingSymbolSel = document.getElementById("pricingSymbol");
    const seriesProductSel = document.getElementById("seriesProduct");
    const filterSeriesProdSel = document.getElementById("filterSeriesProduct");
    const filterSeriesStatus = document.getElementById("filterSeriesStatus");
    const markDateInput = document.getElementById("markDate");

    async function refreshProducts(){
      try { products = await fetchJSON(`${apiBase}/products`); }
      catch(e){ toast(e.message||'Products load failed'); return; }

      Object.keys(productById).forEach(k=>delete productById[k]);
      Object.keys(productBySymbol).forEach(k=>delete productBySymbol[k]);
      pricingSymbolSel.innerHTML=''; seriesProductSel.innerHTML=''; filterSeriesProdSel.innerHTML=`<option value="">(all products)</option>`;

      products.forEach(p=>{
        productById[p.id]=p; productBySymbol[p.symbol_root]=p;
        const opt1=document.createElement('option'); opt1.value=p.symbol_root; opt1.textContent = `${p.symbol_root} ‚Äî ${p.material}`;
        const opt2=document.createElement('option'); opt2.value=p.id;          opt2.textContent = `${p.symbol_root} ‚Äî ${p.material}`;
        const opt3=document.createElement('option'); opt3.value=p.id;          opt3.textContent = `${p.symbol_root} ‚Äî ${p.material}`;
        pricingSymbolSel.appendChild(opt1); seriesProductSel.appendChild(opt2); filterSeriesProdSel.appendChild(opt3);
      });
    }

    async function refreshSeries(){
      const q = new URLSearchParams();
      const pid = filterSeriesProdSel.value, st = filterSeriesStatus.value;
      if (pid) q.set("product_id", pid);
      if (st)  q.set("status", st);
      showSkeleton('#series-table', 7);
      let rows=[]; try{ rows = await fetchJSON(`${apiBase}/series?${q.toString()}`);}catch(e){ toast(e.message||'Series load failed'); }
      renderSeriesTable(rows);
      clearBusy('#series-table');
    }

    async function refreshMarks(){
      showSkeleton('#marks-table', 5);
      let rows=[]; try{ rows = await fetchJSON(`${apiBase}/marks`);}catch(e){ toast(e.message||'Marks load failed'); }
      renderMarksTable(rows);
      clearBusy('#marks-table');
    }

    async function createProduct(form){
      const body = Object.fromEntries(new FormData(form));
      body.contract_size_tons = parseFloat(body.contract_size_tons);
      body.tick_size = parseFloat(body.tick_size);
      try{
        await fetchJSON(`${apiBase}/products`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        form.reset(); await refreshProducts(); await refreshSeries(); toast('Product saved.');
      }catch(e){ toast('Create product failed: ' + e.message); }
    }

    async function submitPricing(){
      const symbol_root = pricingSymbolSel.value;
      const body = {
        lookback_days: parseInt(document.getElementById('pricingLookback').value||'14',10),
        basis_adjustment: parseFloat(document.getElementById('pricingBasis').value||'0'),
        carry_per_month: parseFloat(document.getElementById('pricingCarry').value||'0'),
        manual_mark: document.getElementById('pricingManual').value ? parseFloat(document.getElementById('pricingManual').value) : null
      };

      try{
        await fetchJSON(`${apiBase}/products/${encodeURIComponent(symbol_root)}/pricing`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        toast('Pricing saved.');
      }catch(e){ toast('Save pricing failed: ' + e.message); }
    }

    async function submitGenerateSeries(){
      const product_id = seriesProductSel.value;
      try{
        await fetchJSON(`${apiBase}/series/generate`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ product_id, months_ahead:12, day_of_month: parseInt(document.getElementById('seriesDay').value||'15',10) })
        });
        await refreshSeries(); toast('Series generated.');
      }catch(e){ toast('Generate series failed: ' + e.message); }
    }

    async function listSeries(listing_id){
      try{ await fetchJSON(`${apiBase}/series/${listing_id}/list`, { method:'POST' }); await refreshSeries(); }
      catch(e){ toast('List failed: ' + e.message); }
    }

    async function publishMark(listing_id){
      const mark_date = markDateInput.value ? new Date(markDateInput.value + "T00:00:00Z").toISOString().substring(0,10) : null;
      const body = { listing_id }; if (mark_date) body.mark_date = mark_date;
      try{
        await fetchJSON(`${apiBase}/marks/publish`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        await refreshSeries(); await refreshMarks();
      }catch(e){ toast('Publish mark failed: ' + e.message); }
    }

    function renderSeriesTable(rows){
      const tbody=document.querySelector("#series-table tbody"); tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">No listings yet. Create a product, set pricing, then Generate Series.</td></tr>`; return; }
      rows.forEach(r=>{
        const p = productById[r.product_id] || {};
        const sym = p.symbol_root || '‚Äî', mat = p.material || '‚Äî';
        const actions = [];
        if (r.status === "Draft") actions.push(`<button class="btn btn-sm btn-outline-success me-2" onclick="listSeries('${r.id}')">List</button>`);
        actions.push(`<button class="btn btn-sm btn-outline-primary" onclick="publishMark('${r.id}')">Publish Mark</button>`);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${sym}</td><td>${mat}</td><td>${r.contract_month}</td><td>${r.contract_year}</td>
          <td>${r.expiry_date}</td>
          <td><span class="badge ${r.status==='Listed'?'bg-primary':'bg-secondary'}">${r.status}</span></td>
          <td class="text-center">${actions.join('')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMarksTable(rows){
      const tbody=document.querySelector("#marks-table tbody"); tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">No marks yet.</td></tr>`; return; }
      rows.forEach(r=>{
        const contract = `${r.contract_month}${String(r.contract_year).slice(-2)}`;
        const tr=document.createElement('tr');
        const methodClass = r.method==='MANUAL' ? 'bg-warning text-dark' : (r.method==='EXTERNAL' ? 'bg-info' : 'bg-success');
        tr.innerHTML = `
          <td>${r.symbol_root}</td>
          <td>${contract}</td>
          <td>${r.mark_date}</td>
          <td>${money(r.mark_price)}</td>
          <td><span class="badge badge-pill ${methodClass}">${r.method}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Init loads
    loadBOLsAdmin();
    setInterval(loadBOLsAdmin, 10000);

    let futuresLoadedOnce=false;
    document.getElementById("futures-tab").addEventListener("shown.bs.tab", async ()=>{
      if (!futuresLoadedOnce){ await refreshProducts(); await refreshSeries(); await refreshMarks(); futuresLoadedOnce=true; }
      else { await refreshSeries(); await refreshMarks(); }
    });
  </script>
<div id="tape" style="font:14px system-ui;background:#0b1220;color:#cde3ff;padding:8px 12px;border-radius:10px;margin:10px 0;white-space:nowrap;overflow:auto"></div>

<script>
(function tapeWS(){
  const tape = document.getElementById('tape');
  let backoff = 1000;
  function connect(){
    const ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/md/ws');
    ws.onopen = ()=> backoff = 1000;
    ws.onmessage = (e)=>{
      const m = JSON.parse(e.data);
      if(m.type==='trade'){
        const span = document.createElement('span');
        span.textContent = ` ${m.symbol} ${m.price?.toFixed ? m.price.toFixed(4) : m.price} √ó ${m.qty_lots}  |`;
        tape.appendChild(span);
        tape.scrollLeft = tape.scrollWidth;  
      }
    };
    ws.onclose = ()=> setTimeout(()=>{ backoff = Math.min(backoff*1.6, 15000); connect(); }, backoff);
    ws.onerror = ()=> ws.close();
  }
  connect();
})();
</script>

<!-- Admin: Quick Billing Tools -->
<div class="card p-3 mb-3">
  <div class="d-flex align-items-end gap-2">
    <div>
      <label class="form-label">Invoice ID</label>
      <input id="adm_invoice_id" class="form-control" placeholder="invoice UUID">
    </div>
    <div>
      <label class="form-label">Member</label>
      <input id="adm_member" class="form-control" placeholder="member key (Organization)">
    </div>
    <button class="btn btn-success" id="adm_bill_now" style="height:38px">Bill Now</button>
    <button class="btn btn-outline-primary" id="adm_change_pm" style="height:38px">Change Payment Method</button>
  </div>
  <div class="form-hint mt-2">Charges the stored default payment method off-session, or opens a Stripe setup session to update the PM.</div>
</div>

<script>
  document.getElementById('adm_bill_now').addEventListener('click', async ()=>{
    const invoice_id = document.getElementById('adm_invoice_id').value.trim();
    if(!invoice_id){ return toast('Enter an invoice id'); }
    try{
      const res = await api('/billing/pay/charge_now', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ invoice_id })
      });
      const j = await res.json();
      toast(j.ok ? '‚úì Charged and marked paid' : 'Charge attempt finished');
    }catch(e){ toast(e.message || 'Charge failed'); }
  });

  document.getElementById('adm_change_pm').addEventListener('click', async ()=>{
    const member = document.getElementById('adm_member').value.trim();
    if(!member){ return toast('Enter member'); }
    try{
      const res = await api('/billing/pm/change_session', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ member })
      });
      const j = await res.json();
      if(j.url){ location.href = j.url; } else { toast('Could not start PM change'); }
    }catch(e){ toast(e.message || 'Could not start PM change'); }
  });
</script>

  <footer class="legal-footer">
    <a href="/legal/terms" target="_blank" rel="noopener">Terms of Use</a>
    <span class="sep">|</span>
    <a href="/legal/eula" target="_blank" rel="noopener">EULA</a>
    <span class="sep">|</span>
    <a href="/legal/privacy" target="_blank" rel="noopener">Privacy Policy</a>
    <span class="sep">|</span>
    <a href="/legal/aup" target="_blank" rel="noopener">Acceptable Use</a>
    <span class="sep">|</span>
    <a href="/legal/cookies" target="_blank" rel="noopener">Cookie Notice</a>
    <span class="sep">|</span>
    <a href="/legal/subprocessors" target="_blank" rel="noopener">Subprocessors</a>
    <span class="sep">|</span>
    <a href="/legal/dpa" target="_blank" rel="noopener">DPA</a>
    <span class="sep">|</span>
    <a href="/legal/sla" target="_blank" rel="noopener">SLA</a>
    <span class="sep">|</span>
    <a href="/legal/security" target="_blank" rel="noopener">Security Overview</a>
    <span class="sep">|</span>
    <a href="/legal/appendix" target="_blank" rel="noopener">Privacy Appendix (APAC &amp; CA)</a>
  </footer>
</body>
</html>
