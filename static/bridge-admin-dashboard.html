<!DOCTYPE html>
<html class="loading" lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/static/app.css?v=20251111" nonce="{{NONCE}}">
  <link rel="icon" href="/static/favicon.ico" />
  
  <script nonce="{{NONCE}}">
    function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        try { fn(); } catch(e){ console.error(e); }
      }
    }
    // Mint XSRF-TOKEN early so POST/PUT/PATCH/DELETE have a header to echo
    onReady(async () => { try { await fetch('/health', { credentials:'include' }); } catch {} });
    // If any script errors or unhandled promise rejections happen, don't hang the loader
    window.addEventListener('error', () => { try { window.hideLoading(); } catch {} });
    window.addEventListener('unhandledrejection', () => { try { window.hideLoading(); } catch {} });
    // Clear after 3s no matter what
    setTimeout(() => { try { window.hideLoading(); } catch {} }, 3000);
  </script>
  
  <script src="/static/js/i18n.js" defer nonce="{{NONCE}}"></script>
  <script src="/static/js/locale.js" defer nonce="{{NONCE}}"></script>
  
  <script nonce="{{NONCE}}">
    // Single source of truth for API base
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);

    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g,'\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    // Toast notification (non-blocking)
    function toast(msg, ms=2800){
      const t=document.getElementById('toast'); if(!t){ alert(typeof msg==='string'?msg:(msg?.message||'')); return; }
      t.textContent = (typeof msg==='string'? msg : (msg?.message||''));
      t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), ms);
    }
    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const method = (opts.method || 'GET').toUpperCase();
      const headers = { Accept:'application/json', ...(opts.headers||{}) };
      if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
        headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
      }
      const res = await fetch(url, { ...opts, credentials:'include', headers });

      if (res.status === 401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if (!res.ok){
        let m = 'Request failed';
        try { m = (await res.clone().json()).detail || m; } catch { try { m = await res.clone().text() || m; } catch {} }
        toast(m);
        throw new Error(m);
      }
      return res;
    }
    // Optional tiny health badge
    onReady(async () => {
      const el = document.querySelector('[data-health-badge]');
      if (!el) return;
      async function ping(){
        try {
          try { await api('/health'); }
          catch { await api('/healthz'); }
          el.textContent='‚óè Live'; el.dataset.ok='1';
        } catch {
          el.textContent='‚óè Degraded'; el.dataset.ok='0';
        }
      }
      ping();
      setInterval(ping, 15000);
    });
  </script>

  <script nonce="{{NONCE}}">
    // Remove the 'loading' class and any preloader overlay if you use one
    window.hideLoading = function(){
      try { document.documentElement.classList.remove('loading'); } catch {}
      try { document.body.classList.add('loaded'); } catch {}
      const overlay = document.getElementById('preload') || document.getElementById('loading-overlay');
      if (overlay && overlay.parentNode) overlay.parentNode.removeChild(overlay);
    };
  </script>

  <script nonce="{{NONCE}}">
    // If DOMContentLoaded doesn't fire, still clear the loader.
    setTimeout(() => { try { window.hideLoading && window.hideLoading(); } catch {} }, 2500);
  </script>
  
  <script nonce="{{NONCE}}">
    // Belt-and-suspenders: if something above fails, end loading.
    window.addEventListener('DOMContentLoaded', () => {
      try { window.hideLoading && window.hideLoading(); } catch(_) {}
      try {
        const f = document.querySelector('footer.legal-footer');
        if (f) f.classList.remove('invisible');
      } catch(_) {}
      // If DOMContentLoaded fired but something still blocked earlier scripts, re-clear in a microtask
      queueMicrotask(() => { try { window.hideLoading && window.hideLoading(); } catch {} });
    });
  </script>
  </head>

<body>
  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
  <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
  <select id="lang-select" class="form-select form-select-sm w-auto">
    <option value="en">English</option><option value="es">Espa√±ol</option><option value="zh">‰∏≠Êñá</option>
  </select>
  <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
  <input id="tz-select" class="form-control form-control-sm w-220" list="tz-list" placeholder="America/Phoenix" data-i18n-ph="timezone"/>
  <datalist id="tz-list">
    <option value="America/Phoenix"></option><option value="America/New_York"></option>
    <option value="America/Chicago"></option><option value="America/Los_Angeles"></option>
    <option value="UTC"></option><option value="Europe/London"></option><option value="Asia/Shanghai"></option>
  </datalist>
  <button id="save-locale" class="btn btn-outline-secondary btn-sm ms-1"><span data-i18n="save">Save</span></button>
  <small class="text-muted ms-auto" id="local-time"></small>
</div>

  <!-- Toast lives in <body> (valid HTML) -->
  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1"></div>

  <!-- Admin Navbar -->
  <header class="border-bottom mb-3 bg-light">
    <div class="container-fluid py-2 d-flex align-items-center justify-content-between">
      <div class="d-flex align-items-center gap-2">
        <span class="brand-badge">B</span>
        <span class="fw-semibold">BRidge Admin</span>
      </div>
      <nav class="nav nav-pills small">
        <a class="nav-link active" href="/admin">Dashboard</a>
        <a class="nav-link" href="/static/admin-billing.html">Billing</a>
        <a class="nav-link" href="/static/admin-compliance.html">Compliance</a>
        <a class="nav-link" href="/static/admin-tenants.html">Tenants</a>
        <a class="nav-link active" href="/static/indices.html">Indices</a>
        <a class="nav-link active" href="/static/trader.html">Trader</a>
      </nav>
    </div>
  </header>

  <div class="container-fluid">

    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0">üìä BRidge Admin Dashboard</h2>
        <div class="d-flex align-items-center gap-1">
          <label for="tenantSelect" class="small text-muted mb-0">Tenant</label>
          <select id="tenantSelect" class="form-select form-select-sm tenant-min">
            <option value="">(all)</option>
          </select>
        </div>
      </div>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="bols-tab" data-bs-toggle="tab" data-bs-target="#bols-pane" type="button" role="tab" aria-controls="bols-pane" aria-selected="true">BOLs</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="futures-tab" data-bs-toggle="tab" data-bs-target="#futures-pane" type="button" role="tab" aria-controls="futures-pane" aria-selected="false">Futures</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="contracts-tab" data-bs-toggle="tab" data-bs-target="#contracts-pane" type="button" role="tab" aria-controls="contracts-pane" aria-selected="false">
          Contracts
        </button>
      </li>          
      </ul>
    <div class="tab-content" id="adminTabsContent">

      <!-- BR-Indices Controls -->
      <div class="card p-3 mb-2">
        <div class="d-flex align-items-center justify-content-between">
          <h3 class="m-0">BR-Indices Controls</h3>
          <a class="btn btn-link btn-sm" href="/static/indices.html">Open Indices Dashboard ‚Üí</a>
        </div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <button class="btn btn-primary btn-sm" id="btnPullRefs">Pull Reference Prices</button>
          <button class="btn btn-primary btn-sm" id="btnBuildIndices">Build Today's Indices</button>
          <button class="btn btn-primary btn-sm" id="btnRunForecasts">Run Forecasts</button>

          <div class="btn-group btn-group-sm ms-2" id="manualRefGroup" aria-label="Manual reference prices">
            <button class="btn btn-outline-secondary" type="button" data-ref-symbol="COMEX_CU">Cu</button>
            <button class="btn btn-outline-secondary" type="button" data-ref-symbol="LME_AL">Al</button>
            <button class="btn btn-outline-secondary" type="button" data-ref-symbol="COMEX_AU">Au</button>
            <button class="btn btn-outline-secondary" type="button" data-ref-symbol="COMEX_AG">Ag</button>
            <button class="btn btn-outline-secondary" type="button" data-ref-symbol="COMEX_PL">Pt</button>
            <button class="btn btn-outline-secondary" type="button" data-ref-symbol="COMEX_PA">Pd</button>
          </div>
        </div>
        <div id="idxCtlMsg" class="mt-2 small text-muted"></div>
      </div>

      <script nonce="{{NONCE}}">
        async function postJSON(url, body){
          try{
            const r = await api(url, {
              method:'POST',
              headers: body ? {'Content-Type':'application/json'} : undefined,
              body: body ? JSON.stringify(body) : undefined
            });
            try { return await r.json(); } catch { return {}; }
          }catch(e){
            // api() already extracted server error text; rethrow so caller shows it
            throw e;
          }
        }

        function guard(btn, fn){
          btn.disabled = true;
          btn.setAttribute('aria-busy','true');
          return fn().finally(()=>{ btn.disabled=false; btn.removeAttribute('aria-busy'); });
        }

        // CSRF cookie is minted earlier via /health; handlers below just show exact errors.
        document.getElementById('btnPullRefs').onclick = function(){
          const el = document.getElementById('idxCtlMsg'); el.textContent='Pulling reference prices...';
          guard(this, async ()=>{
            const j = await postJSON('/reference_prices/pull_now_all');
            el.textContent = '‚úì Reference prices pulled.';
            if (j && j.ok === false) toast(JSON.stringify(j));
          }).catch(e=> el.textContent = '‚úó Failed: ' + (e?.message || 'error'));
        };

        document.getElementById('btnBuildIndices').onclick = function(){
          const el = document.getElementById('idxCtlMsg'); el.textContent='Building indices...';
          guard(this, async ()=>{
            const j = await postJSON('/indices/run');
            el.textContent = '‚úì Indices built.';
            if (j && j.ok === false) toast(JSON.stringify(j));
          }).catch(e=> el.textContent = '‚úó Failed: ' + (e?.message || 'error'));
        };

        document.getElementById('btnRunForecasts').onclick = function(){
          const el = document.getElementById('idxCtlMsg'); el.textContent='Running forecasts...';
          guard(this, async ()=>{
            const j = await postJSON('/forecasts/run');
            el.textContent = '‚úì Forecasts complete.';
            if (j && j.ok === false) toast(JSON.stringify(j));
          }).catch(e=> el.textContent = '‚úó Failed: ' + (e?.message || 'error'));
        };

        // Manual reference price overrides (Cu/Al/Au/Ag/Pt/Pd)
        (function wireManualRefs(){
          const group = document.getElementById('manualRefGroup');
          if (!group) return;

          const LABELS = {
            COMEX_CU: 'Copper (BR-CU)',
            LME_AL:   'Aluminum (BR-AL)',
            COMEX_AU: 'Gold (BR-AU)',
            COMEX_AG: 'Silver (BR-AG)',
            COMEX_PL: 'Platinum (BR-PL)',
            COMEX_PA: 'Palladium (BR-PA)'
          };

          group.addEventListener('click', async (ev) => {
            const btn = ev.target.closest('button[data-ref-symbol]');
            if (!btn) return;
            if (btn.dataset.busy === '1') return;

            const symbol = btn.getAttribute('data-ref-symbol');
            const label  = LABELS[symbol] || symbol;

            const raw = prompt(`Enter official close for ${label} in USD/lb:`);
            if (!raw) return;

            const price = Number(raw);
            if (!Number.isFinite(price) || price <= 0) {
              toast('Invalid price.');
              return;
            }

            const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
            btn.dataset.busy = '1';

            try {
              await api(`/reference_prices/override_close?symbol=${encodeURIComponent(symbol)}&d=${today}&price=${encodeURIComponent(price)}&source=manual_admin`, {
                method: 'POST'
              });
              toast(`‚úì ${label} set to ${price.toFixed(4)} USD/lb (manual)`);
              const el = document.getElementById('idxCtlMsg');
              if (el) el.textContent = `Manual override: ${label} = ${price.toFixed(4)} USD/lb. Click "Build Today's Indices" to propagate.`;
            } catch (e) {
              toast(e?.message || `Failed to set ${label}.`);
            } finally {
              btn.dataset.busy = '0';
            }
          });
        })();
      </script>

<h5 class="mt-3">Tons / Month by Yard</h5>
<table class="table table-sm" id="tonsTbl">
  <thead><tr><th>Yard</th><th>Tons (month)</th></tr></thead>
  <tbody></tbody>
</table>
<script nonce="{{NONCE}}">
(async function loadTons(){
  try{
    const res = await api("/analytics/tons_by_yard_this_month");
    const data = await res.json();
    const tb = document.querySelector("#tonsTbl tbody");
    tb.innerHTML = data.map(r=>`<tr><td>${r.yard_id}</td><td>${r.tons_month}</td></tr>`).join("");
  }catch(e){ /* optional toast */ }
})();
</script>

<canvas id="bolsByDay" height="120" class="mb-3"></canvas>
<script nonce="{{NONCE}}">
onReady(async function(){
  try{
    // Wait until Chart.js is available (it‚Äôs loaded later on the page)
    if (!window.Chart) {
      let tries = 0;
      await new Promise((resolve) => {
        const iv = setInterval(() => {
          if (window.Chart || tries++ > 100) { clearInterval(iv); resolve(); }
        }, 30);
      });
    }
    if (!window.Chart) return;    

    const res  = await api("/analytics/prices_over_time?material=Shred%20Steel&window=1M");
    const data = await res.json();
    const el   = document.getElementById('bolsByDay');
    if (!el) return;
    const ctx  = el.getContext('2d');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: data.map(r=>r.date),
        datasets: [{ label: "Avg $/ton (1M)", data: data.map(r=>r.avg_price) }]
      },
      options: { responsive:true, maintainAspectRatio:false, plugins:{ legend:{ display:true } } }
    });
  } catch (e) {}
});
</script>

<div class="d-flex gap-2">
  <button id="prevBtn" class="btn btn-outline-secondary btn-sm">Prev</button>
  <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next</button>
</div>

<!-- Usage & Risk Overview -->
<div class="row g-3 mt-3">
  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">Usage by Member (Current Cycle)</h5>
      <div class="table-responsive">
        <table class="table table-sm table-striped align-middle" id="usageTbl">
          <thead>
            <tr>
              <th>Member</th><th>Plan</th><th>BOLs</th><th>Contracts</th><th>Receipts</th><th>Overage ($)</th>
            </tr>
          </thead>
          <tbody><tr><td colspan="6" class="text-muted text-center py-2">Loading‚Ä¶</td></tr></tbody>
        </table>
      </div>
      <div class="small text-muted mt-1">
        Backed by billing_plan_limits, usage_events and billing_invoices. ICE/Citadel ready.
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card p-3">
      <h5 class="mb-2">Risk & Surveillance</h5>
      <div class="row g-2">
        <div class="col-12">
          <strong class="small text-muted">Recent Anomaly Scores</strong>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-1" id="anomalyTbl">
              <thead>
                <tr><th>Member</th><th>Symbol</th><th>Score</th><th>As Of</th></tr>
              </thead>
              <tbody><tr><td colspan="4" class="text-muted text-center py-1">Loading‚Ä¶</td></tr></tbody>
            </table>
          </div>
        </div>
        <div class="col-12">
          <strong class="small text-muted">Surveillance Alerts</strong>
          <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0" id="surveilTbl">
              <thead>
                <tr><th>Rule</th><th>Subject</th><th>Severity</th><th>Opened</th></tr>
              </thead>
              <tbody><tr><td colspan="4" class="text-muted text-center py-1">Loading‚Ä¶</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="small text-muted mt-1">
        Feeds from anomaly_scores and surveil_alerts/surveil_cases. Use for T+1 reviews and ICE audits.
      </div>
    </div>
  </div>
</div>

<!-- Dossier Ingestion Status -->
<div class="card p-3 mb-3 mt-3">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h5 class="m-0">Dossier Ingestion</h5>
    <button class="btn btn-outline-secondary btn-sm" id="dossierRetry">Retry Failed</button>
  </div>
  <div class="table-responsive">
    <table class="table table-sm table-striped align-middle" id="dossierTbl">
      <thead>
        <tr>
          <th>Source</th><th>Table</th><th>Event</th><th>Status</th><th>Attempts</th><th>Last Error</th><th>Created</th>
        </tr>
      </thead>
      <tbody><tr><td colspan="7" class="text-muted text-center py-2">Loading‚Ä¶</td></tr></tbody>
    </table>
  </div>
  <div class="small text-muted mt-1" id="dossierMsg"></div>
</div>

<!-- RFQ (two-click) -->
<div class="card p-3 mb-2">
  <h5 class="m-0 mb-2">Quick RFQ</h5>
  <div class="d-flex gap-2">
    <select id="rfqSym" class="form-select maxw-200" aria-label="Symbol">
      <option>CU-SHRED-1M</option>
      <option>AL-6061-1M</option>
    </select>
    <select id="rfqSide" class="form-select maxw-120" aria-label="Side">
      <option>buy</option>
      <option>sell</option>
    </select>
    <input id="rfqQty" class="form-control maxw-160" type="number" placeholder="Qty (lots)" min="0.01" step="0.01" aria-label="Quantity in lots">
    <button id="rfqGo" class="btn btn-primary">RFQ</button>
  </div>
</div>

<script nonce="{{NONCE}}">
  (function(){
    const btn = document.getElementById('rfqGo');
    if(!btn) return;
    btn.onclick = async ()=>{
      const s   = document.getElementById('rfqSym').value;
      const side= document.getElementById('rfqSide').value;
      const q   = +document.getElementById('rfqQty').value;
      if(!q) return toast('Enter qty');
      const exp = new Date(Date.now()+20*60*1000).toISOString();
      const r = await api('/rfq', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ symbol:s, side, quantity_lots:q, expires_at:exp })
      });
      toast('RFQ posted');
      try { console.log(await r.json()); } catch {}
    };
  })();
</script>

<section class="card">
  <h3>Vendor Pricing (Latest Sheet)</h3>
  <div id="vendor-latest-wrap">
    <table id="vendor-latest" class="table">
      <thead>
        <tr><th>Vendor</th><th>Category</th><th>Material</th><th>$ / lb</th><th>Unit</th><th>Date</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <canvas id="vendorChart" height="120"></canvas>
</section>

<script nonce="{{NONCE}}">
  (function loadChartJS(){
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/chart.js';
    s.defer = true;
    s.onload = () => console.debug('Chart.js loaded');
    s.onerror = () => console.warn('Chart.js failed to load; continuing without charts');
    document.head.appendChild(s);
  })();
</script>

<script nonce="{{NONCE}}">
(async function(){
  try {
    // 1) Use the same API helper (auth + CSRF + 401 ‚Üí login)
    const res  = await api('/vendor_quotes/latest');
    const rows = await res.json();

    const tbody = document.querySelector('#vendor-latest tbody');
    if (!tbody) return;

    tbody.innerHTML = rows.map(r => `
      <tr>
        <td>${r.vendor||''}</td>
        <td>${r.category||''}</td>
        <td>${r.material||''}</td>
        <td>${r.price_per_lb ?? ''}</td>
        <td>${r.unit_raw||''}</td>
        <td>${r.sheet_date||''}</td>
      </tr>`).join('');

    // 2) Wait for Chart.js to exist 
    if (!window.Chart) {
      let tries = 0;
      await new Promise((resolve) => {
        const iv = setInterval(() => {
          if (window.Chart || tries++ > 100) { // ~3s max (100 * 30ms)
            clearInterval(iv);
            resolve();
          }
        }, 30);
      });
    }
    if (!window.Chart) {
      console.warn('Chart.js still unavailable; skipping vendor chart.');
      return;
    }

    // 3) Aggregate vendor sheet into avg $/lb per material
    const agg = {};
    for (const r of rows) {
      if (r.unit_raw && ['LB','LBS','POUND','POUNDS',''].includes(String(r.unit_raw).toUpperCase()) && r.price_per_lb != null) {
        agg[r.material] = agg[r.material] || [];
        agg[r.material].push(+r.price_per_lb);
      }
    }
    const labels = [];
    const data   = [];
    Object.entries(agg).forEach(([mat, arr]) => {
      const avg = arr.reduce((a,b)=>a+b,0) / arr.length;
      labels.push(mat);
      data.push(+avg.toFixed(4));
    });

    // Top 10 by price
    const idx = data
      .map((v,i)=>[v,i])
      .sort((a,b)=>b[0]-a[0])
      .slice(0,10)
      .map(x=>x[1]);
    const topLabels = idx.map(i=>labels[i]);
    const topData   = idx.map(i=>data[i]);

    const canvas = document.getElementById('vendorChart');
    if (!canvas) return;
    const ctx = canvas.getContext('2d');

    new Chart(ctx, {
      type: 'line',
      data: {
        labels: topLabels,
        datasets: [
          { label: 'Avg $/lb (latest)', data: topData }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: false }
        }
      }
    });
  } catch(e) {
    console.error(e);
  }
})();
</script>

      <!-- ====================== BOLs TAB ====================== -->
      <div class="tab-pane fade show active" id="bols-pane" role="tabpanel" aria-labelledby="bols-tab">
        <div class="filters row g-3">
          <div class="col-md-3"><input type="date" class="form-control" id="startDate" /></div>
          <div class="col-md-3"><input type="date" class="form-control" id="endDate" /></div>
          <div class="col-md-3"><input type="text" class="form-control" id="buyerFilter" placeholder="Filter by Buyer" /></div>
          <div class="col-md-3"><input type="text" class="form-control" id="materialFilter" placeholder="Filter by Material/SKU (e.g., SHRED)" /></div>

          <div class="col-md-3">
            <button class="btn btn-secondary w-100" data-call="downloadCSV">üì§ Export CSV</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-secondary w-100" data-call="downloadAll">üì¶ Download All (ZIP)</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-secondary w-100" data-call="openOpenAPI">üìú OpenAPI</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-secondary w-100" data-call="openHealth">üü¢ Health</button>
          </div>
        </div>

        <div class="d-flex gap-2 mb-2">
          <button id="adminPrevBtn" class="btn btn-secondary btn-sm">‚óÄ Prev</button>
          <button id="adminNextBtn" class="btn btn-secondary btn-sm">Next ‚ñ∂</button>
          <span id="adminPageInfo" class="small text-muted"></span>
        </div>

        <div class="table-container table-scroll">
          <table class="table table-striped table-hover align-middle" id="bol-table" aria-busy="false">
            <thead class="table-dark sticky">
              <tr>
                <th>BOL ID</th>
                <th>Contract ID</th>
                <th>Buyer</th>
                <th>Material</th>
                <th>Weight (Tons)</th>
                <th>Status</th>
                <th>Pickup Time</th>
                <th>Delivery Time</th>
                <th>Total Value</th>
                <th>PDF</th>
                <th>ICE</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ====================== CONTRACTS TAB ====================== -->
      <div class="tab-pane fade" id="contracts-pane" role="tabpanel" aria-labelledby="contracts-tab">
        <!-- Filters -->
        <div class="row g-2 align-items-end mb-2">
          <div class="col-md-2">
            <label class="form-label">Status</label>
            <select id="cStatus" class="form-select">
              <option value="all">All</option>
              <option>Pending</option>
              <option>Signed</option>
              <option>Dispatched</option>
              <option>Fulfilled</option>
              <option>Cancelled</option>
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Yard</label>
            <input id="cYard" class="form-control" placeholder="Winski Brothers">
          </div>
          <div class="col-md-3">
            <label class="form-label">From</label>
            <input id="cFrom" type="date" class="form-control">
          </div>
          <div class="col-md-3">
            <label class="form-label">To</label>
            <input id="cTo" type="date" class="form-control">
          </div>
          <div class="col-md-1 d-grid">
            <button id="cApply" class="btn btn-secondary">Apply</button>
          </div>
          <div class="col-md-1 d-grid">
            <button id="cClear" class="btn btn-outline-secondary">Clear</button>
          </div>
        </div>
  <!-- Pager -->
  <div class="d-flex gap-2 mb-2">
    <button id="cPrev" class="btn btn-secondary btn-sm">‚óÄ Prev</button>
    <button id="cNext" class="btn btn-secondary btn-sm">Next ‚ñ∂</button>
    <span id="cInfo" class="small text-muted"></span>
  </div>

  <!-- Table -->
  <div class="table-container table-scroll">
    <table class="table table-striped table-hover align-middle" id="contracts-table" aria-busy="false">
      <thead class="table-dark sticky">
        <tr>
          <th>ID</th><th>Buyer</th><th>Seller</th><th>Material</th>
          <th>Tons</th><th>$/ton</th><th>Status</th><th>Created</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>
<!-- =================== /CONTRACTS TAB =================== -->

      <!-- ====================== FUTURES TAB ====================== -->
      <div class="tab-pane fade" id="futures-pane" role="tabpanel" aria-labelledby="futures-tab">
        <div class="row g-4">
          <!-- Create Product -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Create Product</h5>
              <form id="productForm">
                <div class="row g-3">
                  <div class="col-md-4"><label class="form-label">Symbol Root</label><input name="symbol_root" class="form-control" placeholder="HMS" required /></div>
                  <div class="col-md-8"><label class="form-label">Material</label><input name="material" class="form-control" placeholder="Shred Steel" required /></div>
                  <div class="col-md-6"><label class="form-label">Delivery Location</label><input name="delivery_location" class="form-control" placeholder="IN-Midwest" required /></div>
                  <div class="col-md-3"><label class="form-label">Contract Size (tons)</label><input name="contract_size_tons" type="number" step="0.01" class="form-control" value="20" required /></div>
                  <div class="col-md-3"><label class="form-label">Tick Size</label><input name="tick_size" type="number" step="0.01" class="form-control" value="0.5" required /></div>
                  <div class="col-md-4"><label class="form-label">Currency</label><select name="currency" class="form-select"><option>USD</option><option>EUR</option></select></div>
                  <div class="col-md-8">
                    <label class="form-label">Price Method</label>
                    <select name="price_method" class="form-select">
                      <option value="VWAP_BASIS">VWAP_BASIS</option>
                      <option value="MANUAL">MANUAL</option>
                      <option value="EXTERNAL">EXTERNAL</option>
                    </select>
                    <div class="form-hint">VWAP_BASIS = VWAP + basis + carry√ómonths</div>
                  </div>
                  <div class="col-12"><button class="btn btn-primary">Create / Upsert</button></div>
                </div>
              </form>
            </div>
          </div>

          <!-- Pricing Params -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Pricing Params</h5>
              <form id="pricingForm">
                <div class="row g-3">
                  <div class="col-md-5"><label class="form-label">Product (Symbol Root)</label><select id="pricingSymbol" class="form-select" required></select></div>
                  <div class="col-md-3"><label class="form-label">Lookback (days)</label><input id="pricingLookback" type="number" class="form-control" value="14" /></div>
                  <div class="col-md-2"><label class="form-label">Basis ($/t)</label><input id="pricingBasis" type="number" step="0.01" class="form-control" value="0" /></div>
                  <div class="col-md-2"><label class="form-label">Carry ($/t/mo)</label><input id="pricingCarry" type="number" step="0.01" class="form-control" value="0" /></div>
                  <div class="col-md-6"><label class="form-label">Manual Mark (if MANUAL)</label><input id="pricingManual" type="number" step="0.01" class="form-control" /></div>
                  <div class="col-12"><button class="btn btn-primary">Save Pricing</button></div>
                </div>
              </form>
            </div>
          </div>

          <!-- Generate Series -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Generate Series (12 months)</h5>
              <form id="seriesForm">
                <div class="row g-3">
                  <div class="col-md-6"><label class="form-label">Product</label><select id="seriesProduct" class="form-select" required></select></div>
                  <div class="col-md-3"><label class="form-label">Expiry Day</label><input id="seriesDay" type="number" min="1" max="28" class="form-control" value="15" /></div>
                  <div class="col-md-3 d-flex align-items-end"><button class="btn btn-primary w-100">Generate</button></div>
                </div>
              </form>
              <div class="form-hint mt-2">Generates monthly <b>Draft</b> listings. Then click <b>List</b> to publish and <b>Publish Mark</b> for settlement.</div>
            </div>
          </div>

          <!-- Listings -->
          <div class="col-12">
            <div class="table-container">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-3">Listings</h5>
                <div class="d-flex gap-2 align-items-center">
                  <input type="date" id="markDate" class="form-control form-control-sm maxw-170" />
                  <span class="muted small">Backfill Mark Date (optional)</span>
                  <select id="filterSeriesProduct" class="form-select form-select-sm maxw-220"></select>
                  <select id="filterSeriesStatus" class="form-select form-select-sm w-160">
                    <option value="">(all statuses)</option>
                    <option>Draft</option><option>Listed</option><option>Halted</option><option>Expired</option>
                  </select>
                  <button class="btn btn-outline-secondary btn-sm" data-call="refreshSeries">Refresh</button>
                </div>
              </div>
              <div class="table-scroll">
                <table class="table table-striped table-hover align-middle" id="series-table" aria-busy="false">
                  <thead class="table-dark sticky">
                    <tr>
                      <th>Symbol</th><th>Material</th><th>Month</th><th>Year</th><th>Expiry</th><th>Status</th><th class="text-center">Actions</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Recent Marks -->
          <div class="col-12">
            <div class="table-container">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-3">Recent Marks</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" data-call="refreshMarks">Refresh</button>
                </div>
              </div>
              <div class="table-scroll">
                <table class="table table-striped table-hover align-middle" id="marks-table" aria-busy="false">
                  <thead class="table-dark sticky">
                    <tr><th>Symbol</th><th>Contract</th><th>Mark Date</th><th>Mark Price</th><th>Method</th></tr>
                  </thead>
                  <tbody></tbody>
                </table>
              </div>
            </div>
          </div>

        </div>
      </div>
      <!-- =============== /FUTURES TAB ================= -->
    </div>
  </div>

  <!-- Delivery Log Modal -->
  <div class="modal fade" id="deliveryLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delivery Log ‚Äî <span id="logBolId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="logStats" class="small text-muted mb-2"></div>
        <div class="table-scroll maxh-50vh">
          <table class="table table-sm table-striped table-hover align-middle">
            <thead class="table-dark sticky"><tr><th>Attempt</th><th>When (UTC)</th><th>Status</th><th>Latency (ms)</th><th>Response</th></tr></thead>
            <tbody id="logTbody"></tbody>
          </table>
        </div>
        <div id="hashRow" class="small text-muted"></div>
      </div>
      <div class="d-none">
        <button class="btn btn-outline-primary" id="btnResend">‚Üª Re-send</button>
        <button class="btn btn-outline-secondary" id="btnTest">üß™ Test Ping</button>
        <button class="btn btn-outline-danger" id="btnRotate">üîë Rotate Secret</button>
      </div>
    </div></div>
  </div>

  <script
    nonce="{{NONCE}}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    defer
    crossorigin="anonymous"
  ></script>

  <script nonce="{{NONCE}}">
  // ---- Admin Contracts Pager + Filters (scoped) ----
  (function(){
    const $ = (id)=>document.getElementById(id);
    const qs = new URLSearchParams(location.search);

    // Pager buttons specifically for Contracts tab
    const cPrevBtn = document.getElementById("cPrev");
    const cNextBtn = document.getElementById("cNext");

    // state
    let cLimit  = +(qs.get("c_limit")  || 25);
    let cOffset = +(qs.get("c_offset") || 0);

    // hydrate controls from URL if present
    (function hydrate(){
      const status = qs.get("status") || "all";
      const yard   = qs.get("yard_id") || "";
      const from   = qs.get("date_from") || "";
      const to     = qs.get("date_to") || "";
      if ($("cStatus")) $("cStatus").value = status;
      if ($("cYard"))   $("cYard").value   = yard;
      if ($("cFrom"))   $("cFrom").value   = from;
      if ($("cTo"))     $("cTo").value     = to;
    })();

    function currentFilterQS(){
      const filters = [
        ["status",   $("cStatus")?.value],
        ["seller",  $("cYard")?.value],
        ["start",$("cFrom")?.value],
        ["end",  $("cTo")?.value],
      ].filter(([k,v]) => v && v !== "all");
      return filters.map(([k,v]) => `${k}=${encodeURIComponent(v)}`).join("&");
    }

    function skeleton(rows=6, cols=8){
      const tb = document.querySelector("#contracts-table tbody");
      if (!tb) return;
      tb.innerHTML = "";
      for (let i=0;i<rows;i++){
        const tr = document.createElement("tr");
        for (let c=0;c<cols;c++){
          const td = document.createElement("td");
          td.innerHTML = '<span class="skeleton"></span>';
          tr.appendChild(td);
        }
        tb.appendChild(tr);
      }
    }

    function render(rows){
      const tb = document.querySelector("#contracts-table tbody");
      if (!tb) return;
      if (!(rows && rows.length)){
        tb.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-3">No contracts match your filters.</td></tr>`;
        return;
      }
      tb.innerHTML = rows.map(r => `
        <tr>
          <td>${r.id}</td>
          <td>${r.buyer||""}</td>
          <td>${r.seller||""}</td>
          <td>${r.material||""}</td>
          <td>${r.weight_tons??""}</td>
          <td>${r.price_per_ton??""}</td>
          <td>${r.status||""}</td>
          <td>${r.created_at ? new Date(r.created_at).toLocaleString() : ""}</td>
        </tr>
      `).join("");
    }

    async function loadContracts(){
      const fqs = currentFilterQS();
      const base = `/contracts?limit=${cLimit}&offset=${cOffset}`;
      const url  = fqs ? `${base}&${fqs}` : base;

      skeleton();

      const res = await api(url, { headers:{ "Accept":"application/json" }});
      const total = +(res.headers.get("X-Total-Count") || 0);
      const data = await res.json();

      render(Array.isArray(data.items) ? data.items : data);
      try { window.hideLoading(); } catch {}

      // pager UI
      $("cPrev").disabled = (cOffset <= 0);
      $("cNext").disabled = ((Array.isArray(data.items)?data.items.length:data.length) < cLimit);
      const from = total ? Math.min(cOffset+1, total) : 0;
      const to   = total ? Math.min(cOffset + (Array.isArray(data.items)?data.items.length:data.length), total) : 0;
      $("cInfo").textContent = total ? `${from}‚Äì${to} of ${total}` : "";

      // reflect URL (namespaced keys so it doesn't clash with BOLs)
      const nextQS = new URLSearchParams(location.search);
      nextQS.set("c_limit",  String(cLimit));
      nextQS.set("c_offset", String(cOffset));
      const kv = Object.fromEntries(new URLSearchParams(fqs));
      ["status","seller","start","end"].forEach(k=>{
        if (kv[k]) nextQS.set(k, kv[k]); else nextQS.delete(k);
      });
      history.replaceState(null, "", `?${nextQS.toString()}`);
    }

    // wire
    cPrevBtn?.addEventListener("click", ()=>{
      cOffset = Math.max(0, cOffset - cLimit);
      loadContracts();
    });
    cNextBtn?.addEventListener("click", ()=>{
      cOffset = cOffset + cLimit;
      loadContracts();
    });
    $("cApply")?.addEventListener("click", ()=>{
      cOffset = 0;
      loadContracts();
    });
    $("cClear")?.addEventListener("click", ()=>{
      if ($("cStatus")) $("cStatus").value = "all";
      if ($("cYard"))   $("cYard").value   = "";
      if ($("cFrom"))   $("cFrom").value   = "";
      if ($("cTo"))     $("cTo").value     = "";
      cOffset = 0;
      loadContracts();
    });

    // only fetch when the Contracts tab is shown
    const tab = document.getElementById("contracts-tab");
    tab?.addEventListener("shown.bs.tab", loadContracts);
    tab?.addEventListener("click", () => {
      loadContracts().catch(()=>{});
    });

    // if Contracts pane is already active (deep link), load immediately
    if (document.getElementById("contracts-pane")?.classList.contains("show")) {
      loadContracts();
    }
  })();
  </script>

  <script nonce="{{NONCE}}">
    // ----- helpers -----
    async function fetchJSON(url, opts){ const r = await api(url, opts||{}); return r.json(); }
    function statusColor(s){ return {Open:'secondary',Matched:'info','BOL Issued':'primary','In Transit':'warning',Delivered:'success',Closed:'dark'}[s] || 'light'; }
    function formatTime(iso){ try{ return iso? new Date(iso).toLocaleString() : '‚Äî'; }catch{ return '‚Äî'; } }
    const safeVal = v => (v ?? '‚Äî');
    const _fmtUSD = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:2 });
    const money = n => _fmtUSD.format(Number(n||0));
    const esc = (s)=>String(s??'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));

    async function _tryDownload(paths){
      for (const p of paths){
        const url = `${window.endpoint}${p}`;
        const head = await api(url, { method:"HEAD" }).catch(()=>null);
        if (head?.ok){ window.location.href = url; return; }
        const get = await api(url, { method:"GET" }).catch(()=>null);
        if (get?.ok){ window.location.href = url; return; }
      }
      toast("Download endpoint not found (404/405).");
    }

    // ----- BOLs pagination -----
    let aOffset=0, aLimit=100;
    const startDate=document.getElementById("startDate"), endDate=document.getElementById("endDate");
    const buyerFilter=document.getElementById("buyerFilter"), materialFilter=document.getElementById("materialFilter");
    const adminPrevBtn=document.getElementById("adminPrevBtn"), adminNextBtn=document.getElementById("adminNextBtn"), adminPageInfo=document.getElementById("adminPageInfo");

    function setBusy(sel, busy){
      const el = document.querySelector(sel);
      if (!el) return;
      if (busy) el.setAttribute('aria-busy','true'); else el.removeAttribute('aria-busy');
    }
    function showSkeleton(tableSel, cols){
      const tb = document.querySelector(`${tableSel} tbody`); if (!tb) return;
      setBusy(tableSel, true);
      tb.innerHTML='';
      for(let i=0;i<5;i++){
        const tr=document.createElement('tr'); tr.className='skeleton-row';
        for(let c=0;c<cols;c++){ const td=document.createElement('td'); td.innerHTML='<span class="skeleton"></span>'; tr.appendChild(td); }
        tb.appendChild(tr);
      }
    }
    function clearBusy(tableSel){ setBusy(tableSel, false); }

    function downloadCSV(){
      const paths = [ "/admin/exports/contracts.csv", "/contracts/export_csv" ];
      window.location.assign(`${window.endpoint}${paths[0]}`);
    }
    function downloadAll(){ _tryDownload([ "/admin/exports/all.zip", "/admin/export_all", "/admin/export_all.zip" ]); }
    function openOpenAPI(){ window.open(`${window.endpoint}/docs`, "_blank", "noopener,noreferrer"); }
    function openHealth(){ window.open(`${window.endpoint}/health`, "_blank", "noopener,noreferrer"); }
    function downloadPDF(bolId){ window.open(`${window.endpoint}/bol/${bolId}/pdf`, "_blank", "noopener,noreferrer"); }

    async function loadBOLsAdmin(){
      const qs = new URLSearchParams({ limit:aLimit, offset:aOffset });
      const buyer = buyerFilter.value.trim(), material = materialFilter.value.trim();
      const start = startDate.value, end = endDate.value;
      if (buyer) qs.set("buyer", buyer);
      if (material) qs.set("material", material);
      if (start){ const d=new Date(start); d.setHours(0,0,0,0); qs.set("start", d.toISOString()); }
      if (end){ const d=new Date(end); d.setHours(23,59,59,999); qs.set("end", d.toISOString()); }

      showSkeleton('#bol-table', 11);
      const ctl = new AbortController();
      const _timer = setTimeout(() => ctl.abort(), 15000); // 15s hard timeout so UI never hangs
      try {
        const res = await api(`/bols?${qs.toString()}`, { headers:{ "Accept":"application/json" }, signal: ctl.signal });
        const total = +(res.headers.get('X-Total-Count') || 0);
        const rows = await res.json();

        renderBOLTable(rows);
        adminPrevBtn.disabled = aOffset===0;
        adminNextBtn.disabled = rows.length < aLimit;
        adminPageInfo.textContent = total
          ? `Page ${Math.floor(aOffset/aLimit)+1} ‚Ä¢ ${rows.length} rows ‚Ä¢ ${aOffset+1}‚Äì${aOffset+rows.length} of ${total}`
          : `Page ${Math.floor(aOffset/aLimit)+1} ‚Ä¢ ${rows.length} rows`;

      } catch(e){
        toast(e.message||'Load failed');
      } finally {
        clearTimeout(_timer);
        clearBusy('#bol-table');
        try { window.hideLoading(); } catch {}
      }
    }

    function renderBOLTable(rows){
      const tbody = document.querySelector("#bol-table tbody");
      if (!rows.length){
        tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-3">No BOLs match your filters.</td></tr>`;
        return;
      }
      const html = rows.map(bol => {
        const hashHtml = bol.pdf_sha256
          ? `<div class="small text-muted">SHA-256: <code class="small">${esc(String(bol.pdf_sha256).slice(0,12))}‚Ä¶</code></div>`
          : '';
        return `
        <tr>
          <td>${esc(bol.bol_id)}</td>
          <td>${esc(bol.contract_id)}</td>
          <td>${esc(bol.buyer)}</td>
          <td>${esc(bol.material)}</td>
          <td>${safeVal(bol.weight_tons)}</td>
          <td><span class="badge bg-${statusColor(bol.status)}">${esc(bol.status)}</span></td>
          <td>${formatTime(bol.pickup_time)}</td>
          <td>${formatTime(bol.delivery_time)}</td>
          <td>${money(bol.total_value)}</td>
          <td>
            <button class="btn btn-sm btn-dark" data-call="downloadPDF" data-bol-id="${esc(bol.bol_id)}">üìÑ PDF</button>
            ${hashHtml}
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-secondary" data-call="showDeliveryLog" data-bol-id="${esc(bol.bol_id)}">üöö Log</button>
            </div>
          </td>
        </tr>`;
      }).join('');
      tbody.innerHTML = html;
    }

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }
    adminPrevBtn?.addEventListener("click", ()=>{ aOffset=Math.max(0,aOffset-aLimit); loadBOLsAdmin(); });
    adminNextBtn?.addEventListener("click", ()=>{ aOffset=aOffset+aLimit; loadBOLsAdmin(); });
    startDate.addEventListener("change", ()=>{ aOffset=0; loadBOLsAdmin(); });
    endDate.addEventListener("change", ()=>{ aOffset=0; loadBOLsAdmin(); });
    buyerFilter.addEventListener("input", debounce(()=>{ aOffset=0; loadBOLsAdmin(); }));
    materialFilter.addEventListener("input", debounce(()=>{ aOffset=0; loadBOLsAdmin(); }));

    // Top pager (global) ‚Üí reuse BOLs pagination
    const topPrevBtn = document.getElementById("prevBtn");
    const topNextBtn = document.getElementById("nextBtn");
    topPrevBtn?.addEventListener("click", ()=>{ aOffset = Math.max(0, aOffset - aLimit); loadBOLsAdmin(); });
    topNextBtn?.addEventListener("click", ()=>{ aOffset = aOffset + aLimit; loadBOLsAdmin(); });

    // Delivery log modal
    async function showDeliveryLog(bolId){
      document.getElementById("logBolId").textContent = bolId;
      const modal = new bootstrap.Modal(document.getElementById('deliveryLogModal'));
      try{
        const log = await fetchJSON(`/admin/ice/logs?bol_id=${encodeURIComponent(bolId)}`);
        const tb = document.getElementById("logTbody"); tb.innerHTML='';
        (log.entries||[]).forEach((e,i)=>{
          const tr=document.createElement('tr');
          tr.innerHTML = `<td>${i+1}</td><td>${e.when_utc||"‚Äî"}</td><td>${e.http_status||"‚Äî"}</td><td>${e.ms||"‚Äî"}</td><td><code class="small">${(e.response||"").slice(0,160)}</code></td>`;
          tb.appendChild(tr);
        });
        document.getElementById("logStats").textContent = `Delivered: ${log.delivered_count||0} ‚Ä¢ Pending: ${log.pending_count||0} ‚Ä¢ Failed: ${log.failed_count||0}`;
        document.getElementById("hashRow").innerHTML = log.pdf_sha256 ? `PDF SHA-256: <code class="small">${String(log.pdf_sha256)}</code>` : "";

        document.getElementById("btnResend").onclick = ()=> fetchJSON(`/admin/ice/resend`, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ bol_id: bolId })
        }).then(()=>showDeliveryLog(bolId)).catch(e=>toast(e.message));

        document.getElementById("btnTest").onclick = ()=> fetchJSON(`/admin/ice/test_ping`, {
          method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ bol_id: bolId })
        }).then(()=>showDeliveryLog(bolId)).catch(e=>toast(e.message));

        document.getElementById("btnRotate").onclick = ()=> fetchJSON(`/admin/ice/rotate_secret`, { method:"POST" })
          .then(()=>toast("Secret rotated.")).catch(e=>toast(e.message));

        modal.show();
      }catch(e){ toast("Failed to load log: " + e.message); }
    }

    // ----- FUTURES -----
    const apiBase = `${window.endpoint}/admin/futures`;
    let products = []; const productById = {}, productBySymbol = {};
    const pricingSymbolSel = document.getElementById("pricingSymbol");
    const seriesProductSel = document.getElementById("seriesProduct");
    const filterSeriesProdSel = document.getElementById("filterSeriesProduct");
    const filterSeriesStatus = document.getElementById("filterSeriesStatus");
    const markDateInput = document.getElementById("markDate");

    async function refreshProducts(){
      try { products = await fetchJSON(`${apiBase}/products`); }
      catch(e){ toast(e.message||'Products load failed'); return; }

      Object.keys(productById).forEach(k=>delete productById[k]);
      Object.keys(productBySymbol).forEach(k=>delete productBySymbol[k]);
      pricingSymbolSel.innerHTML=''; seriesProductSel.innerHTML=''; filterSeriesProdSel.innerHTML=`<option value="">(all products)</option>`;

      products.forEach(p=>{
        productById[p.id]=p; productBySymbol[p.symbol_root]=p;
        const opt1=document.createElement('option'); opt1.value=p.symbol_root; opt1.textContent = `${p.symbol_root} ‚Äî ${p.material}`;
        const opt2=document.createElement('option'); opt2.value=p.id;          opt2.textContent = `${p.symbol_root} ‚Äî ${p.material}`;
        const opt3=document.createElement('option'); opt3.value=p.id;          opt3.textContent = `${p.symbol_root} ‚Äî ${p.material}`;
        pricingSymbolSel.appendChild(opt1); seriesProductSel.appendChild(opt2); filterSeriesProdSel.appendChild(opt3);
      });
    }

    async function refreshSeries(){
      const q = new URLSearchParams();
      const pid = filterSeriesProdSel.value, st = filterSeriesStatus.value;
      if (pid) q.set("product_id", pid);
      if (st)  q.set("status", st);
      showSkeleton('#series-table', 7);
      let rows=[]; try{ rows = await fetchJSON(`${apiBase}/series?${q.toString()}`);}catch(e){ toast(e.message||'Series load failed'); }
      renderSeriesTable(rows);
      clearBusy('#series-table');
    }

    async function refreshMarks(){
      showSkeleton('#marks-table', 5);
      let rows=[]; try{ rows = await fetchJSON(`${apiBase}/marks`);}catch(e){ toast(e.message||'Marks load failed'); }
      renderMarksTable(rows);
      clearBusy('#marks-table');
    }

    async function createProduct(form){
      const body = Object.fromEntries(new FormData(form));
      body.contract_size_tons = parseFloat(body.contract_size_tons);
      body.tick_size = parseFloat(body.tick_size);
      try{
        await fetchJSON(`${apiBase}/products`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        form.reset(); await refreshProducts(); await refreshSeries(); toast('Product saved.');
      }catch(e){ toast('Create product failed: ' + e.message); }
    }

    async function submitPricing(){
      const symbol_root = pricingSymbolSel.value;
      const body = {
        lookback_days: parseInt(document.getElementById('pricingLookback').value||'14',10),
        basis_adjustment: parseFloat(document.getElementById('pricingBasis').value||'0'),
        carry_per_month: parseFloat(document.getElementById('pricingCarry').value||'0'),
        manual_mark: document.getElementById('pricingManual').value ? parseFloat(document.getElementById('pricingManual').value) : null
      };

      try{
        await fetchJSON(`${apiBase}/products/${encodeURIComponent(symbol_root)}/pricing`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        toast('Pricing saved.');
      }catch(e){ toast('Save pricing failed: ' + e.message); }
    }

    async function submitGenerateSeries(){
      const product_id = seriesProductSel.value;
      try{
        await fetchJSON(`${apiBase}/series/generate`, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ product_id, months_ahead:12, day_of_month: parseInt(document.getElementById('seriesDay').value||'15',10) })
        });
        await refreshSeries(); toast('Series generated.');
      }catch(e){ toast('Generate series failed: ' + e.message); }
    }

    async function listSeries(listing_id){
      try{ await fetchJSON(`${apiBase}/series/${listing_id}/list`, { method:'POST' }); await refreshSeries(); }
      catch(e){ toast('List failed: ' + e.message); }
    }

    async function publishMark(listing_id){
      const mark_date = markDateInput.value ? new Date(markDateInput.value + "T00:00:00Z").toISOString().substring(0,10) : null;
      const body = { listing_id }; if (mark_date) body.mark_date = mark_date;
      try{
        await fetchJSON(`${apiBase}/marks/publish`, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
        await refreshSeries(); await refreshMarks();
      }catch(e){ toast('Publish mark failed: ' + e.message); }
    }

    function renderSeriesTable(rows){
      const tbody=document.querySelector("#series-table tbody"); tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">No listings yet. Create a product, set pricing, then Generate Series.</td></tr>`; return; }
      rows.forEach(r=>{
        const p = productById[r.product_id] || {};
        const sym = p.symbol_root || '‚Äî', mat = p.material || '‚Äî';
        const actions = [];
        if (r.status === "Draft") actions.push(`<button class="btn btn-sm btn-success me-2" data-call="listSeries" data-listing-id="${r.id}">List</button>`);
        actions.push(`<button class="btn btn-sm btn-primary" data-call="publishMark" data-listing-id="${r.id}">Publish Mark</button>`);
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${sym}</td><td>${mat}</td><td>${r.contract_month}</td><td>${r.contract_year}</td>
          <td>${r.expiry_date}</td>
          <td><span class="badge ${r.status==='Listed'?'bg-primary':'bg-secondary'}">${r.status}</span></td>
          <td class="text-center">${actions.join('')}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMarksTable(rows){
      const tbody=document.querySelector("#marks-table tbody"); tbody.innerHTML='';
      if (!rows.length){ tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">No marks yet.</td></tr>`; return; }
      rows.forEach(r=>{
        const contract = `${r.contract_month}${String(r.contract_year).slice(-2)}`;
        const tr=document.createElement('tr');
        const methodClass = r.method==='MANUAL' ? 'bg-warning text-dark' : (r.method==='EXTERNAL' ? 'bg-info' : 'bg-success');
        tr.innerHTML = `
          <td>${r.symbol_root}</td>
          <td>${contract}</td>
          <td>${r.mark_date}</td>
          <td>${money(r.mark_price)}</td>
          <td><span class="badge rounded-pill ${methodClass}">${r.method}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Init loads
    loadBOLsAdmin();
    setInterval(loadBOLsAdmin, 10000);

    (function ensureFuturesInit(){
      let futuresLoadedOnce = false;

      async function initFuturesOnce(){
        if (futuresLoadedOnce) return;
        futuresLoadedOnce = true;
        await refreshProducts();
        await refreshSeries();
        await refreshMarks();
      }

      const futTab  = document.getElementById('futures-tab');
      const futPane = document.getElementById('futures-pane');

      // Bootstrap tab event
      futTab?.addEventListener('shown.bs.tab', async ()=>{
        if (!futuresLoadedOnce) await initFuturesOnce();
        else { await refreshSeries(); await refreshMarks(); }
      });

      // Fallback: click (in case shown.bs.tab doesn‚Äôt fire)
      futTab?.addEventListener('click', initFuturesOnce);

      // If Futures is already active on load, run immediately
      if (futPane?.classList.contains('show') && futPane?.classList.contains('active')) {
        initFuturesOnce();
      }
    })();

  </script>
  <script nonce="{{NONCE}}">
  onReady(() => {
    document.getElementById('productForm')?.addEventListener('submit', (e)=>{ 
      e.preventDefault(); 
      createProduct(e.currentTarget); 
    });
    document.getElementById('pricingForm')?.addEventListener('submit', (e)=>{ 
      e.preventDefault(); 
      submitPricing(); 
    });
    document.getElementById('seriesForm')?.addEventListener('submit', (e)=>{ 
      e.preventDefault(); 
      submitGenerateSeries(); 
    });
  });
  </script>
  <script nonce="{{NONCE}}">
Object.assign(window, {
  downloadCSV, downloadAll, openOpenAPI, openHealth,
  downloadPDF, showDeliveryLog, listSeries, publishMark
});
</script>

<div id="tape"></div>

<script nonce="{{NONCE}}">
(function tapeWS(){
  const tape = document.getElementById('tape');
  let backoff = 1000;
  function connect(){
    const ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/md/ws');
    ws.onopen = ()=> backoff = 1000;
    ws.onmessage = (e)=>{
      const m = JSON.parse(e.data);
      if(m.type==='trade'){
        const span = document.createElement('span');
        span.textContent = ` ${m.symbol} ${m.price?.toFixed ? m.price.toFixed(4) : m.price} √ó ${m.qty_lots}  |`;
        tape.appendChild(span);
        while (tape.childNodes.length > 400) { tape.removeChild(tape.firstChild); }
        tape.scrollLeft = tape.scrollWidth;  
      }
    };
    ws.onclose = ()=> setTimeout(()=>{ backoff = Math.min(backoff*1.6, 15000); connect(); }, backoff);
    ws.onerror = ()=> ws.close();
  }
  connect();
})();
</script>

<!-- Admin: Quick Billing Tools -->
<div class="card p-3 mb-2">
  <div class="d-flex align-items-end gap-2">
    <div>
      <label class="form-label">Invoice ID</label>
      <input id="adm_invoice_id" class="form-control" placeholder="invoice UUID">
    </div>
    <div>
      <label class="form-label">Member</label>
      <input id="adm_member" class="form-control" placeholder="member key (Organization)">
    </div>
    <button class="btn btn-success btn-h38" id="adm_bill_now">Bill Now</button>
    <button class="btn btn-outline-primary btn-h38" id="adm_change_pm">Change Payment Method</button>
  </div>
  <div class="form-hint mt-2">Charges the stored default payment method off-session, or opens a Stripe setup session to update the PM.</div>
</div>

<script nonce="{{NONCE}}">
  document.getElementById('adm_bill_now').addEventListener('click', async ()=>{
    const invoice_id = document.getElementById('adm_invoice_id').value.trim();
    if(!invoice_id){ return toast('Enter an invoice id'); }
    try{
      const res = await api('/billing/pay/charge_now', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ invoice_id })
      });
      const j = await res.json();
      toast(j.ok ? '‚úì Charged and marked paid' : 'Charge attempt finished');
    }catch(e){ toast(e.message || 'Charge failed'); }
  });

  document.getElementById('adm_change_pm').addEventListener('click', async ()=>{
    const member = document.getElementById('adm_member').value.trim();
    if(!member){ return toast('Enter member'); }
    try{
      const res = await api('/billing/pm/change_session', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ member })
      });
      const j = await res.json();
      if(j.url){ location.href = j.url; } else { toast('Could not start PM change'); }
    }catch(e){ toast(e.message || 'Could not start PM change'); }
  });
</script>

  <!-- Policy Acceptance Modal -->
  <div class="modal fade" id="policyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Policy Update</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" disabled></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2" id="policySummary">You must accept the current Terms / Rulebook to create contracts and BOLs.</p>
          <p class="small">
            View full documents:
            <a href="/legal/terms" target="_blank" rel="noopener noreferrer">Terms</a> ¬∑
            <a href="/legal/eula" target="_blank" rel="noopener noreferrer">EULA</a> ¬∑
            <a href="/legal/fees" target="_blank" rel="noopener noreferrer">Fees</a> ¬∑
            <a href="/legal/rulebook" target="_blank" rel="noopener noreferrer">Rulebook</a>
          </p>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="policyAgreeChkSeller">
            <label class="form-check-label small" for="policyAgreeChkSeller">
              I have read and agree to the current Terms, Rulebook, Fee Schedule, and Policies.
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button id="policyAcceptBtnSeller" type="button" class="btn btn-primary" disabled>Accept & Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script nonce="{{NONCE}}">
  // Seller/Yard: policy gating
  (function(){
    async function checkPolicies(){
      try{
        const res = await api('/policies/status');
        const j = await res.json();
        if (j.accepted) return;

        let summary = 'You must accept the current Terms / Rulebook to create contracts and BOLs.';
        try{
          const r2 = await api('/policies/current');
          const p = await r2.json();
          if (p && p.version){
            summary = `You must accept ${p.key || 'the Rulebook'} v${p.version} to create contracts and BOLs.`;
          }
        }catch{}
        const sEl = document.getElementById('policySummary'); if (sEl) sEl.textContent = summary;

        const modalEl = document.getElementById('policyModal');
        if (!modalEl || !(window.bootstrap && bootstrap.Modal)) return;
        const modal = new bootstrap.Modal(modalEl, { backdrop:'static', keyboard:false });
        modal.show();

        const chk = document.getElementById('policyAgreeChkSeller');
        const btn = document.getElementById('policyAcceptBtnSeller');
        chk?.addEventListener('change', ()=>{ btn.disabled = !chk.checked; });
        btn?.addEventListener('click', async ()=>{
          btn.disabled = true;
          try{
            await api('/policies/accept', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ key:'rulebook', version: null })
            });
            modal.hide();
            toast('Policy accepted.');
          }catch(e){
            toast(e.message || 'Could not record acceptance');
            btn.disabled = false;
          }
        });
      }catch{}
    }
    onReady(checkPolicies);
  })();
  </script>

  <script nonce="{{NONCE}}">
  // Admin: tenant dropdown stub
  (function(){
    async function loadTenants(){
      const sel = document.getElementById('tenantSelect');
      if (!sel) return;
      try{
        const res = await api('/admin/tenants');
        const rows = await res.json();
        rows.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.id || t.slug || t.org || t.name;
          opt.textContent = t.display_name || t.name || t.slug || opt.value;
          sel.appendChild(opt);
        });
      }catch(e){
        console.warn('tenants load failed', e);
      }
    }
    onReady(loadTenants);
  })();
  </script>

  <footer class="legal-footer invisible">
    <hr class="mb-3">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms.html" class="link-secondary" rel="noopener noreferrer">Terms</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>¬∑</span>
      <a href="/legal/eula.html" class="link-secondary" rel="noopener noreferrer">EULA</a><span>¬∑</span>
      <a href="/legal/aup.html" class="link-secondary" rel="noopener noreferrer">AUP</a><span>¬∑</span>
      <a href="/legal/cookies.html" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>¬∑</span>
      <a href="/legal/subprocessors.html" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>¬∑</span>
      <a href="/legal/dpa.html" class="link-secondary" rel="noopener noreferrer">DPA</a><span>¬∑</span>
      <a href="/legal/sla.html" class="link-secondary" rel="noopener noreferrer">SLA</a><span>¬∑</span>
      <a href="/legal/security.html" class="link-secondary" rel="noopener noreferrer">Security</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy Appendix</a><span>¬∑</span>
      <a href="/legal/fees.html" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> ‚Äì Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
  <script nonce="{{NONCE}}">
  onReady(() => {
    document.body.addEventListener('click', (e) => {
      const el = e.target.closest('[data-call]');
      if (!el) return;
      const fnName = el.dataset.call;
      const fn = window[fnName];
      if (typeof fn !== 'function') return;
      e.preventDefault();
      fn(el.dataset.bolId || el.dataset.listingId || e);
    });
  });
  </script>

    <script nonce="{{NONCE}}">
  // ---- Admin Usage, Risk, Dossier Ingest ----
  (function(){
    const $ = (id)=>document.getElementById(id);

    async function loadUsage(){
      const tb = $('usageTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api('/analytics/usage_by_member_current_cycle');
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">No usage yet in this cycle.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.member || ''}</td>
            <td>${r.plan_code || ''}</td>
            <td>${r.bols_month ?? 0}</td>
            <td>${r.contracts_month ?? 0}</td>
            <td>${r.receipts_month ?? 0}</td>
            <td>${(r.overage_usd ?? 0).toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:2})}</td>
          </tr>
        `).join('');
      }catch(e){
        tb.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    async function loadAnomalies(){
      const tb = $('anomalyTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-1">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api('/analytics/anomalies_recent?limit=25');
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-1">No recent anomalies.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.member || ''}</td>
            <td>${r.symbol || ''}</td>
            <td>${r.score ?? ''}</td>
            <td>${r.as_of || ''}</td>
          </tr>
        `).join('');
      }catch(e){
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-1">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    async function loadSurveil(){
      const tb = $('surveilTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-1">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api('/analytics/surveil_recent?limit=25');
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-1">No recent alerts.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.rule || ''}</td>
            <td>${r.subject || ''}</td>
            <td>${r.severity || 'info'}</td>
            <td>${r.opened_at || r.created_at || ''}</td>
          </tr>
        `).join('');
      }catch(e){
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-1">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    async function loadDossier(){
      const tb = $('dossierTbl')?.querySelector('tbody');
      const msg = $('dossierMsg');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="7" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api('/admin/dossier/queue?limit=40');
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="7" class="text-muted text-center py-2">Ingest queue is empty.</td></tr>`;
          if (msg) msg.textContent = '';
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.source_system || 'bridge'}</td>
            <td>${r.source_table || ''}</td>
            <td>${r.event_type || ''}</td>
            <td>${r.status || ''}</td>
            <td>${r.attempts ?? 0}</td>
            <td class="small">${(r.last_error || '').slice(0,80)}</td>
            <td>${r.created_at || ''}</td>
          </tr>
        `).join('');
        if (msg) {
          const pending = rows.filter(x => x.status === 'pending').length || 0;
          const failed  = rows.filter(x => x.status === 'failed').length  || 0;
          msg.textContent = `Pending: ${pending} ¬∑ Failed: ${failed}`;
        }
      }catch(e){
        tb.innerHTML = `<tr><td colspan="7" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
        if (msg) msg.textContent = '';
      }
    }

    async function retryDossierFailed(){
      try{
        const res = await api('/admin/dossier/retry_failed', { method:'POST' });
        const j = await res.json().catch(()=>({}));
        toast(j.message || 'Retry triggered.');
        await loadDossier();
      }catch(e){
        toast(e.message || 'Retry failed');
      }
    }

    onReady(() => {
      loadUsage().catch(()=>{});
      loadAnomalies().catch(()=>{});
      loadSurveil().catch(()=>{});
      loadDossier().catch(()=>{});
      $('dossierRetry')?.addEventListener('click', retryDossierFailed);
    });
  })();
  </script>

<script nonce="{{NONCE}}">
onReady(() => {
  const tabButtons = document.querySelectorAll('#adminTabs button[data-bs-toggle="tab"]');
  const tabPanes   = document.querySelectorAll('#adminTabsContent .tab-pane');

  if (!tabButtons.length || !tabPanes.length) return;

  function activateTab(btn) {
    const targetSelector = btn.getAttribute('data-bs-target');
    if (!targetSelector) return;
    const pane = document.querySelector(targetSelector);
    if (!pane) return;

    // Deactivate all
    tabButtons.forEach(b => b.classList.remove('active'));
    tabPanes.forEach(p => p.classList.remove('show', 'active'));

    // Activate selected
    btn.classList.add('active');
    pane.classList.add('show', 'active');
  }

  tabButtons.forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.preventDefault();      // don‚Äôt let Bootstrap be the only one in charge
      activateTab(btn);
    });
  });
});
</script>

</body>
</html>