<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRidge Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f4f6f8;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
    }
    .table-container {
      background: white;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      padding: 20px;
    }
    .table th, .table td { vertical-align: middle; }
    .filters { margin-bottom: 20px; }
    .signature-pad {
      border: 1px solid #ccc; border-radius: 6px;
      width: 100%; height: 150px; background-color: #fff; margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="mb-4">ðŸ“Š BRidge Admin Dashboard</h2>

    <div class="filters row g-3">
      <div class="col-md-3">
        <input type="date" class="form-control" id="startDate" />
      </div>
      <div class="col-md-3">
        <input type="date" class="form-control" id="endDate" />
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" id="buyerFilter" placeholder="Filter by Buyer" />
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" id="materialFilter" placeholder="Filter by Material/SKU (e.g., SHRED)" />
      </div>
      <div class="col-md-3">
        <button class="btn btn-outline-primary w-100" onclick="downloadCSV()">ðŸ“¤ Export CSV</button>
      </div>
    </div>

    <div class="d-flex gap-2 mb-2">
      <button id="prevBtn" class="btn btn-outline-secondary btn-sm">â—€ Prev</button>
      <button id="nextBtn" class="btn btn-outline-secondary btn-sm">Next â–¶</button>
      <span id="pageInfo" class="ms-2 small text-muted"></span>
    </div>

    <div class="table-container">
      <table class="table table-bordered table-striped" id="bol-table">
        <thead class="table-dark">
          <tr>
            <th>BOL ID</th>
            <th>Contract ID</th>
            <th>Buyer</th>
            <th>Material</th>
            <th>Weight (Tons)</th>
            <th>Status</th>
            <th>Pickup Time</th>
            <th>Delivery Time</th>
            <th>Total Value</th>
            <th>Download</th>
            <th>View</th> <!-- âœ… View BOLs column -->
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const endpoint = "https://bridge-buyer.onrender.com";
    let offset = 0, limit = 100;

    async function fetchBOLs() {
      const start    = document.getElementById("startDate").value;
      const end      = document.getElementById("endDate").value;
      const buyer    = document.getElementById("buyerFilter").value;
      const material = document.getElementById("materialFilter").value;

      const qs = new URLSearchParams();
      if (buyer)    qs.set("buyer", buyer);
      if (material) qs.set("material", material);
      if (start)    qs.set("start", new Date(start).toISOString());
      if (end)      qs.set("end",   new Date(end).toISOString());
      qs.set("limit", String(limit));
      qs.set("offset", String(offset));

      const res  = await fetch(`${endpoint}/bols?${qs.toString()}`);
      if (!res.ok) {
        const t = await res.text();
        console.error("BOLs fetch failed:", t);
        return;
      }
      const data = await res.json();

      const tbody = document.querySelector("#bol-table tbody");
      tbody.innerHTML = "";

      if (data.length === 0) {
        const row = document.createElement("tr");
        row.innerHTML = `<td colspan="11" class="text-center text-muted py-3">No BOLs match your filters.</td>`;
        tbody.appendChild(row);
        document.getElementById("nextBtn").disabled = true;
        document.getElementById("pageInfo").textContent = `Showing 0 â€¢ offset ${offset}`;
        return;
      }

      data.forEach(bol => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${bol.bol_id}</td>
          <td>${bol.contract_id}</td>
          <td>${bol.buyer}</td>
          <td>${bol.material}</td>
          <td>${bol.weight_tons}</td>
          <td><span class="badge bg-${statusColor(bol.status)}">${bol.status}</span></td>
          <td>${formatTime(bol.pickup_time)}</td>
          <td>${bol.delivery_time ? formatTime(bol.delivery_time) : "â€”"}</td>
          <td>$${Number(bol.total_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
          <td><button class="btn btn-sm btn-outline-dark" onclick="downloadPDF('${bol.bol_id}')">ðŸ“„ PDF</button></td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="viewBOLsFor('${bol.contract_id}')">View BOLs</button></td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById("pageInfo").textContent = `Showing ${data.length} â€¢ offset ${offset}`;
      document.getElementById("prevBtn").disabled = offset === 0;
      document.getElementById("nextBtn").disabled = data.length < limit;
    }

    function viewBOLsFor(contractId) {
      const qs = new URLSearchParams();
      qs.set("contract_id", contractId);
      qs.set("limit", "100");
      qs.set("offset", "0");
      window.location.href = `${endpoint}/bols?${qs.toString()}`;
    }

    function formatTime(isoString) {
      try { return new Date(isoString).toLocaleString(); } catch { return "â€”"; }
    }

    function statusColor(status) {
      switch(status) {
        case 'Open': return 'secondary';
        case 'Matched': return 'info';
        case 'BOL Issued': return 'primary';
        case 'In Transit': return 'warning';
        case 'Delivered': return 'success';
        case 'Closed': return 'dark';
        default: return 'light';
      }
    }

    function downloadCSV() {
      window.open(`${endpoint}/contracts/export_csv`, "_blank");
    }

    function downloadPDF(bolId) {
      window.open(`${endpoint}/bol/${bolId}/pdf`, "_blank");
    }

    // Reset to first page when filters change
    document.getElementById("startDate").addEventListener("change", () => { offset = 0; fetchBOLs(); });
    document.getElementById("endDate").addEventListener("change",   () => { offset = 0; fetchBOLs(); });
    document.getElementById("buyerFilter").addEventListener("input", () => { offset = 0; fetchBOLs(); });
    document.getElementById("materialFilter").addEventListener("input", () => { offset = 0; fetchBOLs(); });

    // Prev/Next buttons
    document.getElementById("prevBtn").addEventListener("click", () => { offset = Math.max(0, offset - limit); fetchBOLs(); });
    document.getElementById("nextBtn").addEventListener("click", () => { offset = offset + limit; fetchBOLs(); });

    // Initial load + periodic refresh
    fetchBOLs();
    setInterval(fetchBOLs, 10000);
  </script>

  <footer style="margin-top: 40px; text-align: center; font-size: 0.9em;">
    <a href="/terms" target="_blank">Terms of Use</a> |
    <a href="/eula" target="_blank">EULA</a> |
    <a href="/privacy" target="_blank">Privacy Policy</a>
  </footer>
</body>
</html>
