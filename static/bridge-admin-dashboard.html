<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRidge Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
    .table-container { background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; }
    .table th, .table td { vertical-align: middle; }
    .filters { margin-bottom: 20px; }
    .signature-pad { border: 1px solid #ccc; border-radius: 6px; width: 100%; height: 150px; background-color: #fff; margin-top: 10px; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="mb-4">ðŸ“Š BRidge Admin Dashboard</h2>

    <div class="filters row g-3">
      <div class="col-md-3">
        <input type="date" class="form-control" id="startDate" />
      </div>
      <div class="col-md-3">
        <input type="date" class="form-control" id="endDate" />
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" id="buyerFilter" placeholder="Filter by Buyer" />
      </div>
      <div class="col-md-3">
        <input type="text" class="form-control" id="materialFilter" placeholder="Filter by Material/SKU (e.g., SHRED)" />
      </div>
      <div class="col-md-3">
        <button class="btn btn-outline-primary w-100" onclick="downloadCSV()">ðŸ“¤ Export CSV</button>
      </div>
    </div>

    <!-- NEW: Admin pagination controls -->
    <div class="d-flex gap-2 mb-2">
      <button id="adminPrevBtn" class="btn btn-outline-secondary btn-sm">â—€ Prev</button>
      <button id="adminNextBtn" class="btn btn-outline-secondary btn-sm">Next â–¶</button>
      <span id="adminPageInfo" class="small text-muted"></span>
    </div>

    <div class="table-container">
      <table class="table table-bordered table-striped" id="bol-table">
        <thead class="table-dark">
          <tr>
            <th>BOL ID</th>
            <th>Contract ID</th>
            <th>Buyer</th>
            <th>Material</th>
            <th>Weight (Tons)</th>
            <th>Status</th>
            <th>Pickup Time</th>
            <th>Delivery Time</th>
            <th>Total Value</th>
            <th>Download</th>
            <th>View</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script>
    const endpoint = "https://bridge-buyer.onrender.com";

    // === NEW admin pagination state + elements ===
    let aOffset = 0, aLimit = 100;

    const startDate      = document.getElementById("startDate");
    const endDate        = document.getElementById("endDate");
    const buyerFilter    = document.getElementById("buyerFilter");
    const materialFilter = document.getElementById("materialFilter");

    const adminPrevBtn   = document.getElementById("adminPrevBtn");
    const adminNextBtn   = document.getElementById("adminNextBtn");
    const adminPageInfo  = document.getElementById("adminPageInfo");

    function statusColor(status) {
      switch(status) {
        case 'Open':         return 'secondary';
        case 'Matched':      return 'info';
        case 'BOL Issued':   return 'primary';
        case 'In Transit':   return 'warning';
        case 'Delivered':    return 'success';
        case 'Closed':       return 'dark';
        default:             return 'light';
      }
    }
    function formatTime(isoString) {
      try { return isoString ? new Date(isoString).toLocaleString() : "â€”"; } catch { return "â€”"; }
    }

    function downloadCSV() {
      window.open(`${endpoint}/contracts/export_csv`, "_blank");
    }
    function downloadPDF(bolId) {
      window.open(`${endpoint}/bol/${bolId}/pdf`, "_blank");
    }
    function viewBOLsFor(contractId) {
      const qs = new URLSearchParams();
      qs.set("contract_id", contractId);
      qs.set("limit", "100");
      qs.set("offset", "0");
      window.location.href = `${endpoint}/bols?${qs.toString()}`;
    }

    // === NEW loader that honors admin pagination + filters ===
    async function loadBOLsAdmin() {
      const qs = new URLSearchParams({ limit: aLimit, offset: aOffset });

      const buyer    = buyerFilter.value.trim();
      const material = materialFilter.value.trim();
      const start    = startDate.value;
      const end      = endDate.value;

      if (buyer)    qs.set("buyer", buyer);
      if (material) qs.set("material", material);
      if (start)    qs.set("start", new Date(start).toISOString());
      if (end)      qs.set("end",   new Date(end).toISOString());

      const res = await fetch(`${endpoint}/bols?${qs.toString()}`, {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) { console.error("BOLs fetch failed:", await res.text()); return; }
      const rows = await res.json();

      renderBOLTable(rows);

      // Paging guards
      adminPrevBtn.disabled = aOffset === 0;
      adminNextBtn.disabled = rows.length < aLimit;
      adminPageInfo.textContent = `Showing ${rows.length} â€¢ offset ${aOffset}`;
    }

    function renderBOLTable(rows) {
      const tbody = document.querySelector("#bol-table tbody");
      tbody.innerHTML = "";

      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-3">No BOLs match your filters.</td></tr>`;
        return;
      }

      rows.forEach(bol => {
        const pdfUrl = `${endpoint}/bol/${bol.bol_id}/pdf`;
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${bol.bol_id}</td>
          <td>${bol.contract_id}</td>
          <td>${bol.buyer}</td>
          <td>${bol.material}</td>
          <td>${bol.weight_tons}</td>
          <td><span class="badge bg-${statusColor(bol.status)}">${bol.status}</span></td>
          <td>${formatTime(bol.pickup_time)}</td>
          <td>${formatTime(bol.delivery_time)}</td>
          <td>$${Number(bol.total_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
          <td><button class="btn btn-sm btn-outline-dark" onclick="downloadPDF('${bol.bol_id}')">ðŸ“„ PDF</button></td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="viewBOLsFor('${bol.contract_id}')">View BOLs</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Hook buttons (NEW)
    adminPrevBtn?.addEventListener("click", () => { aOffset = Math.max(0, aOffset - aLimit); loadBOLsAdmin(); });
    adminNextBtn?.addEventListener("click", () => { aOffset = aOffset + aLimit; loadBOLsAdmin(); });

    // Debounce helper for inputs
    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    // Filters trigger reload, reset to first page
    startDate.addEventListener("change",   () => { aOffset = 0; loadBOLsAdmin(); });
    endDate.addEventListener("change",     () => { aOffset = 0; loadBOLsAdmin(); });
    buyerFilter.addEventListener("input",  debounce(() => { aOffset = 0; loadBOLsAdmin(); }));
    materialFilter.addEventListener("input", debounce(() => { aOffset = 0; loadBOLsAdmin(); }));

    // Initial load + periodic refresh
    loadBOLsAdmin();
    setInterval(loadBOLsAdmin, 10000);
  </script>

  <footer style="margin-top: 40px; text-align: center; font-size: 0.9em;">
    <a href="/terms" target="_blank">Terms of Use</a> |
    <a href="/eula" target="_blank">EULA</a> |
    <a href="/privacy" target="_blank">Privacy Policy</a>
  </footer>
</body>
</html>
