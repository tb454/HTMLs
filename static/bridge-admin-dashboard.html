<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>BRidge Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background-color: #f4f6f8; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; }
    .table-container { background: white; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); padding: 20px; }
    .table th, .table td { vertical-align: middle; }
    .filters { margin-bottom: 20px; }
    .signature-pad { border: 1px solid #ccc; border-radius: 6px; width: 100%; height: 150px; background-color: #fff; margin-top: 10px; }
    .form-hint { font-size: 0.85rem; color: #6c757d; }
    .badge-pill { border-radius: 50rem; padding: 0.35em 0.6em; }
    .muted { color: #6c757d; }
    code.small { font-size: .8rem; }
  </style>
</head>
<body>
  <div class="container-fluid">
    <h2 class="mb-4">ðŸ“Š BRidge Admin Dashboard</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3" id="adminTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="bols-tab" data-bs-toggle="tab" data-bs-target="#bols-pane" type="button" role="tab" aria-controls="bols-pane" aria-selected="true">BOLs</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="futures-tab" data-bs-toggle="tab" data-bs-target="#futures-pane" type="button" role="tab" aria-controls="futures-pane" aria-selected="false">Futures</button>
      </li>
    </ul>

    <div class="tab-content" id="adminTabsContent">
      <!-- ====================== BOLs TAB ====================== -->
      <div class="tab-pane fade show active" id="bols-pane" role="tabpanel" aria-labelledby="bols-tab">
        <div class="filters row g-3">
          <div class="col-md-3">
            <input type="date" class="form-control" id="startDate" />
          </div>
          <div class="col-md-3">
            <input type="date" class="form-control" id="endDate" />
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="buyerFilter" placeholder="Filter by Buyer" />
          </div>
          <div class="col-md-3">
            <input type="text" class="form-control" id="materialFilter" placeholder="Filter by Material/SKU (e.g., SHRED)" />
          </div>

          <div class="col-md-3">
            <button class="btn btn-outline-primary w-100" onclick="downloadCSV()">ðŸ“¤ Export CSV</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-dark w-100" onclick="downloadAll()">ðŸ“¦ Download All (ZIP)</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-secondary w-100" onclick="openOpenAPI()">ðŸ“œ OpenAPI</button>
          </div>
          <div class="col-md-3">
            <button class="btn btn-outline-success w-100" onclick="openHealth()">ðŸŸ¢ Health</button>
          </div>
        </div>

        <!-- Admin pagination controls -->
        <div class="d-flex gap-2 mb-2">
          <button id="adminPrevBtn" class="btn btn-outline-secondary btn-sm">â—€ Prev</button>
          <button id="adminNextBtn" class="btn btn-outline-secondary btn-sm">Next â–¶</button>
          <span id="adminPageInfo" class="small text-muted"></span>
        </div>

        <div class="table-container">
          <table class="table table-bordered table-striped" id="bol-table">
            <thead class="table-dark">
              <tr>
                <th>BOL ID</th>
                <th>Contract ID</th>
                <th>Buyer</th>
                <th>Material</th>
                <th>Weight (Tons)</th>
                <th>Status</th>
                <th>Pickup Time</th>
                <th>Delivery Time</th>
                <th>Total Value</th>
                <th>PDF</th>
                <th>ICE</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- ====================== FUTURES TAB ====================== -->
      <div class="tab-pane fade" id="futures-pane" role="tabpanel" aria-labelledby="futures-tab">
        <div class="row g-4">
          <!-- Create Product -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Create Product</h5>
              <form id="productForm" onsubmit="event.preventDefault(); createProduct(this);">
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label">Symbol Root</label>
                    <input name="symbol_root" class="form-control" placeholder="HMS" required />
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Material</label>
                    <input name="material" class="form-control" placeholder="Shred Steel" required />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Delivery Location</label>
                    <input name="delivery_location" class="form-control" placeholder="IN-Midwest" required />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Contract Size (tons)</label>
                    <input name="contract_size_tons" type="number" step="0.01" class="form-control" value="20" required />
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Tick Size</label>
                    <input name="tick_size" type="number" step="0.01" class="form-control" value="0.5" required />
                  </div>
                  <div class="col-md-4">
                    <label class="form-label">Currency</label>
                    <select name="currency" class="form-select">
                      <option>USD</option>
                      <option>EUR</option>
                    </select>
                  </div>
                  <div class="col-md-8">
                    <label class="form-label">Price Method</label>
                    <select name="price_method" class="form-select">
                      <option value="VWAP_BASIS">VWAP_BASIS</option>
                      <option value="MANUAL">MANUAL</option>
                      <option value="EXTERNAL">EXTERNAL</option>
                    </select>
                    <div class="form-hint">VWAP_BASIS = VWAP + basis + carryÃ—months</div>
                  </div>
                  <div class="col-12">
                    <button class="btn btn-primary">Create / Upsert</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Pricing Params -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Pricing Params</h5>
              <form id="pricingForm" onsubmit="event.preventDefault(); submitPricing();">
                <div class="row g-3">
                  <div class="col-md-5">
                    <label class="form-label">Product (Symbol Root)</label>
                    <select id="pricingSymbol" class="form-select" required></select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Lookback (days)</label>
                    <input id="pricingLookback" type="number" class="form-control" value="14" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Basis ($/t)</label>
                    <input id="pricingBasis" type="number" step="0.01" class="form-control" value="0" />
                  </div>
                  <div class="col-md-2">
                    <label class="form-label">Carry ($/t/mo)</label>
                    <input id="pricingCarry" type="number" step="0.01" class="form-control" value="0" />
                  </div>
                  <div class="col-md-6">
                    <label class="form-label">Manual Mark (if MANUAL)</label>
                    <input id="pricingManual" type="number" step="0.01" class="form-control" />
                  </div>
                  <div class="col-12">
                    <button class="btn btn-primary">Save Pricing</button>
                  </div>
                </div>
              </form>
            </div>
          </div>

          <!-- Generate Series -->
          <div class="col-lg-6">
            <div class="table-container">
              <h5 class="mb-3">Generate Series (12 months)</h5>
              <form id="seriesForm" onsubmit="event.preventDefault(); submitGenerateSeries();">
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label">Product</label>
                    <select id="seriesProduct" class="form-select" required></select>
                  </div>
                  <div class="col-md-3">
                    <label class="form-label">Expiry Day</label>
                    <input id="seriesDay" type="number" min="1" max="28" class="form-control" value="15" />
                  </div>
                  <div class="col-md-3 d-flex align-items-end">
                    <button class="btn btn-primary w-100">Generate</button>
                  </div>
                </div>
              </form>
              <div class="form-hint mt-2">Generates monthly <b>Draft</b> listings. Then click <b>List</b> to publish and <b>Publish Mark</b> for settlement.</div>
            </div>
          </div>

          <!-- Listings + backfill mark date -->
          <div class="col-12">
            <div class="table-container">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-3">Listings</h5>
                <div class="d-flex gap-2 align-items-center">
                  <input type="date" id="markDate" class="form-control form-control-sm" style="width: 170px;" />
                  <span class="muted small">Backfill Mark Date (optional)</span>
                  <select id="filterSeriesProduct" class="form-select form-select-sm" style="width: 220px;"></select>
                  <select id="filterSeriesStatus" class="form-select form-select-sm" style="width: 160px;">
                    <option value="">(all statuses)</option>
                    <option>Draft</option>
                    <option>Listed</option>
                    <option>Halted</option>
                    <option>Expired</option>
                  </select>
                  <button class="btn btn-outline-secondary btn-sm" onclick="refreshSeries()">Refresh</button>
                </div>
              </div>
              <table class="table table-bordered table-striped" id="series-table">
                <thead class="table-dark">
                  <tr>
                    <th>Symbol</th>
                    <th>Material</th>
                    <th>Month</th>
                    <th>Year</th>
                    <th>Expiry</th>
                    <th>Status</th>
                    <th class="text-center">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

          <!-- Recent Marks -->
          <div class="col-12">
            <div class="table-container">
              <div class="d-flex align-items-center justify-content-between">
                <h5 class="mb-3">Recent Marks</h5>
                <div class="d-flex gap-2">
                  <button class="btn btn-outline-secondary btn-sm" onclick="refreshMarks()">Refresh</button>
                </div>
              </div>
              <table class="table table-bordered table-striped" id="marks-table">
                <thead class="table-dark">
                  <tr>
                    <th>Symbol</th>
                    <th>Contract</th>
                    <th>Mark Date</th>
                    <th>Mark Price</th>
                    <th>Method</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </div>

        </div>
      </div>
      <!-- =============== /FUTURES TAB ================= -->
    </div>
  </div>

  <!-- Delivery Log Modal -->
  <div class="modal fade" id="deliveryLogModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Delivery Log â€” <span id="logBolId"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="logStats" class="small text-muted mb-2"></div>
        <table class="table table-sm table-striped">
          <thead><tr>
            <th>Attempt</th><th>When (UTC)</th><th>Status</th><th>Latency (ms)</th><th>Response</th>
          </tr></thead>
          <tbody id="logTbody"></tbody>
        </table>
        <div id="hashRow" class="small text-muted"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-outline-primary" id="btnResend">â†» Re-send</button>
        <button class="btn btn-outline-secondary" id="btnTest">ðŸ§ª Test Ping</button>
        <button class="btn btn-outline-danger" id="btnRotate">ðŸ”‘ Rotate Secret</button>
      </div>
    </div></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const endpoint = window.location.origin;

    // ----------------- Utilities -----------------
    async function fetchJSON(url, opts) {
      const r = await fetch(url, opts || {});
      if (!r.ok) throw new Error(await r.text());
      return r.json();
    }
    function toast(msg) { console.log(msg); } // swap for nicer toast later

    // ----------------- BOLs JS -----------------
    let aOffset = 0, aLimit = 100;

    const startDate      = document.getElementById("startDate");
    const endDate        = document.getElementById("endDate");
    const buyerFilter    = document.getElementById("buyerFilter");
    const materialFilter = document.getElementById("materialFilter");

    const adminPrevBtn   = document.getElementById("adminPrevBtn");
    const adminNextBtn   = document.getElementById("adminNextBtn");
    const adminPageInfo  = document.getElementById("adminPageInfo");

    function statusColor(status) {
      switch(status) {
        case 'Open':         return 'secondary';
        case 'Matched':      return 'info';
        case 'BOL Issued':   return 'primary';
        case 'In Transit':   return 'warning';
        case 'Delivered':    return 'success';
        case 'Closed':       return 'dark';
        default:             return 'light';
      }
    }
    function formatTime(isoString) {
      try { return isoString ? new Date(isoString).toLocaleString() : "â€”"; } catch { return "â€”"; }
    }

    // Same-tab to ensure session cookies apply
    function downloadCSV()  { window.location.href = `${endpoint}/contracts/export_csv`; }
    function downloadAll()  { window.location.href = `${endpoint}/admin/export_all`; }
    function openOpenAPI()  { window.open(`${endpoint}/openapi.json`, "_blank"); }
    function openHealth()   { window.open(`${endpoint}/health`, "_blank"); }
    function downloadPDF(bolId) { window.open(`${endpoint}/bol/${bolId}/pdf`, "_blank"); }

    function viewBOLsFor(contractId) {
      const qs = new URLSearchParams();
      qs.set("contract_id", contractId);
      qs.set("limit", "100");
      qs.set("offset", "0");
      window.location.href = `${endpoint}/bols?${qs.toString()}`;
    }

    async function loadBOLsAdmin() {
      const qs = new URLSearchParams({ limit: aLimit, offset: aOffset });

      const buyer    = buyerFilter.value.trim();
      const material = materialFilter.value.trim();
      const start    = startDate.value;
      const end      = endDate.value;

      if (buyer)    qs.set("buyer", buyer);
      if (material) qs.set("material", material);
      if (start)    qs.set("start", new Date(start).toISOString());
      if (end)      qs.set("end",   new Date(end).toISOString());

      try {
        const rows = await fetchJSON(`${endpoint}/bols?${qs.toString()}`, { headers: { "Accept": "application/json" }});
        renderBOLTable(rows);
        adminPrevBtn.disabled = aOffset === 0;
        adminNextBtn.disabled = rows.length < aLimit;
        adminPageInfo.textContent = `Showing ${rows.length} â€¢ offset ${aOffset}`;
      } catch (e) {
        console.error("BOLs fetch failed:", e.message);
      }
    }

    function renderBOLTable(rows) {
      const tbody = document.querySelector("#bol-table tbody");
      tbody.innerHTML = "";

      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted py-3">No BOLs match your filters.</td></tr>`;
        return;
      }

      rows.forEach(bol => {
        const tr = document.createElement("tr");
        const hashHtml = bol.pdf_sha256 ? `<div class="small text-muted">SHA-256: <code class="small">${String(bol.pdf_sha256).slice(0,12)}â€¦</code></div>` : ``;
        tr.innerHTML = `
          <td>${bol.bol_id}</td>
          <td>${bol.contract_id}</td>
          <td>${bol.buyer}</td>
          <td>${bol.material}</td>
          <td>${bol.weight_tons}</td>
          <td><span class="badge bg-${statusColor(bol.status)}">${bol.status}</span></td>
          <td>${formatTime(bol.pickup_time)}</td>
          <td>${formatTime(bol.delivery_time)}</td>
          <td>$${Number(bol.total_value || 0).toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
          <td>
            <button class="btn btn-sm btn-outline-dark" onclick="downloadPDF('${bol.bol_id}')">ðŸ“„ PDF</button>
            ${hashHtml}
          </td>
          <td>
            <div class="btn-group btn-group-sm">
              <button class="btn btn-outline-secondary" onclick="showDeliveryLog('${bol.bol_id}')">ðŸšš Log</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    adminPrevBtn?.addEventListener("click", () => { aOffset = Math.max(0, aOffset - aLimit); loadBOLsAdmin(); });
    adminNextBtn?.addEventListener("click", () => { aOffset = aOffset + aLimit; loadBOLsAdmin(); });

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(() => fn(...a), ms); }; }
    startDate.addEventListener("change",   () => { aOffset = 0; loadBOLsAdmin(); });
    endDate.addEventListener("change",     () => { aOffset = 0; loadBOLsAdmin(); });
    buyerFilter.addEventListener("input",  debounce(() => { aOffset = 0; loadBOLsAdmin(); }));
    materialFilter.addEventListener("input", debounce(() => { aOffset = 0; loadBOLsAdmin(); }));

    // ---- Delivery Log modal wiring ----
    async function showDeliveryLog(bolId){
      document.getElementById("logBolId").textContent = bolId;
      const modal = new bootstrap.Modal(document.getElementById('deliveryLogModal'));
      try {
        const log = await fetchJSON(`${endpoint}/admin/ice/logs?bol_id=${encodeURIComponent(bolId)}`);
        const tb = document.getElementById("logTbody"); tb.innerHTML = "";
        (log.entries||[]).forEach((e,i)=>{
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${i+1}</td><td>${e.when_utc||"â€”"}</td><td>${e.http_status||"â€”"}</td>
            <td>${e.ms||"â€”"}</td><td><code class="small">${(e.response||"").slice(0,160)}</code></td>`;
          tb.appendChild(tr);
        });
        document.getElementById("logStats").textContent =
          `Delivered: ${log.delivered_count||0} â€¢ Pending: ${log.pending_count||0} â€¢ Failed: ${log.failed_count||0}`;
        document.getElementById("hashRow").innerHTML =
          log.pdf_sha256 ? `PDF SHA-256: <code class="small">${String(log.pdf_sha256)}</code>` : "";

        document.getElementById("btnResend").onclick = ()=> fetchJSON(`${endpoint}/admin/ice/resend`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ bol_id: bolId })
        }).then(()=>showDeliveryLog(bolId)).catch(e=>alert(e.message));

        document.getElementById("btnTest").onclick = ()=> fetchJSON(`${endpoint}/admin/ice/test_ping`, {
          method:"POST", headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ bol_id: bolId })
        }).then(()=>showDeliveryLog(bolId)).catch(e=>alert(e.message));

        document.getElementById("btnRotate").onclick = ()=> fetchJSON(`${endpoint}/admin/ice/rotate_secret`, {
          method:"POST"
        }).then(()=>alert("Secret rotated.")).catch(e=>alert(e.message));

        modal.show();
      } catch(e){ alert("Failed to load log: " + e.message); }
    }

    // ----------------- FUTURES JS -----------------
    const api = `${endpoint}/admin/futures`;

    // cached products map for symbol/metadata
    let products = [];               // array of rows
    const productById = {};          // {id: product}
    const productBySymbol = {};      // {symbol_root: product}

    // UI elements
    const pricingSymbolSel   = document.getElementById("pricingSymbol");
    const seriesProductSel   = document.getElementById("seriesProduct");
    const filterSeriesProdSel= document.getElementById("filterSeriesProduct");
    const filterSeriesStatus = document.getElementById("filterSeriesStatus");
    const markDateInput      = document.getElementById("markDate");

    async function refreshProducts() {
      try {
        products = await fetchJSON(`${api}/products`);
      } catch (e) {
        console.error("products fetch failed", e.message);
        return;
      }

      // reset maps/lists
      Object.keys(productById).forEach(k => delete productById[k]);
      Object.keys(productBySymbol).forEach(k => delete productBySymbol[k]);

      pricingSymbolSel.innerHTML = "";
      seriesProductSel.innerHTML = "";
      filterSeriesProdSel.innerHTML = `<option value="">(all products)</option>`;

      products.forEach(p => {
        productById[p.id] = p;
        productBySymbol[p.symbol_root] = p;

        const opt1 = document.createElement("option"); opt1.value = p.symbol_root; opt1.textContent = `${p.symbol_root} â€” ${p.material}`;
        const opt2 = document.createElement("option"); opt2.value = p.id;          opt2.textContent = `${p.symbol_root} â€” ${p.material}`;
        const opt3 = document.createElement("option"); opt3.value = p.id;          opt3.textContent = `${p.symbol_root} â€” ${p.material}`;

        pricingSymbolSel.appendChild(opt1);
        seriesProductSel.appendChild(opt2);
        filterSeriesProdSel.appendChild(opt3);
      });
    }

    async function refreshSeries() {
      const q = new URLSearchParams();
      const pid = filterSeriesProdSel.value;
      const st  = filterSeriesStatus.value;
      if (pid) q.set("product_id", pid);
      if (st)  q.set("status", st);

      let rows = [];
      try {
        rows = await fetchJSON(`${api}/series?${q.toString()}`);
      } catch (e) {
        console.error("series fetch failed", e.message);
      }
      renderSeriesTable(rows);
    }

    async function refreshMarks() {
      let rows = [];
      try {
        rows = await fetchJSON(`${api}/marks`);
      } catch (e) {
        console.error("marks fetch failed", e.message);
      }
      renderMarksTable(rows);
    }

    async function createProduct(form) {
      const body = Object.fromEntries(new FormData(form));
      body.contract_size_tons = parseFloat(body.contract_size_tons);
      body.tick_size = parseFloat(body.tick_size);
      try {
        await fetchJSON(`${api}/products`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(body) });
        form.reset();
        await refreshProducts();
        await refreshSeries();
        toast("Product saved.");
      } catch (e) {
        alert("Create product failed: " + e.message);
      }
    }

    async function setPricing(symbol_root, body) {
      try {
        await fetchJSON(`${api}/products/${encodeURIComponent(symbol_root)}/pricing`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        toast("Pricing saved.");
      } catch (e) {
        alert("Save pricing failed: " + e.message);
      }
    }

    async function generateSeries(product_id) {
      try {
        await fetchJSON(`${api}/series/generate`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ product_id, months_ahead:12, day_of_month: parseInt(document.getElementById("seriesDay").value || "15",10) })
        });
        await refreshSeries();
        toast("Series generated.");
      } catch (e) {
        alert("Generate series failed: " + e.message);
      }
    }

    async function listSeries(listing_id) {
      try {
        await fetchJSON(`${api}/series/${listing_id}/list`, { method:"POST" });
        await refreshSeries();
      } catch (e) {
        alert("List failed: " + e.message);
      }
    }

    async function publishMark(listing_id) {
      const mark_date = markDateInput.value ? new Date(markDateInput.value + "T00:00:00Z").toISOString().substring(0,10) : null;
      const body = { listing_id };
      if (mark_date) body.mark_date = mark_date;
      try {
        await fetchJSON(`${api}/marks/publish`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(body)
        });
        await refreshSeries();
        await refreshMarks();
      } catch (e) {
        alert("Publish mark failed: " + e.message);
      }
    }

    function renderSeriesTable(rows) {
      const tbody = document.querySelector("#series-table tbody");
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">No listings yet. Create a product, set pricing, then Generate Series.</td></tr>`;
        return;
      }
      rows.forEach(r => {
        const p = productById[r.product_id] || {};
        const sym = p.symbol_root || "â€”";
        const mat = p.material || "â€”";
        const actions = [];
        if (r.status === "Draft") {
          actions.push(`<button class="btn btn-sm btn-outline-success me-2" onclick="listSeries('${r.id}')">List</button>`);
        }
        actions.push(`<button class="btn btn-sm btn-outline-primary" onclick="publishMark('${r.id}')">Publish Mark</button>`);

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${sym}</td>
          <td>${mat}</td>
          <td>${r.contract_month}</td>
          <td>${r.contract_year}</td>
          <td>${r.expiry_date}</td>
          <td><span class="badge ${r.status==='Listed'?'bg-primary':'bg-secondary'}">${r.status}</span></td>
          <td class="text-center">${actions.join("")}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderMarksTable(rows) {
      const tbody = document.querySelector("#marks-table tbody");
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">No marks yet.</td></tr>`;
        return;
      }
      rows.forEach(r => {
        const tr = document.createElement("tr");
        const contract = `${r.contract_month}${String(r.contract_year).slice(-2)}`;
        tr.innerHTML = `
          <td>${r.symbol_root}</td>
          <td>${contract}</td>
          <td>${r.mark_date}</td>
          <td>$${Number(r.mark_price).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})}</td>
          <td><span class="badge badge-pill ${r.method==='MANUAL' ? 'bg-warning text-dark' : (r.method==='EXTERNAL' ? 'bg-info' : 'bg-success')}">${r.method}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Filters
    filterSeriesProdSel?.addEventListener("change", refreshSeries);
    filterSeriesStatus?.addEventListener("change", refreshSeries);

    // Init loads
    loadBOLsAdmin();
    setInterval(loadBOLsAdmin, 10000);

    // Load futures when tab shown
    let futuresLoadedOnce = false;
    document.getElementById("futures-tab").addEventListener("shown.bs.tab", async () => {
      if (!futuresLoadedOnce) {
        await refreshProducts();
        await refreshSeries();
        await refreshMarks();
        futuresLoadedOnce = true;
      } else {
        await refreshSeries();
        await refreshMarks();
      }
    });
  </script>

  <footer style="margin-top: 40px; text-align: center; font-size: 0.9em;">
    <a href="/terms" target="_blank">Terms of Use</a> |
    <a href="/eula" target="_blank">EULA</a> |
    <a href="/privacy" target="_blank">Privacy Policy</a>
  </footer>
</body>
</html>
