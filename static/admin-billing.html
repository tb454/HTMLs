<!DOCTYPE html>
<html class="loading" lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Admin ‚Äî Billing & Plans</title>

  <!-- Bootstrap + app css -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/static/app.css?v=20251111" nonce="{{NONCE}}">
  <link rel="icon" href="/static/favicon.ico" />

  <script nonce="{{NONCE}}">
    // Small onReady helper (same pattern as other pages)
    function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        try { fn(); } catch(e){ console.error(e); }
      }
    }
    // Mint XSRF-TOKEN early
    onReady(async () => { try { await fetch('/health', { credentials:'include' }); } catch {} });
  </script>

  <script nonce="{{NONCE}}">
    // Remove loading class if you use it
    window.hideLoading = function(){
      try { document.documentElement.classList.remove('loading'); } catch {}
      try { document.body.classList.add('loaded'); } catch {}
    };
    setTimeout(() => { try { window.hideLoading && window.hideLoading(); } catch {} }, 2500);
    window.addEventListener('DOMContentLoaded', () => {
      try { window.hideLoading && window.hideLoading(); } catch {}
    });
  </script>

  <script id="boot" nonce="{{NONCE}}">
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);
  </script>
  <script src="/static/js/locale.js" defer nonce="{{NONCE}}"></script>
</head>
<body>

  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
    <select id="lang-select" class="form-select form-select-sm w-auto">
      <option value="en">English</option><option value="es">Espa√±ol</option><option value="zh">‰∏≠Êñá</option>
    </select>
    <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
    <input id="tz-select" class="form-control form-control-sm w-220" list="tz-list" placeholder="America/Phoenix" data-i18n-ph="timezone"/>
    <datalist id="tz-list">
      <option value="America/Phoenix"></option><option value="America/New_York"></option>
      <option value="America/Chicago"></option><option value="America/Los_Angeles"></option>
      <option value="UTC"></option><option value="Europe/London"></option><option value="Asia/Shanghai"></option>
    </datalist>
    <button id="save-locale" class="btn btn-outline-secondary btn-sm ms-1">
      <span data-i18n="save">Save</span>
    </button>
    <small class="text-muted ms-auto" id="local-time"></small>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1"></div>

  <nav class="nav nav-pills small">
    <a class="nav-link" href="/static/bridge-admin-dashboard.html">Dashboard</a>
    <a class="nav-link active" href="/static/admin-billing.html">Billing</a>
    <a class="nav-link" href="/static/admin-compliance.html">Compliance</a>
    <a class="nav-link" href="/static/admin-tenants.html">Tenants</a>
    <a class="nav-link" href="/static/indices.html">Indices</a>
    <a class="nav-link" href="/static/trader.html">Trader</a>
    </nav>

  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0">üí≥ BRidge Admin ‚Äî Billing & Plans</h2>
        <span class="badge bg-light text-muted">Stripe-backed ¬∑ Usage-based</span>
      </div>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <div class="row g-3">
      <!-- LEFT COLUMN: Plans + Members Summary -->
      <div class="col-lg-5">
        <!-- Plan Catalog -->
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span><strong>Plan Catalog</strong></span>
            <button id="reloadPlans" class="btn btn-sm btn-outline-secondary">Refresh</button>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-striped align-middle mb-0" id="planTbl">
                <thead class="table-light">
                  <tr>
                    <th>Code</th><th>Name</th><th>Price (USD)</th><th>Active</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-1">
              Backed by <code>billing_plans</code> and <code>billing_plan_limits</code>.
            </div>
          </div>
        </div>

        <!-- Member Usage & Guaranty Summary -->
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span><strong>Members ‚Äî Usage & Guaranty</strong></span>
            <span class="small text-muted">Current billing cycle</span>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive">
              <table class="table table-sm table-hover align-middle mb-0" id="memberTbl">
                <thead class="table-light">
                  <tr>
                    <th>Member</th>
                    <th>Plan</th>
                    <th>BOLs</th>
                    <th>Contracts</th>
                    <th>Guaranty ($)</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-1">
              Usage from <code>/analytics/usage_by_member_current_cycle</code>, guaranty from <code>guaranty_fund</code>.
              Click a row to load member details.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Member Detail -->
      <div class="col-lg-7">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <strong>Member Detail</strong>
              <span id="detailMember" class="ms-2 text-muted"></span>
            </div>
            <span id="detailStatus" class="small text-muted"></span>
          </div>
          <div class="card-body">
            <!-- Plan & Guaranty Summary -->
            <div class="row g-3 mb-2">
              <div class="col-md-4">
                <label class="form-label">Plan</label>
                <div id="detailPlan" class="form-control-plaintext small text-muted">‚Äî</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Guaranty Fund</label>
                <div id="detailGuaranty" class="form-control-plaintext small text-muted">‚Äî</div>
              </div>
              <div class="col-md-4">
                <label class="form-label">Defaults</label>
                <div id="detailDefaults" class="form-control-plaintext small text-muted">‚Äî</div>
              </div>
            </div>

            <hr class="my-3">

            <!-- Billing Preferences -->
            <h6 class="mb-2">Billing Preferences</h6>
            <form id="prefsForm" class="row g-2 mb-3">
              <div class="col-md-2">
                <label class="form-label">Billing Day</label>
                <input id="prefDay" type="number" min="1" max="28" class="form-control form-control-sm" placeholder="1">
              </div>
              <div class="col-md-3">
                <label class="form-label">Timezone</label>
                <input id="prefTz" class="form-control form-control-sm" placeholder="America/Phoenix">
              </div>
              <div class="col-md-2">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="prefAutopay">
                  <label class="form-check-label small" for="prefAutopay">Autopay</label>
                </div>
              </div>
              <div class="col-md-2">
                <div class="form-check mt-4">
                  <input class="form-check-input" type="checkbox" id="prefAutoCharge">
                  <label class="form-check-label small" for="prefAutoCharge">Auto-charge</label>
                </div>
              </div>
              <div class="col-md-3">
                <label class="form-label">Invoice CC Emails</label>
                <input id="prefCc" class="form-control form-control-sm" placeholder="comma-separated">
              </div>
              <div class="col-12 d-flex justify-content-end gap-2">
                <button id="prefsSave" type="button" class="btn btn-sm btn-primary">Save Preferences</button>
              </div>
            </form>

            <hr class="my-3">

            <!-- Invoice list + detail -->
            <div class="row g-3">
              <div class="col-md-6">
                <h6 class="mb-2">Invoices</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover align-middle mb-0" id="invoiceTbl">
                    <thead class="table-light">
                      <tr>
                        <th>Period</th>
                        <th>Total</th>
                        <th>Status</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="3" class="text-muted text-center py-2">No member selected.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-2">Invoice Lines</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-striped align-middle mb-0" id="invoiceLinesTbl">
                    <thead class="table-light">
                      <tr>
                        <th>Event</th>
                        <th>Amount</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="2" class="text-muted text-center py-2">Select an invoice.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <div class="small text-muted mt-3">
              This panel reads from <code>member_plans</code>, <code>billing_preferences</code>, <code>billing_invoices</code>,
              <code>billing_line_items</code>, <code>guaranty_fund</code>, and <code>default_events</code>.
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap bundle -->
  <script
    nonce="{{NONCE}}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
    defer
  ></script>

  <script nonce="{{NONCE}}">
    // Basic toast + API helper (aligned with other BRidge pages)
    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    function toast(msg, ms=2800){
      const t = document.getElementById('toast');
      if (!t){ alert(typeof msg === 'string' ? msg : (msg?.message || 'Error')); return; }
      const text = typeof msg === 'string' ? msg : (msg?.message || 'Error');
      t.textContent = text;
      t.classList.add('show');
      try { t.focus(); } catch {}
      setTimeout(()=> t.classList.remove('show'), ms);
    }

    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const method = (opts.method || 'GET').toUpperCase();
      const headers = { Accept:'application/json', ...(opts.headers||{}) };
      if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
        headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
      }
      const res = await fetch(url, { ...opts, credentials:'include', headers });
      if (res.status === 401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if (!res.ok){
        let m = 'Request failed';
        try { m = (await res.clone().json()).detail || m; }
        catch { try { m = await res.clone().text() || m; } catch {} }
        toast(m);
        throw new Error(m);
      }
      return res;
    }

    // Health badge for this page
    onReady(async () => {
      const el = document.querySelector('[data-health-badge]');
      if (!el) return;
      try {
        let ok = false;
        try { ok = (await api('/health')).ok; } catch {}
        if (!ok) { try { ok = (await api('/healthz')).ok; } catch {} }
        if (ok){ el.textContent='‚óè Live'; el.dataset.ok='1'; }
        else { el.textContent='‚óè Degraded'; el.dataset.ok='0'; }
      }catch{
        el.textContent='‚óè Degraded'; el.dataset.ok='0';
      }
    });
  </script>

  <script nonce="{{NONCE}}">
    (function(){
      const fmtUSD = new Intl.NumberFormat(undefined, { style:'currency', currency:'USD', maximumFractionDigits:2 });

      let currentMember = null;
      const $ = id => document.getElementById(id);

      async function loadPlans(){
        const tb = $('#planTbl')?.querySelector('tbody');
        if (!tb) return;
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
        try{
          const res = await api('/billing/plans');
          const rows = await res.json();
          if (!rows.length){
            tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">No plans configured.</td></tr>`;
            return;
          }
          tb.innerHTML = rows.map(r => `
            <tr>
              <td>${r.plan_code}</td>
              <td>${r.name}</td>
              <td>${fmtUSD.format(r.price_usd)}</td>
              <td>${r.active ? 'Yes' : 'No'}</td>
            </tr>
          `).join('');
        }catch(e){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
        }
      }

      async function loadMembersSummary(){
        const tb = $('#memberTbl')?.querySelector('tbody');
        if (!tb) return;
        tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
        try{
          // usage rows contain member + plan_code + monthly counts
          const [usageRes, guarRes] = await Promise.all([
            api('/analytics/usage_by_member_current_cycle'),
            api('/billing/guaranty_fund')
          ]);
          const usage = await usageRes.json();
          const guar  = await guarRes.json();
          const guarMap = {};
          guar.forEach(g => { guarMap[g.member] = g.contribution_usd; });

          if (!usage.length){
            tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No usage yet in this cycle.</td></tr>`;
            return;
          }
          tb.innerHTML = usage.map(u => {
            const g = guarMap[u.member] || 0;
            return `
              <tr data-member="${u.member}">
                <td>${u.member}</td>
                <td>${u.plan_code || ''}</td>
                <td>${u.bols_month ?? 0}</td>
                <td>${u.contracts_month ?? 0}</td>
                <td>${g ? fmtUSD.format(g) : '‚Äî'}</td>
              </tr>`;
          }).join('');

          // click handler to load detail
          tb.querySelectorAll('tr[data-member]').forEach(tr => {
            tr.addEventListener('click', () => {
              const member = tr.getAttribute('data-member');
              setMember(member);
            });
          });

        }catch(e){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
        }
      }

      async function setMember(member){
        currentMember = member;
        $('#detailMember').textContent = member ? `Member: ${member}` : '';
        $('#detailStatus').textContent = 'Loading‚Ä¶';
        await Promise.all([
          loadMemberPlan(member),
          loadMemberGuarantyAndDefaults(member),
          loadPrefs(member),
          loadInvoices(member)
        ]).catch(()=>{});
        $('#detailStatus').textContent = '';
      }

      async function loadMemberPlan(member){
        const el = $('#detailPlan');
        if (!el) return;
        el.textContent = '‚Äî';
        try{
          const res = await api(`/billing/member_plan?member=${encodeURIComponent(member)}`);
          const row = await res.json();
          if (!row){
            el.textContent = 'No plan recorded';
          }else{
            el.textContent = `${row.plan_code} (since ${row.effective_date})`;
          }
        }catch(e){
          el.textContent = `Error: ${e.message || 'failed'}`;
        }
      }

      async function loadMemberGuarantyAndDefaults(member){
        const elG = $('#detailGuaranty');
        const elD = $('#detailDefaults');
        if (elG) elG.textContent = '‚Äî';
        if (elD) elD.textContent = '‚Äî';
        try{
          const [gRes, dRes] = await Promise.all([
            api('/billing/guaranty_fund'),
            api(`/billing/defaults?member=${encodeURIComponent(member)}`)
          ]);
          const gRows = await gRes.json();
          const dRows = await dRes.json();
          const g = gRows.find(r => r.member === member);
          if (g && elG){
            elG.textContent = fmtUSD.format(g.contribution_usd);
          }
          if (dRows.length && elD){
            const total = dRows.reduce((acc, r) => acc + Number(r.amount_usd || 0), 0);
            elD.textContent = `${dRows.length} event(s), total ${fmtUSD.format(total)}`;
          }else if (elD){
            elD.textContent = 'None';
          }
        }catch(e){
          if (elG) elG.textContent = 'Error';
          if (elD) elD.textContent = 'Error';
        }
      }

      async function loadPrefs(member){
        const dayEl = $('#prefDay');
        const tzEl  = $('#prefTz');
        const ccEl  = $('#prefCc');
        const aEl   = $('#prefAutopay');
        const acEl  = $('#prefAutoCharge');
        if (!dayEl || !tzEl || !ccEl || !aEl || !acEl) return;
        dayEl.value = '';
        tzEl.value  = '';
        ccEl.value  = '';
        aEl.checked = false;
        acEl.checked= false;
        try{
          const res = await api(`/billing/preferences?member=${encodeURIComponent(member)}`);
          const p = await res.json();
          if (!p) return;
          dayEl.value = p.billing_day || '';
          tzEl.value  = p.timezone || '';
          ccEl.value  = (p.invoice_cc_emails || []).join(', ');
          aEl.checked = !!p.autopay;
          acEl.checked = !!p.auto_charge;
        }catch(e){
          // ignore; prefs may not exist yet
        }
      }

      async function savePrefs(){
        if (!currentMember) return toast('Select a member first');
        const body = {
          billing_day: $('#prefDay').value ? parseInt($('#prefDay').value,10) : null,
          invoice_cc_emails: $('#prefCc').value
            ? $('#prefCc').value.split(',').map(s => s.trim()).filter(Boolean)
            : [],
          autopay: $('#prefAutopay').checked,
          timezone: $('#prefTz').value || null,
          auto_charge: $('#prefAutoCharge').checked
        };
        try{
          await api(`/billing/preferences?member=${encodeURIComponent(currentMember)}`, {
            method:'PUT',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          toast('Preferences saved');
          await loadPrefs(currentMember);
        }catch(e){
          // toast already shown by api()
        }
      }

      async function loadInvoices(member){
        const tb = $('#invoiceTbl')?.querySelector('tbody');
        const linesTb = $('#invoiceLinesTbl')?.querySelector('tbody');
        if (!tb || !linesTb) return;
        tb.innerHTML = `<tr><td colspan="3" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
        linesTb.innerHTML = `<tr><td colspan="2" class="text-muted text-center py-2">Select an invoice.</td></tr>`;
        try{
          const res = await api(`/billing/invoices?member=${encodeURIComponent(member)}`);
          const rows = await res.json();
          if (!rows.length){
            tb.innerHTML = `<tr><td colspan="3" class="text-muted text-center py-2">No invoices yet.</td></tr>`;
            return;
          }
          tb.innerHTML = rows.map(r => `
            <tr data-invoice="${r.invoice_id}">
              <td>${r.period_start} ‚Äì ${r.period_end}</td>
              <td>${fmtUSD.format(r.total)}</td>
              <td>${r.status}</td>
            </tr>
          `).join('');

          tb.querySelectorAll('tr[data-invoice]').forEach(tr => {
            tr.addEventListener('click', () => {
              const id = tr.getAttribute('data-invoice');
              loadInvoiceLines(id);
            });
          });

        }catch(e){
          tb.innerHTML = `<tr><td colspan="3" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
        }
      }

      async function loadInvoiceLines(invoiceId){
        const tb = $('#invoiceLinesTbl')?.querySelector('tbody');
        if (!tb) return;
        tb.innerHTML = `<tr><td colspan="2" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
        try{
          const res = await api(`/billing/invoices/${encodeURIComponent(invoiceId)}/lines`);
          const rows = await res.json();
          if (!rows.length){
            tb.innerHTML = `<tr><td colspan="2" class="text-muted text-center py-2">No line items.</td></tr>`;
            return;
          }
          tb.innerHTML = rows.map(r => `
            <tr>
              <td>${r.event_type || ''}${r.description ? ' ‚Äî ' + r.description : ''}</td>
              <td>${fmtUSD.format(r.amount)} ${r.currency}</td>
            </tr>
          `).join('');
        }catch(e){
          tb.innerHTML = `<tr><td colspan="2" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
        }
      }

      onReady(() => {
        // load plan catalog & member summary
        loadPlans().catch(()=>{});
        loadMembersSummary().catch(()=>{});
        $('#reloadPlans')?.addEventListener('click', () => loadPlans().catch(()=>{}));
        $('#prefsSave')?.addEventListener('click', savePrefs);
      });
    })();
  </script>

  <footer class="legal-footer">
    <hr class="mb-3">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms.html" class="link-secondary" rel="noopener noreferrer">Terms</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>¬∑</span>
      <a href="/legal/eula.html" class="link-secondary" rel="noopener noreferrer">EULA</a><span>¬∑</span>
      <a href="/legal/aup.html" class="link-secondary" rel="noopener noreferrer">AUP</a><span>¬∑</span>
      <a href="/legal/cookies.html" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>¬∑</span>
      <a href="/legal/subprocessors.html" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>¬∑</span>
      <a href="/legal/dpa.html" class="link-secondary" rel="noopener noreferrer">DPA</a><span>¬∑</span>
      <a href="/legal/sla.html" class="link-secondary" rel="noopener noreferrer">SLA</a><span>¬∑</span>
      <a href="/legal/security.html" class="link-secondary" rel="noopener noreferrer">Security</a><span>¬∑</span>
      <a href="/legal/fees.html" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> ‚Äì Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
</body>
</html>
