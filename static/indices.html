<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>BRidge Indices Dashboard</title>
  <meta name="theme-color" content="#0f62fe">
  <meta name="description" content="Auditable daily scrap indices with forecast overlay.">
  <link rel="icon" href="/static/favicon.ico">

  <!-- Fonts (allowed by your CSP) -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

  <!-- Styles -->
  <style>
    :root{
      --brand:#0f62fe; --ink:#0f172a; --muted:#6b7280; --bg:#f6f8fb;
      --card:#fff; --line:#e7eaf0; --ring:rgba(15,98,254,.16);
      --shadow:0 12px 30px rgba(22,29,37,.06), 0 4px 14px rgba(22,29,37,.05);
      --radius:14px; --radius-sm:10px;
      --ok:#10b981; --bad:#e11d48;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b1020; --card:#0f1426; --ink:#e5e7eb; --muted:#96a0b8;
        --line:#1e2745; --ring:rgba(15,98,254,.35);
        --shadow:0 12px 30px rgba(0,0,0,.35), 0 4px 14px rgba(0,0,0,.25);
      }
    }

    *{box-sizing:border-box}
    body{
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      margin:24px; background:var(--bg); color:var(--ink);
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Topbar */
    .topbar{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand h1{font-size:20px;margin:0;font-weight:700;letter-spacing:.2px}
    .muted{color:var(--muted);font-size:13px}
    .health-badge{font:12px/1 system-ui;color:#6b7280}
    .health-badge[data-ok="1"]{color:var(--ok)}

    /* Layout */
    .grid{display:grid;grid-template-columns:2fr 1fr;gap:16px}
    @media (max-width:1000px){.grid{grid-template-columns:1fr}}

    /* Card */
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
    }

    /* Toolbar */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px; align-items:center}
    .btn{
      padding:8px 12px; border:1px solid var(--line);
      border-radius:12px; background:var(--card); cursor:pointer; color:var(--ink);
      transition: box-shadow .15s ease, background-color .15s ease, transform .02s ease;
    }
    .btn:hover{background:#f3f6ff}
    .btn[data-busy="1"]{opacity:.6;pointer-events:none}
    .btn-primary{
      background:linear-gradient(180deg,#2b78ff,#0f62fe);
      color:#fff; border-color:#0f62fe;
    }
    .btn-primary:hover{filter:brightness(1.03)}
    .input{
      height:38px; padding:6px 10px; border:1px solid var(--line);
      border-radius:10px; background:var(--card); color:var(--ink);
      outline:none; transition: box-shadow .15s ease, border-color .15s ease;
    }
    .input:focus{box-shadow:0 0 0 4px var(--ring); border-color:transparent}

    /* Table */
    table{width:100%;border-collapse:collapse}
    thead.sticky{position:sticky;top:0;background:var(--card);z-index:2;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    th,td{padding:10px;border-bottom:1px solid #eee;font-size:14px}
    @media (prefers-color-scheme: dark){ th,td{border-bottom:1px solid #1f2a44} }
    th{text-align:left;user-select:none}
    tbody tr:hover{background:rgba(15,98,254,.04)}
    .positive{color:#047857}.negative{color:#b91c1c}

    /* Charts */
    #chart,#forecastChart{
      width:100%;height:280px;background:var(--card);border:1px solid var(--line);border-radius:12px
    }

    /* Toast */
    .toast{
      position:fixed;right:16px;bottom:16px;background:#111827;color:#fff;
      padding:10px 12px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,.25);
      font-size:13px;display:none; z-index:999
    }
    .toast[data-show="1"]{display:block}

    /* Skeletons */
    .skeleton-row td{height:14px}
    .skeleton{display:block;width:100%;height:10px;border-radius:6px;background:linear-gradient(90deg,#eee,#f6f7f8,#eee);background-size:200% 100%;animation:sk 1.1s linear infinite}
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>
</head>
<body>

<div class="topbar">
  <div class="brand">
    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" aria-hidden="true">
      <path d="M4 12h16M4 6h10M4 18h10" stroke="#0f62fe" stroke-width="2" stroke-linecap="round"/>
    </svg>
    <h1>BRidge Scrap Indices™</h1>
  </div>
  <div class="muted">USD/lb • daily closes & forecast overlay · <span class="health-badge" data-health-badge>● Checking…</span></div>
</div>

<div class="grid">
  <div class="card">
    <div class="toolbar">
      <button class="btn" id="refreshAll">Refresh</button>
      <button class="btn" id="exportUniverse">Export Universe CSV</button>
      <button class="btn" id="pullRefs">Pull Refs</button>
      <button class="btn btn-primary" id="runIndices">Build Indices</button>
      <button class="btn btn-primary" id="runForecasts">Run Forecasts</button>
      <span style="flex:1"></span>
      <input id="filterInput" class="input" placeholder="Filter tickers… (e.g., CU_*, HMS)" aria-label="Filter tickers"/>
    </div>
    <table id="universeTbl" aria-label="Index universe">
      <thead class="sticky">
        <tr>
          <th>Ticker</th><th>Method</th><th>Factor</th><th>Base</th><th>Last</th><th>Δ</th><th>Updated</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h3 id="detailTitle" style="margin-top:0;">Details</h3>
    <div class="muted" id="detailNote"></div>
    <div style="margin:8px 0; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" data-days="30" aria-pressed="true">30d</button>
      <button class="btn" data-days="90">90d</button>
      <button class="btn" id="toggleForecast" aria-pressed="false">Toggle Forecast Overlay</button>
    </div>
    <canvas id="chart"></canvas>
    <canvas id="forecastChart" style="margin-top:10px; display:none;"></canvas>
    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="exportHistory">Export History CSV</button>
      <button class="btn" id="exportForecast">Export Forecast CSV</button>
    </div>
    <div style="margin-top:6px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="dlDailyJson" aria-label="Download daily indices as JSON">Daily JSON (public)</button>
      <button class="btn" id="dlDailyCsv"  aria-label="Download daily indices as CSV">Daily CSV (public)</button>
    </div>
    <div id="provenance" class="muted" style="margin-top:8px;font-size:12px">
      <span id="asofLine">As of: —</span> ·
      <span id="methodLine">Method: —</span> ·
      <span id="hashLine">Hash: —</span>
    </div>
  </div>
</div>

<!-- Toast node (needed by toast()) -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>

<!-- Shared helpers: defines window.endpoint, api(), toast() -->
<script src="/static/js/app.js"></script>

<script>
  // Health badge using api() from app.js
  window.addEventListener('DOMContentLoaded', async ()=>{
    try{
      const r = await api('/health');
      if(r.ok){
        const b = document.querySelector('[data-health-badge]');
        b.textContent = '● Live';
        b.setAttribute('data-ok','1');
      }
    }catch{}
  });

  // Shortcuts
  const $ = sel => document.querySelector(sel);
  function setBusy(btn, busy){ btn?.setAttribute('data-busy', busy ? '1' : '0'); }

  function csvDownload(filename, rows){
    if(!rows?.length){ toast('No data.'); return; }
    const headers = Object.keys(rows[0]||{});
    const csv = [headers.join(',')].concat(
      rows.map(r=>headers.map(h=>JSON.stringify(r[h] ?? '')).join(','))
    ).join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
    URL.revokeObjectURL(url);
  }

  function showSkeleton(tbody, cols){
    tbody.innerHTML='';
    for(let i=0;i<5;i++){
      const tr=document.createElement('tr');
      tr.className='skeleton-row';
      tr.innerHTML = Array.from({length:cols},()=>'<td><span class="skeleton"></span></td>').join('');
      tbody.appendChild(tr);
    }
  }

  // DPR-aware lightweight line chart
  function drawLine(canvas, series, options={}){
    const ctx = canvas.getContext('2d');
    const dpr = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    const cssW = canvas.clientWidth, cssH = canvas.clientHeight;
    canvas.width  = Math.floor(cssW * dpr);
    canvas.height = Math.floor(cssH * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);

    const W = cssW, H = cssH;
    ctx.clearRect(0,0,W,H);
    if(!series.length) return;
    const pad = 28;
    const xs = series.map(d=>new Date(d.dt).getTime());
    const ys = series.map(d=>+d.value);
    const minX = Math.min(...xs), maxX = Math.max(...xs);
    const minY = Math.min(...ys), maxY = Math.max(...ys);
    const rangeY = maxY - minY || 1;
    const y0 = minY - rangeY*0.05, y1 = maxY + rangeY*0.05;

    const xPix = t => pad + (W-2*pad)*( (t-minX)/(maxX-minX || 1) );
    const yPix = v => H-pad - (H-2*pad)*( (v-y0)/(y1-y0 || 1) );

    // axes
    ctx.strokeStyle = '#e5e7eb'; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();

    // grid + labels
    ctx.fillStyle = '#6b7280'; ctx.font='12px system-ui';
    const ticks = 5;
    for(let i=0;i<=ticks;i++){
      const val = y0 + (y1-y0)*i/ticks;
      const y = yPix(val);
      ctx.strokeStyle = '#f3f4f6'; ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(W-pad,y); ctx.stroke();
      ctx.fillText(val.toFixed(3), 6, y+3);
    }

    // main series
    ctx.strokeStyle = options.color || '#111827'; ctx.lineWidth=2;
    ctx.beginPath();
    series.forEach((d,idx)=>{ const x=xPix(new Date(d.dt).getTime()), y=yPix(d.value); if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
    ctx.stroke();

    // CI band (forecast)
    if(options.ci){
      const lows  = options.ci.map(d=>({dt:d.dt, value:d.low}));
      const highs = options.ci.map(d=>({dt:d.dt, value:d.high}));
      ctx.fillStyle = 'rgba(37,99,235,.12)';
      ctx.beginPath();
      highs.forEach((d,idx)=>{ const x=xPix(new Date(d.dt).getTime()), y=yPix(d.value); if(idx===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
      for(let i=lows.length-1;i>=0;i--){ const d=lows[i]; const x=xPix(new Date(d.dt).getTime()), y=yPix(d.value); ctx.lineTo(x,y); }
      ctx.closePath(); ctx.fill();
    }
  }

  // state
  let universe = [];
  let selectedSymbol = null;
  let historyDays = 30;
  let showForecast = false;

  async function getJSON(url){ const r = await api(url); return r.json(); }

  async function loadUniverse(){
    const tbody = $('#universeTbl tbody');
    showSkeleton(tbody, 8);
    try{
      universe = await getJSON('/indices/universe');
      document.getElementById('detailNote').textContent =
        'History (USD/lb); toggle forecast overlay to view 7/30/90d. Universe loaded ' +
        new Date().toISOString().slice(0,19).replace('T',' ') + 'Z';
      tbody.innerHTML = '';

      // apply filter if any
      const q = ($('#filterInput')?.value || '').trim().toLowerCase();
      const filter = (row) => {
        if(!q) return true;
        const sym = (row.symbol||'').toLowerCase();
        const meth = (row.method||'').toLowerCase();
        return sym.includes(q) || meth.includes(q);
      };

      for (const row of universe.filter(filter)){
        const sym = row.symbol;
        let last=null, prev=null, updated=null;
        try{
          const hist = await getJSON(`/indices/history?symbol=${encodeURIComponent(sym)}`);
          if(hist.length){
            last = hist[hist.length-1]?.close_price;
            if(hist.length>1) prev = hist[hist.length-2]?.close_price;
            updated = hist[hist.length-1]?.dt;
          }
        }catch(e){}
        const delta = (last!=null && prev!=null) ? (last - prev) : null;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><b>${sym}</b></td>
          <td>${row.method}</td>
          <td>${(+row.factor).toFixed(4)}</td>
          <td>${row.base_symbol}</td>
          <td>${last!=null ? (+last).toFixed(4) : '-'}</td>
          <td class="${delta>0?'positive':delta<0?'negative':''}">${delta!=null ? (delta>0?'+':'')+delta.toFixed(4) : '-'}</td>
          <td class="muted">${updated || '-'}</td>
          <td><button class="btn" data-view="${sym}">View</button></td>
        `;
        tbody.appendChild(tr);
      }
      if (!tbody.children.length){
        tbody.innerHTML = `<tr><td colspan="8" class="muted">No rows match your filter.</td></tr>`;
      }
    }catch(e){
      tbody.innerHTML = `<tr><td colspan="8" class="muted">Failed to load universe.</td></tr>`;
      toast('Could not load index universe');
    }
  }

  async function viewSymbol(sym){
    selectedSymbol = sym;
    $('#detailTitle').textContent = sym;
    $('#detailNote').textContent = 'History (USD/lb); toggle forecast overlay to view 7/30/90d.';

    // history for chart
    const histAll = await getJSON(`/indices/history?symbol=${encodeURIComponent(sym)}`);
    const trim = histAll.slice(-historyDays).map(r=>({dt:r.dt, value:+r.close_price}));
    drawLine($('#chart'), trim, {color:'#111827'});

    // forecast overlay
    if(showForecast){
      const fc = await getJSON(`/forecasts/latest?symbol=${encodeURIComponent(sym)}&horizon_days=90`);
      const series = fc.map(r=>({dt:r.forecast_date, value:+r.predicted_price}));
      const ci = fc.map(r=>({dt:r.forecast_date, low:+(r.conf_low ?? r.predicted_price), high:+(r.conf_high ?? r.predicted_price)}));
      $('#forecastChart').style.display = '';
      drawLine($('#forecastChart'), series, {color:'#2563eb', ci});
    } else {
      $('#forecastChart').style.display = 'none';
    }

    // provenance (as-of, method, integrity hash)
    try {
      const latest = histAll[histAll.length-1];
      const asof = latest ? latest.dt : null;
      const uniRow = (universe || []).find(u => u.symbol === sym);
      const method = uniRow ? uniRow.method : '—';

      const enc = new TextEncoder();
      const data = JSON.stringify(histAll.slice(-historyDays));
      const buf = await crypto.subtle.digest('SHA-256', enc.encode(data));
      const hash = Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('').slice(0,12);

      document.getElementById('asofLine').textContent   = `As of: ${asof || '—'} (UTC)`;
      document.getElementById('methodLine').textContent = `Method: ${method}`;
      document.getElementById('hashLine').textContent   = `Hash: ${hash}`;
    } catch {}
  }

  // interactions
  document.getElementById('universeTbl').addEventListener('click', (e)=>{
    const b = e.target.closest('button[data-view]');
    if(b){ viewSymbol(b.getAttribute('data-view')); }
  });

  // Days toggle
  document.querySelectorAll('button[data-days]').forEach(b=>{
    b.onclick = ()=>{
      document.querySelectorAll('button[data-days]').forEach(x=>x.setAttribute('aria-pressed','false'));
      b.setAttribute('aria-pressed','true');
      historyDays = +b.dataset.days; if(selectedSymbol) viewSymbol(selectedSymbol);
    };
  });

  // Forecast toggle
  document.getElementById('toggleForecast').onclick = (ev)=>{
    showForecast = !showForecast;
    ev.currentTarget.setAttribute('aria-pressed', showForecast ? 'true' : 'false');
    if(selectedSymbol) viewSymbol(selectedSymbol);
  };

  // exports
  document.getElementById('exportUniverse').onclick = ()=>{
    const rows = universe.map(r=>({symbol:r.symbol, method:r.method, factor:r.factor, base_symbol:r.base_symbol}));
    csvDownload('bridge_index_universe.csv', rows);
  };
  document.getElementById('exportHistory').onclick = async ()=>{
    if(!selectedSymbol) return toast('Select a ticker first.');
    const rows = await getJSON(`/indices/history?symbol=${encodeURIComponent(selectedSymbol)}`);
    csvDownload(`${selectedSymbol}_history.csv`, rows);
  };
  document.getElementById('exportForecast').onclick = async ()=>{
    if(!selectedSymbol) return toast('Select a ticker first.');
    const rows = await getJSON(`/forecasts/latest?symbol=${encodeURIComponent(selectedSymbol)}&horizon_days=90`);
    csvDownload(`${selectedSymbol}_forecast90.csv`, rows);
  };

  // public downloads (ensure window.endpoint exists via app.js; fall back if not)
  (function ensureEndpoint(){ window.endpoint = window.endpoint || location.origin; })();
  document.getElementById('dlDailyJson').onclick = ()=>{ window.location = `${window.endpoint}/public/indices/daily.json`; };
  document.getElementById('dlDailyCsv').onclick  = ()=>{ window.location = `${window.endpoint}/public/indices/daily.csv`;  };

  // admin buttons
  function onceBusy(btn, fn){
    if(btn.dataset.busy === "1") return;
    setBusy(btn, true);
    Promise.resolve(fn()).finally(()=> setBusy(btn, false));
  }
  document.getElementById('runIndices').onclick   = e => onceBusy(e.target, () => api('/indices/run',{method:'POST'}).then(()=> { toast('✓ Indices built'); if(selectedSymbol) viewSymbol(selectedSymbol); }));
  document.getElementById('runForecasts').onclick = e => onceBusy(e.target, () => api('/forecasts/run',{method:'POST'}).then(()=> { toast('✓ Forecasts complete'); if(selectedSymbol) viewSymbol(selectedSymbol); }));

  // filter
  document.getElementById('filterInput').addEventListener('input', ()=>{
    loadUniverse();
  });

  // init
  document.getElementById('refreshAll').onclick = loadUniverse;
  loadUniverse().then(()=>{ const first = universe[0]?.symbol; if(first) viewSymbol(first); });

  // simple sortable columns
  function makeSortable(table){
    const ths = table.querySelectorAll('thead th');
    ths.forEach((th, idx) => {
      th.style.cursor='pointer'; th.title='Click to sort';
      let dir = 1;
      th.addEventListener('click', ()=>{
        const rows = Array.from(table.tBodies[0].rows);
        const isNum = rows.every(r => !isNaN(parseFloat(r.cells[idx].innerText.replace(/[,$]/g,''))) || r.cells[idx].innerText.trim()==='-');
        rows.sort((a,b)=>{
          const av = a.cells[idx].innerText.trim(), bv = b.cells[idx].innerText.trim();
          if (av==='-' || bv==='-') return av==='-' && bv==='-' ? 0 : av==='-' ? 1 : -1;
          if (isNum) return (parseFloat(av.replace(/[,$+]/g,'')) - parseFloat(bv.replace(/[,$+]/g,''))) * dir;
          return av.localeCompare(bv, undefined, {numeric:true, sensitivity:'base'}) * dir;
        });
        dir *= -1; rows.forEach(r=>table.tBodies[0].appendChild(r));
      });
    });
  }
  makeSortable(document.getElementById('universeTbl'));
</script>

<footer class="muted" style="margin-top:20px;font-size:12px;text-align:center">
  BR-Index values are produced by Atlas IP Holdings using the published methodology.
  Provisional values may be revised pursuant to the corrections policy. No investment advice.
</footer>
</body>
</html>
