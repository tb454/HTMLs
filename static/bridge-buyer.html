<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BRidge Buyer Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="icon" href="/static/favicon.ico">
  <meta name="color-scheme" content="light dark">
  <style>
    body{background:#f4f6f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:20px}
    .cardy{background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.06);padding:18px;margin-bottom:16px}
    .health-badge{font:12px/1 system-ui;color:#6b7280}
    .health-badge[data-ok="1"]{color:#10b981}
    /* skeletons */
    .skeleton{ display:block; width:100%; height:14px; border-radius:6px;
      background:linear-gradient(90deg,#ececec,#f6f7f8,#ececec); background-size:200% 100%;
      animation:sk 1.1s linear infinite; }
    @keyframes sk{0%{background-position:200% 0;}100%{background-position:-200% 0;}}
    button:disabled{opacity:.6;cursor:not-allowed}
  </style>

  <!-- Global endpoint + toast + api helper -->
  <div id="toast" style="position:fixed;right:16px;bottom:16px;max-width:360px;display:none;padding:12px 14px;background:#111827;color:#fff;border-radius:10px;box-shadow:0 6px 24px rgba(0,0,0,.2);font:14px system-ui" role="status" aria-live="polite"></div>
  <script>
    // Single source of truth for API base (same-origin in prod; localhost in dev)
    window.endpoint = window.endpoint || (
      location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin
    );

    function toast(msg, ms=2800){
      const t = document.getElementById('toast');
      if(!t){ alert(msg); return; }
      t.textContent = typeof msg === 'string' ? msg : (msg?.message || 'Error');
      t.style.display = 'block';
      setTimeout(()=>{ t.style.display = 'none'; }, ms);
    }

    // Uniform fetch with JSON Accept + 401‚Üílogin + error‚Üítoast
    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const res = await fetch(url, { ...opts, headers:{ Accept:'application/json', ...(opts.headers||{}) }});
      if(res.status === 401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if(!res.ok){
        let msg = 'Request failed';
        try{ msg = (await res.clone().json()).detail || msg; } catch { try { msg = await res.clone().text() || msg; } catch {} }
        toast(msg);
        throw new Error(msg);
      }
      return res;
    }

    // Tiny health check badge for ‚Äúlive‚Äù feel
    window.addEventListener('DOMContentLoaded', async ()=>{
      const el = document.querySelector('[data-health-badge]');
      if(!el) return;
      try{ await api('/health'); el.textContent = '‚óè Live'; el.setAttribute('data-ok','1'); }
      catch{ el.textContent = '‚óè Degraded'; el.removeAttribute('data-ok'); }
    });
  </script>
</head>
<body>
  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      <h2 class="mb-3">üõí BRidge Buyer Portal</h2>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <div class="d-flex gap-2 mb-3">
      <input id="buyerFilter" class="form-control form-control-sm" placeholder="Filter buyer (optional)">
      <input id="materialFilter" class="form-control form-control-sm" placeholder="Material/SKU (e.g., SHRED, Barley, #1)">
      <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">Refresh</button>
    </div>

    <!-- RFQ (two-click) -->
    <div class="cardy" id="rfqCard">
      <div class="d-flex gap-2 align-items-end" style="max-width:520px">
        <div style="flex:1">
          <label class="form-label mb-1">Symbol</label>
          <select id="rfqSym" class="form-select">
            <option>CU-SHRED-1M</option>
            <option>AL-6061-1M</option>
          </select>
        </div>
        <div style="width:120px">
          <label class="form-label mb-1">Side</label>
          <select id="rfqSide" class="form-select">
            <option>buy</option>
            <option>sell</option>
          </select>
        </div>
        <div style="width:140px">
          <label class="form-label mb-1">Qty (lots)</label>
          <input id="rfqQty" class="form-control" type="number" placeholder="e.g. 5" min="1">
        </div>
        <div>
          <label class="form-label mb-1" style="opacity:0">.</label>
          <button id="rfqGo" class="btn btn-primary">RFQ</button>
        </div>
      </div>
    </div>

    <!-- live region for loading text (a11y) -->
    <div id="loadingStatus" class="visually-hidden" role="status" aria-live="polite"></div>

    <div id="list"></div>

    <div class="d-flex gap-2 mt-2">
      <button class="btn btn-outline-secondary btn-sm" id="prevBtn">‚óÄ Prev</button>
      <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next ‚ñ∂</button>
      <span class="small text-muted" id="pageInfo"></span>
    </div>
  </div>

  <script>
    const endpoint = window.endpoint;           // unified base
    let offset = 0, limit = 100;                // pagination
    let loadCtl = null;                         // AbortController for overlapping loads
    let refreshTimer = null;                    // interval handle

    // Role guard: hide Buy if not buyer
    function currentRole(){
      try{ return (JSON.parse(localStorage.getItem('bridgeUser')||'{}').role||'').toLowerCase(); }
      catch{ return ''; }
    }

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function showSkeletonCards(n=5){
      const root = document.getElementById('list');
      root.innerHTML = '';
      for(let i=0;i<n;i++){
        const div = document.createElement('div');
        div.className = 'cardy';
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div style="flex:1; padding-right:12px;">
              <div class="skeleton" style="width:40%; margin-bottom:10px;"></div>
              <div class="skeleton" style="width:60%; margin-bottom:8px;"></div>
              <div class="skeleton" style="width:55%; margin-bottom:6px;"></div>
              <div class="skeleton" style="width:50%;"></div>
            </div>
            <div style="width:90px;"><div class="skeleton"></div></div>
          </div>`;
        root.appendChild(div);
      }
    }

    function _syncQuery(params){
      const u = new URL(location.href);
      for (const [k,v] of Object.entries(params)) {
        if (v === '' || v == null) u.searchParams.delete(k);
        else u.searchParams.set(k, v);
      }
      history.replaceState({}, '', u);
    }

    // Optional nicety: disable nav buttons while loading
    function setLoadingUI(isLoading){
      const ids = ['prevBtn','nextBtn','refreshBtn'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if (el) el.disabled = isLoading;
      });
    }

    // Abortable loader with button-state + URL sync
    async function loadOpenContracts(){
      // cancel any in-flight load
      if (loadCtl) loadCtl.abort();
      loadCtl = new AbortController();

      const root = document.getElementById('list');
      const ls = document.getElementById('loadingStatus');
      ls.textContent = 'Loading contracts‚Ä¶';
      setLoadingUI(true);
      showSkeletonCards(5);

      const q = new URLSearchParams({ status: 'Pending', limit, offset });
      const buyerVal = document.getElementById('buyerFilter').value.trim();
      const matVal   = document.getElementById('materialFilter').value.trim();
      if (buyerVal) q.set('buyer', buyerVal);
      if (matVal)   q.set('material', matVal);

      // save filters/page to URL
      const page = Math.floor(offset/limit)+1;
      _syncQuery({ buyer: buyerVal || '', material: matVal || '', page });

      try{
        const res  = await api(`/contracts?` + q.toString(), { signal: loadCtl.signal });
        const rows = await res.json();

        root.innerHTML = '';
        if (rows.length === 0) {
          root.innerHTML = `<div class="text-muted">No open contracts.</div>`;
          document.getElementById('pageInfo').textContent = `Showing 0 ‚Ä¢ offset ${offset}`;
          ls.textContent = 'Loaded.';
          return;
        }

        const role = currentRole();
        rows.forEach(r=>{
          const div = document.createElement('div');
          div.className = 'cardy';
          const total = (Number(r.weight_tons) * Number(r.price_per_ton));
          const buyBtn = (role === 'buyer')
            ? `<button class="btn btn-primary btn-sm" data-id="${r.id}" onclick="buy(event,'${r.id}')">Buy</button>`
            : `<button class="btn btn-secondary btn-sm" disabled title="Login as Buyer to purchase">Buy</button>`;
          div.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <h5 class="mb-1">${r.material}</h5>
                <div class="text-muted small">Seller: ${r.seller}</div>
                <div class="text-muted small">Buyer: ${r.buyer}</div>
                <div class="small">Tons: <b>${r.weight_tons}</b> @ $<b>${r.price_per_ton}</b>/ton ¬∑ Total $<b>${total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</b></div>
                <div class="small text-muted">Created: ${r.created_at ? new Date(r.created_at).toLocaleString() : ''}</div>
              </div>
              <div class="text-end">
                ${buyBtn}
              </div>
            </div>`;
          root.appendChild(div);
        });

        document.getElementById('pageInfo').textContent = `Showing ${rows.length} ‚Ä¢ offset ${offset}`;
      }catch(e){
        if (e.name !== 'AbortError') {
          // api() already toasted the error
        }
      }finally{
        ls.textContent = 'Loaded.';
        loadCtl = null;
        setLoadingUI(false);
      }
    }

    async function buy(ev, id){
      const btn = ev?.currentTarget;
      if (btn){ btn.disabled = true; btn.textContent = 'Purchasing‚Ä¶'; }
      try{
        const res = await api(`/contracts/${id}/purchase`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Idempotency-Key': crypto.randomUUID()
          },
          body: JSON.stringify({ op:'purchase', expected_status:'Pending' })
        });
        const data = await res.json();
        toast(`Purchased. BOL ${data.bol_id} created.`);
        loadOpenContracts();
      }catch(e){
        // api() already showed toast
      }finally{
        if (btn){ btn.disabled = false; btn.textContent = 'Buy'; }
      }
    }
    window.buy = buy; // expose for inline onclick

    // Wire UI
    document.getElementById('refreshBtn').addEventListener('click', ()=>{ offset = 0; loadOpenContracts(); });
    document.getElementById('buyerFilter').addEventListener('input', debounce(()=>{ offset = 0; loadOpenContracts(); }, 250));
    document.getElementById('materialFilter').addEventListener('input', debounce(()=>{ offset = 0; loadOpenContracts(); }, 250));
    document.getElementById('prevBtn').addEventListener('click', ()=>{ offset = Math.max(0, offset - limit); loadOpenContracts(); });
    document.getElementById('nextBtn').addEventListener('click', ()=>{ offset += limit; loadOpenContracts(); });

    // Hydrate filters/page from URL on first load
    (function hydrateFromURL(){
      const q = new URL(location.href).searchParams;
      const buyer = q.get('buyer') || '';
      const material = q.get('material') || '';
      const page = Math.max(1, parseInt(q.get('page')||'1', 10));
      document.getElementById('buyerFilter').value = buyer;
      document.getElementById('materialFilter').value = material;
      offset = (page - 1) * limit;
    })();

    // Auto-refresh controls (pause when hidden)
    function startAuto(){ if (!refreshTimer) refreshTimer = setInterval(loadOpenContracts, 10000); }
    function stopAuto(){ if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; } }
    document.addEventListener('visibilitychange', ()=> document.hidden ? stopAuto() : (loadOpenContracts(), startAuto()));

    // Initial load + start timer
    loadOpenContracts();
    startAuto();
  </script>

  <!-- RFQ wiring (after api() & DOM exist) + hide for non-buyers -->
  <script>
    (function(){
      // Hide RFQ for non-buyers (client-side courtesy; server still enforces)
      const role = (JSON.parse(localStorage.getItem('bridgeUser')||'{}').role||'').toLowerCase();
      if (role !== 'buyer') document.getElementById('rfqCard')?.classList.add('d-none');

      const btn = document.getElementById('rfqGo');
      if(!btn) return;
      // default side to 'buy' for buyers
      if (role === 'buyer') {
        const sideSel = document.getElementById('rfqSide');
        if (sideSel) sideSel.value = 'buy';
      }

      btn.onclick = async ()=>{
        const s   = document.getElementById('rfqSym').value;
        const side= document.getElementById('rfqSide').value;
        const q   = +document.getElementById('rfqQty').value;
        if (!q) return toast('Enter qty');
        const exp = new Date(Date.now() + 20*60*1000).toISOString();
        const r = await api('/rfq', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ symbol:s, side, quantity_lots:q, expires_at:exp })
        });
        toast('RFQ posted');
        try { console.log(await r.json()); } catch {}
      };
    })();
  </script>
</body>
</html>
