<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BRidge Buyer</title>
  <meta name="description" content="Purchase open BRidge contracts, post RFQs, and monitor live inventory and BOLs." />
  <meta name="color-scheme" content="light dark" />

  <script nonce="{{NONCE}}">
    function onReady(fn) {
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        try { fn(); } catch (e) { console.error(e); }
      }
    }
    // Mint XSRF cookie immediately so unsafe methods can echo it
    onReady(async () => { try { await fetch('/health', { credentials: 'include' }); } catch {} });
  </script>

  <!-- Performance & Integrity -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="/static/app.css" />

  <script id="boot" nonce="{{NONCE}}">
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);
  </script>
  <script src="/static/js/locale.js" defer nonce="{{NONCE}}"></script>
  <script src="/static/js/i18n.js" defer nonce="{{NONCE}}"></script>
</head>
<body>
  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
    <select id="lang-select" class="form-select form-select-sm w-auto">
      <option value="en">English</option>
      <option value="es">Espa√±ol</option>
      <option value="zh">‰∏≠Êñá</option>
    </select>

    <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
    <input
      id="tz-select"
      class="form-control form-control-sm w-220"
      list="tz-list"
      placeholder="America/Phoenix"
      data-i18n-ph="timezone"
    />
    <datalist id="tz-list">
      <option value="America/Phoenix"></option>
      <option value="America/New_York"></option>
      <option value="America/Chicago"></option>
      <option value="America/Los_Angeles"></option>
      <option value="UTC"></option>
      <option value="Europe/London"></option>
      <option value="Asia/Shanghai"></option>
    </datalist>

    <button id="save-locale" class="btn btn-outline-secondary btn-sm ms-1">
      <span data-i18n="save">Save</span>
    </button>

    <small class="text-muted ms-auto" id="local-time"></small>
  </div>

  <a href="#list" class="visually-hidden visually-hidden-focusable">Skip to content</a>

  <!-- Toast (live region) -->
  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1">
    <button type="button" class="toast-close" aria-label="Close notification">&times;</button>
    <span id="toastMsg"></span>
  </div>

  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      <h2 class="mb-3" data-i18n="buyer_portal">üõí BRidge Buyer Portal</h2>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <!-- Auth/health banner -->
    <div id="authBanner" class="mb-2">
      <strong>Status:</strong> <span id="authMsg">Checking‚Ä¶</span>
      <a href="/static/bridge-login.html" class="ms-2">Re-authenticate</a>
    </div>

    <!-- Compliance cues -->
    <div class="small text-muted mb-2">
      KYC/AML verified ‚Ä¢ Data retention 7y ‚Äî <a href="/legal/security">Security</a> ‚Ä¢ <a href="/legal/terms">Terms</a>
    </div>

    <!-- Timezone hint -->
    <div class="small text-muted mb-2" id="tzHint"></div>

    <!-- Buyer overview: positions, BOLs, billing, market -->
    <div class="row mb-3" id="buyerOverviewRow">
      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">My Positions</h5>
          <div class="small text-muted mb-2">Contracts you have purchased and still hold.</div>
          <div id="buyerPositionsBody" class="small">Loading positions‚Ä¶</div>
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">My BOLs</h5>
          <div class="small text-muted mb-2">Recent Bills of Lading where you are the buyer.</div>
          <div id="buyerBolsBody" class="small">Loading BOLs‚Ä¶</div>
        </div>
      </div>
    </div>

    <div class="row mb-3" id="buyerSecondaryRow">
      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">Plan &amp; Billing</h5>
          <div id="buyerBillingBody" class="small">Loading billing summary‚Ä¶</div>
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">Market Snapshot</h5>
          <div id="buyerMarketBody" class="small">Loading market snapshot‚Ä¶</div>
        </div>
      </div>
    </div>
    <!-- /Buyer overview -->

    <!-- Buyer extras -->
    <div class="row mb-3" id="buyerExtrasRow">
      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">My RFQs</h5>
          <div class="small text-muted mb-2">RFQs you‚Äôve posted (latest first).</div>
          <div id="buyerRfqsBody" class="small">Loading RFQs‚Ä¶</div>
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <div class="d-flex justify-content-between align-items-center">
            <h5 class="mb-2 mb-0">Contract History</h5>
            <button id="dlContractsCsv" class="btn btn-outline-secondary btn-sm" type="button">CSV</button>
          </div>
          <div class="small text-muted mb-2">Signed/fulfilled purchases you‚Äôve made.</div>
          <div id="buyerHistoryBody" class="small">Loading contracts‚Ä¶</div>
        </div>
      </div>
    </div>

    <div class="row mb-3" id="buyerPlanRow">
      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">Delivery Calendar</h5>
          <div class="small text-muted mb-2">Upcoming &amp; recent BOLs.</div>
          <div id="buyerCalendarBody" class="small">Loading schedule‚Ä¶</div>
        </div>
      </div>

      <div class="col-lg-6 mb-3">
        <div class="cardy h-100">
          <div class="d-flex align-items-end gap-2">
            <div class="flex-grow-1">
              <label class="form-label mb-1" for="qMaterial">Quick Price ‚Äî Material</label>
              <input id="qMaterial" class="form-control" placeholder="#1 Copper, Shred Steel, 6061‚Ä¶" />
            </div>
            <div class="maxw-140">
              <label class="form-label mb-1" for="qTons">Tons</label>
              <input id="qTons" class="form-control" type="number" min="1" step="0.5" />
            </div>
            <div>
              <span class="form-label mb-1 vis-hidden-label">&nbsp;</span>
              <button id="qGo" class="btn btn-primary" type="button">Quote</button>
            </div>
          </div>
          <div id="qOut" class="small mt-2 text-muted">Enter a material + tons and click Quote.</div>
        </div>
      </div>
    </div>
    <!-- /Buyer extras -->

    <!-- BOL Manager -->
    <div class="row mb-3" id="buyerBolManagerRow">
      <div class="col-lg-12 mb-3">
        <div class="cardy h-100">
          <h5 class="mb-2">BOL Manager</h5>
          <div class="small text-muted mb-2">Quick actions on a single BOL and (optionally) its Contract.</div>

          <div class="row g-2 align-items-end">
            <div class="col-sm-3">
              <label class="form-label mb-1" for="bmBolId">BOL ID</label>
              <input id="bmBolId" class="form-control" placeholder="9fd8-...-e57" />
            </div>
            <div class="col-sm-3">
              <label class="form-label mb-1" for="bmContractId">Contract ID (optional)</label>
              <input id="bmContractId" class="form-control" placeholder="b1c8-...-e9" />
            </div>

            <div class="col-sm-6 text-sm-end">
              <button id="bmRefresh" class="btn btn-outline-secondary btn-sm">Refresh</button>
              <button id="bmReceive" class="btn btn-primary btn-sm">Mark Delivered (Receive)</button>
            </div>
          </div>

          <hr/>

          <div class="row g-3">
            <!-- Attachments -->
            <div class="col-md-6">
              <h6 class="mb-2">Attachments</h6>
              <div class="d-flex gap-2 align-items-end mb-2">
                <div class="flex-grow-1">
                  <label class="form-label mb-1" for="bmFile">Upload (photo / scale ticket)</label>
                  <input id="bmFile" type="file" class="form-control" />
                </div>
                <div class="maxw-180">
                  <label class="form-label mb-1" for="bmFileKind">Kind</label>
                  <select id="bmFileKind" class="form-select">
                    <option value="photo">photo</option>
                    <option value="scale_ticket">scale_ticket</option>
                    <option value="other">other</option>
                  </select>
                </div>
                <div>
                  <span class="form-label mb-1 vis-hidden-label">&nbsp;</span>
                  <button id="bmUpload" class="btn btn-secondary">Upload</button>
                </div>
              </div>
              <div id="bmAttachList" class="small text-muted">No attachments yet.</div>
            </div>

            <!-- Disputes -->
            <div class="col-md-6">
              <h6 class="mb-2">Disputes</h6>
              <div class="d-flex gap-2 mb-2">
                <input id="bmDisputeReason" class="form-control" placeholder="Reason (short)" />
                <input id="bmDisputeNotes" class="form-control" placeholder="Notes (optional)" />
                <button id="bmOpenDispute" class="btn btn-warning">Open</button>
              </div>
              <div id="bmDisputeList" class="small text-muted">No disputes yet.</div>
            </div>

            <!-- Payouts -->
            <div class="col-md-6">
              <h6 class="mb-2 mt-2">Payout</h6>
              <div class="d-flex gap-2 mb-2">
                <input id="bmPayee" class="form-control" placeholder="Payee (seller/broker)" />
                <input id="bmPayoutAmt" type="number" min="0" step="0.01" class="form-control" placeholder="Amount USD" />
                <button id="bmCreatePayout" class="btn btn-success">Create</button>
              </div>
              <div id="bmPayoutList" class="small text-muted">No payouts found.</div>
            </div>

            <!-- Tags -->
            <div class="col-md-6">
              <h6 class="mb-2 mt-2">Tags</h6>
              <div class="d-flex gap-2 mb-2">
                <input id="bmTag" class="form-control" placeholder="e.g., urgent, qc-hold" />
                <button id="bmAddTag" class="btn btn-outline-primary">Add</button>
                <button id="bmDelTag" class="btn btn-outline-danger">Remove</button>
              </div>
              <div id="bmTagList" class="small text-muted">No tags yet.</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /BOL Manager -->

    <!-- Controls -->
    <div class="d-flex gap-2 mb-3 align-items-end">
      <div class="flex-grow-1">
        <label class="visually-hidden" for="buyerFilter">Filter buyer</label>
        <input id="buyerFilter" class="form-control form-control-sm" placeholder="Filter buyer (optional)" autocomplete="off" />
      </div>
      <div class="flex-grow-1">
        <label class="visually-hidden" for="materialFilter">Filter material/SKU</label>
        <input
          id="materialFilter"
          class="form-control form-control-sm"
          placeholder="Material/SKU (e.g., SHRED, Barley, #1)"
          autocomplete="off"
        />
      </div>

      <button class="btn btn-secondary btn-sm" id="refreshBtn" type="button">Refresh</button>

      <label class="visually-hidden" for="sortBy">Sort contracts by</label>
      <select
        id="sortBy"
        class="form-select form-select-sm w-auto"
        aria-label="Sort contracts by"
        title="Sort contracts by"
      >
        <option value="created_at_desc" selected>Newest</option>
        <option value="price_per_ton_asc">Price ‚Üë</option>
        <option value="price_per_ton_desc">Price ‚Üì</option>
        <option value="weight_tons_desc">Tons ‚Üì</option>
      </select>

      <div class="small text-muted ms-auto" id="unitBadge">Units: US short tons ‚Ä¢ Currency: USD</div>
    </div>

    <!-- RFQ (two-click) -->
    <div class="cardy" id="rfqCard">
      <div class="d-flex gap-2 align-items-end maxw-620">
        <div class="flex-grow-1">
          <label class="form-label mb-1" for="rfqSym">Symbol</label>
          <select id="rfqSym" class="form-select">
            <option>CU-SHRED-1M</option>
            <option>AL-6061-1M</option>
          </select>
        </div>
        <div class="maxw-140">
          <label class="form-label mb-1" for="rfqSide">Side</label>
          <select id="rfqSide" class="form-select">
            <option>buy</option>
            <option>sell</option>
          </select>
        </div>
        <div class="maxw-160">
          <label class="form-label mb-1" for="rfqQty">Qty (lots)</label>
          <input id="rfqQty" class="form-control" type="number" placeholder="e.g. 5" min="0.01" step="0.01" />
        </div>
        <div>
          <span class="form-label mb-1 vis-hidden-label" aria-hidden="true">&nbsp;</span>
          <button id="rfqGo" class="btn btn-primary" type="button">RFQ</button>
        </div>
      </div>
    </div>

    <!-- Live region for loading text (a11y) -->
    <div id="loadingStatus" class="visually-hidden" role="status" aria-live="polite"></div>

    <div id="list" aria-busy="false"></div>

    <div class="d-flex gap-2 mt-2 align-items-center">
      <button class="btn btn-secondary btn-sm" id="prevBtn" type="button" aria-label="Previous page">‚óÄ Prev</button>
      <button class="btn btn-secondary btn-sm" id="nextBtn" type="button" aria-label="Next page">Next ‚ñ∂</button>
      <label class="small text-muted mb-0" for="pageSize">Rows:</label>
      <select id="pageSize" class="form-select form-select-sm w-auto">
        <option>25</option>
        <option selected>100</option>
        <option>200</option>
      </select>
      <span class="small text-muted" id="pageInfo" aria-live="polite"></span>
    </div>
  </div>

  <script nonce="{{NONCE}}">
    // Cookie reader for CSRF etc.
    function _cookie(name) {
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    // Toast helper
    function toast(msg, ms = 2800) {
      const wrap = document.getElementById('toast');
      const msgEl = document.getElementById('toastMsg');
      const text = typeof msg === 'string' ? msg : (msg?.message || 'Error');
      if (!wrap || !msgEl) { alert(text); return; }
      msgEl.textContent = text; // safe text only
      wrap.classList.add('show');
      try { wrap.focus(); } catch {}
      setTimeout(() => { wrap.classList.remove('show'); }, ms);
    }

    // Close toast via delegated click (no inline handlers)
    document.addEventListener('click', (e) => {
      if (e.target && e.target.classList.contains('toast-close')) {
        const t = e.target.closest('.toast-bridge');
        if (t) t.classList.remove('show');
      }
    });

    // Unified endpoint + fetch wrapper with CSRF + 401 redirect
    let __inflight = new Map();
    async function api(path, opts = {}) {
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;

      // abort same-URL inflight to avoid piling up when user types filters
      if (__inflight.has(url)) { try { __inflight.get(url).abort(); } catch {} }
      const ctl = new AbortController(); __inflight.set(url, ctl);
      const to = setTimeout(() => ctl.abort(), 9000);

      const method = (opts.method || 'GET').toUpperCase();
      const headers = { Accept: 'application/json', ...(opts.headers || {}) };
      if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
        headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
      }

      try {
        const res = await fetch(url, { credentials: 'include', ...opts, signal: ctl.signal, headers });
        if (res.status === 401) {
          const next = encodeURIComponent(location.pathname + location.search);
          location.href = `/static/bridge-login.html?next=${next}`;
          throw new Error('Unauthorized');
        }
        if (!res.ok) {
          let m = 'Request failed';
          try { m = (await res.clone().json()).detail || m; }
          catch { try { m = await res.clone().text() || m; } catch {} }
          toast(m);
          throw new Error(m);
        }
        return res;
      } finally {
        clearTimeout(to);
        __inflight.delete(url);
      }
    }

    // Health badge + auth banner
    onReady(async () => {
      const hb = document.querySelector('[data-health-badge]');
      const banner = document.getElementById('authBanner');
      const msg = document.getElementById('authMsg');

      try {
        let ok = false;
        try { ok = (await api('/health')).ok; } catch {}
        if (!ok) { try { ok = (await api('/healthz')).ok; } catch {} }
        if (ok) { hb?.setAttribute('data-ok', '1'); if (hb) hb.textContent = '‚óè Live'; }
        else {
          hb?.removeAttribute('data-ok'); if (hb) hb.textContent = '‚óè Degraded';
          if (banner && msg) { banner.style.display = 'block'; msg.textContent = 'Service degraded'; }
        }
      } catch {
        hb?.removeAttribute('data-ok'); if (hb) hb.textContent = '‚óè Degraded';
        if (banner && msg) { banner.style.display = 'block'; msg.textContent = 'Service degraded'; }
      }

      try {
        const r = await api('/me'); const j = await r.json();
        if (!j?.username) {
          if (banner && msg) { banner.style.display = 'block'; msg.textContent = 'Not logged in'; }
        }
      } catch {
        if (banner && msg) { banner.style.display = 'block'; msg.textContent = 'Auth unknown'; }
      }
    });
  </script>

  <script nonce="{{NONCE}}">
  function wireQuickQuote(){
    const btn  = document.getElementById('qGo');
    const mat  = document.getElementById('qMaterial');
    const tons = document.getElementById('qTons');
    const out  = document.getElementById('qOut');
    if(!btn || !mat || !tons || !out) return;

    btn.onclick = async () => {
      const m = (mat.value||'').trim();
      const t = Number(tons.value||0);
      if(!m || !(t>0)){ out.textContent = 'Enter a material and tons.'; return; }
      out.textContent = 'Quoting‚Ä¶';
      try{
        const r = await api(`/pricing/quote?material=${encodeURIComponent(m)}&tons=${encodeURIComponent(t)}`);
        const j = await r.json();
        const perTon = (j.price_per_ton ?? (j.price_per_lb && j.price_per_lb*2000)) || null;
        out.textContent = perTon ? `${j.material||m}: $${perTon.toFixed(2)}/ton` : 'No quote available.';
      }catch{
        out.textContent = 'Quote failed.';
      }
    };
  }
  </script>

  <script nonce="{{NONCE}}">
    const endpoint = window.endpoint;
    let offset = 0, limit = 100;        // pagination
    let sortBy = 'created_at_desc';
    let loadCtl = null;                 // AbortController for overlapping loads
    let paused = false;

    // ---- Timezone toggle (UTC vs local) ----
    let useUTC = localStorage.getItem('buyer.useUTC') === '1';

    // Buyer/member context (from bridgeUser blob set at login)
    const storedUser = (() => {
      try { return JSON.parse(localStorage.getItem('bridgeUser') || '{}'); }
      catch { return {}; }
    })();

    // Best-effort mapping; adjust in backend or login writer if needed
    let buyerKey  = storedUser.buyer  || storedUser.member || storedUser.org || storedUser.company || storedUser.username || '';
    let memberKey = storedUser.member || storedUser.org    || storedUser.company || buyerKey || '';

    // Ensure buyer context, even if bridgeUser is empty
    async function ensureBuyerContext() {
      if (buyerKey && memberKey) return true;

      try {
        const r = await api('/me');
        const j = await r.json();
        const u = (j.username || '').toLowerCase();

        // Hard mappings for your real accounts
        if (u === 'anthony.priority' || u === 'anthony@priorityrecycling.com') {
          buyerKey = memberKey = 'Priority Recycling';
        } else if (u === 'alex.farnsworth' || u === 'alex@farnsworthmetals.com') {
          buyerKey = memberKey = 'Farnsworth Metals';
        } else if (u) {
          // Generic fallback: turn "anthony.priority" into "Anthony Priority"
          const base = u.split('@')[0].replace(/[._-]+/g, ' ').trim();
          const orgGuess = base ? base.replace(/\b\w/g, c => c.toUpperCase()) : j.username;
          buyerKey = buyerKey || orgGuess || j.username || '';
          memberKey = memberKey || orgGuess || j.username || '';
        }

        // Persist back into bridgeUser so next page load is instant
        const merged = {
          ...(storedUser || {}),
          username: j.username || storedUser.username || '',
          role: j.role || storedUser.role || '',
          buyer: buyerKey,
          member: memberKey,
          org: memberKey
        };
        try { localStorage.setItem('bridgeUser', JSON.stringify(merged)); } catch {}
      } catch {
        // If /me fails, fall through and report "no context"
      }

      return !!buyerKey;
    }

    function _formatTons(v) {
      const n = Number(v || 0);
      if (!isFinite(n) || !n) return '‚Äî';
      return n.toLocaleString(undefined, { maximumFractionDigits: 2 });
    }

    function _fmtDate(d) {
      const dt = new Date(d);
      return useUTC
        ? dt.toLocaleString('en-US', { timeZone: 'UTC', timeZoneName: 'short' })
        : dt.toLocaleString();
    }

    function _renderTZHint() {
      const el = document.getElementById('tzHint');
      if (!el) return;
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
      el.innerHTML = `Times shown in <b>${useUTC ? 'UTC' : tz}</b> ‚Ä¢ <a href="#" id="toggleTZ">${useUTC ? 'Use local' : 'Use UTC'}</a>`;
      document.getElementById('toggleTZ')?.addEventListener('click', (e) => {
        e.preventDefault();
        useUTC = !useUTC;
        localStorage.setItem('buyer.useUTC', useUTC ? '1' : '0');
        _renderTZHint();
        loadOpenContracts();
      });
    }
    onReady(_renderTZHint);
    // ---- /Timezone toggle ----

    function currentRole() {
      try { return (JSON.parse(localStorage.getItem('bridgeUser') || '{}').role || '').toLowerCase(); }
      catch { return ''; }
    }

    function debounce(fn, ms = 250) {
      let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
    }

    // ---- Buyer-side widgets: positions, BOLs, billing, market ----
    async function loadBuyerPositions() {
      const body = document.getElementById('buyerPositionsBody');
      if (!body) return;

      if (!(await ensureBuyerContext())) {
        body.textContent = 'No buyer context detected. Log in again or contact support.';
        return;
      }

      body.textContent = 'Loading positions‚Ä¶';
      try {
        const res = await api(`/buyer_positions?buyer=${encodeURIComponent(buyerKey)}`);
        const rows = await res.json();
        if (!Array.isArray(rows) || rows.length === 0) {
          body.textContent = 'No open positions yet.';
          return;
        }

        const ul = document.createElement('ul');
        ul.className = 'list-unstyled mb-0';

        rows.slice(0, 10).forEach(p => {
          const li = document.createElement('li');
          li.className = 'small mb-1';
          const sym = p.symbol || p.material || p.sku || 'Position';
          const tons = _formatTons(p.net_tons ?? p.quantity_tons ?? p.weight_tons);
          const avg = Number(p.avg_price_per_ton ?? p.price_per_ton ?? p.last_price_per_ton ?? 0);
          const avgStr = avg
            ? `$${avg.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}/ton`
            : '‚Äî';
          const status = (p.status || p.side || '').toString();
          li.textContent = `${sym} ¬∑ ${tons} tons${avg ? ' @ ' + avgStr : ''}${status ? ' ¬∑ ' + status : ''}`;
          ul.appendChild(li);
        });

        body.innerHTML = '';
        body.appendChild(ul);

        if (rows.length > 10) {
          const more = document.createElement('div');
          more.className = 'small text-muted mt-1';
          more.textContent = `Showing first 10 of ${rows.length} positions.`;
          body.appendChild(more);
        }
      } catch {
        body.textContent = 'Could not load positions.';
      }
    }

    async function loadBuyerBols() {
      const body = document.getElementById('buyerBolsBody');
      if (!body) return;

      if (!(await ensureBuyerContext())) {
        body.textContent = 'No buyer context detected. Log in again or contact support.';
        return;
      }

      body.textContent = 'Loading BOLs‚Ä¶';
      try {
        const res = await api(`/bols?buyer=${encodeURIComponent(buyerKey)}`);
        const rows = await res.json();
        if (!Array.isArray(rows) || rows.length === 0) {
          body.textContent = 'No BOLs found for this buyer.';
          return;
        }

        const table = document.createElement('table');
        table.className = 'table table-sm mb-0 align-middle';

        const thead = document.createElement('thead');
        thead.innerHTML = '<tr><th>BOL</th><th>Status</th><th>Weight (t)</th><th>Updated</th><th>PDF</th></tr>';
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        rows.slice(0, 10).forEach(b => {
          const tr = document.createElement('tr');

          const idCell = document.createElement('td');
          const bolId = b.bol_id ?? b.id ?? '‚Äî';
          idCell.textContent = bolId;

          const statusCell = document.createElement('td');
          statusCell.textContent = b.status || '‚Äî';

          const wtCell = document.createElement('td');
          wtCell.textContent = _formatTons(b.weight_tons ?? b.gross_tons ?? b.net_tons);

          const ts = b.updated_at || b.delivered_at || b.created_at;
          const tsCell = document.createElement('td');
          tsCell.textContent = ts ? _fmtDate(ts) : '‚Äî';

          const pdfCell = document.createElement('td');
          if (bolId && bolId !== '‚Äî') {
            const a = document.createElement('a');
            a.className = 'btn btn-sm btn-outline-secondary';
            a.textContent = 'PDF';
            a.href = `${window.endpoint}/bol/${encodeURIComponent(bolId)}/pdf`;
            a.target = '_blank';
            a.rel = 'noopener noreferrer';
            pdfCell.appendChild(a);
          } else {
            pdfCell.textContent = '‚Äî';
          }

          tr.append(idCell, statusCell, wtCell, tsCell, pdfCell);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);

        body.innerHTML = '';
        body.appendChild(table);

        if (rows.length > 10) {
          const more = document.createElement('div');
          more.className = 'small text-muted mt-1';
          more.textContent = `Showing first 10 of ${rows.length} BOLs.`;
          body.appendChild(more);
        }
      } catch {
        body.textContent = 'Could not load BOLs.';
      }
    }

    async function loadBuyerBilling() {
      const body = document.getElementById('buyerBillingBody');
      if (!body) return;

      if (!(await ensureBuyerContext())) {
        body.textContent = 'No member context detected. Billing may not be available.';
        return;
      }

      body.textContent = 'Loading billing summary‚Ä¶';
      try {
        const res = await api(`/billing/member_summary?member=${encodeURIComponent(memberKey)}`);
        const j = await res.json();

        const plan   = j.plan_name || j.plan || j.tier || '‚Äî';
        const status = j.status || j.state || '';
        const limitTons = j.contract_limit_tons ?? j.included_tons_per_month ?? null;
        const usedTons  = j.used_tons_this_month ?? j.consumed_tons ?? null;
        const nextInvoice = j.next_invoice_date || j.next_bill_at || '';
        const lastAmt = j.last_invoice_amount ?? j.last_amount ?? null;
        const cur = j.currency || 'USD';

        const frag = document.createDocumentFragment();
        const mkLine = (label, value) => {
          if (value == null || value === '') return;
          const div = document.createElement('div');
          div.className = 'small';
          div.textContent = `${label}: ${value}`;
          frag.appendChild(div);
        };

        mkLine('Plan', plan);
        mkLine('Status', status);
        if (limitTons != null) mkLine('Tons/month included', _formatTons(limitTons));
        if (usedTons != null) mkLine('Tons used this month', _formatTons(usedTons));
        if (nextInvoice) mkLine('Next invoice', nextInvoice);
        if (lastAmt != null) {
          mkLine('Last invoice amount', `${cur} ${Number(lastAmt).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);
        }

        if (!frag.childNodes.length) mkLine('Billing', 'No billing summary available.');

        body.innerHTML = '';
        body.appendChild(frag);
      } catch {
        body.textContent = 'Could not load billing summary.';
      }
    }

    async function loadMarketSnapshot() {
      const body = document.getElementById('buyerMarketBody');
      if (!body) return;
      body.textContent = 'Loading market snapshot‚Ä¶';
      try {
        const [idxRes, cuRes] = await Promise.allSettled([
          api('/indices/latest?symbol=' + encodeURIComponent('BR-CU-#1')),
          api('/prices/copper_last')
        ]);

        const lines = [];

        if (idxRes.status === 'fulfilled') {
          const j = await idxRes.value.json();
          const primary = Array.isArray(j) ? j[0] : j;
          if (primary) {
            const name = primary.name || primary.index || 'Scrap Index';
            const val  = primary.value ?? primary.level ?? null;
            if (val != null) lines.push(`${name}: ${Number(val).toLocaleString(undefined, { maximumFractionDigits: 2 })}`);
          }
        }

        if (cuRes.status === 'fulfilled') {
          const j = await cuRes.value.json();
          const last = Number(j.last ?? j.price ?? j.value ?? 0);
          const chg  = Number(j.change ?? j.change_abs ?? 0);
          if (Number.isFinite(last) && last) {
            let s = `BR-CU (Copper) $${last.toLocaleString(undefined, { maximumFractionDigits: 4 })}/lb`;
            if (Number.isFinite(chg) && chg !== 0) {
              const sign = chg > 0 ? '+' : '';
              s += ` (${sign}${chg.toFixed(4)})`;
            }
            lines.push(s);
          }
        }

        if (!lines.length) {
          body.textContent = 'No market data available.';
          return;
        }

        body.innerHTML = '';
        const ul = document.createElement('ul');
        ul.className = 'list-unstyled mb-0';
        for (const l of lines) {
          const li = document.createElement('li');
          li.className = 'small mb-1';
          li.textContent = l;
          ul.appendChild(li);
        }
        body.appendChild(ul);
      } catch {
        body.textContent = 'Could not load market data.';
      }
    }
    // ---- /Buyer-side widgets ----

    // ---- Buyer BOL Manager (attachments, disputes, payouts, tags, receive) ----
    function _bmVals() {
      const bol = (document.getElementById('bmBolId')?.value || '').trim();
      const cid = (document.getElementById('bmContractId')?.value || '').trim();
      return { bol, cid };
    }

    async function bmRefresh() {
      const { bol, cid } = _bmVals();
      if (!bol) { toast('Enter BOL ID'); return; }

      // attachments
      try {
        const r = await api(`/attachments/bols/${encodeURIComponent(bol)}`);
        const rows = await r.json();
        const el = document.getElementById('bmAttachList');
        if (!rows?.length) { el.textContent = 'No attachments yet.'; }
        else {
          const ul = document.createElement('ul'); ul.className = 'list-unstyled mb-0';
          rows.forEach(a => {
            const li = document.createElement('li');
            const when = a.created_at ? _fmtDate(a.created_at) : '';
            li.innerHTML = `${a.kind || 'file'} ‚Äì <a href="${a.url}" target="_blank" rel="noopener">${a.url}</a> ${when ? ' ¬∑ ' + when : ''}`;
            ul.appendChild(li);
          });
          el.innerHTML = ''; el.appendChild(ul);
        }
      } catch { document.getElementById('bmAttachList').textContent = 'Failed to load attachments.'; }

      // disputes (entity: bol)
      try {
        const r = await api(`/disputes?entity_type=bol&entity_id=${encodeURIComponent(bol)}&limit=50`);
        const rows = await r.json();
        const el = document.getElementById('bmDisputeList');
        if (!rows?.length) el.textContent = 'No disputes yet.';
        else {
          const ul = document.createElement('ul'); ul.className = 'list-unstyled mb-0';
          rows.forEach(d => {
            const when = d.created_at ? _fmtDate(d.created_at) : '';
            ul.innerHTML += `<li>${d.status || 'open'} ‚Äî ${d.reason || ''} ${when ? ' ¬∑ ' + when : ''}</li>`;
          });
          el.innerHTML = ''; el.appendChild(ul);
        }
      } catch { document.getElementById('bmDisputeList').textContent = 'Failed to load disputes.'; }

      // tags (entity: bol)
      try {
        const r = await api(`/tags?entity_type=bol&entity_id=${encodeURIComponent(bol)}`);
        const rows = await r.json();
        const el = document.getElementById('bmTagList');
        if (!rows?.length) el.textContent = 'No tags yet.';
        else {
          el.textContent = rows.map(t => t.tag).join(', ');
        }
      } catch { document.getElementById('bmTagList').textContent = 'Failed to load tags.'; }

      // payouts (needs contract id)
      try {
        const el = document.getElementById('bmPayoutList');
        if (!cid) { el.textContent = 'Enter Contract ID to view payouts.'; }
        else {
          const r = await api(`/payouts?contract_id=${encodeURIComponent(cid)}&limit=50`);
          const rows = await r.json();
          if (!rows?.length) el.textContent = 'No payouts found.';
          else {
            const ul = document.createElement('ul'); ul.className = 'list-unstyled mb-0';
            rows.forEach(p => {
              const when = p.created_at ? _fmtDate(p.created_at) : '';
              ul.innerHTML += `<li>${p.status || 'pending'} ‚Äî $${Number(p.amount_usd || 0).toFixed(2)} ‚Üí ${p.payee || ''}${when ? ' ¬∑ ' + when : ''}</li>`;
            });
            el.innerHTML = ''; el.appendChild(ul);
          }
        }
      } catch { document.getElementById('bmPayoutList').textContent = 'Failed to load payouts.'; }
    }

    async function bmUpload() {
      const { bol } = _bmVals();
      const file = document.getElementById('bmFile')?.files?.[0];
      const kind = document.getElementById('bmFileKind')?.value || 'photo';
      if (!bol || !file) { toast('BOL + file required'); return; }
      const fd = new FormData();
      fd.append('file', file);
      fd.append('kind', kind);
      await api(`/attachments/bols/${encodeURIComponent(bol)}`, { method: 'POST', body: fd });
      toast('Attachment uploaded');
      bmRefresh();
      try { document.getElementById('bmFile').value = ''; } catch {}
    }

    async function bmOpenDispute() {
      const { bol } = _bmVals();
      const reason = (document.getElementById('bmDisputeReason')?.value || '').trim();
      const notes  = (document.getElementById('bmDisputeNotes')?.value || '').trim();
      if (!bol || !reason) { toast('BOL + reason required'); return; }
      await api('/disputes', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ entity_type: 'bol', entity_id: bol, reason, notes })
      });
      toast('Dispute opened');
      bmRefresh();
    }

    async function bmReceive() {
      const { bol } = _bmVals();
      if (!bol) { toast('Enter BOL ID'); return; }
      if (!confirm('Mark this BOL Delivered and post a receipt?')) return;
      await api('/buyer/inventory/receive', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ bol_id: bol, notes: 'buyer receive via UI' })
      });
      toast('BOL marked Delivered');
      bmRefresh();
      // keep widgets in sync
      loadBuyerBols();
      loadBuyerPositions();
    }

    async function bmCreatePayout() {
      const { cid } = _bmVals();
      const payee = (document.getElementById('bmPayee')?.value || '').trim();
      const amt   = Number(document.getElementById('bmPayoutAmt')?.value || 0);
      if (!cid || !payee || !(amt > 0)) { toast('Contract ID, payee, and amount are required'); return; }
      await api('/payouts', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ contract_id: cid, payee, amount_usd: amt })
      });
      toast('Payout created');
      bmRefresh();
    }

    async function bmAddTag() {
      const { bol } = _bmVals();
      const tag = (document.getElementById('bmTag')?.value || '').trim();
      if (!bol || !tag) { toast('BOL + tag required'); return; }
      await api('/tags', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ entity_type:'bol', entity_id: bol, tag })
      });
      toast('Tag added'); bmRefresh();
    }

    async function bmDelTag() {
      const { bol } = _bmVals();
      const tag = (document.getElementById('bmTag')?.value || '').trim();
      if (!bol || !tag) { toast('BOL + tag required'); return; }
      await api(`/tags?entity_type=bol&entity_id=${encodeURIComponent(bol)}&tag=${encodeURIComponent(tag)}`, { method:'DELETE' });
      toast('Tag removed'); bmRefresh();
    }

    // Wire BOL manager buttons
    onReady(() => {
      document.getElementById('bmRefresh')?.addEventListener('click', bmRefresh);
      document.getElementById('bmUpload')?.addEventListener('click', bmUpload);
      document.getElementById('bmOpenDispute')?.addEventListener('click', bmOpenDispute);
      document.getElementById('bmReceive')?.addEventListener('click', bmReceive);
      document.getElementById('bmCreatePayout')?.addEventListener('click', bmCreatePayout);
      document.getElementById('bmAddTag')?.addEventListener('click', bmAddTag);
      document.getElementById('bmDelTag')?.addEventListener('click', bmDelTag);
    });
    // ---- /Buyer BOL Manager ----

    function _syncQuery(params) {
      const u = new URL(location.href);
      for (const [k, v] of Object.entries(params)) {
        if (v === '' || v == null) u.searchParams.delete(k);
        else u.searchParams.set(k, v);
      }
      history.replaceState({}, '', u);
    }

    function setLoadingUI(isLoading) {
      const ids = ['prevBtn', 'nextBtn', 'refreshBtn'];
      ids.forEach(id => {
        const el = document.getElementById(id);
        if (el) { el.disabled = isLoading; el.setAttribute('aria-disabled', String(isLoading)); }
      });
    }

    function rowCard(r) {
      const div = document.createElement('div');
      div.className = 'cardy';

      const left = document.createElement('div');
      const title = document.createElement('h5');
      title.className = 'mb-1';
      title.textContent = r?.material ?? '';
      const seller = document.createElement('div');
      seller.className = 'text-muted small';
      seller.textContent = `Seller: ${r?.seller ?? ''}`;
      const buyer  = document.createElement('div');
      buyer.className = 'text-muted small';
      buyer.textContent = `Buyer: ${r?.buyer ?? ''}`;

      const wt = Number(r?.weight_tons ?? 0);
      const pt = Number(r?.price_per_ton ?? 0);
      const total = wt * pt;

      const cur = (r?.currency || 'USD').toString().toUpperCase();
      const tax = (r?.tax_percent ?? r?.tax_pct);
      const taxStr = (tax !== null && tax !== undefined && !Number.isNaN(Number(tax)))
        ? ` ¬∑ Tax ${Number(tax).toFixed(2)}%`
        : '';

      const line = document.createElement('div');
      line.className = 'small';
      line.textContent =
        `Tons: ${wt} @ ${cur} $${pt}/ton ¬∑ Total ${cur} $${total.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}${taxStr}`;

      const created = document.createElement('div');
      created.className = 'small text-muted';
      if (r?.created_at) created.textContent = `Created: ${_fmtDate(r.created_at)}`;

      left.append(title, seller, buyer, line, created);

      const right = document.createElement('div');
      right.className = 'text-end';
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary btn-sm';
      btn.type = 'button';
      btn.textContent = 'Buy';
      btn.setAttribute('aria-label', `Buy contract ${r?.material || ''} from ${r?.seller || ''}`);
      const canBuy = /^(open|pending)$/i.test(r?.status || '');
      btn.disabled = !canBuy;
      if (canBuy) btn.addEventListener('click', (ev) => buy(ev, r.id));
      right.append(btn);

      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-start';
      row.append(left, right);

      div.append(row);
      return div;
    }

    async function loadOpenContracts() {
      if (loadCtl) loadCtl.abort();
      loadCtl = new AbortController();

      const root = document.getElementById('list');
      const ls = document.getElementById('loadingStatus');
      if (ls) ls.textContent = 'Loading contracts‚Ä¶';
      setLoadingUI(true);
      root.setAttribute('aria-busy', 'true');

      const q = new URLSearchParams({ status: 'Open', limit, offset, sort: sortBy });
      const buyerEl = document.getElementById('buyerFilter');
      const matEl   = document.getElementById('materialFilter');
      const buyerVal = (buyerEl?.value || '').trim();
      const matVal   = (matEl?.value || '').trim();
      if (buyerVal) q.set('buyer', buyerVal);
      if (matVal)   q.set('material', matVal);

      const page = Math.floor(offset / limit) + 1;
      _syncQuery({ buyer: buyerVal || '', material: matVal || '', page, rows: String(limit) });

      try {
        const res  = await api(`/contracts?` + q.toString(), { signal: loadCtl.signal });
        const rows = await res.json();
        const total = +(res.headers.get('X-Total-Count') || 0);

        root.innerHTML = '';
        if (!Array.isArray(rows) || rows.length === 0) {
          const wrap = document.createElement('div');
          wrap.className = 'text-muted';
          wrap.innerHTML = `
            <div>No open contracts.</div>
            <div class="mt-2 d-flex gap-2">
              <button type="button" class="btn btn-sm btn-secondary" id="clearFiltersBtn">Clear filters</button>
              <button type="button" class="btn btn-sm btn-primary" id="reqQuoteBtn">Request Quote</button>
            </div>`;
          root.append(wrap);
          document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
            document.getElementById('buyerFilter').value = '';
            document.getElementById('materialFilter').value = '';
            offset = 0; loadOpenContracts();
          });
          document.getElementById('reqQuoteBtn')?.addEventListener('click', () => {
            const q = document.getElementById('rfqQty'); if (q) { q.focus(); }
            toast('Enter RFQ quantity and submit.');
          });

          const pi = document.getElementById('pageInfo');
          if (pi) pi.textContent = `Showing 0 ‚Ä¢ offset ${offset}`;
          if (ls) ls.textContent = 'Loaded.';
          return;
        }

        const frag = document.createDocumentFragment();
        for (const r of rows) frag.append(rowCard(r));
        root.append(frag);

        const pi = document.getElementById('pageInfo');
        if (pi) {
          pi.textContent = total
            ? `Showing ${rows.length} ‚Ä¢ ${offset + 1}‚Äì${offset + rows.length} of ${total}`
            : `Showing ${rows.length} ‚Ä¢ offset ${offset}`;
        }

        // enable/disable paging buttons based on results/offset
        const prev = document.getElementById('prevBtn');
        const next = document.getElementById('nextBtn');
        if (prev) prev.disabled = (offset <= 0);
        if (next) next.disabled = (rows.length < limit);
      } catch (e) {
        if (e.name !== 'AbortError') { /* api() already toasted */ }
      } finally {
        if (ls) ls.textContent = 'Loaded.';
        loadCtl = null;
        setLoadingUI(false);
        root.setAttribute('aria-busy', 'false');
      }
    }

    async function buy(ev, id) {
      const btn = ev?.currentTarget;
      if (!confirm('Confirm purchase of this contract?')) return;
      if (btn) { btn.disabled = true; btn.textContent = 'Purchasing‚Ä¶'; }
      try {
        const res = await api(`/contracts/${id}/purchase`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Idempotency-Key': (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()))
          },
          body: JSON.stringify({ op: 'purchase' })
        });
        const data = await res.json();
        toast(`Purchased. BOL ${data?.bol_id ?? '‚Äî'} created.`);
        loadOpenContracts();
        // keep buyer widgets in sync after purchase
        loadBuyerPositions();
        loadBuyerBols();
      } catch {
        toast('Purchase failed');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = 'Buy'; }
      }
    }
    window.buy = buy; // expose for inline

    // Wire UI
    document.getElementById('refreshBtn')?.addEventListener('click', () => { offset = 0; loadOpenContracts(); });
    document.getElementById('buyerFilter')?.addEventListener('input', debounce(() => {
      offset = 0;
      localStorage.setItem('buyer.filter.buyer', document.getElementById('buyerFilter').value || '');
      loadOpenContracts();
    }, 250));
    document.getElementById('materialFilter')?.addEventListener('input', debounce(() => {
      offset = 0;
      localStorage.setItem('buyer.filter.material', document.getElementById('materialFilter').value || '');
      loadOpenContracts();
    }, 250));

    document.getElementById('prevBtn')?.addEventListener('click', () => {
      offset = Math.max(0, offset - limit);
      const page = Math.floor(offset / limit) + 1;
      _syncQuery({ page, rows: String(limit) });
      loadOpenContracts();
    });
    document.getElementById('nextBtn')?.addEventListener('click', () => {
      offset += limit;
      const page = Math.floor(offset / limit) + 1;
      _syncQuery({ page, rows: String(limit) });
      loadOpenContracts();
    });

    document.getElementById('sortBy')?.addEventListener('change', e => {
      sortBy = e.target.value; offset = 0;
      localStorage.setItem('buyer.sortBy', sortBy);
      loadOpenContracts();
    });

    document.getElementById('pageSize')?.addEventListener('change', e => {
      const v = Math.max(1, parseInt(e.target.value || '100', 10));
      limit = v;
      offset = 0;
      // keep URL in sync with page size + reset to page 1
      const u = new URL(location.href);
      u.searchParams.set('rows', String(v));
      u.searchParams.set('page', '1');
      history.replaceState({}, '', u);
      loadOpenContracts();
    });

    // Hydrate filters/page from URL on first load
    (function hydrateFromURL() {
      const q = new URL(location.href).searchParams;
      const buyer = q.get('buyer') || localStorage.getItem('buyer.filter.buyer') || '';
      const material = q.get('material') || localStorage.getItem('buyer.filter.material') || '';
      const page = Math.max(1, parseInt(q.get('page') || '1', 10));
      const rows = parseInt(q.get('rows') || '', 10);
      const savedSort = localStorage.getItem('buyer.sortBy') || 'created_at_desc';
      sortBy = savedSort;

      const bf = document.getElementById('buyerFilter'); if (bf) bf.value = buyer;
      const mf = document.getElementById('materialFilter'); if (mf) mf.value = material;
      const sb = document.getElementById('sortBy'); if (sb) sb.value = savedSort;

      if (!Number.isNaN(rows) && rows > 0) {
        limit = rows;
        const ps = document.getElementById('pageSize'); if (ps) ps.value = String(rows);
      }
      offset = (page - 1) * limit;

      const p = localStorage.getItem('buyer.paused') === '1';
      if (p) { paused = true; const pb = document.getElementById('pauseBtn'); if (pb) pb.textContent = 'Resume'; }
    })();

    // Initial load + keep refreshing in the background
    loadOpenContracts();
    onReady(() => {
      // Buyer-facing widgets
      loadBuyerPositions();
      loadBuyerBols();
      loadBuyerBilling();
      loadMarketSnapshot();
    });

    // Refresh every 5 minutes; do NOT clear the table first.
    setInterval(() => {
      if (!paused && !document.hidden) {
        loadOpenContracts();
        // Light refresh of market snapshot; positions/BOLs/billing can stay as-once per load
        loadMarketSnapshot();
      }
    }, 300000);
  </script>

  <script nonce="{{NONCE}}">
    // --- My RFQs (buyer scope) ---
    async function loadMyRfqs() {
      const el = document.getElementById('buyerRfqsBody');
      if (!el) return;
      if (!(await ensureBuyerContext())) { el.textContent = 'No buyer context.'; return; }

      try {
        const r = await api('/rfqs?scope=mine');
        const rows = await r.json();
        if (!rows?.length) { el.textContent = 'No RFQs yet.'; return; }

        const tbl = document.createElement('table');
        tbl.className = 'table table-sm mb-0 align-middle';
        tbl.innerHTML = '<thead><tr><th>ID</th><th>Symbol</th><th>Side</th><th>Lots</th><th>Expires</th></tr></thead>';

        const tb = document.createElement('tbody');
        rows.slice(0, 10).forEach(x => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td class="text-monospace">${x.rfq_id}</td>
            <td>${x.symbol || ''}</td>
            <td>${x.side || ''}</td>
            <td>${Number(x.quantity_lots || 0).toLocaleString()}</td>
            <td>${x.expires_at ? _fmtDate(x.expires_at) : '‚Äî'}</td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);

        el.innerHTML = '';
        el.appendChild(tbl);
      } catch {
        el.textContent = 'Could not load RFQs.';
      }
    }

    // --- Contract History (+ CSV button) ---
    async function loadBuyerHistory() {
      const el = document.getElementById('buyerHistoryBody');
      if (!el) return;
      if (!(await ensureBuyerContext())) { el.textContent = 'No buyer context.'; return; }

      try {
        const base = new URLSearchParams({ buyer: buyerKey, limit: '100', offset: '0', sort: 'created_at_desc' });
        const [a, b] = await Promise.all([
          api('/contracts?' + base + '&status=Signed'),
          api('/contracts?' + base + '&status=Fulfilled')
        ]);
        const rows = [...await a.json(), ...await b.json()]
          .sort((x, y) => new Date(y.created_at) - new Date(x.created_at));
        if (!rows.length) { el.textContent = 'No past contracts.'; return; }

        const tbl = document.createElement('table');
        tbl.className = 'table table-sm mb-0 align-middle';
        tbl.innerHTML = '<thead><tr><th>When</th><th>Material</th><th>Tons</th><th>$ / ton</th><th>Total</th><th>Status</th></tr></thead>';

        const tb = document.createElement('tbody');
        rows.slice(0, 15).forEach(r => {
          const wt = Number(r.weight_tons || 0), pt = Number(r.price_per_ton || 0), tot = wt * pt;
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${_fmtDate(r.created_at)}</td>
            <td>${r.material || ''}</td>
            <td>${_formatTons(wt)}</td>
            <td>$${pt.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>$${tot.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>${r.status || ''}</td>`;
          tb.appendChild(tr);
        });
        tbl.appendChild(tb);

        el.innerHTML = '';
        el.appendChild(tbl);

        const btn = document.getElementById('dlContractsCsv');
        if (btn && !btn._wired) {
          btn._wired = true;
          btn.addEventListener('click', () => {
            const u = new URL(`${window.endpoint}/contracts/export_csv`);
            window.open(u.toString(), '_blank', 'noopener');
          });
        }
      } catch {
        el.textContent = 'Could not load history.';
      }
    }

    // --- Delivery Calendar (upcoming + recent) ---
    async function loadDeliveryCalendar() {
      const el = document.getElementById('buyerCalendarBody');
      if (!el) return;
      if (!(await ensureBuyerContext())) { el.textContent = 'No buyer context.'; return; }

      try {
        const [up, done] = await Promise.all([
          api(`/bols?buyer=${encodeURIComponent(buyerKey)}&status=Scheduled&limit=50`),
          api(`/bols?buyer=${encodeURIComponent(buyerKey)}&status=Delivered&limit=10`)
        ]);
        const upcoming = await up.json();
        const delivered = await done.json();

        const wrap = document.createElement('div');
        const sec = (title, rows, tsKey) => {
          const card = document.createElement('div');
          const h = document.createElement('div');
          h.className = 'fw-bold mb-1';
          h.textContent = title;
          card.appendChild(h);
          if (!rows?.length) { card.appendChild(document.createTextNode('None')); return card; }
          const ul = document.createElement('ul');
          ul.className = 'list-unstyled mb-2';
          rows.slice(0, 8).forEach(b => {
            const ts = b[tsKey] || b.pickup_time || b.delivery_time;
            const li = document.createElement('li');
            li.textContent = `${b.material || ''} ¬∑ ${_formatTons(b.weight_tons)} tons ¬∑ ${_fmtDate(ts)}`;
            ul.appendChild(li);
          });
          card.appendChild(ul);
          return card;
        };
        wrap.appendChild(sec('Upcoming', upcoming, 'pickup_time'));
        wrap.appendChild(sec('Recently Delivered', delivered, 'delivery_time'));

        el.innerHTML = '';
        el.appendChild(wrap);
      } catch {
        el.textContent = 'Could not load schedule.';
      }
    }
      // --- RFQ creator (buyer scope) ---
    function wireRfq() {
      const btn = document.getElementById('rfqGo');
      if (!btn) return;
      btn.onclick = async () => {
        const sym  = (document.getElementById('rfqSym')?.value || '').trim();
        const side = (document.getElementById('rfqSide')?.value || 'buy').trim().toLowerCase();
        const qty  = Number(document.getElementById('rfqQty')?.value || 0);
        if (!sym || !(qty > 0)) { toast('Symbol and quantity required.'); return; }

        try {
          const res = await api('/rfqs', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ symbol: sym, side, quantity_lots: qty })
          });
          const j = await res.json();
          toast(`RFQ posted (${j.rfq_id || 'ok'}).`);
          // Refresh "My RFQs" card
          loadMyRfqs();
        } catch (e) {
          toast(e?.message || 'RFQ failed');
        }
      };
    }
  </script>  

  <!-- Policy Acceptance Modal -->
  <div
    class="modal fade"
    id="policyModal"
    tabindex="-1"
    role="dialog"
    aria-modal="true"
    aria-labelledby="policyModalTitle"
  >
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Policy Update</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" disabled></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2" id="policySummary">
            You must accept the current Terms / Rulebook to continue trading.
          </p>
          <p class="small">
            View full documents:
            <a href="/legal/terms.html" target="_blank" rel="noopener noreferrer">Terms</a> ¬∑
            <a href="/legal/eula.html" target="_blank" rel="noopener noreferrer">EULA</a> ¬∑
            <a href="/legal/fees.html" target="_blank" rel="noopener noreferrer">Fees</a> ¬∑
            <a href="/legal/rulebook.html" target="_blank" rel="noopener noreferrer">Rulebook</a>
          </p>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="policyAgreeChk" />
            <label class="form-check-label small" for="policyAgreeChk">
              I have read and agree to the current Terms, Rulebook, Fee Schedule, and Policies.
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button id="policyAcceptBtn" type="button" class="btn btn-primary" disabled>Accept &amp; Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script
    nonce="{{NONCE}}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
    defer
  ></script>

  <script nonce="{{NONCE}}">
    // Buyer: policy acceptance gating
    (function () {
      async function checkPolicies() {
        try {
          const res = await api('/policies/status');
          const j = await res.json();
          if (j.accepted) return; // nothing to do

          // fetch current policy metadata (optional)
          let summary = 'You must accept the current Terms / Rulebook to continue trading.';
          try {
            const r2 = await api('/policies/current');
            const p = await r2.json();
            if (p && p.version) {
              summary = `You must accept ${p.key || 'the Rulebook'} v${p.version} to continue trading.`;
            }
          } catch {}
          const sEl = document.getElementById('policySummary'); if (sEl) sEl.textContent = summary;

          // show blocking modal
          const modalEl = document.getElementById('policyModal');
          if (!modalEl || !(window.bootstrap && bootstrap.Modal)) return;
          const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });
          modal.show();

          const chk = document.getElementById('policyAgreeChk');
          const btn = document.getElementById('policyAcceptBtn');
          chk?.addEventListener('change', () => { btn.disabled = !chk.checked; });
          btn?.addEventListener('click', async () => {
            btn.disabled = true;
            try {
              await api('/policies/accept', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'rulebook', version: null })
              });
              modal.hide();
              toast('Policy accepted.');
            } catch (e) {
              toast(e.message || 'Could not record acceptance');
              btn.disabled = false;
            }
          });
        } catch {
          // if policy endpoint fails, do nothing; backend will enforce if critical
        }
      }

      onReady(checkPolicies);
      onReady(loadMyRfqs);
      onReady(loadBuyerHistory);
      onReady(loadDeliveryCalendar);
      onReady(wireQuickQuote);
      onReady(wireRfq);
    })();
  </script>

  <footer class="legal-footer">
    <hr class="mb-3" />
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms.html" class="link-secondary" rel="noopener noreferrer">Terms</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>¬∑</span>
      <a href="/legal/eula.html" class="link-secondary" rel="noopener noreferrer">EULA</a><span>¬∑</span>
      <a href="/legal/aup.html" class="link-secondary" rel="noopener noreferrer">AUP</a><span>¬∑</span>
      <a href="/legal/cookies.html" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>¬∑</span>
      <a href="/legal/subprocessors.html" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>¬∑</span>
      <a href="/legal/dpa.html" class="link-secondary" rel="noopener noreferrer">DPA</a><span>¬∑</span>
      <a href="/legal/sla.html" class="link-secondary" rel="noopener noreferrer">SLA</a><span>¬∑</span>
      <a href="/legal/security.html" class="link-secondary" rel="noopener noreferrer">Security</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy Appendix</a><span>¬∑</span>
      <a href="/legal/fees.html" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> ‚Äì Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
</body>
</html>
