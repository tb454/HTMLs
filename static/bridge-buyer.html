<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BRidge Buyer </title>
  <meta name="description" content="Purchase open BRidge contracts, post RFQs, and monitor live inventory and BOLs." />
  <link rel="icon" href="/static/favicon.ico">

  <script nonce="{{NONCE}}">
    function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        try { fn(); } catch(e){ console.error(e); }
      }
    }
    // Mint XSRF cookie immediately so unsafe methods can echo it
    onReady(async () => { try { await fetch('/health', { credentials:'include' }); } catch {} });
  </script>

  <!-- Performance & Integrity -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
    integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM"
    crossorigin="anonymous"
  />
  <link rel="stylesheet" href="/static/app.css">

  <meta name="color-scheme" content="light dark">

  <script id="boot" nonce="{{NONCE}}">
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);
  </script>
  <script src="/static/js/locale.js" defer></script>
</head>
<body>
  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2" style="flex-wrap:wrap">
  <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
  <select id="lang-select" class="form-select form-select-sm" style="width:auto">
    <option value="en">English</option><option value="es">Espa√±ol</option><option value="zh">‰∏≠Êñá</option>
  </select>
  <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
  <input id="tz-select" class="form-control form-control-sm" list="tz-list" placeholder="America/Phoenix" style="width:220px" data-i18n-ph="timezone"/>
  <datalist id="tz-list">
    <option value="America/Phoenix"></option><option value="America/New_York"></option>
    <option value="America/Chicago"></option><option value="America/Los_Angeles"></option>
    <option value="UTC"></option><option value="Europe/London"></option><option value="Asia/Shanghai"></option>
  </datalist>
  <button class="btn btn-outline-secondary btn-sm ms-1" onclick="BRIDGE_LOCALE.save()"><span data-i18n="save">Save</span></button>
  <small class="text-muted ms-auto" id="local-time"></small>
</div>
 
  <a href="#list" class="visually-hidden visually-hidden-focusable">Skip to content</a>

  <!-- Toast (live region) -->
  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1">
    <button type="button" class="toast-close" aria-label="Close notification">&times;</button>

    <span id="toastMsg"></span>
  </div>

  <div class="container">
    <div class="d-flex align-items-center justify-content-between">
      <h2 class="mb-3" data-i18n="buyer_portal">üõí BRidge Buyer Portal</h2>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <!-- Auth/health banner -->
    <div id="authBanner" class="mb-2">
      <strong>Status:</strong> <span id="authMsg">Checking‚Ä¶</span>
      <a href="/static/bridge-login.html" style="margin-left:10px">Re-authenticate</a>
    </div>

    <!-- Compliance cues -->
    <div class="small text-muted mb-2">
      KYC/AML verified ‚Ä¢ Data retention 7y
      ‚Äî <a href="/legal/security">Security</a> ‚Ä¢ <a href="/legal/terms">Terms</a>
    </div>

    <!-- Timezone hint -->
    <div class="small text-muted mb-2" id="tzHint"></div>

    <!-- Controls -->
    <div class="d-flex gap-2 mb-3 align-items-end">
      <div class="flex-grow-1">
        <label class="visually-hidden" for="buyerFilter">Filter buyer</label>
        <input id="buyerFilter" class="form-control form-control-sm" placeholder="Filter buyer (optional)" autocomplete="off">
      </div>
      <div class="flex-grow-1">
        <label class="visually-hidden" for="materialFilter">Filter material/SKU</label>
        <input id="materialFilter" class="form-control form-control-sm" placeholder="Material/SKU (e.g., SHRED, Barley, #1)" autocomplete="off">
      </div>
      <button class="btn btn-secondary btn-sm" id="refreshBtn" type="button">Refresh</button>
      <select id="sortBy" class="form-select form-select-sm" style="width:auto">
        <option value="created_at_desc" selected>Newest</option>
        <option value="price_per_ton_asc">Price ‚Üë</option>
        <option value="price_per_ton_desc">Price ‚Üì</option>
        <option value="weight_tons_desc">Tons ‚Üì</option>
      </select>

      <div class="small text-muted ms-auto" id="unitBadge">
        Units: US short tons ‚Ä¢ Currency: USD
      </div>
    </div>

    <!-- RFQ (two-click) -->
    <div class="cardy" id="rfqCard">
      <div class="d-flex gap-2 align-items-end maxw-620">
        <div style="flex:1">
          <label class="form-label mb-1" for="rfqSym">Symbol</label>
          <select id="rfqSym" class="form-select">
            <option>CU-SHRED-1M</option>
            <option>AL-6061-1M</option>
          </select>
        </div>
        <div class="maxw-140">
          <label class="form-label mb-1" for="rfqSide">Side</label>
          <select id="rfqSide" class="form-select">
            <option>buy</option>
            <option>sell</option>
          </select>
        </div>
        <div class="maxw-160">
          <label class="form-label mb-1" for="rfqQty">Qty (lots)</label>
          <input id="rfqQty" class="form-control" type="number" placeholder="e.g. 5" min="0.01" step="0.01">
        </div>
        <div>
          <label class="form-label mb-1 vis-hidden-label">.</label>
          <button id="rfqGo" class="btn btn-primary" type="button">RFQ</button>
        </div>
      </div>
    </div>

    <!-- live region for loading text (a11y) -->
    <div id="loadingStatus" class="visually-hidden" role="status" aria-live="polite"></div>

    <div id="list" aria-busy="false"></div>

    <div class="d-flex gap-2 mt-2 align-items-center">
      <button class="btn btn-secondary btn-sm" id="prevBtn" type="button" aria-label="Previous page">‚óÄ Prev</button>
      <button class="btn btn-secondary btn-sm" id="nextBtn" type="button" aria-label="Next page">Next ‚ñ∂</button>
      <label class="small text-muted mb-0" for="pageSize">Rows:</label>
      <select id="pageSize" class="form-select form-select-sm" style="width:auto">
        <option>25</option><option selected>100</option><option>200</option>
      </select>
      <span class="small text-muted" id="pageInfo" aria-live="polite"></span>
    </div>
  </div>

  <script nonce="{{NONCE}}">
    // Cookie reader for CSRF etc.
    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }
    // Unified endpoint (already set in boot) and helpers
    function toast(msg, ms=2800){
      const wrap = document.getElementById('toast');
      const msgEl = document.getElementById('toastMsg');
      const text = typeof msg === 'string' ? msg : (msg?.message || 'Error');
      if (!wrap || !msgEl){ alert(text); return; }
      msgEl.textContent = text; // safe text only
      wrap.classList.add('show');
      try{ wrap.focus(); }catch{}
      setTimeout(()=>{ wrap.classList.remove('show'); }, ms);
    }

    // Close toast via delegated click (no inline handlers)
    document.addEventListener('click', (e)=>{
      if (e.target && e.target.classList.contains('toast-close')) {
        const t = e.target.closest('.toast-bridge');
        if (t) t.classList.remove('show');
      }
    });

    let __inflight = new Map();
    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;

      // abort same-URL inflight to avoid piling up when user types filters
      if (__inflight.has(url)) { try { __inflight.get(url).abort(); } catch{} }
      const ctl = new AbortController(); __inflight.set(url, ctl);
      const to = setTimeout(()=>ctl.abort(), 9000);

      const method = (opts.method || 'GET').toUpperCase();
      const headers = { Accept:'application/json', ...(opts.headers||{}) };
      if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
        headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
      }

      try{
        const res = await fetch(url, { credentials:'include', ...opts, signal: ctl.signal, headers });
        if (res.status === 401) {
          const next = encodeURIComponent(location.pathname + location.search);
          location.href = `/static/bridge-login.html?next=${next}`;
          throw new Error('Unauthorized');
        }
        if (!res.ok) {
          let m='Request failed';
          try { m=(await res.clone().json()).detail||m; } catch { try { m=await res.clone().text()||m; } catch{} }
          toast(m);
          throw new Error(m);
        }
        return res;
      } finally {
        clearTimeout(to);
        __inflight.delete(url);
      }
    }

    // Health badge
    onReady(async ()=>{
      const hb = document.querySelector('[data-health-badge]');
      const banner = document.getElementById('authBanner');
      const msg = document.getElementById('authMsg');

      try{
        let ok=false;
        try { ok = (await api('/health')).ok; } catch {}
        if (!ok) { try { ok = (await api('/healthz')).ok; } catch {} }
        if (ok){ hb?.setAttribute('data-ok','1'); if(hb) hb.textContent='‚óè Live'; }
        else {
          hb?.removeAttribute('data-ok'); if(hb) hb.textContent='‚óè Degraded';
          if (banner && msg){ banner.style.display='block'; msg.textContent = 'Service degraded'; }
        }
      }catch{
        hb?.removeAttribute('data-ok'); if(hb) hb.textContent='‚óè Degraded';
        if (banner && msg){ banner.style.display='block'; msg.textContent = 'Service degraded'; }
      }

      try{
        const r = await api('/me'); const j = await r.json();
        if (!j?.username){
          if (banner && msg){ banner.style.display='block'; msg.textContent = 'Not logged in'; }
        }
      }catch{
        if (banner && msg){ banner.style.display='block'; msg.textContent = 'Auth unknown'; }
      }
    });
  </script>

  <script nonce="{{NONCE}}">
    const endpoint = window.endpoint;
    let offset = 0, limit = 100; // pagination
    let sortBy = 'created_at_desc';
    let loadCtl = null;          // AbortController for overlapping loads
    let refreshTimer = null;     // interval handle
    let paused = false;

    // ---- Timezone toggle (UTC vs local) ----
    let useUTC = localStorage.getItem('buyer.useUTC') === '1';

    function _fmtDate(d){
      const dt = new Date(d);
      return useUTC
        ? dt.toLocaleString('en-US', { timeZone:'UTC', timeZoneName:'short' })
        : dt.toLocaleString();
    }

    function _renderTZHint(){
      const el = document.getElementById('tzHint');
      if (!el) return;
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
      el.innerHTML = `Times shown in <b>${useUTC ? 'UTC' : tz}</b> ‚Ä¢ <a href="#" id="toggleTZ">${useUTC ? 'Use local' : 'Use UTC'}</a>`;
      document.getElementById('toggleTZ')?.addEventListener('click', (e)=>{
        e.preventDefault();
        useUTC = !useUTC;
        localStorage.setItem('buyer.useUTC', useUTC ? '1':'0');
        _renderTZHint();
        loadOpenContracts();
      });
    }
    onReady(_renderTZHint);
    // ---- /Timezone toggle ----

    function currentRole(){
      try{ return (JSON.parse(localStorage.getItem('bridgeUser')||'{}').role||'').toLowerCase(); }
      catch{ return ''; }
    }

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function showSkeletonCards(n=5){
      const root = document.getElementById('list');
      root.innerHTML = '';
      for(let i=0;i<n;i++){
        const div = document.createElement('div');
        div.className = 'cardy';
        const row = document.createElement('div'); row.className='d-flex justify-content-between align-items-start';
        const left = document.createElement('div'); left.style.flex='1'; left.style.paddingRight='12px';
        const s1 = document.createElement('div'); s1.className='skeleton'; s1.style.cssText='width:40%;margin-bottom:10px;';
        const s2 = document.createElement('div'); s2.className='skeleton'; s2.style.cssText='width:60%;margin-bottom:8px;';
        const s3 = document.createElement('div'); s3.className='skeleton'; s3.style.cssText='width:55%;margin-bottom:6px;';
        const s4 = document.createElement('div'); s4.className='skeleton'; s4.style.cssText='width:50%;';
        left.append(s1,s2,s3,s4);
        const right = document.createElement('div'); right.style.width='90px';
        const s5 = document.createElement('div'); s5.className='skeleton'; right.append(s5);
        row.append(left,right); div.append(row); root.append(div);
      }
    }

    function _syncQuery(params){
      const u = new URL(location.href);
      for (const [k,v] of Object.entries(params)){
        if (v === '' || v == null) u.searchParams.delete(k);
        else u.searchParams.set(k, v);
      }
      history.replaceState({}, '', u);
    }

    function setLoadingUI(isLoading){
      const ids = ['prevBtn','nextBtn','refreshBtn'];
      ids.forEach(id=>{
        const el = document.getElementById(id);
        if (el){ el.disabled = isLoading; el.setAttribute('aria-disabled', String(isLoading)); }
      });
    }

    function rowCard(r){
      const div = document.createElement('div');
      div.className = 'cardy';

      const left = document.createElement('div');
      const title = document.createElement('h5'); title.className='mb-1'; title.textContent = r?.material ?? '';
      const seller = document.createElement('div'); seller.className='text-muted small'; seller.textContent = `Seller: ${r?.seller ?? ''}`;
      const buyer  = document.createElement('div'); buyer .className='text-muted small'; buyer .textContent = `Buyer: ${r?.buyer ?? ''}`;

      const wt = Number(r?.weight_tons ?? 0);
      const pt = Number(r?.price_per_ton ?? 0);
      const total = wt * pt;
      const line = document.createElement('div'); line.className='small';
      line.textContent = `Tons: ${wt} @ $${pt}/ton ¬∑ Total $${total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`;

      const created = document.createElement('div'); created.className='small text-muted';
      if (r?.created_at) created.textContent = `Created: ${_fmtDate(r.created_at)}`;

      left.append(title, seller, buyer, line, created);

      const right = document.createElement('div'); right.className='text-end';
      const btn = document.createElement('button');
      btn.className = 'btn btn-primary btn-sm';
      btn.type = 'button';
      btn.textContent = 'Buy';
      btn.setAttribute('aria-label', `Buy contract ${r?.material||''} from ${r?.seller||''}`);
      btn.addEventListener('click', (ev)=> buy(ev, r.id));
      right.append(btn);

      const row = document.createElement('div');
      row.className = 'd-flex justify-content-between align-items-start';
      row.append(left, right);

      div.append(row);
      return div;
    }

    async function loadOpenContracts(){
      if (loadCtl) loadCtl.abort();
      loadCtl = new AbortController();

      const root = document.getElementById('list');
      const ls = document.getElementById('loadingStatus');
      if (ls) ls.textContent = 'Loading contracts‚Ä¶';
      setLoadingUI(true);
      root.setAttribute('aria-busy','true');
      showSkeletonCards(5);

      const q = new URLSearchParams({ status: 'Pending', limit, offset, sort: sortBy });
      const buyerEl = document.getElementById('buyerFilter');
      const matEl   = document.getElementById('materialFilter');
      const buyerVal = (buyerEl?.value || '').trim();
      const matVal   = (matEl?.value || '').trim();
      if (buyerVal) q.set('buyer', buyerVal);
      if (matVal)   q.set('material', matVal);

      const page = Math.floor(offset/limit)+1;
      _syncQuery({ buyer: buyerVal || '', material: matVal || '', page, rows: String(limit) });

      try{
        const res  = await api(`/contracts?` + q.toString(), { signal: loadCtl.signal });
        const rows = await res.json();
        const total = +(res.headers.get('X-Total-Count')||0);

        root.innerHTML = '';
        if (!Array.isArray(rows) || rows.length === 0) {
          const wrap = document.createElement('div');
          wrap.className = 'text-muted';
          wrap.innerHTML = `
            <div>No open contracts.</div>
            <div class="mt-2 d-flex gap-2">
              <button type="button" class="btn btn-sm btn-secondary" id="clearFiltersBtn">Clear filters</button>
              <button type="button" class="btn btn-sm btn-primary" id="reqQuoteBtn">Request Quote</button>
            </div>`;
          root.append(wrap);
          document.getElementById('clearFiltersBtn')?.addEventListener('click', ()=>{
            document.getElementById('buyerFilter').value='';
            document.getElementById('materialFilter').value='';
            offset=0; loadOpenContracts();
          });
          document.getElementById('reqQuoteBtn')?.addEventListener('click', ()=>{
            const q = document.getElementById('rfqQty'); if (q){ q.focus(); }
            toast('Enter RFQ quantity and submit.');
          });
         
          const pi = document.getElementById('pageInfo'); if (pi) pi.textContent = `Showing 0 ‚Ä¢ offset ${offset}`;
          if (ls) ls.textContent = 'Loaded.';
          return;
        }

        const frag = document.createDocumentFragment();
        for (const r of rows) frag.append(rowCard(r));
        root.append(frag);

        const pi = document.getElementById('pageInfo');
        if (pi) {
          pi.textContent = total
            ? `Showing ${rows.length} ‚Ä¢ ${offset+1}‚Äì${offset+rows.length} of ${total}`
            : `Showing ${rows.length} ‚Ä¢ offset ${offset}`;
        }
        // enable/disable paging buttons based on results/offset
        const prev = document.getElementById('prevBtn');
        const next = document.getElementById('nextBtn');
        if (prev) prev.disabled = (offset <= 0);
        if (next) next.disabled = (rows.length < limit);

      } catch(e){
        if (e.name !== 'AbortError') {/* api() already toasted */}
      } finally{
        if (ls) ls.textContent = 'Loaded.';
        loadCtl = null;
        setLoadingUI(false);
        root.setAttribute('aria-busy','false');
      }
    }

    async function buy(ev, id){
      const btn = ev?.currentTarget;
      if (!confirm('Confirm purchase of this contract?')) return;
      if (btn){ btn.disabled = true; btn.textContent = 'Purchasing‚Ä¶'; }
      try{
        const res = await api(`/contracts/${id}/purchase`, {
          method: 'PATCH',
          headers: {
            'Content-Type': 'application/json',
            'Idempotency-Key': (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now())),            
          },
          body: JSON.stringify({ op:'purchase', expected_status:'Pending' })
        });
        const data = await res.json();
        toast(`Purchased. BOL ${data?.bol_id ?? '‚Äî'} created.`);
        loadOpenContracts();
      } catch(e) {
        // api() already toasted details
        toast('Purchase failed');
      } finally {
        if (btn){ btn.disabled = false; btn.textContent = 'Buy'; }
      }
    }
    window.buy = buy; // expose for inline

    // Wire UI
    document.getElementById('refreshBtn')?.addEventListener('click', ()=>{ offset = 0; loadOpenContracts(); });
    document.getElementById('buyerFilter')?.addEventListener('input', debounce(()=>{
      offset = 0;
      localStorage.setItem('buyer.filter.buyer', document.getElementById('buyerFilter').value||'');
      loadOpenContracts();
    }, 250));
    document.getElementById('materialFilter')?.addEventListener('input', debounce(()=>{
      offset = 0;
      localStorage.setItem('buyer.filter.material', document.getElementById('materialFilter').value||'');
      loadOpenContracts();
    }, 250));

    document.getElementById('prevBtn')?.addEventListener('click', ()=>{
      offset = Math.max(0, offset - limit);
      const page = Math.floor(offset/limit)+1;
      _syncQuery({ page, rows: String(limit) });
      loadOpenContracts();
    });
    document.getElementById('nextBtn')?.addEventListener('click', ()=>{
      offset += limit;
      const page = Math.floor(offset/limit)+1;
      _syncQuery({ page, rows: String(limit) });
      loadOpenContracts();
    });

    document.getElementById('sortBy')?.addEventListener('change', e=>{
      sortBy = e.target.value; offset = 0;
      localStorage.setItem('buyer.sortBy', sortBy);
      loadOpenContracts();
    });

    document.getElementById('pageSize')?.addEventListener('change', e=>{
      const v = Math.max(1, parseInt(e.target.value||'100', 10));
      limit = v; 
      offset = 0; 
      // keep URL in sync with page size + reset to page 1
      const u = new URL(location.href);
      u.searchParams.set('rows', String(v));
      u.searchParams.set('page', '1');
      history.replaceState({}, '', u);
      loadOpenContracts();
    });

    // Hydrate filters/page from URL on first load
    (function hydrateFromURL(){
      const q = new URL(location.href).searchParams;
      const buyer = q.get('buyer') || localStorage.getItem('buyer.filter.buyer') || '';
      const material = q.get('material') || localStorage.getItem('buyer.filter.material') || '';
      const page = Math.max(1, parseInt(q.get('page')||'1', 10));
      const rows = parseInt(q.get('rows')||'', 10);
      const savedSort = localStorage.getItem('buyer.sortBy') || 'created_at_desc';
      sortBy = savedSort;

      const bf = document.getElementById('buyerFilter'); if (bf) bf.value = buyer;
      const mf = document.getElementById('materialFilter'); if (mf) mf.value = material;
      const sb = document.getElementById('sortBy'); if (sb) sb.value = savedSort;

      if (!Number.isNaN(rows) && rows > 0) {
        limit = rows;
        const ps = document.getElementById('pageSize'); if (ps) ps.value = String(rows);
      }
      offset = (page - 1) * limit;

      const p = localStorage.getItem('buyer.paused') === '1';
      if (p) { paused = true; const pb = document.getElementById('pauseBtn'); if (pb) pb.textContent = 'Resume'; }
    })();
  
    // Auto-refresh controls (pause + jitter)    
    const MIN_MS = 35000;  // 35s
    const MAX_MS = 55000;  // 55s
    function _jitter() { return Math.floor(MIN_MS + Math.random() * (MAX_MS - MIN_MS)); }

    function tickAuto(){
      if (paused) return;
      loadOpenContracts().catch(()=>{});
      refreshTimer = setTimeout(tickAuto, _jitter());
    }

    function startAuto(){
      if (refreshTimer) return;
      refreshTimer = setTimeout(tickAuto, _jitter());
    }
    function stopAuto(){
      if (refreshTimer) { clearTimeout(refreshTimer); refreshTimer = null; }
    } 
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stopAuto(); else { loadOpenContracts(); startAuto(); }
    });

    // Add a Pause/Resume button next to Refresh
    (function addPause(){
      const bar = document.querySelector('.d-flex.gap-2.mb-3.align-items-end');
      if (!bar) return;
      const btn = document.createElement('button');
      btn.className = 'btn btn-secondary btn-sm';
      btn.type = 'button';
      btn.id = 'pauseBtn';
      btn.textContent = paused ? 'Resume' : 'Pause';
      btn.setAttribute('aria-pressed', String(!paused));
      btn.onclick = () => {
        paused = !paused;
        localStorage.setItem('buyer.paused', paused ? '1':'0');
        btn.textContent = paused ? 'Resume' : 'Pause';
        btn.setAttribute('aria-pressed', String(!paused));
        if (!paused) { loadOpenContracts(); startAuto(); } else { stopAuto(); }
      };
      bar.appendChild(btn);
    })(); 
    // Initial load + start timer
    loadOpenContracts();
    startAuto();
  </script>

  <!-- RFQ wiring (after api() & DOM exist) + hide for non-buyers -->
  <script nonce="{{NONCE}}">
    (function(){
      const role = (JSON.parse(localStorage.getItem('bridgeUser')||'{}').role||'').toLowerCase();
      const rfqCard = document.getElementById('rfqCard');
      if (rfqCard && role !== 'buyer') rfqCard.classList.add('d-none');

      const btn = document.getElementById('rfqGo');
      if(!btn) return;

      if (role === 'buyer') {
        const sideSel = document.getElementById('rfqSide');
        if (sideSel) sideSel.value = 'buy';
      }

      btn.onclick = async ()=>{
        const s   = document.getElementById('rfqSym')?.value || '';
        const side= document.getElementById('rfqSide')?.value || 'buy';
        const q   = +(document.getElementById('rfqQty')?.value || 0);
        if (!q) return toast('Enter qty');
        const exp = new Date(Date.now() + 20*60*1000).toISOString();
        try{
          const r = await api('/rfq', {
            method:'POST',
            headers: {
              'Content-Type':'application/json',
              'Idempotency-Key': (crypto?.randomUUID ? crypto.randomUUID() : String(Date.now()))           
            },
            body: JSON.stringify({ symbol:s, side, quantity_lots:q, expires_at:exp })
          });
          toast('RFQ posted');
          try { console.log(await r.json()); } catch {}
        }catch(e){ /* toast already shown */ }
      };
      document.getElementById('rfqQty')?.addEventListener('keydown', (e)=>{
        if (e.key === 'Enter') { e.preventDefault(); btn.click(); }
      });
    })();
  </script>

  <footer class="legal-footer">
    <hr class="mb-3">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms.html" class="link-secondary" rel="noopener noreferrer">Terms</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>¬∑</span>
      <a href="/legal/eula.html" class="link-secondary" rel="noopener noreferrer">EULA</a><span>¬∑</span>
      <a href="/legal/aup.html" class="link-secondary" rel="noopener noreferrer">AUP</a><span>¬∑</span>
      <a href="/legal/cookies.html" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>¬∑</span>
      <a href="/legal/subprocessors.html" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>¬∑</span>
      <a href="/legal/dpa.html" class="link-secondary" rel="noopener noreferrer">DPA</a><span>¬∑</span>
      <a href="/legal/sla.html" class="link-secondary" rel="noopener noreferrer">SLA</a><span>¬∑</span>
      <a href="/legal/security.html" class="link-secondary" rel="noopener noreferrer">Security</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy Appendix</a><span>¬∑</span>
      <a href="/legal/fees.html" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> ‚Äì Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
</body>
</html>
