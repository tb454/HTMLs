<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Buyer Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body{background:#f4f6f8;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial;padding:20px}
    .cardy{background:#fff;border-radius:10px;box-shadow:0 0 10px rgba(0,0,0,.06);padding:18px;margin-bottom:16px}
  </style>
</head>
<body>
  <div class="container">
    <h2 class="mb-3">ðŸ›’ BRidge Buyer Portal</h2>
    <div class="d-flex gap-2 mb-3">
      <input id="buyerFilter" class="form-control form-control-sm" placeholder="Filter buyer (optional)">
      <input id="materialFilter" class="form-control form-control-sm" placeholder="Material/SKU (e.g., SHRED, Barley, #1)">
      <button class="btn btn-outline-secondary btn-sm" id="refreshBtn">Refresh</button>
    </div>
    <div id="list"></div>
    <div class="d-flex gap-2 mt-2">
      <button class="btn btn-outline-secondary btn-sm" id="prevBtn">â—€ Prev</button>
      <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next â–¶</button>
      <span class="small text-muted" id="pageInfo"></span>
    </div>
  </div>

  <script>
    const endpoint = "https://scrapfutures.com";
    let offset = 0, limit = 100;

    async function loadOpenContracts() {
      const q = new URLSearchParams({ status: "Pending", limit, offset });

      const buyer = document.getElementById("buyerFilter").value.trim();
      if (buyer) q.set("buyer", buyer);

      const material = document.getElementById("materialFilter").value.trim();
      if (material) q.set("material", material);

      const res = await fetch(`${endpoint}/contracts?` + q.toString());
      if (!res.ok) { console.error(await res.text()); return; }
      const rows = await res.json();

      const root = document.getElementById("list");
      root.innerHTML = "";
      if (rows.length === 0) {
        root.innerHTML = `<div class="text-muted">No open contracts.</div>`;
        document.getElementById("pageInfo").textContent = `Showing 0 â€¢ offset ${offset}`;
        return;
      }
      rows.forEach(r => {
        const div = document.createElement("div");
        div.className = "cardy";
        const total = (Number(r.weight_tons) * Number(r.price_per_ton)).toLocaleString(
          undefined,{minimumFractionDigits:2}
        );
        div.innerHTML = `
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h5 class="mb-1">${r.material}</h5>
              <div class="text-muted small">Seller: ${r.seller}</div>
              <div class="text-muted small">Buyer: ${r.buyer}</div>
              <div class="small">Tons: <b>${r.weight_tons}</b> @ $<b>${r.price_per_ton}</b>/ton Â· Total $<b>${total}</b></div>
              <div class="small text-muted">Created: ${r.created_at ?? ""}</div>
            </div>
            <div class="text-end">
              <button class="btn btn-primary btn-sm" onclick="buy('${r.id}')">Buy</button>
            </div>
          </div>`;
        root.appendChild(div);
      });
      document.getElementById("pageInfo").textContent = `Showing ${rows.length} â€¢ offset ${offset}`;
    }

    async function buy(id) {
      const res = await fetch(`${endpoint}/contracts/${id}/purchase`, {
        method: "PATCH",
        headers: { "Content-Type": "application/json", "Idempotency-Key": crypto.randomUUID() },
        body: JSON.stringify({ op: "purchase", expected_status: "Pending" })
      });
      if (!res.ok) { alert("Purchase failed: " + (await res.text())); return; }
      const data = await res.json();
      alert(`Purchased. BOL ${data.bol_id} created.`);
      loadOpenContracts();
    }

    document.getElementById("refreshBtn").addEventListener("click", () => { offset = 0; loadOpenContracts(); });
    document.getElementById("buyerFilter").addEventListener("input", () => { offset = 0; loadOpenContracts(); });
    document.getElementById("materialFilter").addEventListener("input", () => { offset = 0; loadOpenContracts(); });
    document.getElementById("prevBtn").addEventListener("click", () => { offset = Math.max(0, offset - limit); loadOpenContracts(); });
    document.getElementById("nextBtn").addEventListener("click", () => { offset += limit; loadOpenContracts(); });

    loadOpenContracts();
    setInterval(loadOpenContracts, 10000);
  </script>
</body>
</html>
