<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BRidge Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/app.css?v=20251125">
  <link rel="icon" href="/static/favicon.ico">
  <script defer nonce="{{NONCE}}" src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="/static/js/locale.js" defer nonce="{{NONCE}}"></script>
  <script src="/static/js/i18n.js" defer nonce="{{NONCE}}"></script>  
<script nonce="{{NONCE}}">
  // run now if DOM is ready, else when DOMContentLoaded fires
  function onReady(fn){
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', fn);
    } else {
      try { fn(); } catch(e){ console.error(e); }
    }
  }
</script>

<!-- Gate by role early (session-probed) -->
<script nonce="{{NONCE}}">
  (async () => {
    try {
      // optional: warm cookies
      await fetch('/health', { credentials: 'include' });
      const r = await fetch('/me', {
        credentials: 'include',
        headers: { 'Accept': 'application/json' }
      });
      if (!r.ok) throw new Error('no session');
      const me = await r.json(); // expect: { username, role }
      window.__bridgeUser = me;

      const role = (me.role || '').toLowerCase();
      if (!role || !['seller', 'yard', 'admin', 'buyer'].includes(role)) {
        location.href = '/static/bridge-login.html';
        return;
      }

      // UI role gates + propagate into seller dashboard once DOM is ready
      onReady(() => {
        const userEl = document.getElementById('current-user');
        if (userEl) userEl.textContent = `User: ${me.username || 'Guest'}`;

        document.querySelectorAll('[data-role="admin"]').forEach(el => {
          el.hidden = (role !== 'admin');
        });
        document.querySelectorAll('[data-role="seller"]').forEach(el => {
          el.hidden = !(role === 'seller' || role === 'admin' || role === 'yard');
        });
        document.querySelectorAll('[data-role="buyer"]').forEach(el => {
          el.hidden = (role !== 'buyer');
        });

        // Once the seller dashboard wiring exists, kick it so the page isn't "dead"
        if (window.wireSellerUI) {
          try { window.wireSellerUI(); } catch (e) { console.error(e); }
        }
      });
    } catch {
      location.href = '/static/bridge-login.html';
    }
  })();
</script>

</head>
<body>
  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
    <select id="lang-select" class="form-select form-select-sm w-auto">
      <option value="en">English</option><option value="es">Español</option><option value="zh">中文</option>
    </select>
    <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
    <input id="tz-select" class="form-control form-control-sm w-220" list="tz-list" placeholder="America/Phoenix" data-i18n-ph="timezone"/>
    <datalist id="tz-list">
      <option value="America/Phoenix"></option><option value="America/New_York"></option>
      <option value="America/Chicago"></option><option value="America/Los_Angeles"></option>
      <option value="UTC"></option><option value="Europe/London"></option><option value="Asia/Shanghai"></option>
    </datalist>
    <button id="save-locale" class="btn btn-outline-secondary btn-sm ms-1"><span data-i18n="save">Save</span></button>
    <small class="text-muted ms-auto" id="local-time"></small>
  </div>

  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>BRidge Dashboard</h1>
      <div class="user-info">
        <span id="current-user">User: Guest</span>
        <button type="button" class="btn btn-outline-primary btn-sm" id="btnLogin">Login</button>
        <button type="button" class="btn btn-outline-danger btn-sm" id="btnLogout">Logout</button>

<script nonce="{{NONCE}}">
(async function(){
  async function doLogout(){
    try { await api('/logout', { method:'POST' }); } catch {}
    localStorage.removeItem('bridgeUser');
    location.href='/static/bridge-login.html';
  }
  Object.assign(window, { doLogout });

  onReady(() => {
    document.getElementById('btnLogin')?.addEventListener('click', (e)=>{ e.preventDefault(); showLoginModal(); });
    document.getElementById('btnLogout')?.addEventListener('click', (e)=>{ e.preventDefault(); doLogout(); });
  });
})();
</script>
        <a class="btn btn-secondary btn-sm" href="/static/spec-ferrous">Spec Sheet Ferrous</a>
        <a class="btn btn-secondary btn-sm" href="/static/spec-nonferrous">Spec Sheet Nonferrous</a>
        <a class="btn btn-secondary btn-sm" href="/static/shipping-terms.html">Shipping Terms</a>
        <a class="btn btn-secondary btn-sm" href="/static/contract-specs">Contract Specs</a>
        <a class="btn btn-secondary btn-sm" href="/static/mixed-load.html">Mixed Load</a>
        <span id="header-date">—</span>
        <span class="health-badge" data-health-badge>● Checking…</span>
      </div>
    </header>

    <!-- Overview Cards -->
    <section class="section">
      <div class="section-title">Overview Cards</div>
      <div class="overview-cards">
        <div id="finished-goods-card" class="card-custom">
        <div><strong>Finished Goods</strong></div>
        <div id="finishedGoodsInfo">Loading...</div>
        <div class="chart-container h-220">
          <canvas id="finishedGoodsChart"></canvas>
        </div>
      </div>

        <div class="card-custom">
          <div><strong>Active Contracts</strong></div>
          <div id="active-contracts-secured">0 Secured</div>
          <div id="active-contracts-margin">Notional: $0.00</div>
          <div id="active-contracts-change">Total Change: $0.00</div>
          <div class="chart-container h-220">
            <canvas id="activeContractsChart"></canvas>
          </div>
        </div>
        <div class="card-custom">
          <div class="d-flex align-items-center justify-content-center gap-2">
            <strong class="me-2">Market Snapshot (Top 10)</strong>
          </div>
          <div class="table-responsive mt-2">
            <table class="table table-sm mb-0">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th>Material</th>
                  <th class="text-end">Last (USD/ton)</th>
                </tr>
              </thead>
              <tbody id="market-snapshot-body">
                <!-- filled by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
    
    <script nonce="{{NONCE}}">
    // ---- Yard Pricing & Hedge Config UI ----
    (function(){
      const $ = (id)=>document.getElementById(id);

      function yardKey(){
        const fromField = ($('yardConfigSeller')?.value || '').trim();
        if (fromField) return fromField;
        const seller = ($('sellerName')?.value || '').trim();
        if (seller) return seller;
        return '';
      }

      function skuKey(){
        return ($('yardConfigSku')?.value || $('material')?.value || '').trim();
      }

      function setMsg(msg){
        const el = $('yardConfigMsg');
        if (el) el.textContent = msg || '';
      }

      function renderRules(rows){
        const tb = $('yardRulesTable')?.querySelector('tbody');
        if (!tb) return;
        if (!rows || !rows.length){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No rules yet.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.material || ''}</td>
            <td>${r.formula || ''}</td>
            <td>${(r.loss_min_pct ?? 0)}–${(r.loss_max_pct ?? 0)}%</td>
            <td>${r.min_margin_usd_ton ?? 0}</td>
            <td>${(r.target_hedge_ratio ?? 0)}</td>
          </tr>
        `).join('');
      }

      function renderHedges(rows){
        const tb = $('yardHedgeTable')?.querySelector('tbody');
        if (!tb) return;
        if (!rows || !rows.length){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No hedge recommendations.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.material || ''}</td>
            <td>${r.on_hand_tons ?? ''}</td>
            <td>${r.hedged_tons ?? ''}</td>
            <td>${(r.target_hedge_ratio ?? 0)}</td>
            <td>${r.suggested_lots ?? 0}</td>
          </tr>
        `).join('');
      }

      async function loadRules(){
        const yard = yardKey();
        if (!yard){ setMsg('Set Seller or Yard key first.'); return; }
        setMsg('Loading rules...');
        try{
          const res = await api(`/yard_rules?yard=${encodeURIComponent(yard)}`);
          const rows = await res.json();
          renderRules(rows || []);
          setMsg(`Loaded ${rows.length || 0} rule(s) for ${yard}.`);
        }catch(e){
          setMsg(e.message || 'Failed to load rules');
        }
      }

      async function saveRule(){
        const yard = yardKey();
        const sku  = skuKey();
        if (!yard || !sku){ toast('Seller/Yard and SKU are required.'); return; }
        const body = {
          yard,
          material: sku,
          formula: ($('yardConfigFormula')?.value || '').trim() || null,
          loss_min_pct: $('yardLossMin')?.value ? parseFloat($('yardLossMin').value) : null,
          loss_max_pct: $('yardLossMax')?.value ? parseFloat($('yardLossMax').value) : null,
          min_margin_usd_ton: $('yardMinMargin')?.value ? parseFloat($('yardMinMargin').value) : null,
          target_hedge_ratio: $('yardHedgeRatio')?.value ? parseFloat($('yardHedgeRatio').value) : null,
          min_tons: $('yardMinTons')?.value ? parseFloat($('yardMinTons').value) : null,
          futures_symbol_root: ($('yardSymbolRoot')?.value || '').trim() || null,
          auto_hedge: ($('yardAutoHedge')?.value === 'true')
        };
        setMsg('Saving rule...');
        try{
          await api('/yard_rules', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          toast('Yard rule saved.');
          await loadRules();
          setMsg('Saved.');
        }catch(e){
          setMsg(e.message || 'Failed to save rule');
        }
      }

      async function loadHedgeRecs(){
        const yard = yardKey();
        if (!yard){ toast('Set Seller/Yard first.'); return; }
        setMsg('Loading hedge recommendations...');
        try{
          const res = await api(`/hedge/recommendations?yard=${encodeURIComponent(yard)}`);
          const rows = await res.json();
          renderHedges(rows || []);
          setMsg(`Got ${rows.length || 0} hedge recommendation(s).`);
        }catch(e){
          setMsg(e.message || 'Failed to load hedge recommendations');
        }
      }

      onReady(() => {
        $('yardRuleLoad')?.addEventListener('click', loadRules);
        $('yardRuleSave')?.addEventListener('click', saveRule);
        $('yardHedgeRecs')?.addEventListener('click', loadHedgeRecs);

        // If seller is already set, auto-populate yardConfigSeller & load rules on first open
        const seller = (document.getElementById('sellerName')?.value || '').trim();
        if (seller && $('yardConfigSeller')) {
          $('yardConfigSeller').value = seller;
          loadRules().catch(()=>{});
        }
      });
    })();
    </script>

    <!-- Price This Material -->
    <section class="section">
      <div class="section-title">Price This Material</div>
      <div class="card mt-12 p-12">
        <label>Category:
          <select id="catSel" class="form-select maxw-220 d-inline-block me-2">
            <option>Copper</option><option>Aluminum</option><option>Brass</option>
            <option>Insulated Wire</option><option>Misc Product</option><option>Radiator Product</option>
            <option>Lead</option><option>Stainless</option>
          </select>
        </label>
        <label>Material:
          <input id="matInput" class="form-control maxw-260 di ib-mx" placeholder="e.g., #1 or AL6063_OldExtrusion"/>
        </label>
        <button type="button" class="btn btn-primary" id="btnQuote">Quote</button>
        <div id="quoteOut" class="text-muted mt-2"></div>
      </div>
    </section>

    <!-- Finished Goods Inventory -->
    <section class="section">
      <div class="section-title">Finished Goods Inventory</div>
      <div class="table-responsive">
        <table id="greenspark-table" class="table table-striped table-hover align-middle">
          <caption class="visually-hidden">Finished goods inventory by SKU</caption>
          <thead class="sticky">
            <tr>
              <th>Commodities</th>
              <th>WIP (lbs)</th>
              <th>Finished Goods (lbs)</th>
              <th>Total (lbs)</th>
              <th>Avg Cost ($/lb)</th>
              <th>Total Purchase Value</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td><strong>Totals:</strong></td>
              <td id="total-wip">0</td>
              <td id="total-finished">0</td>
              <td id="total-total">0</td>
              <td></td>
              <td id="total-purchase">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Inventory Import & Manual Add -->
    <section class="section">
      <div class="section-title">Inventory Import & Manual Add</div>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">CSV / XLSX File</label>
          <input type="file" id="invFile" class="form-control" accept=".csv,.xlsx">
        </div>
        <div class="col-md-3">
          <label class="form-label">Default Seller (optional)</label>
          <input id="invDefaultSeller" class="form-control" placeholder="yard name">
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-primary w-100" id="uploadInvBtn">Upload</button>
        </div>
        <div class="col-md-3">
          <a class="btn btn-secondary w-100" href="/inventory/template.csv" download id="dlTemplateBtn">Download CSV template</a>
        </div>
      </div>

      <div class="row g-2 mt-3">
        <div class="col-md-3"><input id="invSku" class="form-control" placeholder="SKU (e.g., SHRED)" autocapitalize="off" autocomplete="off" spellcheck="false" list="skuList"></div>
        <div class="col-md-2"><input id="invQty" type="number" step="0.01" class="form-control" placeholder="Qty on hand (tons)"></div>
        <div class="col-md-2"><input id="invLocation" class="form-control" placeholder="Location"></div>
        <div class="col-md-3"><input id="invDesc" class="form-control" placeholder="Description (optional)"></div>
        <div class="col-md-2"><button type="button" class="btn btn-success w-100" id="manualAddBtn">Manual Add/Set</button></div>
      </div>

      <div id="invUploadMsg" class="small text-muted mt-2"></div>
    </section>

    <!-- Create Contract -->
    <section class="section">
      <div class="section-title">Create Contract</div>
      <div class="row g-2 mb-2">
        <div class="col-md-3">
          <input id="sellerName" class="form-control" placeholder="Seller" autocapitalize="off" autocomplete="off" spellcheck="false">
        </div>
        <div class="col-md-3">
          <input id="buyerName" class="form-control" placeholder="Buyer (mark open or designate)">
        </div>
        <div class="col-md-3">
          <input id="material" class="form-control" placeholder="Material / SKU (e.g., SHRED)"
                autocapitalize="off" autocomplete="off" spellcheck="false" list="skuList">
        </div>
        <div class="col-md-1">
          <input id="tons" type="number" class="form-control" placeholder="Tons" min="0.01" step="0.01">
        </div>
        <div class="col-md-2">
          <input id="price" type="number" class="form-control" placeholder="$/ton" min="0.01" step="0.01">
        </div>
      </div>
      <!-- CREATE CONTRACT button (needed by wireSellerUI) -->
      <div class="mt-2">
        <button type="button" id="createContractBtn" class="btn btn-primary">
          Create Contract
        </button>
      </div>
      <!-- place ONE shared datalist somewhere once in the page --> 
      <datalist id="skuList"></datalist>

      <!-- RFQ (two-click) -->
      <div class="card p-3 mt-3 maxw-520" data-role="buyer">
        <div class="d-flex gap-2">
          <select id="rfqSym" class="form-select" aria-label="RFQ symbol" title="RFQ symbol">
            <option>CU-SHRED-1M</option>
            <option>AL-6061-1M</option>
          </select>
          <select id="rfqSide" class="form-select" aria-label="RFQ side" title="RFQ side">
            <option>buy</option>
            <option>sell</option>
          </select>
          <input id="rfqQty" class="form-control" type="number" placeholder="Qty (lots)" min="0.01" step="0.01">
          <button type="button" id="rfqGo" class="btn btn-primary">RFQ</button>
        </div>
      </div>
    </section>

    <!-- Recent Movements -->
    <section class="section" id="recentMovementsSection">
      <div class="section-title">Recent Inventory Movements</div>
      <div class="text-muted small mb-2">Shows the latest 5 movements for this seller/material.</div>
      <ul id="recentMovements" class="list-group"></ul>
    </section>

    <!-- My Contracts -->
    <section class="section">
      <div class="section-title">My Contracts</div>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="filterStatus" class="form-control form-control-sm" placeholder="Status (e.g., Pending)"></div>
        <div class="col-md-3"><input id="filterStart" type="date" class="form-control form-control-sm" placeholder="Start (ISO)"></div>
        <div class="col-md-3"><input id="filterEnd" type="date" class="form-control form-control-sm" placeholder="End (ISO)"></div>
       <div class="col-md-3 d-flex gap-2">
        <button type="button" class="btn btn-secondary btn-sm" id="refreshContractsBtn">Refresh</button>
        <button type="button" class="btn btn-secondary btn-sm" id="clearFiltersBtn">Clear</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-striped table-hover align-middle" id="sellerContractsTable">
  <caption class="visually-hidden">Contracts list with filters and paging</caption>
          <thead class="sticky">
            <tr>
              <th>ID</th>
              <th>Buyer</th>
              <th>Material</th>
              <th>Tons</th>
              <th>$/ton</th>
              <th>Currency</th>
              <th>Tax %</th>
              <th>Status</th>
              <th>Created</th>
            </tr>
          </thead>  
          <tbody></tbody>
        </table>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-secondary btn-sm" id="prevBtn">◀ Prev</button>
        <button class="btn btn-secondary btn-sm" id="nextBtn">Next ▶</button>
        <span class="small text-muted" id="pageInfo" aria-live="polite"></span>
      </div>
    </section>

    <!-- Trade Log (placeholder) -->
    <section class="section">
      <div class="section-title">Trade Log</div>
      <table id="trade-log-table" class="table table-striped table-hover align-middle">
        <caption class="visually-hidden">Recent trade log</caption>
        <thead class="sticky"><tr><th>Time</th><th>Material</th><th>Quantity (tons)</th><th>Price/ton</th><th>Total Contract Value</th><th>Location</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!--BR-Index-->
    <section class="section">
      <div class="section-title">BR-Index</div>

      <table id="metals-market-table" class="table table-striped table-hover align-middle">
        <caption class="visually-hidden">BR-Index Overview</caption>
        <thead class="sticky">
          <tr>
            <th>Symbol</th>
            <th>Contract Name</th>
            <th>Last</th>
            <th>Change</th>
            <th>Open</th>
            <th>High</th>
            <th>Low</th>
            <th>Volume</th>
            <th>Time</th>
          </tr>
        </thead>
        <tbody>
          <!-- Filled dynamically by loadMetalsOverview() using BR-Index data -->
        </tbody>
      </table>

      <table class="table table-sm align-middle">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Material</th>
            <th>Category</th>
            <th class="text-end">Last (USD/ton)</th>
            <th class="text-end">Change</th>
          </tr>
        </thead>
        <tbody id="materials-table-body">
          <!-- rows will be filled by JS -->
        </tbody>
      </table>

      <div class="d-flex justify-content-between align-items-center">
        <span id="materials-page-label" class="small text-muted"></span>
        <div>
          <button id="materials-prev" class="btn btn-sm btn-outline-secondary me-1">Prev</button>
          <button id="materials-next" class="btn btn-sm btn-outline-secondary">Next</button>
        </div>
      </div>

      <div class="d-flex justify-content-end mt-2">
        <a href="/static/materials-benchmarks.html" class="btn btn-link btn-sm">
          View all materials
        </a>
      </div>
    </section>

    <!-- KPIs -->
    <section class="section">
      <div class="section-title">Key Performance Indicators (KPIs)</div>
      <div class="kpi-content">
  <div class="chart-container h-220">
    <canvas id="kpiChart"></canvas>
  </div>
</div>
    </section>
  </div>

  <!-- KPI Detail Modal -->
  <div class="modal fade" id="kpiDetailModal" tabindex="-1" aria-labelledby="kpiDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="kpiDetailModalLabel">KPI Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body"><p>Detailed analysis of monthly revenue, cost savings, and trade volume trends.</p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div></div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="login-form" autocomplete="on">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                class="form-control"
                required
                autocomplete="username"
                inputmode="email"
                enterkeyhint="go" />
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-control"
                required
                autocomplete="current-password"
                enterkeyhint="done" />
            </div>

            <div id="login-error" class="text-danger small" role="alert" aria-live="polite"></div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Login</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1"></div>

  <script
    defer
    nonce="{{NONCE}}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
  ></script>

  <!-- seller-specific helpers (BR-Index, snapshot, etc.) -->
  <link rel="stylesheet" href="/static/app.css?v=20251125a">
  <script defer nonce="{{NONCE}}" src="/static/js/locale.js?v=20251125"></script>
  <script defer nonce="{{NONCE}}" src="/static/js/i18n.js?v=20251125"></script>
  <script defer nonce="{{NONCE}}" src="/static/js/seller.js?v=20251125"></script>

  <script nonce="{{NONCE}}">
    // endpoint + api + toast + health
    const ORIGIN = location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin;
    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

let __toastTimer;
function toast(msg, ms=2800){
  const t=document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  try { t.focus(); } catch {}
  clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=>{ t.classList.remove('show'); }, ms);
}

async function api(path, opt = {}) {
  const url = path.startsWith('http') ? path : `${ORIGIN}${path}`;
  const method = (opt.method || 'GET').toUpperCase();
  const headers = { 'Accept':'application/json', ...(opt.headers || {}) };
  // add CSRF header only for unsafe methods
  if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
    headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
  }
  const res = await fetch(url, { credentials:'include', ...opt, headers });
  if (res.status === 401) {
    const next = encodeURIComponent(location.pathname + location.search);
    location.href = `/static/bridge-login.html?next=${next}`;
    throw new Error('Unauthorized');
  }
  if (!res.ok) {
    let m = 'Request failed';
    try { m = (await res.clone().json()).detail || m; }
    catch { m = await res.text() || m; }
    toast(m); throw new Error(m);
  }
  return res;
}

onReady(async () => {
  try {
    // sets XSRF-TOKEN cookie for the SPA
    await fetch('/health', { credentials:'include' });
    const b = document.querySelector('[data-health-badge]');
    if (b) { b.textContent='● Live'; b.setAttribute('data-ok','1'); }
  } catch {}
});

    const accentColor = '#3498db';
    // ---- Timezone toggle (UTC vs local) ----
    let __useUTC = localStorage.getItem('seller.useUTC') === '1';
    function _fmtDate(d){
      const dt = new Date(d);
      return __useUTC
        ? dt.toLocaleString('en-US', { timeZone:'UTC', timeZoneName:'short' })
        : dt.toLocaleString();
    }
    function _renderTZHintSeller(){
      let el = document.getElementById('header-date');
      if (!el) return;
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
      el.title = `Times shown in ${__useUTC ? 'UTC' : tz} — click to toggle`;
      el.classList.add('is-clickable');
      el.onclick = () => {
        __useUTC = !__useUTC;
        localStorage.setItem('seller.useUTC', __useUTC ? '1':'0');
        // re-render views with dates
        try { listContracts(); } catch{}
        try {
          const seller = (document.getElementById("sellerName")?.value || '').trim();
          const mat = (document.getElementById("material")?.value || '').trim();
          renderRecentMovements(seller, mat);
        } catch{}
        _renderTZHintSeller();
      };
    }
    onReady(_renderTZHintSeller);
// ---- /Timezone toggle ----

    /* colors handled by CSS; no inline styles */

    let activeContractsChart, finishedGoodsChart, kpiChart;
    const activeContractsChangeHistory = [], activeContractsChartLabels = [];
    let finishedGoodsChartLabels = [], finishedGoodsChartData = [];
    let kpiChartLabels = [];

    onReady(() => {
      const hd = document.getElementById('header-date');
      if (hd) hd.textContent = _fmtDate(new Date());

      const activeCanvas = document.getElementById('activeContractsChart');
      if (activeCanvas) {
        activeContractsChart = new Chart(activeCanvas.getContext('2d'), {
          type: 'line',
          data: { labels: activeContractsChartLabels, datasets: [{ label: 'Total Change', data: activeContractsChangeHistory, borderColor: accentColor, backgroundColor:'rgba(52,152,219,0.2)', fill:true, tension:0.1 }]},
          options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true } } }
        });
      }
      const finishedCanvas = document.getElementById('finishedGoodsChart');
      if (finishedCanvas) {
        finishedGoodsChart = new Chart(finishedCanvas.getContext('2d'), {
          type: 'line',
          data: { labels: finishedGoodsChartLabels, datasets: [{ label: 'Total Tons', data: finishedGoodsChartData, borderColor: accentColor, backgroundColor:'rgba(52,152,219,0.2)', fill:true, tension:0.1 }]},
          options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true } } }
        });
      }
      const kpiCanvas = document.getElementById('kpiChart');
      if (kpiCanvas) {
        const ctxKPI = kpiCanvas.getContext('2d');
        kpiChart = new Chart(ctxKPI, {
          type: 'bar',
          data: {
            labels: kpiChartLabels,
            datasets: [
              { label:'Tons',          data: [], backgroundColor:'rgba(52,152,219,0.6)' },
              { label:'Notional ($k)', data: [], backgroundColor:'rgba(46,204,113,0.6)' },
              { label:'Contracts',     data: [], backgroundColor:'rgba(231,76,60,0.6)' }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
          }
        });
      }

      refreshFinishedFromInputs();

      // Prime summary widgets once the seller (if any) is set
      try {
        loadActiveContractsSummary();
        loadSellerKPIs();
        loadTradeLog();
        loadMetalsOverview();
        loadMarketSnapshot();          // top 10 card
        loadMaterialBenchmarks(1);     // BR-Index table, 50 at a time
        if (typeof initMaterialBenchmarksPaging === 'function') {
          initMaterialBenchmarksPaging();
        }
      } catch {}
      
      // Refresh summary + trade log every 60s when page visible
      setInterval(() => {
        if (document.hidden) return;
        try {
          loadActiveContractsSummary();
          loadSellerKPIs();
          loadTradeLog();
        } catch {}
      }, 60000);

    });

    // Pricing widget
    onReady(() => {
      const btn = document.getElementById('btnQuote');
      if (!btn) return;
      btn.onclick = async () => {
        const cat = document.getElementById('catSel').value;
        const mat = document.getElementById('matInput').value.trim();
        if (!mat) return;
        const el = document.getElementById('quoteOut');
        btn.disabled = true; btn.textContent = 'Quoting…';
        try {
          const r = await api(`/pricing/quote?category=${encodeURIComponent(cat)}&material=${encodeURIComponent(mat)}`);
          const j = await r.json();
          el.innerHTML = `
            <span class="badge bg-primary">${j.category} / ${j.material}</span>
            <span class="badge bg-light text-dark ms-2">$${(+j.price_per_lb).toFixed(4)} / lb</span>
          `;
        } catch {
          el.innerHTML = `<span class="badge bg-warning text-dark">No price (check spelling)</span>`;
        } finally {
          btn.disabled = false; btn.textContent = 'Quote';
        }
      };
    });

    function updatePurchaseValues() {
      const table = document.getElementById('greenspark-table');
      const rows = table.querySelectorAll('tbody tr.group-sub');
      let sumWIP = 0, sumFinished = 0, sumTotal = 0, sumPurchase = 0;

      rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length >= 6) {
          const wip = parseFloat(cells[1].textContent.replace(/,/g,'')) || 0;
          const finished = parseFloat(cells[2].textContent.replace(/,/g,'')) || 0;
          const totalLbs = parseFloat(cells[3].textContent.replace(/,/g,'')) || 0;
          const avgCost = parseFloat(cells[4].textContent.replace(/[^0-9.]/g,'')) || 0;
          const purchaseValue = totalLbs * avgCost;
          sumWIP += wip;
          sumFinished += finished;
          sumTotal += totalLbs;
          sumPurchase += purchaseValue;
          cells[5].textContent = '$' + purchaseValue.toLocaleString(
            undefined,
            { minimumFractionDigits:2, maximumFractionDigits:2 }
          );
        }
      });

      document.getElementById('total-wip').textContent = sumWIP.toLocaleString();
      document.getElementById('total-finished').textContent = sumFinished.toLocaleString();
      document.getElementById('total-total').textContent = sumTotal.toLocaleString();
      document.getElementById('total-purchase').textContent = '$' + sumPurchase.toLocaleString(
        undefined,
        { minimumFractionDigits:2, maximumFractionDigits:2 }
      );

      const info = document.getElementById('finishedGoodsInfo');
      if (info) {
        const totalTons = sumTotal / 2000;
        const contractsAvailable = Math.floor(sumFinished / 20000);
        info.innerHTML = `<div>${contractsAvailable} Contracts Available</div><div>~${totalTons.toFixed(1)} Total Tons</div>`;
        if (finishedGoodsChart) {
          const now = _fmtDate(new Date());
          finishedGoodsChartLabels.push(now);
          finishedGoodsChartData.push(totalTons);
          if (finishedGoodsChartData.length > 10) {
            finishedGoodsChartLabels.shift();
            finishedGoodsChartData.shift();
          }
          finishedGoodsChart.update();
        }
      }
    }

    // ========= Active contracts summary for the seller =========
    let __lastActiveNotional = 0;

    async function loadActiveContractsSummary() {
      const seller = (document.getElementById('sellerName')?.value || '').trim();
      if (!seller) return;

      const secEl = document.getElementById('active-contracts-secured');
      const mEl   = document.getElementById('active-contracts-margin');
      const chgEl = document.getElementById('active-contracts-change');

      try {
        const qs = new URLSearchParams({ seller, limit: '1000', offset: '0' });
        const res  = await api(`/contracts?${qs.toString()}`);
        const rows = await res.json();

        let secured = 0;
        let notional = 0;
        for (const r of rows) {
          const tons  = Number(r.weight_tons ?? 0);
          const price = Number(r.price_per_ton ?? 0);
          notional += tons * price;

          const st = (r.status || '').toLowerCase();
          if (st && st !== 'cancelled') secured += 1;
        }

        const fmtUsd = (n) => '$' + Number(n || 0).toLocaleString(
          undefined,
          { minimumFractionDigits: 2, maximumFractionDigits: 2 }
        );

        if (secEl) secEl.textContent = `${secured} Secured`;
        if (mEl)   mEl.textContent   = `Notional: ${fmtUsd(notional)}`;

        const delta = (__lastActiveNotional === 0) ? 0 : (notional - __lastActiveNotional);
        __lastActiveNotional = notional;
        if (chgEl) chgEl.textContent = `Total Change: ${fmtUsd(delta)}`;

        if (activeContractsChart) {
          const label = _fmtDate(new Date());
          activeContractsChartLabels.push(label);
          activeContractsChangeHistory.push(Number(delta.toFixed(2)));
          if (activeContractsChangeHistory.length > 20) {
            activeContractsChangeHistory.shift();
            activeContractsChartLabels.shift();
          }
          activeContractsChart.update();
        }
      } catch (e) {
        // api() already toasts
      }
    }

    // ========= KPIs from real contracts (last 12 months) =========
    async function loadSellerKPIs() {
      const seller = (document.getElementById('sellerName')?.value || '').trim();
      if (!seller || !window.Chart || !kpiChart) return;

      const now = new Date();
      const start = new Date(now);
      start.setMonth(start.getMonth() - 11);

      const qs = new URLSearchParams({
        seller,
        limit: '2000',
        offset: '0',
        start: start.toISOString().slice(0, 10)  // YYYY-MM-DD
      });

      try {
        const res  = await api(`/contracts?${qs.toString()}`);
        const rows = await res.json();

        const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const buckets = {};

        for (let i = 0; i < 12; i++) {
          const d = new Date(start);
          d.setMonth(start.getMonth() + i);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          buckets[key] = {
            label: `${monthNames[d.getMonth()]} '${String(d.getFullYear()).slice(-2)}`,
            tons: 0,
            notional: 0,
            count: 0
          };
        }

        for (const r of rows) {
          if (!r.created_at) continue;
          const d = new Date(r.created_at);
          const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
          if (!buckets[key]) continue;
          const tons  = Number(r.weight_tons ?? 0);
          const price = Number(r.price_per_ton ?? 0);
          buckets[key].tons     += tons;
          buckets[key].notional += tons * price;
          buckets[key].count    += 1;
        }

        const labels       = [];
        const tonsData     = [];
        const notionalData = [];
        const countData    = [];

        const keysSorted = Object.keys(buckets).sort();
        for (const k of keysSorted) {
          const b = buckets[k];
          labels.push(b.label);
          tonsData.push(Number(b.tons.toFixed(2)));
          notionalData.push(Number((b.notional / 1000).toFixed(2))); // $k
          countData.push(b.count);
        }

        kpiChartLabels = labels;
        kpiChart.data.labels = labels;
        kpiChart.data.datasets[0].data = tonsData;
        kpiChart.data.datasets[1].data = notionalData;
        kpiChart.data.datasets[2].data = countData;
        kpiChart.update();
      } catch (e) {
        // ignore; api() toasts
      }
    }

    // ========= Trade log from real contracts =========
    async function loadTradeLog() {
      const seller = (document.getElementById('sellerName')?.value || '').trim();
      if (!seller) return;

      const tbody = document.querySelector('#trade-log-table tbody');
      if (!tbody) return;

      tbody.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">Loading…</td></tr>`;

      try {
        const qs = new URLSearchParams({ seller, limit: '50', offset: '0' });
        const res  = await api(`/contracts?${qs.toString()}`);
        const rows = await res.json();

        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">No trades yet for this seller.</td></tr>`;
          return;
        }

        const fmtUsd = (n) => '$' + Number(n || 0).toLocaleString(
          undefined,
          { minimumFractionDigits: 2, maximumFractionDigits: 2 }
        );

        rows.sort((a,b) => new Date(b.created_at || 0) - new Date(a.created_at || 0));

        tbody.innerHTML = rows.map(r => {
          const tons  = Number(r.weight_tons ?? 0);
          const price = Number(r.price_per_ton ?? 0);
          const total = tons * price;
          const when  = r.created_at ? _fmtDate(r.created_at) : '—';
          return `
            <tr>
              <td>${when}</td>
              <td>${r.material || ''}</td>
              <td>${tons || ''}</td>
              <td>${price || ''}</td>
              <td>${fmtUsd(total)}</td>
              <td>—</td>
            </tr>
          `;
        }).join('');
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">Failed to load: ${e.message || 'error'}</td></tr>`;
      }
    }

    // ========= Metals table from reference_prices =========
    async function loadMetalsOverview() {
      const table = document.getElementById('metals-market-table');
      if (!table) return;
      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const symbols = [
        { sym: 'BR-CU', label: 'Bare Bright Copper',    code: 'BBCOP' },
        { sym: 'BR-AL',   label: 'Base Aluminum',    code: 'ALU'   },
        { sym: 'BR-AU', label: 'Gold',      code: 'GC'    },
        { sym: 'BR-AG', label: 'Silver',    code: 'SI'    },
        { sym: 'BR-PA', label: 'Palladium', code: 'PA'    },
      ];

      try {
        const rows = [];
        for (const s of symbols) {
          try {
            const r  = await api(`/reference_prices/latest?symbol=${encodeURIComponent(s.sym)}`);
            const j  = await r.json();
            const px = Number(j.price || j.price_close || j.last || 0);
            const ts = j.ts_market || j.as_of || '';
            if (!px) continue;
            rows.push({
              symbol: s.code,
              name:   s.label,
              last:   px,
              change: j.change ?? 0,
              open:   j.open   ?? '',
              high:   j.high   ?? '',
              low:    j.low    ?? '',
              vol:    j.volume ?? '',
              time:   ts || '—'
            });
          } catch {
            // skip bad row
          }
        }

        if (!rows.length) return; // keep static demo if API fails

        const fmtNum = (n, dp=2) =>
          Number(n || 0).toLocaleString(
            undefined,
            { minimumFractionDigits: dp, maximumFractionDigits: dp }
          );

        tbody.innerHTML = rows.map(r => `
          <tr>
            <td>${r.symbol}</td>
            <td>${r.name}</td>
            <td>${fmtNum(r.last)}</td>
            <td>${r.change >= 0 ? '+'+fmtNum(r.change) : fmtNum(r.change)}</td>
            <td>${r.open || '—'}</td>
            <td>${r.high || '—'}</td>
            <td>${r.low  || '—'}</td>
            <td>${r.vol  || '—'}</td>
            <td>${r.time}</td>
          </tr>
        `).join('');
      } catch {
        // leave static rows alone on error
      }
    }

    // Seller logic
    let offset = 0, limit = 50;

    async function loadFinishedGoods(seller) {
      const tbody = document.querySelector('#greenspark-table tbody');
      if (!seller) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted">Enter seller to load finished goods.</td></tr>`;
        return;
      }
      
      try {
        const r = await api(`/inventory/finished_goods?seller=${encodeURIComponent(seller)}`);
        const rows = await r.json();
        tbody.innerHTML = '';
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-muted">No finished goods on file.</td></tr>`;
        } else {
          rows.forEach(item => {
            const sku = item.sku || '';
            const wip = Math.max(0, Number(item.wip_lbs ?? 0));
            const finished = Math.max(0, Number(item.finished_lbs ?? 0));
            const total = wip + finished;
            const avgCost = Number(item.avg_cost_per_lb ?? 0) || 0;
            const totalPurchaseValue = total * avgCost;
            const tr = document.createElement('tr');
            tr.classList.add('group-sub');
            tr.innerHTML = `
              <td>${sku}</td>
              <td>${wip.toLocaleString()}</td>
              <td>${finished.toLocaleString()}</td>
              <td>${total.toLocaleString()}</td>
              <td>${avgCost ? '$'+avgCost.toFixed(2) : '-'}</td>
              <td>$${totalPurchaseValue.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        updatePurchaseValues();
        try {
          const dl = document.getElementById('skuList');
          if (dl && Array.isArray(rows)) {
            dl.innerHTML = '';
            const seen = new Set();
            rows.forEach(item => {
              const sku = (item.sku || '').toString();
              if (sku && !seen.has(sku.toLowerCase())) {
                seen.add(sku.toLowerCase());
                const opt = document.createElement('option');
                opt.value = sku;
                dl.appendChild(opt);
              }
            });
          }
        } catch {}
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted">Finished goods not available yet.</td></tr>`;
        updatePurchaseValues();
      }
    }

    function refreshFinishedFromInputs() {
      const seller = (document.getElementById("sellerName")?.value || '').trim()
                  || (document.getElementById('invDefaultSeller')?.value || '').trim();
      if (seller) loadFinishedGoods(seller);
    }

    async function renderRecentMovements(seller, material) {
      if (!seller || !material) return;
      const url = `/inventory/movements/list?seller=${encodeURIComponent(seller)}&sku=${encodeURIComponent(material)}&limit=5`;
      try {
        const r = await api(url);
        const rows = await r.json();
        const ul = document.getElementById("recentMovements");
        ul.innerHTML = "";
        if (!rows.length) {
          ul.innerHTML = `<li class="list-group-item text-muted">No recent movements.</li>`;
          return;
        }
        rows.forEach(mv => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          const when = mv.created_at ? _fmtDate(mv.created_at) : "";
          const qty = (mv.qty !== undefined && mv.qty !== null) ? Number(mv.qty).toLocaleString() : "";
          li.innerHTML = `
            <div>
              <div><strong>${(mv.movement_type||'').toUpperCase()}</strong> — ${mv.sku || ''}</div>
              <div class="small text-muted">${when}</div>
            </div>
            <span class="badge bg-secondary rounded-pill">${qty}</span>`;
          ul.appendChild(li);
        });
      } catch (e) {}
    }

    async function createContract() {
      const seller = document.getElementById("sellerName").value.trim();
      const buyer  = document.getElementById("buyerName").value.trim();
      const material = document.getElementById("material").value.trim();
      const weight_tons = parseFloat(document.getElementById("tons").value);
      const price_per_ton = parseFloat(document.getElementById("price").value);

      if (!seller || !buyer || !material || !Number.isFinite(weight_tons) || !Number.isFinite(price_per_ton)) {
        toast("Fill all fields (seller, buyer, material, tons, $/ton).");
        return;
      }

      const res = await api(`/contracts`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Idempotency-Key": (crypto.randomUUID?.() || String(Date.now())) },
        body: JSON.stringify({ seller, buyer, material, weight_tons, price_per_ton })
      });

      toast(`Reserved ${weight_tons} tons of ${material} from ${seller}.`);
      await listContracts();
      renderRecentMovements(seller, material);
      refreshFinishedFromInputs();
    }

    async function listContracts() {
      const seller = document.getElementById("sellerName").value.trim();
      if (!seller) return;
      const status = document.getElementById("filterStatus").value.trim();
      const start  = document.getElementById("filterStart").value;
      const end    = document.getElementById("filterEnd").value;

      const qs = new URLSearchParams({ seller, limit, offset });
      if (status) qs.set("status", status);
      if (start)  qs.set("start", start);
      if (end)    qs.set("end",   end);

      const tbody = document.querySelector("#sellerContractsTable tbody");      
      const res = await api(`/contracts?${qs.toString()}`);
      const totalCount = +(res.headers.get('X-Total-Count') || 0);
      const rows = await res.json();

      tbody.innerHTML = "";
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="9" class="text-muted text-center py-3">No contracts match your filters.</td>`;
        tbody.appendChild(tr);
      } else {
        rows.forEach(r => {
          const tr = document.createElement("tr");
          const created = r.created_at ? _fmtDate(r.created_at) : "";
          const cur = (r.currency || 'USD').toString().toUpperCase();
          const tax = (r.tax_percent ?? r.tax_pct);
          const taxStr = (tax !== null && tax !== undefined && !Number.isNaN(Number(tax)))
            ? Number(tax).toFixed(2)
            : '';

          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.buyer}</td>
            <td>${r.material}</td>
            <td>${r.weight_tons ?? ""}</td>
            <td>${r.price_per_ton ?? ""}</td>
            <td>${cur}</td>
            <td>${taxStr}</td>
            <td>${r.status ?? ""}</td>
            <td>${created}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("pageInfo").textContent = totalCount
        ? `Showing ${rows.length} • ${offset+1}–${offset+rows.length} of ${totalCount}`
        : `Showing ${rows.length} • offset ${offset}`;
      const prev = document.getElementById('prevBtn');
      const next = document.getElementById('nextBtn');
      if (prev) prev.disabled = offset === 0;
      if (next) next.disabled = rows.length < limit;

    }

    // saved filters in URL
    function _syncQuery(params){
      const u = new URL(location.href);
      for (const [k,v] of Object.entries(params)) {
        if (v === '' || v == null) u.searchParams.delete(k); else u.searchParams.set(k, v);
      }
      history.replaceState({}, '', u);
    }

    function wireSellerUI() {
      const userEl   = document.getElementById("current-user");
      const sellerEl = document.getElementById("sellerName");

      // Prefer the session user from /me if available
      let username = "";
      try {
        if (window.__bridgeUser && window.__bridgeUser.username) {
          username = String(window.__bridgeUser.username).trim();
        } else if (userEl && userEl.textContent) {
          const raw = userEl.textContent.replace("User:", "").trim();
          if (raw && raw.toLowerCase() !== "guest") {
            username = raw;
          }
        }
      } catch (e) {
        console.warn("wireSellerUI username resolve failed", e);
      }

      if (sellerEl && username && !sellerEl.value) {
        sellerEl.value = username;
      }

      // Wire buttons/filters once (idempotent)
      document.getElementById("createContractBtn")?.addEventListener("click", createContract);

      document.getElementById("refreshContractsBtn")?.addEventListener("click", () => {
        offset = 0;
        _syncQuery({
          status: document.getElementById("filterStatus").value.trim(),
          start:  document.getElementById("filterStart").value,
          end:    document.getElementById("filterEnd").value,
          page:   1
        });
        listContracts();
      });

      document.getElementById("clearFiltersBtn")?.addEventListener("click", () => {
        const fs  = document.getElementById("filterStatus");
        const fst = document.getElementById("filterStart");
        const fe  = document.getElementById("filterEnd");
        if (fs)  fs.value  = "";
        if (fst) fst.value = "";
        if (fe)  fe.value  = "";
        offset = 0;
        _syncQuery({ status: "", start: "", end: "", page: 1 });
        listContracts();
      });

      document.getElementById("prevBtn")?.addEventListener("click", () => {
        offset = Math.max(0, offset - limit);
        const page = Math.floor(offset / limit) + 1;
        _syncQuery({ page });
        listContracts();
      });

      document.getElementById("nextBtn")?.addEventListener("click", () => {
        offset += limit;
        const page = Math.floor(offset / limit) + 1;
        _syncQuery({ page });
        listContracts();
      });

      const sellerInput = document.getElementById("sellerName");
      if (sellerInput) {
        const onSellerChange = async () => {
          const val = sellerInput.value.trim();
          if (!val) return;
          offset = 0;
          refreshFinishedFromInputs();
          try {
            await listContracts();
            await loadActiveContractsSummary();
            await loadSellerKPIs();
            await loadTradeLog();
          } catch (e) {
            console.warn("seller onChange refresh failed", e);
          }
        };
        sellerInput.addEventListener("change", onSellerChange);
        sellerInput.addEventListener("blur", onSellerChange);
        sellerInput.addEventListener("keyup", (e) => {
          if (e.key === "Enter") onSellerChange();
        });
      }

      // If we already know the seller, kick off the initial loads now
      if (sellerEl && sellerEl.value.trim()) {
        refreshFinishedFromInputs();
        try {
          listContracts();
          loadActiveContractsSummary();
          loadSellerKPIs();
          loadTradeLog();
        } catch (e) {
          console.warn("initial seller loads failed", e);
        }
      } else {
        console.info("wireSellerUI: no seller yet; waiting for user context.");
      }
    }

    async function uploadInvFile() {
      const f = document.getElementById('invFile').files[0];
      if (!f) { toast('Choose a CSV or XLSX file'); return; }
      const sellerDefault = document.getElementById('invDefaultSeller').value.trim();
      const fd = new FormData(); fd.append('file', f); if (sellerDefault) fd.append('seller', sellerDefault);
      const isXlsx = /\.xlsx?$/i.test(f.name);
      const r = await api(`/inventory/import/${isXlsx ? 'excel' : 'csv'}`, { method:'POST', body: fd });
      const txt = await r.text();
      try { const j = JSON.parse(txt); document.getElementById('invUploadMsg').innerText = `Upserted ${j.upserted}. Errors: ${(j.errors||[]).length}`; }
      catch { document.getElementById('invUploadMsg').innerText = txt; }
      refreshFinishedFromInputs();
    }

    async function manualAddInventory() {
      const seller = document.getElementById('sellerName').value.trim()
                    || document.getElementById('invDefaultSeller').value.trim();
      const sku = document.getElementById('invSku').value.trim();
      const qty = parseFloat(document.getElementById('invQty').value);
      const location = document.getElementById('invLocation').value.trim();
      const description = document.getElementById('invDesc').value.trim();

      if (!seller || !sku || !Number.isFinite(qty)) { toast('Seller, SKU, and Qty are required.'); return; }

      const resp = await api(`/inventory/manual_add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Idempotency-Key': (crypto.randomUUID?.() || String(Date.now())) },
        body: JSON.stringify({
          seller, sku, qty_on_hand: qty, uom: 'ton',
          location: location || undefined, description: description || undefined,
          source: 'manual'
        })
      });
      toast('Inventory updated.');
      renderRecentMovements(seller, sku);
      refreshFinishedFromInputs();
    }

    onReady(() => {
      // hydrate filters from URL
      const q = new URL(location.href).searchParams;
      const s = q.get('status') || '';
      const st = q.get('start') || '';
      const en = q.get('end') || '';
      const page = +(q.get('page') || '1');

      const fs  = document.getElementById("filterStatus");
      const fst = document.getElementById("filterStart");
      const fe  = document.getElementById("filterEnd");
      if (fs)  fs.value  = s;
      if (fst) fst.value = st;
      if (fe)  fe.value  = en;

      offset = Math.max(0, (page - 1)) * limit;

      refreshFinishedFromInputs();
      document.getElementById('uploadInvBtn')?.addEventListener('click', uploadInvFile);
      document.getElementById('manualAddBtn')?.addEventListener('click', manualAddInventory);
    });

    // Login modal + focus restore
    let loginTriggerBtn = null;
    async function showLoginModal() {
      if (!(window.bootstrap && bootstrap.Modal)) {
        // allow deferred bootstrap bundle to finish if user clicks instantly
        await new Promise(r => setTimeout(r, 0));
      }
      loginTriggerBtn = document.activeElement;
      const modalEl = document.getElementById('loginModal');
      const modal = new bootstrap.Modal(modalEl, { focus:true, backdrop:'static', keyboard:false });
      modalEl.addEventListener('hidden.bs.modal', ()=>{ loginTriggerBtn?.focus(); }, { once:true });
      modal.show();
    }
    document.getElementById("login-form")?.addEventListener("submit", async function(e) {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      try {
        const resp = await api(`/login`, { method: "POST", headers: { "Content-Type": "application/json", "Accept": "application/json" }, body: JSON.stringify({ username, password }) });
        const data = await resp.json();
        document.getElementById("current-user").innerText = `User: ${username}`;
        const sellerEl = document.getElementById("sellerName");
        if (sellerEl) sellerEl.value = username;      
        refreshFinishedFromInputs();
        try { if (document.getElementById('sellerName')?.value.trim()) { await listContracts(); } } catch {}
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        if (data?.redirect) window.location.href = data.redirect;
      } catch (err) {
        document.getElementById("login-error").innerText = (err?.message || "Login failed");
      }
    });

  </script>
  <script nonce="{{NONCE}}">
    onReady(() => {
      const btn = document.getElementById('rfqGo');
      if(!btn) return;
      btn.onclick = async ()=>{
        const s   = document.getElementById('rfqSym').value;
        const side= document.getElementById('rfqSide').value;
        const q   = +document.getElementById('rfqQty').value;
        if (!q) return toast('Enter qty');
        const exp = new Date(Date.now() + 20*60*1000).toISOString();
        const idem = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
        const r = await api('/rfq', {
          method:'POST',
          headers:{'Content-Type':'application/json', 'Idempotency-Key': idem},
          body: JSON.stringify({ symbol:s, side, quantity_lots:q, expires_at:exp })
        });
        toast('RFQ posted');
        try { console.log(await r.json()); } catch {}
      };
    });
  </script>

  <!-- Policy Acceptance Modal -->
  <div class="modal fade" id="policyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Policy Update</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" disabled></button>
        </div>
        <div class="modal-body">
          <p class="small text-muted mb-2" id="policySummary">
            You must accept the current Terms / Rulebook to create contracts and BOLs.
          </p>
          <p class="small">
            View full documents:
            <a href="/legal/terms.html" target="_blank" rel="noopener noreferrer">Terms</a> ·
            <a href="/legal/eula.html" target="_blank" rel="noopener noreferrer">EULA</a> ·
            <a href="/legal/fees.html" target="_blank" rel="noopener noreferrer">Fees</a> ·
            <a href="/legal/rulebook.html" target="_blank" rel="noopener noreferrer">Rulebook</a>
          </p>
          <div class="form-check mt-3">
            <input class="form-check-input" type="checkbox" id="policyAgreeChkSeller">
            <label class="form-check-label small" for="policyAgreeChkSeller">
              I have read and agree to the current Terms, Rulebook, Fee Schedule, and Policies.
            </label>
          </div>
        </div>
        <div class="modal-footer">
          <button id="policyAcceptBtnSeller" type="button" class="btn btn-primary" disabled>Accept &amp; Continue</button>
        </div>
      </div>
    </div>
  </div>

  <script nonce="{{NONCE}}">
  // Seller/Yard: policy gating
  (function(){
    async function checkPolicies(){
      try{
        const res = await api('/policies/status');
        const j = await res.json();
        if (j.accepted) return;

        let summary = 'You must accept the current Terms / Rulebook to create contracts and BOLs.';
        try{
          const r2 = await api('/policies/current');
          const p = await r2.json();
          if (p && p.version){
            summary = `You must accept ${p.key || 'the Rulebook'} v${p.version} to create contracts and BOLs.`;
          }
        }catch{}

        const sEl = document.getElementById('policySummary');
        if (sEl) sEl.textContent = summary;

        const modalEl = document.getElementById('policyModal');
        if (!modalEl || !(window.bootstrap && bootstrap.Modal)) return;

        const modal = new bootstrap.Modal(modalEl, { backdrop:'static', keyboard:false });
        modal.show();

        const chk = document.getElementById('policyAgreeChkSeller');
        const btn = document.getElementById('policyAcceptBtnSeller');

        chk?.addEventListener('change', () => {
          btn.disabled = !chk.checked;
        });

        btn?.addEventListener('click', async () => {
          btn.disabled = true;
          try{
            await api('/policies/accept', {
              method:'POST',
              headers:{'Content-Type':'application/json'},
              body: JSON.stringify({ key:'rulebook', version: null })
            });
            modal.hide();
            toast('Policy accepted.');
          }catch(e){
            toast(e.message || 'Could not record acceptance');
            btn.disabled = false;
          }
        });
      }catch{
        // If policies endpoints fail, backend still enforces on write; do nothing here.
      }
    }

    onReady(checkPolicies);
  })();
  </script>

  <footer class="legal-footer">
    <hr class="mb-3">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms" class="link-secondary" rel="noopener noreferrer">Terms</a><span>·</span>
      <a href="/legal/privacy" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>·</span>
      <a href="/legal/eula" class="link-secondary" rel="noopener noreferrer">EULA</a><span>·</span>
      <a href="/legal/aup" class="link-secondary" rel="noopener noreferrer">AUP</a><span>·</span>
      <a href="/legal/cookies" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>·</span>
      <a href="/legal/subprocessors" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>·</span>
      <a href="/legal/dpa" class="link-secondary" rel="noopener noreferrer">DPA</a><span>·</span>
      <a href="/legal/sla" class="link-secondary" rel="noopener noreferrer">SLA</a><span>·</span>
      <a href="/legal/security" class="link-secondary" rel="noopener noreferrer">Security</a><span>·</span>
      <a href="/legal/privacy" class="link-secondary" rel="noopener noreferrer">Privacy Appendix</a><span>·</span>
      <a href="/legal/fees" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> – Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>

</body>
</html>
