<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>BRidge Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="icon" href="/static/favicon.ico">

  <style>
    body{font-family:'Roboto',sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#333}
    .container{max-width:100%;margin:auto}
    header.header{background:linear-gradient(90deg,#2c3e50,#34495e);color:#fff;padding:15px 20px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    header.header h1{font-size:28px;margin:0}
    .user-info{font-size:14px}
    .user-info button{margin:0 6px;padding:6px 14px;border:none;background:#e74c3c;color:#fff;border-radius:4px;cursor:pointer;transition:background-color .3s}
    .user-info button:hover{background:#c0392b}
    section.section{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    .section-title{font-weight:700;margin-bottom:15px;font-size:20px;border-bottom:3px solid #3498db;padding-bottom:5px;text-transform:uppercase;letter-spacing:1px;color:#3498db}
    .overview-cards{display:flex;gap:15px;flex-wrap:wrap}
    .card-custom{flex:1;min-width:250px;background:#fff;border:1px solid #e1e4e8;border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column}
    .card-custom:hover{transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;margin-bottom:10px}
    thead.sticky{position:sticky;top:0;background:#fff;z-index:2;box-shadow:0 1px 0 rgba(0,0,0,.06)}
    th,td{padding:12px 15px;border-bottom:1px solid #e1e4e8;text-align:left}
    th{background:#f7f7f7;font-weight:500}
    tr:hover{background:#f9f9f9}
    tr.group-header{background:#e9ecef}
    .action-btn{padding:10px 20px;background:#3498db;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:15px;transition:.3s}
    .action-btn:hover{background:#2980b9}
    .secondary-btn,.danger-btn{padding:6px 12px;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:14px;transition:.3s;margin-right:5px}
    .secondary-btn{background:#27ae60}.secondary-btn:hover{background:#1e8449}
    .danger-btn{background:#e74c3c}.danger-btn:hover{background:#c0392b}
    select,input[type="number"],input[type="date"]{margin-right:8px;padding:8px;font-size:14px;border:1px solid #ced4da;border-radius:4px}
    .chart-container{background:#fff;padding:20px;border-radius:8px;border:1px solid #e1e4e8;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    button:disabled{opacity:.6;cursor:not-allowed}
    .health-badge{font:12px/1 system-ui;color:#cfe9d0}
    .health-badge[data-ok="1"]{color:#10b981}
    .skeleton-row td{height:14px}
    .skeleton{display:block;width:100%;height:10px;border-radius:6px;background:linear-gradient(90deg,#eee,#f6f7f8,#eee);background-size:200% 100%;animation:sk 1.1s linear infinite}
    @keyframes sk{0%{background-position:200% 0}100%{background-position:-200% 0}}
  </style>

  <!-- Gate by role early (session-probed) -->
<script>
  (async () => {
    try {
      // optional: warm cookies
      await fetch('/healthz', { credentials: 'include' });
      const r = await fetch('/me', { credentials: 'include', headers: { 'Accept': 'application/json' }});
      if (!r.ok) throw new Error('no session');
      const me = await r.json(); // expect: { username, role }
      window.__bridgeUser = me;
      if (!me?.role || !['seller','yard','admin','buyer'].includes((me.role||'').toLowerCase())) {
        location.href = '/static/bridge-login.html';
        return;
      }
      // UI role gates
      document.addEventListener('DOMContentLoaded', () => {
        const role = (me.role||'').toLowerCase();
        const userEl = document.getElementById('current-user');
        if (userEl) userEl.textContent = `User: ${me.username || 'Guest'}`;
        document.querySelectorAll('[data-role="admin"]').forEach(el => el.hidden = role!=='admin');
        document.querySelectorAll('[data-role="seller"]').forEach(el => el.hidden = !(role==='seller'||role==='admin'||role==='yard'));
        document.querySelectorAll('[data-role="buyer"]').forEach(el => el.hidden = role!=='buyer');
      });
    } catch {
      location.href = '/static/bridge-login.html';
    }
  })();
</script>

</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>BRidge Dashboard</h1>
      <div class="user-info">
        <span id="current-user">User: Guest</span>
        <button type="button" onclick="showLoginModal()">Login</button>
        <button type="button" onclick="doLogout()">Logout</button>
<script>
  async function doLogout(){
    try { await api('/logout', { method:'POST' }); } catch {}
    localStorage.removeItem('bridgeUser');
    location.href='/static/bridge-login.html';
  }

</script>
        <button type="button" onclick="location.href='/static/spec-ferrous.html'">Spec Sheet Ferrous</button>
        <button type="button" onclick="location.href='/static/spec-nonferrous.html'">Spec Sheet Nonferrous</button>
        <button type="button" onclick="location.href='/static/shipping-terms.html'">Shipping Terms</button>
        <button type="button" onclick="location.href='/static/contract-specs.html'">Contract Specs</button>
        <button type="button" onclick="location.href='/static/mixed-load.html'">Mixed Load</button>
        <span id="header-date">—</span>
        <span class="health-badge" data-health-badge>● Checking…</span>
      </div>
    </header>

    <!-- Overview Cards -->
    <section class="section">
      <div class="section-title">Overview Cards</div>
      <div class="overview-cards">
        <div id="finished-goods-card" class="card-custom">
        <div><strong>Finished Goods</strong></div>
        <div id="finishedGoodsInfo">Loading...</div>
        <div class="chart-container" style="height:220px">
          <canvas id="finishedGoodsChart"></canvas>
        </div>
      </div>

        <div class="card-custom">
          <div><strong>Active Contracts</strong></div>
          <div id="active-contracts-secured">0 Secured</div>
          <div id="active-contracts-margin">Margin: $0.00</div>
          <div id="active-contracts-change">Total Change: $0.00</div>
          <div class="chart-container" style="height:220px">
            <canvas id="activeContractsChart"></canvas>
          </div>
        </div>
        <div class="card-custom">
          <div class="d-flex align-items-center justify-content-center gap-2">
            <strong class="me-2">Market Snapshot</strong>
            <span id="copperBaseBadge" class="badge bg-info text-dark"></span>
          </div>
          <div id="price-Copper">Copper: —</div>
          <div id="price-BushelingSteel">Busheling Steel: —</div>
          <div id="price-Brass">Brass: —</div>
          <div id="price-Aluminum">Aluminum: —</div>
          <div id="price-ElectricMotors">Electric Motors: —</div>
          <div id="price-InsulatedCopperWire">Insulated Copper Wire: —</div>
          <div id="price-Lead">Lead: —</div>
          <div id="price-HMSSteel2">HMS Steel #2: —</div>
          <div id="price-CuRadiator50Cu50Brass">Cu Radiator (50Cu/50Brass): —</div>
          <div id="price-Carbide">Carbide: —</div>
          <div id="price-StainlessSteel">Stainless Steel: —</div>
        </div>
      </div>
    </section>

    <!-- Price This Material -->
    <section class="section">
      <div class="section-title">Price This Material</div>
      <div class="card" style="margin-top:12px; padding:12px;">
        <label>Category:
          <select id="catSel" class="form-select" style="max-width:220px; display:inline-block; margin-right:8px;">
            <option>Copper</option><option>Aluminum</option><option>Brass</option>
            <option>Insulated Wire</option><option>Misc Product</option><option>Radiator Product</option>
            <option>Lead</option><option>Stainless</option>
          </select>
        </label>
        <label>Material:
          <input id="matInput" class="form-control" placeholder="e.g., #1 or AL6063_OldExtrusion" style="width:260px; display:inline-block; margin: 0 8px;"/>
        </label>
        <button type="button" class="btn btn-primary" id="btnQuote">Quote</button>
        <div id="quoteOut" class="text-muted" style="margin-top:8px;"></div>
      </div>
    </section>

    <!-- Finished Goods Inventory -->
    <section class="section">
      <div class="section-title">Finished Goods Inventory</div>
      <div class="table-responsive">
        <table id="greenspark-table" class="table">
          <caption class="visually-hidden">Finished goods inventory by SKU</caption>
          <thead class="sticky">
            <tr>
              <th>Commodities</th>
              <th>WIP (lbs)</th>
              <th>Finished Goods (lbs)</th>
              <th>Total (lbs)</th>
              <th>Avg Cost ($/lb)</th>
              <th>Total Purchase Value</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td><strong>Totals:</strong></td>
              <td id="total-wip">0</td>
              <td id="total-finished">0</td>
              <td id="total-total">0</td>
              <td></td>
              <td id="total-purchase">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Inventory Import & Manual Add -->
    <section class="section">
      <div class="section-title">Inventory Import & Manual Add</div>
      <div class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">CSV / XLSX File</label>
          <input type="file" id="invFile" class="form-control" accept=".csv,.xlsx">
        </div>
        <div class="col-md-3">
          <label class="form-label">Default Seller (optional)</label>
          <input id="invDefaultSeller" class="form-control" placeholder="yard name">
        </div>
        <div class="col-md-2">
          <button type="button" class="btn btn-primary w-100" id="uploadInvBtn">Upload</button>
        </div>
        <div class="col-md-3">
          <a class="btn btn-outline-secondary w-100" href="/inventory/template.csv" download id="dlTemplateBtn">Download CSV template</a>
        </div>
      </div>

      <div class="row g-2 mt-3">
        <div class="col-md-3"><input id="invSku" class="form-control" placeholder="SKU (e.g., SHRED)" autocapitalize="off" autocomplete="off" spellcheck="false" list="skuList"></div>
        <div class="col-md-2"><input id="invQty" type="number" step="0.01" class="form-control" placeholder="Qty on hand (tons)"></div>
        <div class="col-md-2"><input id="invLocation" class="form-control" placeholder="Location"></div>
        <div class="col-md-3"><input id="invDesc" class="form-control" placeholder="Description (optional)"></div>
        <div class="col-md-2"><button type="button" class="btn btn-success w-100" id="manualAddBtn">Manual Add/Set</button></div>
      </div>

      <div id="invUploadMsg" class="small text-muted mt-2"></div>
    </section>

    <!-- Create Contract -->
    <section class="section">
      <div class="section-title">Create Contract</div>
      <div class="row g-2 mb-2">
        <div class="col-md-3">
          <input id="sellerName" class="form-control" placeholder="Seller" autocapitalize="off" autocomplete="off" spellcheck="false">
        </div>
        <div class="col-md-3">
          <input id="buyerName" class="form-control" placeholder="Buyer (mark open or designate)">
        </div>
        <div class="col-md-3">
          <input id="material" class="form-control" placeholder="Material / SKU (e.g., SHRED)"
                autocapitalize="off" autocomplete="off" spellcheck="false" list="skuList">
        </div>
        <div class="col-md-1">
          <input id="tons" type="number" class="form-control" placeholder="Tons" min="0.01" step="0.01">
        </div>
        <div class="col-md-2">
          <input id="price" type="number" class="form-control" placeholder="$/ton" min="0.01" step="0.01">
        </div>
      </div>
      <!-- CREATE CONTRACT button (needed by wireSellerUI) -->
      <div class="mt-2">
        <button type="button" id="createContractBtn" class="btn btn-primary">
          Create Contract
        </button>
      </div>
      <!-- place ONE shared datalist somewhere once in the page (you already have it under Inventory; if not, keep this): -->
      <datalist id="skuList"></datalist>

      <!-- RFQ (two-click) -->
      <div class="card p-3 mt-3" style="max-width:520px" data-role="buyer">
        <div class="d-flex gap-2">
          <select id="rfqSym" class="form-select">
            <option>CU-SHRED-1M</option>
            <option>AL-6061-1M</option>
          </select>
          <select id="rfqSide" class="form-select">
            <option>buy</option>
            <option>sell</option>
          </select>
          <input id="rfqQty" class="form-control" type="number" placeholder="Qty (lots)" min="0.01" step="0.01">
          <button type="button" id="rfqGo" class="btn btn-primary">RFQ</button>
        </div>
      </div>
    </section>

    <!-- Recent Movements -->
    <section class="section" id="recentMovementsSection">
      <div class="section-title">Recent Inventory Movements</div>
      <div class="text-muted small mb-2">Shows the latest 5 movements for this seller/material.</div>
      <ul id="recentMovements" class="list-group"></ul>
    </section>

    <!-- My Contracts -->
    <section class="section">
      <div class="section-title">My Contracts</div>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="filterStatus" class="form-control form-control-sm" placeholder="Status (e.g., Pending)"></div>
        <div class="col-md-3"><input id="filterStart" type="date" class="form-control form-control-sm" placeholder="Start (ISO)"></div>
        <div class="col-md-3"><input id="filterEnd" type="date" class="form-control form-control-sm" placeholder="End (ISO)"></div>
       <div class="col-md-3 d-flex gap-2">
        <button type="button" class="btn btn-outline-secondary btn-sm" id="refreshContractsBtn">Refresh</button>
        <button type="button" class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn">Clear</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm" id="sellerContractsTable">
  <caption class="visually-hidden">Contracts list with filters and paging</caption>
          <thead class="sticky">
            <tr>
              <th>ID</th><th>Buyer</th><th>Material</th><th>Tons</th><th>$/ton</th><th>Status</th><th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="prevBtn">◀ Prev</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next ▶</button>
        <span class="small text-muted" id="pageInfo"></span>
      </div>
    </section>

    <!-- Trade Log (placeholder) -->
    <section class="section">
      <div class="section-title">Trade Log</div>
      <table id="trade-log-table" class="table">
        <caption class="visually-hidden">Recent trade log</caption>
        <thead class="sticky"><tr><th>Time</th><th>Material</th><th>Quantity (tons)</th><th>Price/ton</th><th>Total Contract Value</th><th>Location</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Metals Market Overview (static demo) -->
    <section class="section">
      <div class="section-title">Metals Market Overview</div>
      <table id="metals-market-table" class="table">
        <caption class="visually-hidden">Metals market overview</caption>
        <thead class="sticky"><tr><th>Symbol</th><th>Contract Name</th><th>Last</th><th>Change</th><th>Open</th><th>High</th><th>Low</th><th>Volume</th><th>Time</th></tr></thead>
        <tbody>
          <tr><td>GCJ25</td><td>Gold (Apr '25)</td><td>2,953.25</td><td>-2.90</td><td>2,957.50</td><td>2,964.70</td><td>2,920.00</td><td>155,552</td><td>02/21/25</td></tr>
          <tr><td>ICWR25</td><td>Insulated Copper Wire (Apr '25)</td><td>23.95</td><td>+0.10</td><td>23.85</td><td>24.20</td><td>23.65</td><td>80,334</td><td>02/21/25</td></tr>
          <tr><td>HGG25</td><td>High Grade Copper (May '25)</td><td>4.6155</td><td>-0.0050</td><td>4,590.00</td><td>4,669.0</td><td>4,580.00</td><td>36,500</td><td>02/21/25</td></tr>
        </tbody>
      </table>
    </section>

    <!-- KPIs -->
    <section class="section">
      <div class="section-title">Key Performance Indicators (KPIs)</div>
      <div class="kpi-content">
  <div class="chart-container" style="height:220px">
    <canvas id="kpiChart"></canvas>
  </div>
</div>
    </section>
  </div>

  <!-- KPI Detail Modal -->
  <div class="modal fade" id="kpiDetailModal" tabindex="-1" aria-labelledby="kpiDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="kpiDetailModalLabel">KPI Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body"><p>Detailed analysis of monthly revenue, cost savings, and trade volume trends.</p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div></div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <form id="login-form" autocomplete="on">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Login</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input
                type="text"
                id="username"
                name="username"
                class="form-control"
                required
                autocomplete="username"
                inputmode="email"
                enterkeyhint="go">
            </div>

            <div class="mb-3">
              <label for="password" class="form-label">Password</label>
              <input
                type="password"
                id="password"
                name="password"
                class="form-control"
                required
                autocomplete="current-password"
                enterkeyhint="done">
            </div>

            <div id="login-error" class="text-danger small" role="alert" aria-live="polite"></div>
          </div>

          <div class="modal-footer">
            <button type="submit" class="action-btn">Login</button>
            <button type="button" class="secondary-btn" data-bs-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div id="toast"
     role="status"
     aria-live="polite"
     aria-atomic="true"
     tabindex="-1"
     style="position:fixed;right:16px;bottom:16px;max-width:360px;display:none;
            padding:12px 14px;background:#111827;color:#fff;border-radius:10px;
            box-shadow:0 6px 24px rgba(0,0,0,.2);font:14px system-ui;z-index:9999">
    </div>

  <script
    defer
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-ENjdO4Dr2bkBIFxQpeoTz1HIcje39Wm4jDKdf19U8Y5nUj0v+0U5r2Xq5PW9KSkP"
    crossorigin="anonymous"
  ></script>

  <script defer src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // endpoint + api + toast + health
    const ORIGIN = location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin;
    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

let __toastTimer;
function toast(msg, ms=2800){
  const t=document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  try { t.focus(); } catch {}
  clearTimeout(__toastTimer);
  __toastTimer = setTimeout(()=>{ t.style.display='none'; }, ms);
}

async function api(path, opts={}) {
  const url = path.startsWith('http') ? path : `${ORIGIN}${path}`;
  const res = await fetch(url, {
    credentials: 'include',
    ...opts,
    headers:{ 'Accept':'application/json', 'X-CSRF': _cookie('XSRF-TOKEN'), ...(opts.headers||{}) }
  });

      if (res.status === 401) { const next = encodeURIComponent(location.pathname + location.search); location.href = `/static/bridge-login.html?next=${next}`; throw new Error('Unauthorized'); }
      if (!res.ok) { let m='Request failed'; try{ m=(await res.clone().json()).detail||m; }catch{ m=await res.text()||m; } toast(m); throw new Error(m); }
      return res;
    }
    window.addEventListener('DOMContentLoaded', async ()=>{ try{ const r=await api('/healthz'); if(r.ok){ const b=document.querySelector('[data-health-badge]'); b.textContent='● Live'; b.setAttribute('data-ok','1'); } }catch{} });

    const accentColor = '#3498db';
    // ---- Timezone toggle (UTC vs local) ----
    let __useUTC = localStorage.getItem('seller.useUTC') === '1';
    function _fmtDate(d){
      const dt = new Date(d);
      return __useUTC
        ? dt.toLocaleString('en-US', { timeZone:'UTC', timeZoneName:'short' })
        : dt.toLocaleString();
    }
    function _renderTZHintSeller(){
      let el = document.getElementById('header-date');
      if (!el) return;
      const tz = Intl.DateTimeFormat().resolvedOptions().timeZone || 'local';
      el.title = `Times shown in ${__useUTC ? 'UTC' : tz} — click to toggle`;
      el.style.cursor = 'pointer';
      el.onclick = () => {
        __useUTC = !__useUTC;
        localStorage.setItem('seller.useUTC', __useUTC ? '1':'0');
        // re-render views with dates
        try { listContracts(); } catch{}
        try {
          const seller = (document.getElementById("sellerName")?.value || '').trim();
          const mat = (document.getElementById("material")?.value || '').trim();
          renderRecentMovements(seller, mat);
        } catch{}
        _renderTZHintSeller();
      };
    }
    document.addEventListener('DOMContentLoaded', _renderTZHintSeller);
// ---- /Timezone toggle ----

    document.querySelectorAll('.section-title').forEach(el => { el.style.borderColor = accentColor; el.style.color = accentColor; });

    let activeContractsChart, finishedGoodsChart, kpiChart;
    const activeContractsChangeHistory = [], activeContractsChartLabels = [];
    let finishedGoodsChartLabels = [], finishedGoodsChartData = [];
    let kpiChartLabels = [], kpiChartData = [];

            document.addEventListener('DOMContentLoaded', () => {
      // ensure buttons are wired:
      try { wireSellerUI(); } catch {}

      const hd = document.getElementById('header-date'); if (hd) hd.textContent = _fmtDate(new Date());

      const activeCanvas = document.getElementById('activeContractsChart');
      if (activeCanvas) {
        activeContractsChart = new Chart(activeCanvas.getContext('2d'), {
          type: 'line',
          data: { labels: activeContractsChartLabels, datasets: [{ label: 'Total Change', data: activeContractsChangeHistory, borderColor: accentColor, backgroundColor:'rgba(52,152,219,0.2)', fill:true, tension:0.1 }]},
          options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true } } }
        });
      }
      const finishedCanvas = document.getElementById('finishedGoodsChart');
      if (finishedCanvas) {
        finishedGoodsChart = new Chart(finishedCanvas.getContext('2d'), {
          type: 'line',
          data: { labels: finishedGoodsChartLabels, datasets: [{ label: 'Total Tons', data: finishedGoodsChartData, borderColor: accentColor, backgroundColor:'rgba(52,152,219,0.2)', fill:true, tension:0.1 }]},
          options: { responsive:true, maintainAspectRatio:false, scales: { y: { beginAtZero: true } } }
        });
      }
      const kpiCanvas = document.getElementById('kpiChart');
      if (kpiCanvas) {
        const ctxKPI = kpiCanvas.getContext('2d');
        kpiChartLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const d1 = [100,120,130,110,140,150,180,200,175,185,120,100];
        const d2 = [50,60,55,70,65,80,90,110,100,70,50,50];
        const d3 = [80,90,85,95,100,105,120,140,110,75,90,80];
        kpiChart = new Chart(ctxKPI, {
          type: 'bar',
          data: { labels: kpiChartLabels, datasets: [
            { label:'Electric Motors', data:d1, backgroundColor:'rgba(52,152,219,0.6)' },
            { label:'Brass',           data:d2, backgroundColor:'rgba(46,204,113,0.6)' },
            { label:'Insulated Wire',  data:d3, backgroundColor:'rgba(231,76,60,0.6)' }
          ]},
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } }
          }
        });
      }

      refreshFinishedFromInputs();
    });

    // Pricing widget
    document.addEventListener('DOMContentLoaded', () => {
      const btn = document.getElementById('btnQuote');
      if (!btn) return;
      btn.onclick = async () => {
        const cat = document.getElementById('catSel').value;
        const mat = document.getElementById('matInput').value.trim();
        if (!mat) return;
        const el = document.getElementById('quoteOut');
        btn.disabled = true; btn.textContent = 'Quoting…';
        try {
          const r = await api(`/pricing/quote?category=${encodeURIComponent(cat)}&material=${encodeURIComponent(mat)}`);
          const j = await r.json();
          el.innerHTML = `
            <span class="badge bg-primary">${j.category} / ${j.material}</span>
            <span class="badge bg-light text-dark ms-2">$${(+j.price_per_lb).toFixed(4)} / lb</span>
          `;
        } catch {
          el.innerHTML = `<span class="badge bg-warning text-dark">No price (check spelling)</span>`;
        } finally {
          btn.disabled = false; btn.textContent = 'Quote';
        }
      };
    });

    function updatePurchaseValues() {
      const table = document.getElementById('greenspark-table');
      const rows = table.querySelectorAll('tbody tr.group-sub');
      let sumWIP=0,sumFinished=0,sumTotal=0,sumPurchase=0;
      rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length >= 6) {
          const wip = parseFloat(cells[1].textContent.replace(/,/g,''))||0;
          const finished = parseFloat(cells[2].textContent.replace(/,/g,''))||0;
          const totalLbs = parseFloat(cells[3].textContent.replace(/,/g,''))||0;
          const avgCost = parseFloat(cells[4].textContent.replace(/[^0-9.]/g,''))||0;
          const purchaseValue = totalLbs * avgCost;
          sumWIP += wip; sumFinished += finished; sumTotal += totalLbs; sumPurchase += purchaseValue;
          cells[5].textContent = '$'+purchaseValue.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        }
      });
      document.getElementById('total-wip').textContent = sumWIP.toLocaleString();
      document.getElementById('total-finished').textContent = sumFinished.toLocaleString();
      document.getElementById('total-total').textContent = sumTotal.toLocaleString();
      document.getElementById('total-purchase').textContent = '$'+sumPurchase.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

      const info = document.getElementById('finishedGoodsInfo');
      if (info) {
        const totalTons = sumTotal/2000;
        const contractsAvailable = Math.floor(sumFinished/20000);
        info.innerHTML = `<div>${contractsAvailable} Contracts Available</div><div>~${totalTons.toFixed(1)} Total Tons</div>`;
        if (finishedGoodsChart) {
          const now = _fmtDate(new Date());
          finishedGoodsChartLabels.push(now);
          finishedGoodsChartData.push(totalTons);
          if (finishedGoodsChartData.length > 10) { finishedGoodsChartLabels.shift(); finishedGoodsChartData.shift(); }
          finishedGoodsChart.update();
        }
      }
    }

    // Seller logic
    let offset = 0, limit = 50;

    async function loadFinishedGoods(seller) {
      const tbody = document.querySelector('#greenspark-table tbody');
      if (!seller) { tbody.innerHTML = `<tr><td colspan="6" class="text-muted">Enter seller to load finished goods.</td></tr>`; return; }
      // skeleton
      tbody.innerHTML = ''; for(let i=0;i<5;i++){ const tr=document.createElement('tr'); tr.className='group-sub'; tr.innerHTML = '<td colspan="6"><span class="skeleton" style="height:12px;display:block"></span></td>'; tbody.appendChild(tr); }

      try {
        const r = await api(`/inventory/finished_goods?seller=${encodeURIComponent(seller)}`);
        const rows = await r.json();
        tbody.innerHTML = '';
        if (!rows.length) {
          tbody.innerHTML = `<tr><td colspan="6" class="text-muted">No finished goods on file.</td></tr>`;
        } else {
          rows.forEach(item => {
            const sku = item.sku || '';
            const wip = Math.max(0, Number(item.wip_lbs ?? 0));
            const finished = Math.max(0, Number(item.finished_lbs ?? 0));
            const total = wip + finished;
            const avgCost = Number(item.avg_cost_per_lb ?? 0) || 0;
            const totalPurchaseValue = total * avgCost;
            const tr = document.createElement('tr');
            tr.classList.add('group-sub');
            tr.innerHTML = `
              <td>${sku}</td>
              <td>${wip.toLocaleString()}</td>
              <td>${finished.toLocaleString()}</td>
              <td>${total.toLocaleString()}</td>
              <td>${avgCost ? '$'+avgCost.toFixed(2) : '-'}</td>
              <td>$${totalPurchaseValue.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        updatePurchaseValues();
        try {
          const dl = document.getElementById('skuList');
          if (dl && Array.isArray(rows)) {
            dl.innerHTML = '';
            const seen = new Set();
            rows.forEach(item => {
              const sku = (item.sku || '').toString();
              if (sku && !seen.has(sku.toLowerCase())) {
                seen.add(sku.toLowerCase());
                const opt = document.createElement('option');
                opt.value = sku;
                dl.appendChild(opt);
              }
            });
          }
        } catch {}
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted">Finished goods not available yet.</td></tr>`;
        updatePurchaseValues();
      }
    }

    function refreshFinishedFromInputs() {
      const seller = (document.getElementById("sellerName")?.value || '').trim()
                  || (document.getElementById('invDefaultSeller')?.value || '').trim();
      if (seller) loadFinishedGoods(seller);
    }

    async function renderRecentMovements(seller, material) {
      if (!seller || !material) return;
      const url = `/inventory/movements/list?seller=${encodeURIComponent(seller)}&sku=${encodeURIComponent(material)}&limit=5`;
      try {
        const r = await api(url);
        const rows = await r.json();
        const ul = document.getElementById("recentMovements");
        ul.innerHTML = "";
        if (!rows.length) {
          ul.innerHTML = `<li class="list-group-item text-muted">No recent movements.</li>`;
          return;
        }
        rows.forEach(mv => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          const when = mv.created_at ? _fmtDate(mv.created_at) : "";
          const qty = (mv.qty !== undefined && mv.qty !== null) ? Number(mv.qty).toLocaleString() : "";
          li.innerHTML = `
            <div>
              <div><strong>${(mv.movement_type||'').toUpperCase()}</strong> — ${mv.sku || ''}</div>
              <div class="small text-muted">${when}</div>
            </div>
            <span class="badge bg-secondary rounded-pill">${qty}</span>`;
          ul.appendChild(li);
        });
      } catch (e) {}
    }

    async function createContract() {
      const seller = document.getElementById("sellerName").value.trim();
      const buyer  = document.getElementById("buyerName").value.trim();
      const material = document.getElementById("material").value.trim();
      const weight_tons = parseFloat(document.getElementById("tons").value);
      const price_per_ton = parseFloat(document.getElementById("price").value);

      if (!seller || !buyer || !material || !Number.isFinite(weight_tons) || !Number.isFinite(price_per_ton)) {
        toast("Fill all fields (seller, buyer, material, tons, $/ton).");
        return;
      }

      const res = await api(`/contracts`, {
        method: "POST",
        headers: { "Content-Type": "application/json", "Idempotency-Key": (crypto.randomUUID?.() || String(Date.now())) },
        body: JSON.stringify({ seller, buyer, material, weight_tons, price_per_ton })
      });

      toast(`Reserved ${weight_tons} tons of ${material} from ${seller}.`);
      await listContracts();
      renderRecentMovements(seller, material);
      refreshFinishedFromInputs();
    }

    async function listContracts() {
      const seller = document.getElementById("sellerName").value.trim();
      if (!seller) return;
      const status = document.getElementById("filterStatus").value.trim();
      const start  = document.getElementById("filterStart").value;
      const end    = document.getElementById("filterEnd").value;

      const qs = new URLSearchParams({ seller, limit, offset });
      if (status) qs.set("status", status);
      if (start)  qs.set("start", new Date(start).toISOString());
      if (end)    qs.set("end",   new Date(end).toISOString());

      const tbody = document.querySelector("#sellerContractsTable tbody");
      // skeleton
      tbody.innerHTML=''; for(let i=0;i<5;i++){ const tr=document.createElement('tr'); tr.className='skeleton-row'; tr.innerHTML=Array.from({length:7},()=>'<td><span class="skeleton"></span></td>').join(''); tbody.appendChild(tr); }

      const res = await api(`/contracts?${qs.toString()}`);
      const totalCount = +(res.headers.get('X-Total-Count') || 0);
      const rows = await res.json();

      tbody.innerHTML = "";
      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7" class="text-muted text-center py-3">No contracts match your filters.</td>`;
        tbody.appendChild(tr);
      } else {
        rows.forEach(r => {
          const tr = document.createElement("tr");
          const created = r.created_at ? _fmtDate(r.created_at) : "";
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.buyer}</td>
            <td>${r.material}</td>
            <td>${r.weight_tons ?? ""}</td>
            <td>${r.price_per_ton ?? ""}</td>
            <td>${r.status ?? ""}</td>
            <td>${created}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("pageInfo").textContent = totalCount
        ? `Showing ${rows.length} • ${offset+1}–${offset+rows.length} of ${totalCount}`
        : `Showing ${rows.length} • offset ${offset}`;
      const prev = document.getElementById('prevBtn');
      const next = document.getElementById('nextBtn');
      if (prev) prev.disabled = offset === 0;
      if (next) next.disabled = rows.length < limit;

    }

    // saved filters in URL
    function _syncQuery(params){
      const u = new URL(location.href);
      for (const [k,v] of Object.entries(params)) {
        if (v === '' || v == null) u.searchParams.delete(k); else u.searchParams.set(k, v);
      }
      history.replaceState({}, '', u);
    }

    function wireSellerUI() {
      const userEl = document.getElementById("current-user");
      const sellerEl = document.getElementById("sellerName");
      if (userEl && sellerEl) {
        const u = userEl.textContent?.replace("User:", "").trim();
        if (u && u !== "Guest") sellerEl.value = u;
      }

      document.getElementById("createContractBtn")?.addEventListener("click", createContract);
      document.getElementById("refreshContractsBtn")?.addEventListener("click", () => {
        offset = 0;
        _syncQuery({
          status: document.getElementById("filterStatus").value.trim(),
          start:  document.getElementById("filterStart").value,
          end:    document.getElementById("filterEnd").value,
          page:   1
        });
        listContracts();
      });
      document.getElementById("clearFiltersBtn")?.addEventListener("click", () => {
        document.getElementById("filterStatus").value = "";
        document.getElementById("filterStart").value  = "";
        document.getElementById("filterEnd").value    = "";
        offset = 0; _syncQuery({status:'',start:'',end:'',page:1}); listContracts();
      });
      document.getElementById("prevBtn")?.addEventListener("click", () => { offset = Math.max(0, offset - limit); const page = Math.floor(offset/limit)+1; _syncQuery({ page }); listContracts(); });
      document.getElementById("nextBtn")?.addEventListener("click", () => { offset += limit; const page = Math.floor(offset/limit)+1; _syncQuery({ page }); listContracts(); });

      const sellerInput = document.getElementById('sellerName');
      if (sellerInput) {
        const onSellerChange = async () => {
          offset = 0;
          refreshFinishedFromInputs();
          try { await listContracts(); } catch {}
        };
        sellerInput.addEventListener('change', onSellerChange);
        sellerInput.addEventListener('blur', onSellerChange);
        sellerInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') onSellerChange(); });
      }

      setTimeout(listContracts, 200);
    }

    async function uploadInvFile() {
      const f = document.getElementById('invFile').files[0];
      if (!f) { toast('Choose a CSV or XLSX file'); return; }
      const sellerDefault = document.getElementById('invDefaultSeller').value.trim();
      const fd = new FormData(); fd.append('file', f); if (sellerDefault) fd.append('seller', sellerDefault);
      const isXlsx = /\.xlsx?$/i.test(f.name);
      const r = await api(`/inventory/import/${isXlsx ? 'excel' : 'csv'}`, { method:'POST', body: fd });
      const txt = await r.text();
      try { const j = JSON.parse(txt); document.getElementById('invUploadMsg').innerText = `Upserted ${j.upserted}. Errors: ${(j.errors||[]).length}`; }
      catch { document.getElementById('invUploadMsg').innerText = txt; }
      refreshFinishedFromInputs();
    }

    async function manualAddInventory() {
      const seller = document.getElementById('sellerName').value.trim()
                    || document.getElementById('invDefaultSeller').value.trim();
      const sku = document.getElementById('invSku').value.trim();
      const qty = parseFloat(document.getElementById('invQty').value);
      const location = document.getElementById('invLocation').value.trim();
      const description = document.getElementById('invDesc').value.trim();

      if (!seller || !sku || !Number.isFinite(qty)) { toast('Seller, SKU, and Qty are required.'); return; }

      const resp = await api(`/inventory/manual_add`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Idempotency-Key': (crypto.randomUUID?.() || String(Date.now())) },
        body: JSON.stringify({
          seller, sku, qty_on_hand: qty, uom: 'ton',
          location: location || undefined, description: description || undefined,
          source: 'manual'
        })
      });
      toast('Inventory updated.');
      renderRecentMovements(seller, sku);
      refreshFinishedFromInputs();
    }

        document.addEventListener('DOMContentLoaded', () => {
      const userEl = document.getElementById("current-user");
      const sellerEl = document.getElementById("sellerName");
      if (userEl && sellerEl) {
        const u = (userEl.textContent || '').replace("User:", "").trim();
        if (u && u !== "Guest") sellerEl.value = u;
      }
      // hydrate filters from URL
      const q = new URL(location.href).searchParams;
      const s = q.get('status') || ''; const st = q.get('start') || ''; const en = q.get('end') || '';
      const page = +(q.get('page')||'1');
      document.getElementById("filterStatus").value = s;
      document.getElementById("filterStart").value  = st;
      document.getElementById("filterEnd").value    = en;
      offset = Math.max(0,(page-1))*limit;

      refreshFinishedFromInputs();
      document.getElementById('uploadInvBtn')?.addEventListener('click', uploadInvFile);
      document.getElementById('manualAddBtn')?.addEventListener('click', manualAddInventory);
          });

    // Login modal + focus restore
    let loginTriggerBtn = null;
    function showLoginModal() {
      loginTriggerBtn = document.activeElement;
      const modalEl = document.getElementById('loginModal');
      const modal = new bootstrap.Modal(modalEl, { focus:true, backdrop:'static', keyboard:false });
      modalEl.addEventListener('hidden.bs.modal', ()=>{ loginTriggerBtn?.focus(); }, { once:true });
      modal.show();
    }
    document.getElementById("login-form")?.addEventListener("submit", async function(e) {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      try {
        const resp = await api(`/login`, { method: "POST", headers: { "Content-Type": "application/json", "Accept": "application/json" }, body: JSON.stringify({ username, password }) });
        const data = await resp.json();
        document.getElementById("current-user").innerText = `User: ${username}`;
        const sellerEl = document.getElementById("sellerName");
        if (sellerEl) sellerEl.value = username;      
        refreshFinishedFromInputs();
        try { if (document.getElementById('sellerName')?.value.trim()) { await listContracts(); } } catch {}
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        if (data?.redirect) window.location.href = data.redirect;
      } catch (err) {
        document.getElementById("login-error").innerText = (err?.message || "Login failed");
      }
    });

  </script>
  <script>
    document.addEventListener('DOMContentLoaded', ()=>{
      const btn = document.getElementById('rfqGo');
      if(!btn) return;
      btn.onclick = async ()=>{
        const s   = document.getElementById('rfqSym').value;
        const side= document.getElementById('rfqSide').value;
        const q   = +document.getElementById('rfqQty').value;
        if (!q) return toast('Enter qty');
        const exp = new Date(Date.now() + 20*60*1000).toISOString();
        const idem = (crypto.randomUUID && crypto.randomUUID()) || String(Date.now());
        const r = await api('/rfq', {
          method:'POST',
          headers:{'Content-Type':'application/json', 'Idempotency-Key': idem},
          body: JSON.stringify({ symbol:s, side, quantity_lots:q, expires_at:exp })
        });
        toast('RFQ posted');
        try { console.log(await r.json()); } catch {}
      };
    });
  </script>

  <footer style="margin-top:40px;padding:20px;text-align:center;font-size:14px;color:#777">
    <hr style="margin-bottom:12px;">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/terms" class="link-secondary" rel="noopener noreferrer">Terms</a><span>·</span>
      <a href="/privacy" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>·</span>
      <a href="/eula" class="link-secondary" rel="noopener noreferrer">EULA</a><span>·</span>
      <a href="/aup" class="link-secondary" rel="noopener noreferrer">AUP</a><span>·</span>
      <a href="/cookies" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>·</span>
      <a href="/legal/subprocessors" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>·</span>
      <a href="/legal/dpa" class="link-secondary" rel="noopener noreferrer">DPA</a><span>·</span>
      <a href="/legal/sla" class="link-secondary" rel="noopener noreferrer">SLA</a><span>·</span>
      <a href="/legal/security" class="link-secondary" rel="noopener noreferrer">Security</a><span>·</span>
      <a href="/privacy/appendix" class="link-secondary" rel="noopener noreferrer">Privacy Appendix</a><span>·</span>
      <a href="/fees" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> – Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com" style="color:#3498db">info@atlasipholdingsllc.com</a></div>
    <div style="margin-top:10px;">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>

</body>
</html>
