<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Dashboard</title>

  <!-- Deployed API base -->
  <script>
    window.endpoint = "https://bridge-buyer.onrender.com";
  </script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body{font-family:'Roboto',sans-serif;background:#f4f6f8;margin:0;padding:20px;color:#333}
    .container{max-width:100%;margin:auto}
    header.header{background:linear-gradient(90deg,#2c3e50,#34495e);color:#fff;padding:15px 20px;border-radius:8px;display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    header.header h1{font-size:28px;margin:0}
    .user-info{font-size:14px}
    .user-info button{margin:0 10px;padding:6px 14px;border:none;background:#e74c3c;color:#fff;border-radius:4px;cursor:pointer;transition:background-color .3s}
    .user-info button:hover{background:#c0392b}
    section.section{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 4px 8px rgba(0,0,0,.05)}
    .section-title{font-weight:700;margin-bottom:15px;font-size:20px;border-bottom:3px solid #3498db;padding-bottom:5px;text-transform:uppercase;letter-spacing:1px;color:#3498db}
    .overview-cards{display:flex;gap:15px;flex-wrap:wrap}
    .card-custom{flex:1;min-width:250px;background:#fff;border:1px solid #e1e4e8;border-radius:8px;padding:20px;text-align:center;cursor:pointer;transition:transform .3s,box-shadow .3s;display:flex;flex-direction:column}
    .card-custom:hover{transform:translateY(-3px);box-shadow:0 8px 16px rgba(0,0,0,.1)}
    table{width:100%;border-collapse:collapse;margin-bottom:10px}
    th,td{padding:12px 15px;border-bottom:1px solid #e1e4e8;text-align:left}
    th{background:#f7f7f7;font-weight:500}
    tr:hover{background:#f9f9f9;cursor:pointer}
    tr.group-header{background:#e9ecef;cursor:pointer}
    tr.group-header td{font-weight:bold}
    .action-btn{padding:10px 20px;background:#3498db;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:15px;transition:background-color .3s}
    .action-btn:hover{background:#2980b9}
    .secondary-btn,.danger-btn{padding:6px 12px;border:none;border-radius:4px;color:#fff;cursor:pointer;font-size:14px;transition:background-color .3s;margin-right:5px}
    .secondary-btn{background:#27ae60}
    .secondary-btn:hover{background:#1e8449}
    .danger-btn{background:#e74c3c}
    .danger-btn:hover{background:#c0392b}
    select,input[type="number"],input[type="date"]{margin-right:8px;padding:8px;font-size:14px;border:1px solid #ced4da;border-radius:4px}
    .chart-container{background:#fff;padding:20px;border-radius:8px;border:1px solid #e1e4e8;box-shadow:0 4px 8px rgba(0,0,0,.05)}
  </style>

  <!-- Live Copper Base (COMEX last - $0.25) -->
  <script>
    window.copperBaseUSD = null;
    async function fetchCopperBase() {
      try {
        const r = await fetch(`${window.endpoint || 'https://bridge-buyer.onrender.com'}/prices/copper_last`);
        if (!r.ok) throw new Error(`bad resp ${r.status}`);
        const j = await r.json();
        window.copperBaseUSD = j.base_minus_025; // USD/lb
        console.log("Copper base (last - 0.25):", window.copperBaseUSD);
      } catch (e) {
        window.copperBaseUSD = 4.19 - 0.25;
        console.warn("Copper price fallback used:", window.copperBaseUSD, e);
      }
    }
  </script>

  <!-- Material arrays + pricing -->
  <script>
    const copperMaterials = ["Barley","#1","#2","#3"];
    const aluminumMaterials = ["AL6061_NewBareExtrusion","AL6061_ClipPlatePipe","AL6063_Secondary","AL6063_OldExtrusion","AL6063_Extrusion10/10","AL_PAS_Baled","AL_Cast_Clean","AL_RADS_CleanBaled","AL_RADS_DirtyBaled","AL_Sheet_CleanBaled","AL_WheelAuto_Clean","AL_WheelChrome_Clean","TruckWheel_Clean","AL_Wire_BareCATV","AL_Wire_NeopreneACSR","AL_Wire_ECPrepared","AL_MLC_Prepared"];
    const brassMaterials = ["Brass_Hard","Brass_Red_Ebony","Brass_Red_Semi","Brass_Shaving_AlBronze","Brass_Shaving_BrassRed","Brass_Shell","Brass_Special","Brass_YellowRegular"];
    const leadMaterials = ["Lead_Clean","Lead_Range"];
    const stainlessMaterials = ["SS304","SS316"];
    const eScrapMaterials = ["E_Scrap_Board"];
    const insulatedWireMaterials = ["ICW_LowGrade_ChristmasLights","ICW_LowGrade_ComputerWire25","ICW_LowGrade_CuCATV","ICW_LowGrade_ExtCords35Up","ICW_LowGrade_MixedWire40Up","ICW1_Heliax57_OpenEyeBaled","ICW1_MCM85HG","ICW1_Romex65_NoWeatherProof","ICW1_THHN80","ICW2_50Cat5TelWire","ICW2_HarnessWireNoFuseBoxes","ICW2_BX_Cable_AL","ICW2_BX_Cable_FE24"];

    const steelMaterials = ["SHRED","CLIPS","BUSHELING","HMS","PS"];
    function steelPrice(){return 300/2000} // $/lb placeholder

    function copperPrice(grade){
      const base = (typeof window.copperBaseUSD === 'number') ? window.copperBaseUSD : (4.19 - 0.25);
      const mults = {Barley:.94,"#1":.91,"#2":.85,"#3":.83};
      return mults[grade] ? base*mults[grade] : null;
    }
    function aluminumPrice(p){const x={"AL6061_NewBareExtrusion":.84,"AL6061_ClipPlatePipe":.78,"AL6063_Secondary":.78,"AL6063_OldExtrusion":.95,"AL6063_Extrusion10/10":.85,"AL_PAS_Baled":.82,"AL_Cast_Clean":.72,"AL_RADS_CleanBaled":.67,"AL_RADS_DirtyBaled":.46,"AL_Sheet_CleanBaled":.75,"AL_WheelAuto_Clean":.93,"AL_WheelChrome_Clean":.80,"TruckWheel_Clean":.72,"AL_Wire_BareCATV":.43,"AL_Wire_NeopreneACSR":.54,"AL_Wire_ECPrepared":1.03,"AL_MLC_Prepared":.84};return 1.25*(x[p]??null);}
    function brassPrice(p){const m={"Brass_Hard":.81,"Brass_Red_Ebony":.77,"Brass_Red_Semi":.72,"Brass_Shaving_AlBronze":.57,"Brass_Shaving_BrassRed":.61,"Brass_Shell":.60,"Brass_Special":.64,"Brass_YellowRegular":.61};return 4.19*(m[p]??null);}
    function leadPrice(p){if(p==='Lead_Clean')return (2034/2000)*.718;if(p==='Lead_Range')return (2034/2000)*.728;return null;}
    function stainlessPrice(p){if(p==='SS304')return (15675/2000)*.0638;if(p==='SS316')return (15675/2000)*.1174;return null;}
    function eScrapPrice(){return .5;}
    function insulatedWirePrice(p){const m={"ICW_LowGrade_ChristmasLights":.528,"ICW_LowGrade_ComputerWire25":.448,"ICW_LowGrade_CuCATV":1.008,"ICW_LowGrade_ExtCords35Up":.92,"ICW_LowGrade_MixedWire40Up":1.08,"ICW1_Heliax57_OpenEyeBaled":1.536,"ICW1_MCM85HG":2.536,"ICW1_Romex65_NoWeatherProof":1.904,"ICW1_THHN80":2.36,"ICW2_50Cat5TelWire":1.384,"ICW2_HarnessWireNoFuseBoxes":1.408,"ICW2_BX_Cable_AL":1.648,"ICW2_BX_Cable_FE24":.6};return 1.25*(m[p]??null);}

    /* === Group mapping (removed undefined misc/radiator stubs) === */
    const computedCategoriesMapping = {
      "Copper":         { materials: copperMaterials,        pricingFunc: copperPrice },
      "Aluminum":       { materials: aluminumMaterials,      pricingFunc: aluminumPrice },
      "Brass":          { materials: brassMaterials,         pricingFunc: brassPrice },
      "Lead":           { materials: leadMaterials,          pricingFunc: leadPrice },
      "Stainless":      { materials: stainlessMaterials,     pricingFunc: stainlessPrice },
      "E-Scrap":        { materials: eScrapMaterials,        pricingFunc: eScrapPrice },
      "Insulated Wire": { materials: insulatedWireMaterials, pricingFunc: insulatedWirePrice },
      "Steel":          { materials: steelMaterials,         pricingFunc: steelPrice }
    };

    function updateGroupedComputedMaterialsInventory() {
      const tableBody = document.querySelector('#greenspark-table tbody');
      tableBody.querySelectorAll('tr[data-group]').forEach(r => r.remove());

      for (let category in computedCategoriesMapping) {
        const { materials, pricingFunc } = computedCategoriesMapping[category];

        const groupRow = document.createElement('tr');
        groupRow.setAttribute('data-group', category);
        groupRow.classList.add('group-header');
        groupRow.onclick = () => toggleGroup(category);
        groupRow.innerHTML = `<td colspan="6">${category} <span style="float:right;">&#9660;</span></td>`;
        tableBody.appendChild(groupRow);

        materials.forEach(material => {
          const price = pricingFunc(material);
          if (price !== null) {
            const wip = Math.floor(Math.random() * 10000) + 5000;
            const finished = Math.floor(Math.random() * 20000) + 10000;
            const total = wip + finished;
            const avgCost = (price * 0.8).toFixed(2);
            const totalPurchaseValue = (total * price).toFixed(2);

            const subRow = document.createElement('tr');
            subRow.setAttribute('data-group', category);
            subRow.classList.add('group-sub');
            subRow.style.display = 'none';
            subRow.innerHTML = `
              <td>${material} (${category})</td>
              <td>${wip.toLocaleString()}</td>
              <td>${finished.toLocaleString()}</td>
              <td>${total.toLocaleString()}</td>
              <td>$${avgCost}</td>
              <td>$${Number(totalPurchaseValue).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`;
            tableBody.appendChild(subRow);
          }
        });
      }
    }

    function toggleGroup(category) {
      document.querySelectorAll(`tr.group-sub[data-group='${category}']`).forEach(row => {
        row.style.display = (row.style.display === 'none') ? 'table-row' : 'none';
      });
    }
  </script>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <header class="header">
      <h1>BRidge Dashboard</h1>
      <div class="user-info">
        <span id="current-user">User: Guest</span>
        <button onclick="showLoginModal()">Login</button>
        <button onclick="document.getElementById('current-user').innerText='User: Guest'">Logout</button>
        <button onclick="window.location.href='/static/Spec-ferrous.html'">Spec Sheet Ferrous</button>
        <button onclick="window.location.href='/static/Spec-nonferrous.html'">Spec Sheet Nonferrous</button>
        <button onclick="window.location.href='/static/Shipping terms.html'">Shipping Terms</button>
        <button onclick="window.location.href='/static/Contract-specs.html'">Contract Specs</button>
        <button onclick="window.location.href='/static/mixed-load.html'">Mixed Load</button>
        <span id="header-date">—</span>
      </div>
    </header>

    <!-- Overview Cards -->
    <section class="section">
      <div class="section-title">Overview Cards</div>
      <div class="overview-cards">
        <div id="finished-goods-card" class="card-custom">
          <div><strong>Finished Goods</strong></div>
          <div id="finishedGoodsInfo">Loading...</div>
          <canvas id="finishedGoodsChart" width="250" height="200"></canvas>
        </div>
        <div class="card-custom">
          <div><strong>Active Contracts</strong></div>
          <div id="active-contracts-secured">0 Secured</div>
          <div id="active-contracts-margin">Margin: $0.00</div>
          <div id="active-contracts-change">Total Change: $0.00</div>
          <canvas id="activeContractsChart" width="250" height="200"></canvas>
        </div>
        <div class="card-custom">
          <div class="d-flex align-items-center justify-content-center gap-2">
            <strong class="me-2">Market Snapshot</strong>
            <span id="copperBaseBadge" class="badge bg-info text-dark"></span>
          </div>
          <div id="price-Copper">Copper: $9,500.00</div>
          <div id="price-BushelingSteel">Busheling Steel: $700.00</div>
          <div id="price-Brass">Brass: $7,500.00</div>
          <div id="price-Aluminum">Aluminum: $2,200.00</div>
          <div id="price-ElectricMotors">Electric Motors: $900.00</div>
          <div id="price-InsulatedCopperWire">Insulated Copper Wire: $3,600.00</div>
          <div id="price-Lead">Lead: $1,500.00</div>
          <div id="price-HMSSteel2">HMS Steel #2: $500.00</div>
          <div id="price-CuRadiator50Cu50Brass">Cu Radiator (50Cu/50Brass): $5,600.00</div>
          <div id="price-Carbide">Carbide: $20,000.00</div>
          <div id="price-StainlessSteel">Stainless Steel: $1,600.00</div>
        </div>
      </div>
    </section>

    <!-- Finished Goods Inventory -->
    <section class="section">
      <div class="section-title">Finished Goods Inventory</div>
      <div class="table-responsive">
        <table id="greenspark-table" class="table">
          <thead>
            <tr>
              <th>Commodities</th>
              <th>WIP (lbs)</th>
              <th>Finished Goods (lbs)</th>
              <th>Total (lbs)</th>
              <th>Avg Cost ($/lb)</th>
              <th>Total Purchase Value</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot>
            <tr>
              <td><strong>Totals:</strong></td>
              <td id="total-wip">0</td>
              <td id="total-finished">0</td>
              <td id="total-total">0</td>
              <td></td>
              <td id="total-purchase">0</td>
            </tr>
          </tfoot>
        </table>
      </div>
    </section>

    <!-- Create Contract -->
    <section class="section">
      <div class="section-title">Create Contract</div>
      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="sellerName" class="form-control" placeholder="Seller (e.g., Winski Brothers)"></div>
        <div class="col-md-3"><input id="buyerName" class="form-control" placeholder="Buyer (e.g., Lewis Salvage)"></div>
        <div class="col-md-3"><input id="material" class="form-control" placeholder="Material / SKU (e.g., SHRED)"></div>
        <div class="col-md-1"><input id="tons" type="number" class="form-control" placeholder="Tons"></div>
        <div class="col-md-2"><input id="price" type="number" class="form-control" placeholder="$/ton" step="0.01"></div>
      </div>
      <div>
        <button class="action-btn" id="createContractBtn">Create Contract</button>
        <small class="text-muted ms-2">Creates a real contract via POST /contracts</small>
      </div>
    </section>

    <!-- Recent Movements -->
    <section class="section" id="recentMovementsSection">
      <div class="section-title">Recent Inventory Movements</div>
      <div class="text-muted small mb-2">Shows the latest 5 movements for this seller/material.</div>
      <ul id="recentMovements" class="list-group"></ul>
    </section>

    <!-- My Contracts -->
    <section class="section">
      <div class="section-title">My Contracts</div>

      <div class="row g-2 mb-2">
        <div class="col-md-3"><input id="filterStatus" class="form-control form-control-sm" placeholder="Status (e.g., Pending)"></div>
        <div class="col-md-3"><input id="filterStart" type="date" class="form-control form-control-sm" placeholder="Start (ISO)"></div>
        <div class="col-md-3"><input id="filterEnd" type="date" class="form-control form-control-sm" placeholder="End (ISO)"></div>
        <div class="col-md-3 d-flex gap-2">
          <button class="btn btn-outline-secondary btn-sm" id="refreshContractsBtn">Refresh</button>
          <button class="btn btn-outline-secondary btn-sm" id="clearFiltersBtn">Clear</button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm" id="sellerContractsTable">
          <thead>
            <tr>
              <th>ID</th><th>Buyer</th><th>Material</th><th>Tons</th><th>$/ton</th><th>Status</th><th>Created</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-outline-secondary btn-sm" id="prevBtn">◀ Prev</button>
        <button class="btn btn-outline-secondary btn-sm" id="nextBtn">Next ▶</button>
        <span class="small text-muted" id="pageInfo"></span>
      </div>
    </section>

    <!-- (Optional placeholders kept) -->
    <section class="section">
      <div class="section-title">Trade Log</div>
      <table id="trade-log-table" class="table">
        <thead><tr><th>Time</th><th>Material</th><th>Quantity (tons)</th><th>Price/ton</th><th>Total Contract Value</th><th>Location</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <section class="section">
      <div class="section-title">Metals Market Overview</div>
      <table id="metals-market-table" class="table">
        <thead><tr><th>Symbol</th><th>Contract Name</th><th>Last</th><th>Change</th><th>Open</th><th>High</th><th>Low</th><th>Volume</th><th>Time</th></tr></thead>
        <tbody>
          <tr><td>GCJ25</td><td>Gold (Apr '25)</td><td>2,953.25</td><td>-2.90</td><td>2,957.50</td><td>2,964.70</td><td>2,920.00</td><td>155,552</td><td>02/21/25</td></tr>
          <tr><td>ICWR25</td><td>Insulated Copper Wire (Apr '25)</td><td>23.95</td><td>+0.10</td><td>23.85</td><td>24.20</td><td>23.65</td><td>80,334</td><td>02/21/25</td></tr>
          <tr><td>HGG25</td><td>High Grade Copper (May '25)</td><td>4.6155</td><td>-0.0050</td><td>4,590.00</td><td>4,669.0</td><td>4,580.00</td><td>36,500</td><td>02/21/25</td></tr>
        </tbody>
      </table>
    </section>

    <!-- KPIs -->
    <section class="section">
      <div class="section-title">Key Performance Indicators (KPIs)</div>
      <div class="kpi-content"><canvas id="kpiChart" width="400" height="200"></canvas></div>
    </section>
  </div>

  <!-- KPI Detail Modal -->
  <div class="modal fade" id="kpiDetailModal" tabindex="-1" aria-labelledby="kpiDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="kpiDetailModalLabel">KPI Details</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
      <div class="modal-body"><p>Detailed analysis of monthly revenue, cost savings, and trade volume trends.</p></div>
      <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button></div>
    </div></div>
  </div>

  <!-- Login Modal -->
  <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog"><div class="modal-content">
      <form id="login-form">
        <div class="modal-header"><h5 class="modal-title" id="loginModalLabel">Login</h5><button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button></div>
        <div class="modal-body">
          <div class="mb-3"><label for="username" class="form-label">Username:</label><input type="text" id="username" name="username" class="form-control" required></div>
          <div class="mb-3"><label for="password" class="form-label">Password:</label><input type="password" id="password" name="password" class="form-control" required></div>
          <div id="login-error" class="text-danger small"></div>
        </div>
        <div class="modal-footer"><button type="submit" class="action-btn">Login</button><button type="button" class="secondary-btn" data-bs-dismiss="modal">Cancel</button></div>
      </form>
    </div></div>
  </div>

  <!-- Bootstrap & Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Charts + totals + header date -->
  <script>
    const accentColor = '#3498db';
    document.querySelectorAll('.section-title').forEach(el => { el.style.borderColor = accentColor; el.style.color = accentColor; });

    let activeContractsChart;
    const activeContractsChangeHistory = [], activeContractsChartLabels = [];
    let finishedGoodsChart, finishedGoodsChartLabels = [], finishedGoodsChartData = [];
    let kpiChart, kpiChartLabels = [], kpiChartData = [];

    document.addEventListener('DOMContentLoaded', async () => {
      // header date
      const hd = document.getElementById('header-date'); if (hd) hd.textContent = new Date().toLocaleDateString();

      await fetchCopperBase();

      const activeCanvas = document.getElementById('activeContractsChart');
      if (activeCanvas) {
        activeContractsChart = new Chart(activeCanvas.getContext('2d'), {
          type: 'line',
          data: { labels: activeContractsChartLabels, datasets: [{ label: 'Total Change', data: activeContractsChangeHistory, borderColor: accentColor, backgroundColor:'rgba(52,152,219,0.2)', fill:true, tension:0.1 }]},
          options: { scales: { y: { beginAtZero: true } } }
        });
      }

      const finishedCanvas = document.getElementById('finishedGoodsChart');
      if (finishedCanvas) {
        finishedGoodsChart = new Chart(finishedCanvas.getContext('2d'), {
          type: 'line',
          data: { labels: finishedGoodsChartLabels, datasets: [{ label: 'Total Tons', data: finishedGoodsChartData, borderColor: accentColor, backgroundColor:'rgba(52,152,219,0.2)', fill:true, tension:0.1 }]},
          options: { scales: { y: { beginAtZero: true } } }
        });
      }

      const kpiCanvas = document.getElementById('kpiChart');
      if (kpiCanvas) {
        const ctxKPI = kpiCanvas.getContext('2d');
        kpiChartLabels = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        const d1 = [100,120,130,110,140,150,180,200,175,185,120,100];
        const d2 = [50,60,55,70,65,80,90,110,100,70,50,50];
        const d3 = [80,90,85,95,100,105,120,140,110,75,90,80];
        kpiChart = new Chart(ctxKPI, {
          type: 'bar',
          data: { labels: kpiChartLabels, datasets: [
            { label:'Electric Motors', data:d1, backgroundColor:'rgba(52,152,219,0.6)' },
            { label:'Brass',           data:d2, backgroundColor:'rgba(46,204,113,0.6)' },
            { label:'Insulated Wire',  data:d3, backgroundColor:'rgba(231,76,60,0.6)' }
          ]},
          options: { scales: { x:{ stacked:true }, y:{ stacked:true, beginAtZero:true } } }
        });
      }

      // Build inventory table + totals
      updateGroupedComputedMaterialsInventory();
      updatePurchaseValues();

      // copper base badge
      try {
        const badge = document.getElementById("copperBaseBadge");
        if (badge && typeof window.copperBaseUSD === 'number') {
          badge.textContent = `Cu base (COMEX-0.25): $${window.copperBaseUSD.toFixed(4)}/lb`;
        }
      } catch {}
    });

    function updatePurchaseValues() {
      const table = document.getElementById('greenspark-table');
      const rows = table.querySelectorAll('tbody tr.group-sub');
      let sumWIP=0,sumFinished=0,sumTotal=0,sumPurchase=0;
      rows.forEach(row => {
        const cells = row.getElementsByTagName('td');
        if (cells.length >= 6) {
          const wip = parseFloat(cells[1].textContent.replace(/,/g,''))||0;
          const finished = parseFloat(cells[2].textContent.replace(/,/g,''))||0;
          const totalLbs = parseFloat(cells[3].textContent.replace(/,/g,''))||0;
          const avgCost = parseFloat(cells[4].textContent.replace(/[^0-9.]/g,''))||0;
          const purchaseValue = totalLbs * avgCost;
          sumWIP += wip; sumFinished += finished; sumTotal += totalLbs; sumPurchase += purchaseValue;
          cells[5].textContent = '$'+purchaseValue.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
        }
      });
      document.getElementById('total-wip').textContent = sumWIP.toLocaleString();
      document.getElementById('total-finished').textContent = sumFinished.toLocaleString();
      document.getElementById('total-total').textContent = sumTotal.toLocaleString();
      document.getElementById('total-purchase').textContent = '$'+sumPurchase.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

      const info = document.getElementById('finishedGoodsInfo');
      if (info) {
        const totalTons = sumTotal/2000;
        const contractsAvailable = Math.floor(sumFinished/20000);
        info.innerHTML = `<div>${contractsAvailable} Contracts Available</div><div>~${totalTons.toFixed(1)} Total Tons</div>`;
        if (finishedGoodsChart) {
          const now = new Date().toLocaleTimeString();
          finishedGoodsChartLabels.push(now);
          finishedGoodsChartData.push(totalTons);
          if (finishedGoodsChartData.length > 10) { finishedGoodsChartLabels.shift(); finishedGoodsChartData.shift(); }
          finishedGoodsChart.update();
        }
      }
    }
  </script>

  <!-- Real SELLER logic -->
  <script>
    const endpoint = window.endpoint || "https://bridge-buyer.onrender.com";
    let offset = 0, limit = 50;
    const toISO = (d) => d ? new Date(d).toISOString() : undefined;

    async function renderRecentMovements(seller, material) {
      if (!seller || !material) return;
      const url = `${endpoint}/inventory/movements/list?seller=${encodeURIComponent(seller)}&sku=${encodeURIComponent(material)}&limit=5`;
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error(await r.text());
        const rows = await r.json();

        const ul = document.getElementById("recentMovements");
        ul.innerHTML = "";
        if (!rows.length) {
          ul.innerHTML = `<li class="list-group-item text-muted">No recent movements.</li>`;
          return;
        }

        rows.forEach(mv => {
          const li = document.createElement("li");
          li.className = "list-group-item d-flex justify-content-between align-items-center";
          const when = mv.created_at ? new Date(mv.created_at).toLocaleString() : "";
          const qty = (mv.qty !== undefined && mv.qty !== null) ? Number(mv.qty).toLocaleString() : "";
          li.innerHTML = `
            <div>
              <div><strong>${(mv.movement_type||'').toUpperCase()}</strong> — ${mv.sku || ''}</div>
              <div class="small text-muted">${when}</div>
            </div>
            <span class="badge bg-secondary rounded-pill">${qty}</span>`;
          ul.appendChild(li);
        });
      } catch (e) {
        console.warn("recent movements fetch failed:", e);
      }
    }

    async function createContract() {
      const seller = document.getElementById("sellerName").value.trim();
      const buyer  = document.getElementById("buyerName").value.trim();
      const material = document.getElementById("material").value.trim();
      const weight_tons = parseFloat(document.getElementById("tons").value);
      const price_per_ton = parseFloat(document.getElementById("price").value);

      if (!seller || !buyer || !material || !weight_tons || !price_per_ton) {
        alert("Fill all fields (seller, buyer, material, tons, $/ton).");
        return;
      }

      const res = await fetch(`${endpoint}/contracts`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ seller, buyer, material, weight_tons, price_per_ton })
      });
      if (!res.ok) {
        const t = await res.text(); console.error(t);
        alert("Create failed"); return;
      }

      alert(`Reserved ${weight_tons} tons of ${material} from ${seller}.`);

      await listContracts();
      renderRecentMovements(seller, material);
    }

    async function listContracts() {
      const seller = document.getElementById("sellerName").value.trim();
      if (!seller) return;

      const status = document.getElementById("filterStatus").value.trim();
      const start  = toISO(document.getElementById("filterStart").value);
      const end    = toISO(document.getElementById("filterEnd").value);

      const qs = new URLSearchParams({ seller, limit, offset });
      if (status) qs.set("status", status);
      if (start)  qs.set("start", start);
      if (end)    qs.set("end", end);

      const res = await fetch(`${endpoint}/contracts?${qs.toString()}`);
      if (!res.ok) { console.error(await res.text()); return; }
      const rows = await res.json();

      const tbody = document.querySelector("#sellerContractsTable tbody");
      tbody.innerHTML = "";

      if (!rows.length) {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="7" class="text-muted text-center py-3">No contracts match your filters.</td>`;
        tbody.appendChild(tr);
      } else {
        rows.forEach(r => {
          const tr = document.createElement("tr");
          const created = r.created_at ? new Date(r.created_at).toLocaleString() : "";
          tr.innerHTML = `
            <td>${r.id}</td>
            <td>${r.buyer}</td>
            <td>${r.material}</td>
            <td>${r.weight_tons ?? ""}</td>
            <td>${r.price_per_ton ?? ""}</td>
            <td>${r.status ?? ""}</td>
            <td>${created}</td>`;
          tbody.appendChild(tr);
        });
      }

      document.getElementById("pageInfo").textContent = `Showing ${rows.length} • offset ${offset}`;
    }

    function wireSellerUI() {
      const userEl = document.getElementById("current-user");
      const sellerEl = document.getElementById("sellerName");
      if (userEl && sellerEl) {
        const u = userEl.textContent?.replace("User:", "").trim();
        if (u && u !== "Guest") sellerEl.value = u;
      }

      document.getElementById("createContractBtn")?.addEventListener("click", createContract);
      document.getElementById("refreshContractsBtn")?.addEventListener("click", () => { offset = 0; listContracts(); });
      document.getElementById("clearFiltersBtn")?.addEventListener("click", () => {
        document.getElementById("filterStatus").value = "";
        document.getElementById("filterStart").value = "";
        document.getElementById("filterEnd").value = "";
        offset = 0; listContracts();
      });
      document.getElementById("prevBtn")?.addEventListener("click", () => { offset = Math.max(0, offset - limit); listContracts(); });
      document.getElementById("nextBtn")?.addEventListener("click", () => { offset += limit; listContracts(); });

      setTimeout(listContracts, 200);
    }

    document.addEventListener("DOMContentLoaded", wireSellerUI);
  </script>

  <script>
    // Login modal wired to /login
    function showLoginModal() {
      const loginModal = new bootstrap.Modal(document.getElementById('loginModal'));
      loginModal.show();
    }
    document.getElementById("login-form")?.addEventListener("submit", async function(e) {
      e.preventDefault();
      const username = document.getElementById("username").value.trim();
      const password = document.getElementById("password").value.trim();
      try {
        const resp = await fetch(`${window.endpoint || 'https://bridge-buyer.onrender.com'}/login`, {
          method: "POST",
          headers: { "Content-Type": "application/json", "Accept": "application/json" },
          body: JSON.stringify({ username, password })
        });
        if (!resp.ok) throw new Error(await resp.text());
        const data = await resp.json();
        document.getElementById("current-user").innerText = `User: ${username}`;
        bootstrap.Modal.getInstance(document.getElementById('loginModal')).hide();
        if (data?.redirect) window.location.href = data.redirect;
      } catch (err) {
        document.getElementById("login-error").innerText = (err?.message || "Login failed");
      }
    });
  </script>

  <footer style="margin-top:40px;padding:20px;text-align:center;font-size:14px;color:#777">
    <hr style="margin-bottom:15px;">
    <div><strong>BRidge Platform</strong> – Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com" style="color:#3498db">info@atlasipholdingsllc.com</a></div>
    <div style="margin-top:10px;">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
</body>
</html>
