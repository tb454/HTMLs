<!DOCTYPE html>
<html class="loading" lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Admin ‚Äî Compliance & Surveillance</title>

  <!-- Bootstrap + app css -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/static/app.css?v=20251111" nonce="{{NONCE}}">
  <link rel="icon" href="/static/favicon.ico" />

  <script nonce="{{NONCE}}">
    function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        try { fn(); } catch(e){ console.error(e); }
      }
    }
    // Warm cookies / XSRF
    onReady(async () => { try { await fetch('/health', { credentials:'include' }); } catch {} });

    // Loader clearing
    window.hideLoading = function(){
      try { document.documentElement.classList.remove('loading'); } catch {}
      try { document.body.classList.add('loaded'); } catch {}
    };
    setTimeout(() => { try { window.hideLoading && window.hideLoading(); } catch {} }, 2500);
    window.addEventListener('DOMContentLoaded', () => {
      try { window.hideLoading && window.hideLoading(); } catch {}
    });
  </script>

  <script id="boot" nonce="{{NONCE}}">
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);
  </script>
  <script src="/static/js/locale.js" defer nonce="{{NONCE}}"></script>
</head>
<body>

  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
    <select id="lang-select" class="form-select form-select-sm w-auto">
      <option value="en">English</option><option value="es">Espa√±ol</option><option value="zh">‰∏≠Êñá</option>
    </select>
    <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
    <input id="tz-select" class="form-control form-control-sm w-220" list="tz-list" placeholder="America/Phoenix" data-i18n-ph="timezone"/>
    <datalist id="tz-list">
      <option value="America/Phoenix"></option><option value="America/New_York"></option>
      <option value="America/Chicago"></option><option value="America/Los_Angeles"></option>
      <option value="UTC"></option><option value="Europe/London"></option><option value="Asia/Shanghai"></option>
    </datalist>
    <button id="save-locale" class="btn btn-outline-secondary btn-sm ms-1">
      <span data-i18n="save">Save</span>
    </button>
    <small class="text-muted ms-auto" id="local-time"></small>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1"></div>
  
  <nav class="nav nav-pills small">
    <a class="nav-link" href="/static/bridge-admin-dashboard.html">Dashboard</a>
    <a class="nav-link" href="/static/admin-billing.html">Billing</a>
    <a class="nav-link active" href="/static/admin-compliance.html">Compliance</a>
    <a class="nav-link" href="/static/admin-tenants.html">Tenants</a>
    <a class="nav-link" href="/static/indices.html">Indices</a>
    <a class="nav-link" href="/static/trader.html">Trader</a>
  </nav>

  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0">üõ°Ô∏è BRidge Admin ‚Äî Compliance & Surveillance</h2>
        <span class="badge bg-light text-muted">KYC ¬∑ AML ¬∑ BSA ¬∑ Surveillance</span>
      </div>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <div class="row g-3">
      <!-- LEFT COLUMN: Compliance Members -->
      <div class="col-lg-5">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span><strong>Compliance Members</strong></span>
            <div class="d-flex align-items-center gap-2">
              <input id="filterUser" class="form-control form-control-sm" placeholder="Filter username" style="max-width:180px">
              <button id="reloadMembers" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive" style="max-height:420px; overflow:auto;">
              <table class="table table-sm table-hover align-middle mb-0" id="compTbl">
                <thead class="table-light">
                  <tr>
                    <th>User</th>
                    <th>KYC</th>
                    <th>AML</th>
                    <th>BSA Risk</th>
                    <th>Sanctions</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">
              Backed by <code>compliance_members</code>. Click a row to edit flags.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Alerts + Cases -->
      <div class="col-lg-7">
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span><strong>Surveillance Alerts</strong></span>
            <div class="d-flex align-items-center gap-2">
              <label class="small mb-0">Severity</label>
              <select id="alertSeverityFilter" class="form-select form-select-sm" style="max-width:140px">
                <option value="">(all)</option>
                <option value="info">info</option>
                <option value="warn">warn</option>
                <option value="high">high</option>
              </select>
              <button id="reloadAlerts" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive" style="max-height:220px; overflow:auto;">
              <table class="table table-sm table-striped align-middle mb-0" id="alertTbl">
                <thead class="table-light">
                  <tr>
                    <th>Rule</th>
                    <th>Subject</th>
                    <th>Severity</th>
                    <th>When</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="4" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">
              Data from <code>surveil_alerts</code>. Use alerts to open or update cases below.
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span><strong>Cases</strong></span>
            <div class="d-flex align-items-center gap-2">
              <label class="small mb-0">Status</label>
              <select id="caseStatusFilter" class="form-select form-select-sm" style="max-width:140px">
                <option value="">(all)</option>
                <option value="open">open</option>
                <option value="under_review">under_review</option>
                <option value="closed">closed</option>
              </select>
              <button id="reloadCases" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <div class="table-responsive" style="max-height:260px; overflow:auto;">
                  <table class="table table-sm table-hover align-middle mb-0" id="caseTbl">
                    <thead class="table-light">
                      <tr>
                        <th>ID</th>
                        <th>Rule</th>
                        <th>Subject</th>
                        <th>Status</th>
                        <th>Opened</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-2">Case Detail</h6>
                <div class="mb-2 small text-muted" id="caseDetailHeader">Select a case.</div>
                <form id="caseForm" class="mb-2">
                  <div class="mb-2">
                    <label class="form-label">Status</label>
                    <select id="caseStatus" class="form-select form-select-sm">
                      <option value="open">open</option>
                      <option value="under_review">under_review</option>
                      <option value="closed">closed</option>
                    </select>
                  </div>
                  <div class="mb-2">
                    <label class="form-label">Notes</label>
                    <textarea id="caseNotes" class="form-control form-control-sm" rows="4" placeholder="Add review notes, rationale, escalation steps..."></textarea>
                  </div>
                  <div class="d-flex justify-content-end gap-2">
                    <button id="caseSave" type="button" class="btn btn-sm btn-primary">Save Case</button>
                  </div>
                </form>
                <div class="small text-muted">
                  Cases live in <code>surveil_cases</code>. Updating status + notes writes back for audit.
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Bootstrap -->
  <script
    nonce="{{NONCE}}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
    defer
  ></script>

  <script nonce="{{NONCE}}">
    // Shared helpers (similar to other pages)
    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    function toast(msg, ms=2800){
      const t = document.getElementById('toast');
      if (!t){ alert(typeof msg === 'string' ? msg : (msg?.message || 'Error')); return; }
      const text = typeof msg === 'string' ? msg : (msg?.message || 'Error');
      t.textContent = text;
      t.classList.add('show');
      try { t.focus(); } catch {}
      setTimeout(()=> t.classList.remove('show'), ms);
    }

    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const method = (opts.method || 'GET').toUpperCase();
      const headers = { Accept:'application/json', ...(opts.headers||{}) };
      if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
        headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
      }
      const res = await fetch(url, { ...opts, credentials:'include', headers });
      if (res.status === 401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if (!res.ok){
        let m = 'Request failed';
        try { m = (await res.clone().json()).detail || m; }
        catch { try { m = await res.clone().text() || m; } catch {} }
        toast(m);
        throw new Error(m);
      }
      return res;
    }

    // Health
    onReady(async () => {
      const el = document.querySelector('[data-health-badge]');
      if (!el) return;
      try {
        let ok = false;
        try { ok = (await api('/health')).ok; } catch {}
        if (!ok) { try { ok = (await api('/healthz')).ok; } catch {} }
        if (ok){ el.textContent = '‚óè Live'; el.dataset.ok = '1'; }
        else   { el.textContent = '‚óè Degraded'; el.dataset.ok = '0'; }
      }catch{
        el.textContent = '‚óè Degraded'; el.dataset.ok = '0';
      }
    });
  </script>

  <script nonce="{{NONCE}}">
  (function(){
    const $ = id => document.getElementById(id);
    let currentCaseId = null;
    let caseDataMap = {};   // case_id -> case object

    // ---- Compliance Members ----
    async function loadMembers(){
      const tb = $('#compTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api('/compliance/members');
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No members yet.</td></tr>`;
          return;
        }
        const filterVal = ($('#filterUser')?.value || '').trim().toLowerCase();
        const filtered = filterVal
          ? rows.filter(r => (r.username || '').toLowerCase().includes(filterVal))
          : rows;
        if (!filtered.length){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No matches for filter.</td></tr>`;
          return;
        }
        tb.innerHTML = filtered.map(r => `
          <tr data-username="${r.username}">
            <td>${r.username}</td>
            <td>${r.kyc_passed ? '‚úÖ' : '‚ùå'}</td>
            <td>${r.aml_passed ? '‚úÖ' : '‚ùå'}</td>
            <td>${r.bsa_risk}</td>
            <td>${r.sanctions_screened ? '‚úÖ' : '‚ùå'}</td>
          </tr>
        `).join('');

        tb.querySelectorAll('tr[data-username]').forEach(tr => {
          tr.addEventListener('click', () => {
            openMemberModal(tr.getAttribute('data-username'));
          });
        });
      }catch(e){
        tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    function openMemberModal(username){
      // build a lightweight modal on the fly
      const id = 'memberCompModal';
      let modalEl = document.getElementById(id);
      if (!modalEl){
        modalEl = document.createElement('div');
        modalEl.id = id;
        modalEl.className = 'modal fade';
        modalEl.tabIndex = -1;
        modalEl.innerHTML = `
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Compliance Flags</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="mb-2 small text-muted" id="memberCompUser"></div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="mcKyc">
                  <label class="form-check-label" for="mcKyc">KYC Passed</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="mcAml">
                  <label class="form-check-label" for="mcAml">AML Passed</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="mcSan">
                  <label class="form-check-label" for="mcSan">Sanctions Screened</label>
                </div>
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="mcBoi">
                  <label class="form-check-label" for="mcBoi">BOI Collected</label>
                </div>
                <div class="mt-2">
                  <label class="form-label">BSA Risk</label>
                  <select id="mcRisk" class="form-select form-select-sm">
                    <option value="low">low</option>
                    <option value="medium">medium</option>
                    <option value="high">high</option>
                  </select>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary btn-sm" id="mcSave">Save</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modalEl);
      }

      const userLabel = modalEl.querySelector('#memberCompUser');
      if (userLabel) userLabel.textContent = `User: ${username}`;

      // fetch specific row from table map again
      api('/compliance/members').then(res => res.json()).then(rows => {
        const row = rows.find(r => r.username === username);
        if (!row) return;
        modalEl.querySelector('#mcKyc').checked = !!row.kyc_passed;
        modalEl.querySelector('#mcAml').checked = !!row.aml_passed;
        modalEl.querySelector('#mcSan').checked = !!row.sanctions_screened;
        modalEl.querySelector('#mcBoi').checked = !!row.boi_collected;
        modalEl.querySelector('#mcRisk').value = row.bsa_risk || 'low';
      }).catch(()=>{});

      modalEl.querySelector('#mcSave').onclick = async () => {
        try{
          const body = {
            kyc_passed: modalEl.querySelector('#mcKyc').checked,
            aml_passed: modalEl.querySelector('#mcAml').checked,
            sanctions_screened: modalEl.querySelector('#mcSan').checked,
            boi_collected: modalEl.querySelector('#mcBoi').checked,
            bsa_risk: modalEl.querySelector('#mcRisk').value
          };
          await api(`/compliance/members/${encodeURIComponent(username)}`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          toast('Compliance flags updated.');
          bootstrap.Modal.getInstance(modalEl).hide();
          loadMembers().catch(()=>{});
        }catch(e){
          // toast handled by api()
        }
      };

      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    // ---- Alerts ----
    async function loadAlerts(){
      const tb = $('#alertTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api('/surveil/alerts?limit=50');
        const rows = await res.json();
        const severityFilter = ($('#alertSeverityFilter')?.value || '').toLowerCase();
        const filtered = severityFilter
          ? rows.filter(r => (r.severity || '').toLowerCase() === severityFilter)
          : rows;
        if (!filtered.length){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">No alerts.</td></tr>`;
          return;
        }
        tb.innerHTML = filtered.map(r => `
          <tr>
            <td>${r.rule}</td>
            <td>${r.subject}</td>
            <td>${r.severity}</td>
            <td>${r.created_at}</td>
          </tr>
        `).join('');
      }catch(e){
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    // ---- Cases ----
    async function loadCases(){
      const tb = $('#caseTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const statusFilter = $('#caseStatusFilter')?.value || '';
        const q = statusFilter ? `?status=${encodeURIComponent(statusFilter)}` : '';
        const res = await api(`/surveil/cases${q}`);
        const rows = await res.json();
        caseDataMap = {};
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No cases.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => {
          caseDataMap[r.case_id] = r;
          return `
            <tr data-case="${r.case_id}">
              <td>${r.case_id}</td>
              <td>${r.rule}</td>
              <td>${r.subject}</td>
              <td>${r.status}</td>
              <td>${r.opened_at}</td>
            </tr>
          `;
        }).join('');

        tb.querySelectorAll('tr[data-case]').forEach(tr => {
          tr.addEventListener('click', () => {
            const id = tr.getAttribute('data-case');
            openCase(id);
          });
        });
      }catch(e){
        tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    function openCase(caseId){
      currentCaseId = caseId;
      const row = caseDataMap[caseId];
      const headerEl = $('#caseDetailHeader');
      const statusEl = $('#caseStatus');
      const notesEl  = $('#caseNotes');
      if (!row || !headerEl || !statusEl || !notesEl) return;
      headerEl.textContent = `Case ${caseId} ‚Äî ${row.rule} / ${row.subject}`;
      statusEl.value = row.status || 'open';
      notesEl.value  = row.notes || '';
    }

    async function saveCase(){
      if (!currentCaseId) return toast('Select a case first');
      try{
        const body = {
          status: $('#caseStatus').value || 'open',
          notes: $('#caseNotes').value || null
        };
        await api(`/surveil/cases/${encodeURIComponent(currentCaseId)}`, {
          method:'PATCH',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        toast('Case updated');
        await loadCases();
        // re-open updated
        openCase(currentCaseId);
      }catch(e){
        // toast handled by api()
      }
    }

    onReady(() => {
      // Members
      $('#reloadMembers')?.addEventListener('click', () => loadMembers().catch(()=>{}));
      $('#filterUser')?.addEventListener('input', () => loadMembers().catch(()=>{}));
      loadMembers().catch(()=>{});

      // Alerts
      $('#reloadAlerts')?.addEventListener('click', () => loadAlerts().catch(()=>{}));
      $('#alertSeverityFilter')?.addEventListener('change', () => loadAlerts().catch(()=>{}));
      loadAlerts().catch(()=>{});

      // Cases
      $('#reloadCases')?.addEventListener('click', () => loadCases().catch(()=>{}));
      $('#caseStatusFilter')?.addEventListener('change', () => loadCases().catch(()=>{}));
      $('#caseSave')?.addEventListener('click', () => saveCase().catch(()=>{}));
      loadCases().catch(()=>{});
    });
  })();
  </script>

  <footer class="legal-footer">
    <hr class="mb-3">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms.html" class="link-secondary" rel="noopener noreferrer">Terms</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>¬∑</span>
      <a href="/legal/eula.html" class="link-secondary" rel="noopener noreferrer">EULA</a><span>¬∑</span>
      <a href="/legal/aup.html" class="link-secondary" rel="noopener noreferrer">AUP</a><span>¬∑</span>
      <a href="/legal/cookies.html" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>¬∑</span>
      <a href="/legal/subprocessors.html" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>¬∑</span>
      <a href="/legal/dpa.html" class="link-secondary" rel="noopener noreferrer">DPA</a><span>¬∑</span>
      <a href="/legal/sla.html" class="link-secondary" rel="noopener noreferrer">SLA</a><span>¬∑</span>
      <a href="/legal/security.html" class="link-secondary" rel="noopener noreferrer">Security</a><span>¬∑</span>
      <a href="/legal/fees.html" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> ‚Äì Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
</body>
</html>
