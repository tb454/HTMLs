<!DOCTYPE html>
<html class="loading" lang="en" data-bs-theme="light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BRidge Admin ‚Äî Tenants & Onboarding</title>

  <!-- Bootstrap + app css -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
  <link rel="stylesheet" href="/static/app.css?v=20251111" nonce="{{NONCE}}">
  <link rel="icon" href="/static/favicon.ico" />

  <script nonce="{{NONCE}}">
    function onReady(fn){
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', fn);
      } else {
        try { fn(); } catch(e){ console.error(e); }
      }
    }
    // Warm cookies / XSRF
    onReady(async () => { try { await fetch('/health', { credentials:'include' }); } catch {} });

    // Loader clearing
    window.hideLoading = function(){
      try { document.documentElement.classList.remove('loading'); } catch {}
      try { document.body.classList.add('loaded'); } catch {}
    };
    setTimeout(() => { try { window.hideLoading && window.hideLoading(); } catch {} }, 2500);
    window.addEventListener('DOMContentLoaded', () => {
      try { window.hideLoading && window.hideLoading(); } catch {}
    });
  </script>

  <script id="boot" nonce="{{NONCE}}">
    window.endpoint = window.endpoint || (location.origin.includes('localhost') ? 'http://localhost:8000' : location.origin);
  </script>
  <script src="/static/js/locale.js" defer nonce="{{NONCE}}"></script>
</head>
<body>

  <!-- Locale strip -->
  <div class="d-flex align-items-center gap-2 mb-2 flex-wrap">
    <label class="form-label m-0" for="lang-select" data-i18n="language">Language</label>
    <select id="lang-select" class="form-select form-select-sm w-auto">
      <option value="en">English</option><option value="es">Espa√±ol</option><option value="zh">‰∏≠Êñá</option>
    </select>
    <label class="form-label m-0 ms-2" for="tz-select" data-i18n="timezone">Timezone</label>
    <input id="tz-select" class="form-control form-control-sm w-220" list="tz-list" placeholder="America/Phoenix" data-i18n-ph="timezone"/>
    <datalist id="tz-list">
      <option value="America/Phoenix"></option><option value="America/New_York"></option>
      <option value="America/Chicago"></option><option value="America/Los_Angeles"></option>
      <option value="UTC"></option><option value="Europe/London"></option><option value="Asia/Shanghai"></option>
    </datalist>
    <button id="save-locale" class="btn btn-outline-secondary btn-sm ms-1">
      <span data-i18n="save">Save</span>
    </button>
    <small class="text-muted ms-auto" id="local-time"></small>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast-bridge" role="status" aria-live="polite" aria-atomic="true" tabindex="-1"></div>
  
  <nav class="nav nav-pills small">
    <a class="nav-link" href="/static/bridge-admin-dashboard.html">Dashboard</a>
    <a class="nav-link" href="/static/admin-billing.html">Billing</a>
    <a class="nav-link" href="/static/admin-compliance.html">Compliance</a>
    <a class="nav-link active" href="/static/admin-tenants.html">Tenants</a>
    <a class="nav-link" href="/static/indices.html">Indices</a>
    <a class="nav-link" href="/static/trader.html">Trader</a>
  </nav>

  <div class="container-fluid">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div class="d-flex align-items-center gap-2">
        <h2 class="mb-0">üè≠ BRidge Admin ‚Äî Tenants & Onboarding</h2>
        <span class="badge bg-light text-muted">Yards ¬∑ Mills ¬∑ Brokers ¬∑ Industrial</span>
      </div>
      <span class="health-badge" data-health-badge>‚óè Checking‚Ä¶</span>
    </div>

    <div class="row g-3">
      <!-- LEFT COLUMN: Applications -->
      <div class="col-lg-6">
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <strong>Applications</strong>
              <span class="small text-muted">/onboarding/applications</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="small mb-0">Reviewed</label>
              <select id="appReviewedFilter" class="form-select form-select-sm" style="max-width:150px">
                <option value="">(all)</option>
                <option value="false">Unreviewed</option>
                <option value="true">Reviewed</option>
              </select>
              <button id="reloadApps" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive" style="max-height:420px; overflow:auto;">
              <table class="table table-sm table-hover align-middle mb-0" id="appTbl">
                <thead class="table-light">
                  <tr>
                    <th>Created</th>
                    <th>Org</th>
                    <th>Entity</th>
                    <th>Role</th>
                    <th>Plan</th>
                    <th>Reviewed</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="6" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">
              Backed by <code>applications</code>. Click a row to view & add review notes.
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT COLUMN: Signups + Invites -->
      <div class="col-lg-6">
        <!-- Signups -->
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <strong>Yard Signups</strong>
              <span class="small text-muted">/tenants/signups</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="small mb-0">Status</label>
              <select id="signupStatusFilter" class="form-select form-select-sm" style="max-width:150px">
                <option value="">(all)</option>
                <option value="pending">pending</option>
                <option value="approved">approved</option>
                <option value="rejected">rejected</option>
              </select>
              <button id="reloadSignups" class="btn btn-sm btn-outline-secondary">Refresh</button>
            </div>
          </div>
          <div class="card-body p-2">
            <div class="table-responsive" style="max-height:220px; overflow:auto;">
              <table class="table table-sm table-hover align-middle mb-0" id="signupTbl">
                <thead class="table-light">
                  <tr>
                    <th>Created</th>
                    <th>Yard</th>
                    <th>Contact</th>
                    <th>Plan</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
            <div class="small text-muted mt-2">
              Backed by <code>tenant_signups</code>. Approvals can drive invites/org creation.
            </div>
          </div>
        </div>

        <!-- Invites & Orgs -->
        <div class="card">
          <div class="card-header d-flex align-items-center justify-content-between">
            <div>
              <strong>Invites & Tenants</strong>
              <span class="small text-muted">/orgs ¬∑ /invites</span>
            </div>
            <div class="d-flex align-items-center gap-2">
              <label class="small mb-0">Org</label>
              <select id="orgSelect" class="form-select form-select-sm" style="max-width:220px">
                <option value="">(select org)</option>
              </select>
              <button id="reloadInvites" class="btn btn-sm btn-outline-secondary">Refresh Invites</button>
            </div>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-6">
                <h6 class="mb-2">Existing Invites</h6>
                <div class="table-responsive" style="max-height:200px; overflow:auto;">
                  <table class="table table-sm table-hover align-middle mb-0" id="inviteTbl">
                    <thead class="table-light">
                      <tr>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Created</th>
                        <th>Accepted</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr><td colspan="4" class="text-muted text-center py-2">Select an org.</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <div class="col-md-6">
                <h6 class="mb-2">Create Invite</h6>
                <form id="inviteForm" class="row g-2">
                  <div class="col-12">
                    <label class="form-label">Organization</label>
                    <input id="inviteOrg" class="form-control form-control-sm" readonly placeholder="Select org above">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Email</label>
                    <input id="inviteEmail" type="email" class="form-control form-control-sm" placeholder="user@company.com">
                  </div>
                  <div class="col-12">
                    <label class="form-label">Role</label>
                    <select id="inviteRole" class="form-select form-select-sm">
                      <option value="buyer">Buyer</option>
                      <option value="seller">Seller</option>
                      <option value="admin">Admin</option>
                    </select>
                  </div>
                  <div class="col-12 d-flex justify-content-end gap-2">
                    <button id="inviteCreate" type="button" class="btn btn-sm btn-primary">Send Invite</button>
                  </div>
                </form>
                <div class="small text-muted mt-2">
                  Invites write to <code>invites_log</code> with member = org key. Account creation can then map invites ‚Üí users.
                </div>
              </div>
            </div>
          </div>
        </div>

      </div> <!-- /right col -->
    </div> <!-- /row -->
  </div> <!-- /container -->

  <!-- Bootstrap -->
  <script
    nonce="{{NONCE}}"
    src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"
    defer
  ></script>

  <script nonce="{{NONCE}}">
    // Shared helpers like other admin pages
    function _cookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )'+name.replace(/([.*+?^${}()|[\]\\])/g, '\\$1')+'=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : '';
    }

    function toast(msg, ms=2800){
      const t = document.getElementById('toast');
      if (!t){ alert(typeof msg === 'string' ? msg : (msg?.message || 'Error')); return; }
      const text = typeof msg === 'string' ? msg : (msg?.message || 'Error');
      t.textContent = text;
      t.classList.add('show');
      try { t.focus(); } catch {}
      setTimeout(()=> t.classList.remove('show'), ms);
    }

    async function api(path, opts={}){
      const url = path.startsWith('http') ? path : `${window.endpoint}${path}`;
      const method = (opts.method || 'GET').toUpperCase();
      const headers = { Accept:'application/json', ...(opts.headers||{}) };
      if (!/^(GET|HEAD|OPTIONS)$/.test(method)) {
        headers['X-CSRF'] = _cookie('XSRF-TOKEN') || headers['X-CSRF'];
      }
      const res = await fetch(url, { ...opts, credentials:'include', headers });
      if (res.status === 401){
        const next = encodeURIComponent(location.pathname + location.search);
        location.href = `/static/bridge-login.html?next=${next}`;
        throw new Error('Unauthorized');
      }
      if (!res.ok){
        let m = 'Request failed';
        try { m = (await res.clone().json()).detail || m; }
        catch { try { m = await res.clone().text() || m; } catch {} }
        toast(m);
        throw new Error(m);
      }
      return res;
    }

    // Health badge
    onReady(async () => {
      const el = document.querySelector('[data-health-badge]');
      if (!el) return;
      try {
        let ok = false;
        try { ok = (await api('/health')).ok; } catch {}
        if (!ok) { try { ok = (await api('/healthz')).ok; } catch {} }
        if (ok){ el.textContent = '‚óè Live'; el.dataset.ok = '1'; }
        else   { el.textContent = '‚óè Degraded'; el.dataset.ok = '0'; }
      }catch{
        el.textContent = '‚óè Degraded'; el.dataset.ok = '0';
      }
    });
  </script>

  <script nonce="{{NONCE}}">
  (function(){
    const $ = id => document.getElementById(id);
    const fmtInt = n => Number(n || 0).toLocaleString();

    let orgList = [];
    let currentOrg = '';

    // ----- Applications -----
    async function loadApplications(){
      const tb = $('#appTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const reviewedFilter = $('#appReviewedFilter')?.value;
        let url = '/onboarding/applications';
        if (reviewedFilter === 'true')  url += '?reviewed=true';
        if (reviewedFilter === 'false') url += '?reviewed=false';

        const res = await api(url);
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">No applications.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr data-app-id="${r.id}">
            <td>${r.created_at}</td>
            <td>${r.org_name}</td>
            <td>${r.entity_type}</td>
            <td>${r.role}</td>
            <td>${r.plan}</td>
            <td>${r.is_reviewed ? '‚úÖ' : '‚ùå'}</td>
          </tr>
        `).join('');

        tb.querySelectorAll('tr[data-app-id]').forEach(tr => {
          tr.addEventListener('click', () => {
            const id = tr.getAttribute('data-app-id');
            openApplicationModal(id);
          });
        });
      }catch(e){
        tb.innerHTML = `<tr><td colspan="6" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    function openApplicationModal(appId){
      const id = 'appModal';
      let modalEl = document.getElementById(id);
      if (!modalEl){
        modalEl = document.createElement('div');
        modalEl.id = id;
        modalEl.className = 'modal fade';
        modalEl.tabIndex = -1;
        modalEl.innerHTML = `
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Application Review</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div id="appModalBody" class="small"></div>
                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="appReviewedChk">
                  <label class="form-check-label" for="appReviewedChk">
                    Mark as reviewed
                  </label>
                </div>
                <div class="mt-2">
                  <label class="form-label">Notes</label>
                  <textarea id="appNotes" class="form-control form-control-sm" rows="4"
                    placeholder="KYC/AML outcome, risk flags, onboarding decisions..."></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary btn-sm" id="appSaveBtn">Save</button>
              </div>
            </div>
          </div>
        `;
        document.body.appendChild(modalEl);
      }

      // Load full application from API (reuse list call + filter)
      api('/onboarding/applications').then(res => res.json()).then(rows => {
        const r = rows.find(x => x.id === appId);
        const body = modalEl.querySelector('#appModalBody');
        const chk  = modalEl.querySelector('#appReviewedChk');
        const txt  = modalEl.querySelector('#appNotes');
        if (!r || !body || !chk || !txt) return;
        body.innerHTML = `
          <div><strong>Org:</strong> ${r.org_name}</div>
          <div><strong>Type/Role:</strong> ${r.entity_type} / ${r.role}</div>
          <div><strong>Plan:</strong> ${r.plan}</div>
          <div><strong>Volume (tons/m):</strong> ${fmtInt(r.monthly_volume_tons)}</div>
          <div><strong>Contact:</strong> ${r.contact_name} &lt;${r.email}&gt; ${r.phone || ''}</div>
          <div><strong>Created:</strong> ${r.created_at}</div>
        `;
        chk.checked = !!r.is_reviewed;
        txt.value   = r.notes || '';
      }).catch(()=>{});

      modalEl.querySelector('#appSaveBtn').onclick = async () => {
        try{
          const chk = modalEl.querySelector('#appReviewedChk');
          const txt = modalEl.querySelector('#appNotes');
          const body = {
            is_reviewed: chk.checked,
            notes: txt.value || null
          };
          await api(`/onboarding/applications/${encodeURIComponent(appId)}`, {
            method:'PATCH',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify(body)
          });
          toast('Application updated');
          bootstrap.Modal.getInstance(modalEl).hide();
          loadApplications().catch(()=>{});
        }catch(e){
          // toast already shown
        }
      };

      const modal = new bootstrap.Modal(modalEl);
      modal.show();
    }

    // ----- Signups -----
    async function loadSignups(){
      const tb = $('#signupTbl')?.querySelector('tbody');
      if (!tb) return;
      tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const status = $('#signupStatusFilter')?.value || '';
        const url = status ? `/tenants/signups?status=${encodeURIComponent(status)}` : '/tenants/signups';
        const res = await api(url);
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">No signups.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.created_at}</td>
            <td>${r.yard_name}</td>
            <td>${r.contact_name} &lt;${r.email}&gt;</td>
            <td>${r.plan}</td>
            <td>${r.status}</td>
          </tr>
        `).join('');
      }catch(e){
        tb.innerHTML = `<tr><td colspan="5" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    // ----- Orgs & Invites -----
    async function loadOrgs(){
      const sel = $('#orgSelect');
      if (!sel) return;
      sel.innerHTML = `<option value="">(select org)</option>`;
      try{
        const res = await api('/orgs');
        orgList = await res.json();
        orgList.forEach(o => {
          const opt = document.createElement('option');
          opt.value = o.org;
          opt.textContent = o.display_name || o.org;
          sel.appendChild(opt);
        });
      }catch(e){
        console.warn('loadOrgs failed', e);
      }
    }

    async function loadInvites(){
      const member = $('#orgSelect')?.value || '';
      const tb = $('#inviteTbl')?.querySelector('tbody');
      const orgField = $('#inviteOrg');
      if (orgField) orgField.value = member || '';
      if (!tb) return;
      if (!member){
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Select an org.</td></tr>`;
        return;
      }
      tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Loading‚Ä¶</td></tr>`;
      try{
        const res = await api(`/invites?member=${encodeURIComponent(member)}`);
        const rows = await res.json();
        if (!rows.length){
          tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">No invites yet.</td></tr>`;
          return;
        }
        tb.innerHTML = rows.map(r => `
          <tr>
            <td>${r.email}</td>
            <td>${r.role_req}</td>
            <td>${r.created_at}</td>
            <td>${r.accepted_at || '‚Äî'}</td>
          </tr>
        `).join('');
      }catch(e){
        tb.innerHTML = `<tr><td colspan="4" class="text-muted text-center py-2">Failed: ${e.message || 'error'}</td></tr>`;
      }
    }

    async function createInvite(){
      const member = $('#orgSelect')?.value || '';
      const email  = $('#inviteEmail')?.value.trim() || '';
      const role   = $('#inviteRole')?.value || 'buyer';
      if (!member){ return toast('Select an org first'); }
      if (!email){ return toast('Enter an email'); }
      try{
        await api('/invites', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ email, member, role_req: role })
        });
        toast('Invite created');
        $('#inviteEmail').value = '';
        await loadInvites();
      }catch(e){
        // toast already shown
      }
    }

    // ---- Wiring ----
    onReady(() => {
      // Applications
      $('#reloadApps')?.addEventListener('click', () => loadApplications().catch(()=>{}));
      $('#appReviewedFilter')?.addEventListener('change', () => loadApplications().catch(()=>{}));
      loadApplications().catch(()=>{});

      // Signups
      $('#reloadSignups')?.addEventListener('click', () => loadSignups().catch(()=>{}));
      $('#signupStatusFilter')?.addEventListener('change', () => loadSignups().catch(()=>{}));
      loadSignups().catch(()=>{});

      // Orgs + invites
      loadOrgs().then(() => loadInvites()).catch(()=>{});
      $('#orgSelect')?.addEventListener('change', () => loadInvites().catch(()=>{}));
      $('#reloadInvites')?.addEventListener('click', () => loadInvites().catch(()=>{}));
      $('#inviteCreate')?.addEventListener('click', () => createInvite().catch(()=>{}));
    });
  })();
  </script>

  <footer class="legal-footer">
    <hr class="mb-3">
    <nav class="small d-flex flex-wrap gap-2 justify-content-center" aria-label="Legal navigation">
      <a href="/legal/terms.html" class="link-secondary" rel="noopener noreferrer">Terms</a><span>¬∑</span>
      <a href="/legal/privacy.html" class="link-secondary" rel="noopener noreferrer">Privacy</a><span>¬∑</span>
      <a href="/legal/eula.html" class="link-secondary" rel="noopener noreferrer">EULA</a><span>¬∑</span>
      <a href="/legal/aup.html" class="link-secondary" rel="noopener noreferrer">AUP</a><span>¬∑</span>
      <a href="/legal/cookies.html" class="link-secondary" rel="noopener noreferrer">Cookies</a><span>¬∑</span>
      <a href="/legal/subprocessors.html" class="link-secondary" rel="noopener noreferrer">Subprocessors</a><span>¬∑</span>
      <a href="/legal/dpa.html" class="link-secondary" rel="noopener noreferrer">DPA</a><span>¬∑</span>
      <a href="/legal/sla.html" class="link-secondary" rel="noopener noreferrer">SLA</a><span>¬∑</span>
      <a href="/legal/security.html" class="link-secondary" rel="noopener noreferrer">Security</a><span>¬∑</span>
      <a href="/legal/fees.html" class="link-secondary" rel="noopener noreferrer">Fee Schedule</a>
    </nav>

    <div class="mt-3"><strong>BRidge Platform</strong> ‚Äì Powered by ScrapFutures.com</div>
    <div>For acquisition inquiries or product demos:</div>
    <div><a href="mailto:info@atlasipholdingsllc.com">info@atlasipholdingsllc.com</a></div>
    <div class="mt-2">&copy; 2025 BRidge Technologies. All rights reserved.</div>
  </footer>
</body>
</html>
