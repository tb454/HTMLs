<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Combined Layout</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Bootstrap (optional) -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />

  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .wrapper {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 220px;
      background-color: #fff;
      border-right: 1px solid #ddd;
      padding: 1rem;
    }
    .sidebar .nav-link {
      display: block;
      padding: 0.5rem;
      color: #333;
      text-decoration: none;
      margin-bottom: 0.25rem;
    }
    .sidebar .nav-link.active {
      background-color: #e7f5e8;
      color: #27ae60;
      font-weight: 500;
    }
    .content {
      flex: 1;
      padding: 1rem;
    }
    h1 {
      margin-bottom: 1rem;
    }
    .section-block {
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 4px;
      padding: 1rem;
      margin-bottom: 1rem;
    }
    .section-block h2 {
      font-size: 1.25rem;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0.5rem;
    }
    th, td {
      border-bottom: 1px solid #eee;
      padding: 0.75rem;
    }
    thead th {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f7f7f7;
    }
  </style>
</head>

<body>
  <div class="wrapper">
    <!-- SIDEBAR -->
    <div class="sidebar">
      <a href="#" class="nav-link active">Dashboard</a>
      <a href="#" class="nav-link">Contracts</a>
      <a href="#" class="nav-link">Reports</a>
      <a href="#" class="nav-link">Settings</a>
    </div>

    <!-- MAIN CONTENT -->
    <div class="content">
      <h1>Combined BRidge Dashboard</h1>

      <!-- A button to manually refresh data (optional) -->
      <button class="btn btn-success mb-3" onclick="fetchAllData()">
        Refresh Data
      </button>

      <!-- FINISHED GOODS INVENTORY -->
      <div class="section-block">
        <h2>Finished Goods Inventory (from GreenSpark)</h2>
        <div class="table-responsive">
          <table id="greensparkTable">
            <thead>
              <tr>
                <th>Commodity</th>
                <th>WIP (lbs)</th>
                <th>Finished (lbs)</th>
                <th>Total (lbs)</th>
                <th>Avg Cost</th>
                <th>Value</th>
              </tr>
            </thead>
            <tbody>
              <!-- We'll populate this via JS fetch -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- FUTURES / MARKET DATA -->
      <div class="section-block">
        <h2>Futures / Market Data (from Barchart)</h2>
        <div class="table-responsive">
          <table id="futuresTable">
            <thead>
              <tr>
                <th>Contract Name</th>
                <th>Last</th>
                <th>Change</th>
                <th>High</th>
                <th>Low</th>
                <th>Volume</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>

      <!-- FUTURES TRADING GUIDE (Optional) -->
      <div class="section-block">
        <h2>Futures Trading Guide</h2>
        <div class="table-responsive">
          <table id="tradingGuideTable">
            <thead>
              <tr>
                <th>Contract</th>
                <th>Signal</th>
                <th>Entry Date</th>
                <th>Entry Price</th>
                <th>Stop Loss</th>
                <th>Take Profit</th>
                <th>Time Horizon</th>
                <th>Strength</th>
              </tr>
            </thead>
            <tbody>
              <!-- Populated by JS -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>


  <!-- Optionally load Bootstrap JS Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // 1) FETCH FROM GRESPARK.HTML
    function fetchGreenSparkData() {
      return fetch("greenspark.html")       // or the correct path to greenspark.html
        .then(res => res.text())
        .then(html => {
          // Parse the HTML text to a DOM
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          // Extract the hidden JSON
          const raw = doc.getElementById("greenspark-data").textContent;
          const json = JSON.parse(raw);

          // e.g. { inventory: [...] }
          return json.inventory;
        })
        .catch(err => {
          console.error("Error fetching GreenSpark HTML:", err);
          return [];
        });
    }

    // 2) FETCH FROM BARCHART.HTML
    function fetchBarchartData() {
      return fetch("barchart.html")       // or the correct path to barchart.html
        .then(res => res.text())
        .then(html => {
          // parse the HTML
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, "text/html");

          // get the futures JSON
          const raw = doc.getElementById("futures-data").textContent;
          const json = JSON.parse(raw);
          // e.g. { futures: [...], tradingGuide: [...] }
          return json; 
        })
        .catch(err => {
          console.error("Error fetching Barchart HTML:", err);
          return { futures: [], tradingGuide: [] };
        });
    }

    // 3) RENDER GREENSPARK TABLE
    function renderGreenSparkTable(inventory) {
      const tbody = document.querySelector("#greensparkTable tbody");
      tbody.innerHTML = "";

      inventory.forEach(item => {
        // item example: { commodity, wip, finishedGoods, avgCost, value }
        const total = item.wip + item.finishedGoods;
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.commodity}</td>
          <td>${item.wip.toLocaleString()}</td>
          <td>${item.finishedGoods.toLocaleString()}</td>
          <td>${total.toLocaleString()}</td>
          <td>$${item.avgCost.toFixed(4)}/lb</td>
          <td>$${item.value.toLocaleString()}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // 4) RENDER FUTURES TABLE
    function renderFuturesTable(futures) {
      const tbody = document.querySelector("#futuresTable tbody");
      tbody.innerHTML = "";

      futures.forEach(fut => {
        // e.g. { contractName, last, change, high, low, volume, time }
        // pick color for change
        const chgColor = fut.change >= 0 ? "green" : "red";
        const dispChange = (fut.change >= 0 ? "+" : "") + fut.change.toFixed(2);

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${fut.contractName}</td>
          <td>${fut.last.toFixed(2)}</td>
          <td style="color:${chgColor}">${dispChange}</td>
          <td>${fut.high.toFixed(2)}</td>
          <td>${fut.low.toFixed(2)}</td>
          <td>${fut.volume.toLocaleString()}</td>
          <td>${fut.time}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // 5) RENDER FUTURES TRADING GUIDE
    function renderTradingGuide(guide) {
      const tbody = document.querySelector("#tradingGuideTable tbody");
      tbody.innerHTML = "";

      guide.forEach(g => {
        // e.g. { contractName, signal, entryDate, entryPrice, stopLoss, takeProfit, timeHorizon, strength }
        const sigColor = (g.signal === "BUY") ? "green" : "red";
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${g.contractName}</td>
          <td style="color:${sigColor}; font-weight:bold;">${g.signal}</td>
          <td>${g.entryDate}</td>
          <td>${g.entryPrice.toFixed(2)}</td>
          <td>${g.stopLoss.toFixed(2)}</td>
          <td>${g.takeProfit.toFixed(2)}</td>
          <td>${g.timeHorizon}</td>
          <td>${g.strength}</td>
        `;
        tbody.appendChild(row);
      });
    }

    // 6) ORCHESTRATION: FETCH BOTH, THEN RENDER
    function fetchAllData() {
      // get greenspark inventory, then get barchart data
      Promise.all([fetchGreenSparkData(), fetchBarchartData()])
        .then(([inventory, barchart]) => {
          // inventory = array from greenspark
          // barchart = { futures: [...], tradingGuide: [...] }

          // Render each section
          renderGreenSparkTable(inventory);
          renderFuturesTable(barchart.futures);
          renderTradingGuide(barchart.tradingGuide);
        });
    }

    // 7) ON PAGE LOAD
    window.addEventListener("DOMContentLoaded", () => {
      fetchAllData();
    });
  </script>
</body>
</html>
